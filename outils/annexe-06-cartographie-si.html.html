<!DOCTYPE html>
<html lang="fr">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annexe 6 ‚Äì Cartographie SI d'un Cabinet 100% Numerique</title>
  <style>
    :root {
      --primary: #1e3a5f;
      --primary-light: #2d5a8a;
      --secondary: #0d9488;
      --secondary-light: #14b8a6;
      --accent: #f59e0b;
      --danger: #dc2626;
      --success: #059669;
      --warning: #d97706;
      --info: #2563eb;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, var(--gray-100) 0%, #e0e7ef 100%);
      color: var(--gray-700);
      line-height: 1.6;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -10%;
      width: 300px;
      height: 300px;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
    }
    .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 8px; position: relative; }
    .header p { opacity: 0.9; font-size: 14px; max-width: 900px; position: relative; }
    .header-meta { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.15);
      padding: 6px 14px; border-radius: 20px;
      font-size: 12px; font-weight: 600;
    }
    .badge-accent { background: var(--secondary); color: white; }
    .badge-danger { background: var(--danger); color: white; }

    .context-box {
      background: rgba(255,255,255,0.1);
      border-left: 4px solid var(--accent);
      padding: 16px 20px;
      border-radius: 0 8px 8px 0;
      margin-top: 20px;
    }
    .context-box p { font-size: 13px; margin-bottom: 6px; opacity: 0.95; }
    .context-box p:last-child { margin-bottom: 0; }

    .action-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 24px; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; text-decoration: none;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: var(--shadow); }
    .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
    .btn-secondary:hover { background: var(--gray-300); transform: translateY(-2px); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #047857; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #b91c1c; }

    .tabs {
      display: flex; gap: 4px; background: white; padding: 8px;
      border-radius: var(--radius); box-shadow: var(--shadow);
      margin-bottom: 24px; flex-wrap: wrap;
    }
    .tab {
      padding: 10px 16px; border: none; background: transparent;
      font-size: 13px; font-weight: 600; color: var(--gray-600);
      border-radius: 8px; cursor: pointer; transition: all 0.2s;
      white-space: nowrap;
    }
    .tab:hover { background: var(--gray-100); }
    .tab.active { background: var(--primary); color: white; }

    .panel { display: none; animation: fadeIn 0.3s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      background: white; border-radius: var(--radius);
      padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px;
    }
    .card-header {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 16px; padding-bottom: 16px;
      border-bottom: 1px solid var(--gray-200);
    }
    .card-icon {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      font-size: 22px; color: white; flex-shrink: 0;
    }
    .card-icon.secondary { background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%); }
    .card-icon.accent { background: linear-gradient(135deg, var(--accent) 0%, #fbbf24 100%); }
    .card-icon.danger { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); }
    .card-icon.success { background: linear-gradient(135deg, var(--success) 0%, #34d399 100%); }
    .card-icon.info { background: linear-gradient(135deg, var(--info) 0%, #60a5fa 100%); }
    .card h3 { font-size: 18px; font-weight: 700; color: var(--gray-800); }
    .card .subtitle { color: var(--gray-500); font-size: 13px; margin-top: 2px; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }

    .stat-card {
      background: white; border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow); text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .stat-value {
      font-size: 28px; font-weight: 800;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label { font-size: 12px; color: var(--gray-600); margin-top: 4px; font-weight: 500; }
    .stat-trend { font-size: 11px; margin-top: 8px; padding: 4px 10px; border-radius: 20px; display: inline-block; }
    .stat-trend.up { background: #d1fae5; color: var(--success); }
    .stat-trend.down { background: #fee2e2; color: var(--danger); }
    .stat-trend.neutral { background: var(--gray-100); color: var(--gray-600); }

    .profil-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin: 20px 0; }
    .profil-field label { display: block; font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; }
    .profil-field select, .profil-field input {
      width: 100%; padding: 10px 14px; border: 2px solid var(--gray-200);
      border-radius: 8px; font-size: 14px; background: white;
      transition: border-color 0.2s;
    }
    .profil-field select:focus, .profil-field input:focus { outline: none; border-color: var(--primary); }

    /* ========== ARCHITECTURE SI ========== */
    .archi-wrapper {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: var(--radius);
      padding: 30px 20px;
      margin: 20px 0;
      overflow-x: auto;
    }

    .archi-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto auto auto auto;
      gap: 16px;
      min-width: 900px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .archi-center {
      grid-column: 2;
      grid-row: 2 / 4;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .archi-hub {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
      box-shadow: 0 6px 20px rgba(30, 58, 95, 0.4);
      cursor: pointer;
      transition: transform 0.3s;
      border: 3px solid rgba(255,255,255,0.25);
    }
    .archi-hub:hover { transform: scale(1.05); }
    .archi-hub-icon { font-size: 28px; margin-bottom: 5px; }
    .archi-hub-text { font-size: 10px; font-weight: 700; line-height: 1.2; }
    .archi-hub-sub { font-size: 8px; opacity: 0.85; margin-top: 2px; }

    .archi-zone {
      background: white;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 2px solid var(--gray-200);
    }
    .archi-zone-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      padding: 5px 10px;
      border-radius: 14px;
      display: inline-block;
      margin-bottom: 10px;
      color: white;
    }
    .archi-zone-title.securite { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); }
    .archi-zone-title.stockage { background: linear-gradient(135deg, var(--info) 0%, #60a5fa 100%); }
    .archi-zone-title.production { background: linear-gradient(135deg, var(--success) 0%, #34d399 100%); }
    .archi-zone-title.client { background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%); }
    .archi-zone-title.infra { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); }
    .archi-zone-title.conformite { background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%); }

    .archi-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .archi-item:hover { background: white; border-color: var(--gray-300); transform: translateX(3px); }
    .archi-item:last-child { margin-bottom: 0; }
    .archi-item-icon { font-size: 16px; }
    .archi-item-text { font-size: 11px; font-weight: 600; color: var(--gray-700); flex: 1; }
    .archi-item-status {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }
    .archi-item-status.obligatoire { background: #fef2f2; color: var(--danger); }
    .archi-item-status.recommande { background: #fffbeb; color: var(--warning); }
    .archi-item-status.optionnel { background: #eff6ff; color: var(--info); }

    .archi-zone.top-left { grid-column: 1; grid-row: 1; }
    .archi-zone.top-center { grid-column: 2; grid-row: 1; }
    .archi-zone.top-right { grid-column: 3; grid-row: 1; }
    .archi-zone.mid-left { grid-column: 1; grid-row: 2 / 4; }
    .archi-zone.mid-right { grid-column: 3; grid-row: 2 / 4; }
    .archi-zone.bottom-left { grid-column: 1; grid-row: 4; }
    .archi-zone.bottom-center { grid-column: 2; grid-row: 4; }
    .archi-zone.bottom-right { grid-column: 3; grid-row: 4; }

    .archi-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 20px;
      flex-wrap: wrap;
      padding-top: 15px;
      border-top: 1px dashed var(--gray-300);
    }
    .archi-legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      color: var(--gray-600);
      font-weight: 500;
    }
    .archi-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* ========== FORMATION RH ========== */
    .formation-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      border: 2px solid var(--gray-200);
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    .formation-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
    .formation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .formation-titre { font-size: 14px; font-weight: 700; color: var(--gray-800); }
    .formation-duree {
      font-size: 11px;
      padding: 4px 10px;
      background: var(--gray-100);
      border-radius: 12px;
      color: var(--gray-600);
      font-weight: 600;
    }
    .formation-desc { font-size: 12px; color: var(--gray-600); margin-bottom: 10px; }
    .formation-modules { display: flex; flex-wrap: wrap; gap: 6px; }
    .formation-module {
      font-size: 10px;
      padding: 4px 8px;
      background: #eff6ff;
      color: var(--info);
      border-radius: 6px;
      font-weight: 600;
    }

    /* ========== REVERSIBILITE ========== */
    .reversibilite-step {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 10px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary);
    }
    .reversibilite-num {
      width: 32px;
      height: 32px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }
    .reversibilite-content { flex: 1; }
    .reversibilite-titre { font-size: 14px; font-weight: 700; color: var(--gray-800); margin-bottom: 4px; }
    .reversibilite-desc { font-size: 12px; color: var(--gray-600); }

    /* ========== SCRIPTS CONFIG ========== */
    .script-box {
      background: #1e293b;
      border-radius: 10px;
      padding: 16px;
      margin: 12px 0;
      overflow-x: auto;
    }
    .script-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .script-title { color: #94a3b8; font-size: 12px; font-weight: 600; }
    .script-copy {
      background: #334155;
      color: #e2e8f0;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
    }
    .script-copy:hover { background: #475569; }
    .script-code {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      color: #e2e8f0;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .script-comment { color: #64748b; }
    .script-keyword { color: #7dd3fc; }
    .script-string { color: #86efac; }

    /* ========== AUDIT ========== */
    .audit-section {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .audit-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--gray-200);
    }

    .audit-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      background: white;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 2px solid var(--gray-200);
      transition: all 0.2s;
    }
    .audit-item:hover { border-color: var(--gray-300); }
    .audit-item:last-child { margin-bottom: 0; }
    .audit-item.checked { background: #f0fdf4; border-color: var(--success); }
    .audit-item.checked .audit-item-title { color: var(--success); font-weight: 700; }

    .audit-checkbox {
      width: 22px;
      height: 22px;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .audit-item-content { flex: 1; }
    .audit-item-title { font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
    .audit-item-desc { font-size: 12px; color: var(--gray-500); line-height: 1.4; }
    .audit-item-proof {
      font-size: 11px;
      color: var(--info);
      margin-top: 6px;
      padding: 6px 10px;
      background: #eff6ff;
      border-radius: 6px;
      display: inline-block;
    }
    .audit-item-criticite {
      font-size: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .audit-item-criticite.critique { background: #fee2e2; color: var(--danger); }
    .audit-item-criticite.important { background: #fef3c7; color: var(--warning); }
    .audit-item-criticite.standard { background: #dbeafe; color: var(--info); }

    .audit-score {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin-bottom: 20px;
    }
    .audit-score-value { font-size: 48px; font-weight: 800; }
    .audit-score-label { font-size: 14px; opacity: 0.9; margin-top: 4px; }
    .audit-score-bar {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      height: 12px;
      margin-top: 16px;
      overflow: hidden;
    }
    .audit-score-fill {
      height: 100%;
      border-radius: 10px;
      background: white;
      transition: width 0.5s ease;
    }

    /* ========== FICHES ========== */
    .fiche-card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .fiche-card:hover { border-color: var(--primary); box-shadow: var(--shadow-lg); }
    .fiche-card.highlight { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }

    .fiche-header {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
    }
    .fiche-header.securite { border-left: 4px solid var(--danger); }
    .fiche-header.stockage { border-left: 4px solid var(--info); }
    .fiche-header.production { border-left: 4px solid var(--success); }
    .fiche-header.client { border-left: 4px solid var(--secondary); }
    .fiche-header.conformite { border-left: 4px solid var(--warning); }
    .fiche-header.infra { border-left: 4px solid var(--primary); }
    .fiche-header.rh { border-left: 4px solid #8b5cf6; }

    .fiche-title { display: flex; align-items: center; gap: 12px; }
    .fiche-title-text { font-size: 15px; font-weight: 700; color: var(--gray-800); }
    .fiche-title-sub { font-size: 12px; color: var(--gray-500); margin-top: 2px; }
    .fiche-tags { display: flex; gap: 6px; flex-wrap: wrap; }

    .fiche-body { padding: 20px; display: none; border-top: 1px solid var(--gray-200); }
    .fiche-card.open .fiche-body { display: block; }

    .fiche-grid { display: grid; grid-template-columns: 140px 1fr; gap: 12px; }
    @media (max-width: 640px) { .fiche-grid { grid-template-columns: 1fr; } }
    .fiche-label { font-size: 11px; font-weight: 700; color: var(--gray-500); text-transform: uppercase; }
    .fiche-value { font-size: 13px; color: var(--gray-700); line-height: 1.5; }
    .fiche-value a { color: var(--info); font-weight: 600; text-decoration: none; }
    .fiche-value a:hover { text-decoration: underline; }
    .fiche-value ul { margin: 8px 0 0 20px; }
    .fiche-value li { margin-bottom: 4px; }

    .fiche-actions {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed var(--gray-200);
    }
    .fiche-actions h5 {
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-600);
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .fiche-action-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--gray-700);
      transition: background 0.2s;
    }
    .fiche-action-item:hover { background: var(--gray-100); }
    .fiche-action-item a { color: var(--info); font-weight: 600; }

    .tag {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
    }
    .tag-obligatoire { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
    .tag-recommande { background: #fffbeb; color: var(--warning); border: 1px solid #fde68a; }
    .tag-optionnel { background: #eff6ff; color: var(--info); border: 1px solid #bfdbfe; }
    .tag-critique { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }

    .search-box {
      position: relative;
      margin-bottom: 16px;
    }
    .search-box input {
      width: 100%;
      padding: 14px 20px 14px 48px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .search-box input:focus { outline: none; border-color: var(--primary); }
    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }

    .alert {
      padding: 16px 20px;
      border-radius: var(--radius);
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .alert-icon { font-size: 20px; flex-shrink: 0; }
    .alert-content { flex: 1; }
    .alert-title { font-weight: 700; margin-bottom: 4px; }
    .alert-danger { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }
    .alert-warning { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
    .alert-info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
    .alert-success { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; }

    .insight-box {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      border-left: 4px solid var(--success);
      padding: 16px 20px;
      border-radius: 0 8px 8px 0;
      margin: 16px 0;
    }
    .insight-box.warning { background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%); border-left-color: var(--warning); }
    .insight-box.info { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left-color: var(--info); }
    .insight-box.danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left-color: var(--danger); }
    .insight-box strong { color: var(--gray-800); }

    .category-section { margin-bottom: 24px; }
    .category-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800);
      padding: 12px 16px;
      background: var(--gray-100);
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .timeline { margin: 20px 0; }
    .timeline-item {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px dashed var(--gray-200);
    }
    .timeline-item:last-child { border-bottom: none; }
    .timeline-date {
      flex-shrink: 0;
      width: 80px;
      font-size: 12px;
      font-weight: 700;
      color: var(--primary);
    }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
    .timeline-desc { font-size: 13px; color: var(--gray-600); }

    .matrice-risques {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 20px 0;
    }
    @media (max-width: 768px) { .matrice-risques { grid-template-columns: repeat(2, 1fr); } }
    .risque-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      border: 2px solid var(--gray-200);
      transition: all 0.2s;
    }
    .risque-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
    .risque-card.critique { border-color: var(--danger); background: #fef2f2; }
    .risque-card.eleve { border-color: var(--warning); background: #fffbeb; }
    .risque-card.moyen { border-color: var(--info); background: #eff6ff; }
    .risque-card.faible { border-color: var(--success); background: #f0fdf4; }
    .risque-icon { font-size: 24px; margin-bottom: 8px; }
    .risque-titre { font-size: 13px; font-weight: 700; color: var(--gray-800); margin-bottom: 4px; }
    .risque-impact { font-size: 11px; color: var(--gray-600); }
    .risque-niveau {
      font-size: 10px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 12px;
      margin-top: 8px;
      display: inline-block;
    }
    .risque-niveau.critique { background: var(--danger); color: white; }
    .risque-niveau.eleve { background: var(--warning); color: white; }
    .risque-niveau.moyen { background: var(--info); color: white; }
    .risque-niveau.faible { background: var(--success); color: white; }

    .config-box {
      background: #fef3c7;
      border: 2px solid #fde68a;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .config-box-title {
      font-weight: 700;
      color: #92400e;
      font-size: 13px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .disclaimer {
      background: var(--gray-100);
      border: 1px dashed var(--gray-300);
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 20px;
      font-size: 11px;
      color: var(--gray-600);
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .disclaimer-icon { font-size: 16px; flex-shrink: 0; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white;
      border-radius: var(--radius);
      max-width: 750px;
      width: 100%;
      max-height: 85vh;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    .modal-header {
      background: var(--primary);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title { font-weight: 700; font-size: 16px; }
    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .modal-close:hover { background: rgba(255,255,255,0.3); }
    .modal-body { padding: 20px; overflow-y: auto; max-height: 65vh; }
    .modal-body p { margin-bottom: 12px; color: var(--gray-700); font-size: 14px; }
    .modal-body ul { margin-left: 20px; color: var(--gray-700); font-size: 14px; }
    .modal-body li { margin-bottom: 8px; }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--gray-800);
      color: white;
      padding: 14px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 9999;
      font-size: 14px;
      font-weight: 500;
    }
    .toast.show { transform: translateY(0); opacity: 1; }

    .progress-container {
      background: var(--gray-200);
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-bar {
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.5s ease;
    }

    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    @media print {
      body { background: white; }
      .container { padding: 0; max-width: none; }
      .tabs, .action-bar, .toast, .modal-overlay, .search-box { display: none !important; }
      .panel { display: block !important; page-break-inside: avoid; margin-bottom: 30px; }
      .card, .fiche-card { box-shadow: none; border: 1px solid var(--gray-200); }
      .fiche-body { display: block !important; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Annexe 6 - Cartographie SI d'un Cabinet 100% Numerique</h1>
    <p>Guide methodologique pour <strong>concevoir, securiser et maintenir</strong> le systeme d'information d'un cabinet dematerialise. Architecture cible, auto-audit securite, fiches techniques, reversibilite, guides de parametrage et plan d'action personnalise.</p>
    <div class="header-meta">
      <span class="badge">Architecture SI interactive</span>
      <span class="badge">Auto-audit 25 points</span>
      <span class="badge badge-accent">Fiches techniques detaillees</span>
      <span class="badge badge-danger">Cybersecurite 2026</span>
    </div>
    <div class="context-box">
      <p><strong>Public cible :</strong> Expert-comptable en creation ou en modernisation de son SI, souhaitant un cabinet 100% numerique et securise.</p>
      <p><strong>Objectif :</strong> Cartographier l'architecture SI cible, evaluer la maturite securite, calculer le ROI des investissements et disposer d'un plan d'action concret.</p>
      <p><strong>Contexte 2026 :</strong> Facturation electronique obligatoire (reception sept. 2026), directive NIS2, renforcement RGPD, IA agentique.</p>
    </div>
  </div>

  <div class="action-bar">
    <button class="btn btn-success" onclick="exportJSON()">üíæ Sauvegarder </button>
    <div class="file-input-wrapper">
      <button class="btn btn-secondary">üìÇ Charger un audit</button>
      <input type="file" id="importFile" accept=".json" onchange="importJSON(event)">
    </div>
    <button class="btn btn-primary" onclick="exportPDF()">üñ®Ô∏è Export PDF</button>
    <button class="btn" style="background: var(--accent); color: white;" onclick="loadCabinetX()">üìã Cas pratique Cabinet X</button>
    <button class="btn btn-danger" onclick="resetAll()">üóëÔ∏è Reinitialiser</button>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="showPanel('architecture')">üèóÔ∏è Architecture SI</button>
    <button class="tab" onclick="showPanel('audit')">üîí Auto-Audit</button>
    <button class="tab" onclick="showPanel('fiches')">üìã Fiches Techniques</button>
    <button class="tab" onclick="showPanel('reversibilite')">üîÑ Reversibilite</button>
    <button class="tab" onclick="showPanel('scripts')">‚öôÔ∏è Guides Parametrage</button>
    <button class="tab" onclick="showPanel('references')">üìö References</button>
  </div>

  <!-- ==================== PANEL 1: ARCHITECTURE SI ==================== -->
  <div id="architecture" class="panel active">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üèóÔ∏è</div>
        <div>
          <h3>Architecture SI cible d'un cabinet 100% numerique</h3>
          <div class="subtitle">Cliquez sur une brique pour acceder a sa fiche technique complete</div>
        </div>
      </div>

      <div class="config-box">
        <div class="config-box-title">‚ö†Ô∏è Configuration de votre contexte cabinet</div>
        <div class="profil-grid">
          <div class="profil-field">
            <label>Taille du cabinet</label>
            <select id="tailleCabinet" onchange="renderAll()">
              <option value="solo">Solo / 0-1 collaborateur</option>
              <option value="small">2-10 collaborateurs</option>
              <option value="growth">10+ collaborateurs / multi-sites</option>
            </select>
          </div>
          <div class="profil-field">
            <label>Niveau cloud actuel</label>
            <select id="niveauCloud" onchange="renderAll()">
              <option value="saas">SaaS majoritaire (cloud-first)</option>
              <option value="hybrid">Hybride (SaaS + NAS local)</option>
              <option value="local">Local maitrise (NAS / serveur)</option>
            </select>
          </div>
          <div class="profil-field">
            <label>Priorite actuelle</label>
            <select id="prioriteSI" onchange="renderAll()">
              <option value="securite">Securiser (risques / conformite)</option>
              <option value="production">Fiabiliser la production</option>
              <option value="croissance">Scaler (croissance)</option>
              <option value="couts">Optimiser les couts</option>
            </select>
          </div>
          <div class="profil-field">
            <label>Facturation electronique</label>
            <select id="factureElec" onchange="renderAll()">
              <option value="non">Pas encore prepare</option>
              <option value="encours">En cours de preparation</option>
              <option value="pret">Pret (PA (ex-PDP) choisie)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="alert alert-danger">
        <div class="alert-icon">üö®</div>
        <div class="alert-content">
          <div class="alert-title">Chiffre cle : 47% des entreprises ont subi au moins une cyberattaque significative en 2024</div>
          <div>Les cabinets comptables sont des cibles privilegiees (donnees financieres, RIB, donnees sociales). L'attaque Coaxis (dec. 2023) a paralyse de nombreux cabinets et compromis l'acces aux donnees de leurs clients. <strong>La securite n'est plus optionnelle.</strong> <span style="font-size:11px; opacity:0.8;">(Source : CESIN, 10e Barometre, janv. 2025)</span></div>
        </div>
      </div>

      <!-- ARCHITECTURE VISUELLE -->
      <div class="archi-wrapper">
        <div class="archi-grid">
          
          <!-- Zone Securite (haut gauche) -->
          <div class="archi-zone top-left">
            <span class="archi-zone-title securite">A. Securite</span>
            <div class="archi-item" onclick="focusFiche('mfa')">
              <span class="archi-item-icon">üîê</span>
              <span class="archi-item-text">MFA / SSO</span>
              <span class="archi-item-status obligatoire">Obligatoire</span>
            </div>
            <div class="archi-item" onclick="focusFiche('edr')">
              <span class="archi-item-icon">üõ°Ô∏è</span>
              <span class="archi-item-text">EDR / Antivirus</span>
              <span class="archi-item-status obligatoire">Obligatoire</span>
            </div>
            <div class="archi-item" onclick="focusFiche('chiffrement')">
              <span class="archi-item-icon">üîí</span>
              <span class="archi-item-text">Chiffrement postes</span>
              <span class="archi-item-status obligatoire">Obligatoire</span>
            </div>
          </div>

          <!-- Zone Stockage (haut centre) -->
          <div class="archi-zone top-center">
            <span class="archi-zone-title stockage">B. Stockage</span>
            <div class="archi-item" onclick="focusFiche('cloud')">
              <span class="archi-item-icon">‚òÅÔ∏è</span>
              <span class="archi-item-text">Cloud / GED SaaS</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
            <div class="archi-item" onclick="focusFiche('nas')">
              <span class="archi-item-icon">üíæ</span>
              <span class="archi-item-text">NAS chiffre</span>
              <span class="archi-item-status optionnel">Option</span>
            </div>
            <div class="archi-item" onclick="focusFiche('sauvegarde')">
              <span class="archi-item-icon">üîÑ</span>
              <span class="archi-item-text">Sauvegarde 3-2-1</span>
              <span class="archi-item-status obligatoire">Critique</span>
            </div>
          </div>

          <!-- Zone Production (haut droit) -->
          <div class="archi-zone top-right">
            <span class="archi-zone-title production">C. Production</span>
            <div class="archi-item" onclick="focusFiche('compta')">
              <span class="archi-item-icon">üìä</span>
              <span class="archi-item-text">Logiciel comptable</span>
              <span class="archi-item-status obligatoire">Obligatoire</span>
            </div>
            <div class="archi-item" onclick="focusFiche('facturation')">
              <span class="archi-item-icon">üìÑ</span>
              <span class="archi-item-text">Facturation elec.</span>
              <span class="archi-item-status obligatoire">Sept. 2026</span>
            </div>
            <div class="archi-item" onclick="focusFiche('signature')">
              <span class="archi-item-icon">‚úçÔ∏è</span>
              <span class="archi-item-text">Signature electronique</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
          </div>

          <!-- Zone Infra (milieu gauche) -->
          <div class="archi-zone mid-left">
            <span class="archi-zone-title infra">D. Infrastructure</span>
            <div class="archi-item" onclick="focusFiche('reseau')">
              <span class="archi-item-icon">üåê</span>
              <span class="archi-item-text">Reseau / Wi-Fi / VPN</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
            <div class="archi-item" onclick="focusFiche('email')">
              <span class="archi-item-icon">üìß</span>
              <span class="archi-item-text">Email securise</span>
              <span class="archi-item-status obligatoire">Obligatoire</span>
            </div>
            <div class="archi-item" onclick="focusFiche('mdm')">
              <span class="archi-item-icon">üì±</span>
              <span class="archi-item-text">MDM (gestion postes)</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
            <div class="archi-item" onclick="focusFiche('ia')">
              <span class="archi-item-icon">ü§ñ</span>
              <span class="archi-item-text">IA / Automatisation</span>
              <span class="archi-item-status optionnel">Emergent</span>
            </div>
          </div>

          <!-- Centre : Cabinet -->
          <div class="archi-center">
            <div class="archi-hub" onclick="openModal('Cabinet 100% Numerique', getArchitCenterContent())">
              <div class="archi-hub-icon">üè¢</div>
              <div class="archi-hub-text">CABINET<br>100% NUMERIQUE</div>
              <div class="archi-hub-sub">Architecture cible</div>
            </div>
          </div>

          <!-- Zone Client (milieu droit) -->
          <div class="archi-zone mid-right">
            <span class="archi-zone-title client">E. Relation Client</span>
            <div class="archi-item" onclick="focusFiche('portail')">
              <span class="archi-item-icon">üö™</span>
              <span class="archi-item-text">Portail client / GED</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
            <div class="archi-item" onclick="focusFiche('crm')">
              <span class="archi-item-icon">üë•</span>
              <span class="archi-item-text">CRM / Ticketing</span>
              <span class="archi-item-status optionnel">Optionnel</span>
            </div>
            <div class="archi-item" onclick="focusFiche('communication')">
              <span class="archi-item-icon">üí¨</span>
              <span class="archi-item-text">Communication securisee</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
          </div>

          <!-- Zone Conformite (bas gauche) -->
          <div class="archi-zone bottom-left">
            <span class="archi-zone-title conformite">F. Conformite</span>
            <div class="archi-item" onclick="focusFiche('rgpd')">
              <span class="archi-item-icon">üìã</span>
              <span class="archi-item-text">RGPD / DPA</span>
              <span class="archi-item-status obligatoire">Obligatoire</span>
            </div>
            <div class="archi-item" onclick="focusFiche('logs')">
              <span class="archi-item-icon">üìù</span>
              <span class="archi-item-text">Logs / Tracabilite</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
          </div>

          <!-- Zone PCA/PRA (bas centre) -->
          <div class="archi-zone bottom-center">
            <span class="archi-zone-title securite">G. Resilience</span>
            <div class="archi-item" onclick="focusFiche('pca')">
              <span class="archi-item-icon">üîÑ</span>
              <span class="archi-item-text">PCA / PRA</span>
              <span class="archi-item-status obligatoire">Critique</span>
            </div>
            <div class="archi-item" onclick="focusFiche('incident')">
              <span class="archi-item-icon">üö®</span>
              <span class="archi-item-text">Gestion incidents</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
          </div>

          <!-- Zone API (bas droit) -->
          <div class="archi-zone bottom-right">
            <span class="archi-zone-title infra">H. Integration</span>
            <div class="archi-item" onclick="focusFiche('api')">
              <span class="archi-item-icon">üîó</span>
              <span class="archi-item-text">API / Connecteurs</span>
              <span class="archi-item-status recommande">Recommande</span>
            </div>
          </div>

        </div>

        <!-- Legende -->
        <div class="archi-legend">
          <div class="archi-legend-item">
            <div class="archi-legend-dot" style="background: var(--danger);"></div>
            <span>Securite</span>
          </div>
          <div class="archi-legend-item">
            <div class="archi-legend-dot" style="background: var(--info);"></div>
            <span>Stockage</span>
          </div>
          <div class="archi-legend-item">
            <div class="archi-legend-dot" style="background: var(--success);"></div>
            <span>Production</span>
          </div>
          <div class="archi-legend-item">
            <div class="archi-legend-dot" style="background: var(--secondary);"></div>
            <span>Relation Client</span>
          </div>
          <div class="archi-legend-item">
            <div class="archi-legend-dot" style="background: var(--primary);"></div>
            <span>Infrastructure</span>
          </div>
          <div class="archi-legend-item">
            <div class="archi-legend-dot" style="background: var(--warning);"></div>
            <span>Conformite</span>
          </div>
        </div>
      </div>

      <div class="insight-box info">
        <strong>Principe architectural :</strong> Privilegier le SaaS pour la production et la collaboration, securiser les acces (MFA obligatoire), appliquer le principe du moindre privilege, et garantir la resilience avec des sauvegardes immuables testees.
      </div>

      <div id="recommandationsSI"></div>
    </div>
  </div>

  <!-- ==================== PANEL 2: AUTO-AUDIT ==================== -->
  <div id="audit" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-icon danger">üîí</div>
        <div>
          <h3>Auto-Audit Securite SI (25 points de controle)</h3>
          <div class="subtitle">Evaluez la maturite securite de votre cabinet - A realiser tous les 6 mois (art. 150, code de deontologie : examen periodique des missions)</div>
        </div>
      </div>

      <div class="alert alert-warning">
        <div class="alert-icon">‚è±Ô∏è</div>
        <div class="alert-content">
          <div class="alert-title">Duree estimee : 15-20 minutes</div>
          <div>Chaque point doit etre <strong>prouvable</strong> (capture ecran, procedure documentee, contrat). Integrez ces preuves dans votre dossier "Gouvernance SI".</div>
        </div>
      </div>

      <div class="grid">
        <div class="audit-score">
          <div class="audit-score-value" id="auditScoreValue">0%</div>
          <div class="audit-score-label">Score de maturite securite</div>
          <div class="audit-score-bar">
            <div class="audit-score-fill" id="auditScoreFill" style="width: 0%;"></div>
          </div>
        </div>
        <div class="grid-4" style="margin: 0;">
          <div class="stat-card" id="statCritique">
            <div class="stat-value">0/8</div>
            <div class="stat-label">Points critiques</div>
            <div class="stat-trend down">Prioritaires</div>
          </div>
          <div class="stat-card" id="statImportant">
            <div class="stat-value">0/10</div>
            <div class="stat-label">Points importants</div>
            <div class="stat-trend neutral">A traiter</div>
          </div>
          <div class="stat-card" id="statStandard">
            <div class="stat-value">0/7</div>
            <div class="stat-label">Points standards</div>
            <div class="stat-trend up">Bonnes pratiques</div>
          </div>
        </div>
      </div>

      <div id="auditContainer"></div>

      <!-- PLAN D'ACTION POST-AUDIT (g√©n√©r√© dynamiquement) -->
      <div id="actionPlanContainer" style="margin-top: 24px;"></div>
    </div>
  </div>



  <!-- ==================== PANEL 5: FICHES TECHNIQUES ==================== -->
  <div id="fiches" class="panel">
    <div class="search-box">
      <input type="text" id="searchFiches" placeholder="Rechercher : MFA, sauvegarde, RGPD, NAS, EDR, PCA..." onkeyup="filterFiches()">
    </div>
    <div id="fichesContainer"></div>
  </div>

  <!-- ==================== PANEL 6: REVERSIBILITE ==================== -->
  <div id="reversibilite" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-icon info">üîÑ</div>
        <div>
          <h3>Scenarios de reversibilite (sortie editeur SaaS)</h3>
          <div class="subtitle">Anticipez la migration en cas de changement de prestataire</div>
        </div>
      </div>

      <div class="alert alert-warning">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
          <div class="alert-title">Dependance editeur : un risque a anticiper</div>
          <div>Le SaaS offre de nombreux avantages, mais cree une dependance. Prevoyez toujours une strategie de sortie (export, migration, continuite).</div>
        </div>
      </div>

      <div class="category-title">üìã Checklist reversibilite par type d'outil</div>

      <div class="reversibilite-step">
        <div class="reversibilite-num">1</div>
        <div class="reversibilite-content">
          <div class="reversibilite-titre">Logiciel comptable</div>
          <div class="reversibilite-desc">
            <strong>Verifier :</strong> Export FEC (format legal), export plan comptable, export ecritures, export immobilisations.<br>
            <strong>Frequence :</strong> Export mensuel ou trimestriel vers stockage independant.<br>
            <strong>Attention :</strong> Certains editeurs limitent les exports ou facturent la sortie.
          </div>
        </div>
      </div>

      <div class="reversibilite-step">
        <div class="reversibilite-num">2</div>
        <div class="reversibilite-content">
          <div class="reversibilite-titre">GED / Portail client</div>
          <div class="reversibilite-desc">
            <strong>Verifier :</strong> Export masse des documents (ZIP, arborescence), export metadonnees, format standard (PDF).<br>
            <strong>Frequence :</strong> Sauvegarde hebdomadaire vers stockage independant.<br>
            <strong>Attention :</strong> Verifier les droits sur les documents (propriete vs licence).
          </div>
        </div>
      </div>

      <div class="reversibilite-step">
        <div class="reversibilite-num">3</div>
        <div class="reversibilite-content">
          <div class="reversibilite-titre">Email / Messagerie</div>
          <div class="reversibilite-desc">
            <strong>Verifier :</strong> Export PST/MBOX, migration DNS (MX), portabilite du nom de domaine.<br>
            <strong>Frequence :</strong> Sauvegarde mensuelle des boites critiques.<br>
            <strong>Attention :</strong> Prevoir une periode de transition (double reception).
          </div>
        </div>
      </div>

      <div class="reversibilite-step">
        <div class="reversibilite-num">4</div>
        <div class="reversibilite-content">
          <div class="reversibilite-titre">CRM / Base clients</div>
          <div class="reversibilite-desc">
            <strong>Verifier :</strong> Export CSV/Excel des contacts, historique des echanges, donnees personnalisees.<br>
            <strong>Frequence :</strong> Export mensuel.<br>
            <strong>Attention :</strong> Verifier la conformite RGPD lors du transfert.
          </div>
        </div>
      </div>

      <div class="insight-box info" style="margin-top: 20px;">
        <strong>Bonne pratique :</strong> Documentez dans votre PCA/PRA les procedures de reversibilite pour chaque outil critique. Testez un export complet au moins une fois par an.
      </div>

      <div class="category-title" style="margin-top: 24px;">üìù Clauses contractuelles a verifier</div>
      <ul style="margin-left: 24px; color: var(--gray-700); line-height: 1.8;">
        <li><strong>Duree de preavis</strong> : delai de resiliation (souvent 3 mois)</li>
        <li><strong>Format d'export</strong> : formats standards, sans surcout</li>
        <li><strong>Delai de mise a disposition</strong> : acces aux donnees apres resiliation</li>
        <li><strong>Accompagnement migration</strong> : support technique inclus ou payant</li>
        <li><strong>Destruction des donnees</strong> : attestation de suppression post-migration</li>
      </ul>
    </div>
  </div>

  <!-- ==================== PANEL 7: GUIDES PARAMETRAGE SI ==================== -->
  <div id="scripts" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">‚öôÔ∏è</div>
        <div>
          <h3>Guides de parametrage et verification SI</h3>
          <div class="subtitle">Procedures operationnelles : ce que l'expert-comptable fait, ce qu'il delegue, ce qu'il verifie</div>
        </div>
      </div>

      <!-- Encadr√© philosophie -->
      <div class="alert alert-info" style="border-left: 4px solid var(--primary); background: #f0f4ff;">
        <div class="alert-icon">üéØ</div>
        <div class="alert-content">
          <div class="alert-title">Logique de cet onglet</div>
          <div style="font-size: 13px; line-height: 1.7;">
            L'expert-comptable n'est pas informaticien, mais il est <strong>responsable de la securite des donnees de ses clients</strong> (art. 148 du Code de deontologie, RGPD art. 32). Chaque procedure ci-dessous est structuree en trois niveaux :<br><br>
            <span style="display: inline-flex; align-items: center; gap: 6px; margin-bottom: 4px;">
              <span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 1</span>
              <strong>Methode directe</strong> ‚Äî Ce que l'EC fait lui-meme, en quelques clics, via les portails d'administration.
            </span><br>
            <span style="display: inline-flex; align-items: center; gap: 6px; margin-bottom: 4px;">
              <span style="background: var(--info); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 2</span>
              <strong>Cahier des charges prestataire</strong> ‚Äî Ce que l'EC demande a son prestataire IT, avec les specifications techniques a exiger.
            </span><br>
            <span style="display: inline-flex; align-items: center; gap: 6px;">
              <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 3</span>
              <strong>Verification</strong> ‚Äî Comment l'EC controle que le parametrage a ete correctement realise, meme sans competence technique.
            </span>
          </div>
        </div>
      </div>

      <!-- ===== PROCEDURE 1 : MFA ===== -->
      <div class="category-title">üîê Procedure n¬∞1 ‚Äî Activer l'authentification multifacteur (MFA)</div>
      
      <div style="background: #fef2f2; border-left: 4px solid var(--danger); padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 16px; font-size: 13px;">
        <strong>Pourquoi c'est critique :</strong> Le MFA bloque plus de 99 % des attaques par vol de mot de passe (source : Microsoft Security, 2023). L'ANSSI le classe en mesure n¬∞1 de son guide d'hygiene informatique. L'enquete Annexe 24 revele que seulement 19,2 % des confreres interroges l'ont active sur tous leurs comptes.
      </div>

      <!-- Niveau 1 : M√©thode directe -->
      <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--success); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 1</span>
          <strong style="color: var(--success);">Methode directe ‚Äî L'EC fait lui-meme (‚âà 10 min)</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Environnement Microsoft 365 Business :</strong><br>
          <span style="color: var(--gray-500); font-size: 12px;">Prerequis : disposer d'un compte administrateur sur le tenant Microsoft 365.</span><br><br>
          <strong>Etape 1 :</strong> Se connecter a <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">admin.microsoft.com</code><br>
          <strong>Etape 2 :</strong> Menu lateral ‚Üí <em>Identite</em> ‚Üí <em>Vue d'ensemble</em> ‚Üí <em>Proprietes</em><br>
          <strong>Etape 3 :</strong> En bas de page, cliquer sur <em>Gerer les parametres de securite par defaut</em><br>
          <strong>Etape 4 :</strong> Activer <em>Parametres de securite par defaut</em> ‚Üí Enregistrer<br><br>
          <span style="background: #dcfce7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            ‚úÖ <strong>Resultat :</strong> Tous les utilisateurs devront configurer Microsoft Authenticator a leur prochaine connexion. Aucune exception possible (sauf comptes de service).
          </span><br><br>
          <strong>Environnement Google Workspace :</strong><br>
          <strong>Etape 1 :</strong> Se connecter a <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">admin.google.com</code><br>
          <strong>Etape 2 :</strong> <em>Securite</em> ‚Üí <em>Authentification</em> ‚Üí <em>Validation en 2 etapes</em><br>
          <strong>Etape 3 :</strong> Cocher <em>Autoriser les utilisateurs a activer la validation en 2 etapes</em><br>
          <strong>Etape 4 :</strong> Cocher <em>Application forcee</em> ‚Üí Appliquer a l'unite organisationnelle racine<br><br>
          <span style="background: #dcfce7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            ‚úÖ <strong>Resultat :</strong> Tous les comptes du cabinet passent en MFA obligatoire. Delai de grace parametrable (recommande : 7 jours).
          </span>
        </div>
      </div>

      <!-- Niveau 2 : Cahier des charges -->
      <div style="background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--info); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 2</span>
          <strong style="color: var(--info);">Cahier des charges prestataire ‚Äî Specifications a exiger</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          Si le cabinet fait appel a un prestataire IT, voici les specifications a inclure dans le bon de commande ou le contrat de prestation :
        </div>
        <div class="script-box" style="margin-top: 12px;">
          <div class="script-header">
            <span class="script-title">Specifications techniques MFA ‚Äî a transmettre au prestataire</span>
            <button class="script-copy" onclick="copyScript(this)">Copier</button>
          </div>
          <div class="script-code"><span class="script-comment"># CAHIER DES CHARGES ‚Äî ACTIVATION MFA CABINET</span>
<span class="script-comment"># A remettre au prestataire IT avec le bon de commande</span>

<span class="script-keyword">PERIMETRE :</span>
- Activer le MFA sur <span class="script-string">TOUS</span> les comptes utilisateurs du cabinet (aucune exception)
- Couvrir : messagerie, logiciel comptable (si SSO), GED, espace cloud
- Methode MFA privilegiee : application d'authentification (TOTP)
  <span class="script-comment"># Eviter le SMS : vulnerable au SIM-swapping (source : ANSSI, 2024)</span>

<span class="script-keyword">EXIGENCES :</span>
- Aucun compte partage (1 compte = 1 personne)
- Comptes de service : mot de passe de 20+ caracteres, rotation semestrielle
- Politique de mot de passe : 12 caracteres minimum, complexite activee
- Verrouillage apres 5 tentatives echouees

<span class="script-keyword">LIVRABLES ATTENDUS DU PRESTATAIRE :</span>
1. Liste nominative des comptes avec statut MFA (capture ecran ou export)
2. Procedure de secours en cas de perte du telephone (codes de recuperation)
3. Procedure d'onboarding (creation compte + MFA) pour chaque nouveau collaborateur
4. Procedure d'offboarding (suppression IMMEDIATE des acces le jour du depart)

<span class="script-keyword">DELAI :</span> Sous 5 jours ouvrables apres reception du bon de commande.

<span class="script-comment"># Reference : ANSSI, Guide d'hygiene informatique, mesures n¬∞1 a 4</span>
<span class="script-comment"># Reference : NPMQ ¬ß15 ‚Äî conformite du personnel au code de deontologie</span></div>
        </div>
      </div>

      <!-- Niveau 3 : V√©rification -->
      <div style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 10px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--accent); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 3</span>
          <strong style="color: var(--warning);">Verification ‚Äî Comment l'EC controle (sans competence IT)</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Test 1 ‚Äî Essai de connexion :</strong> Se deconnecter, puis se reconnecter. Si le systeme ne demande PAS de second facteur ‚Üí le MFA n'est pas actif. Alerter le prestataire.<br>
          <strong>Test 2 ‚Äî Verification du portail admin :</strong><br>
          &nbsp;&nbsp;‚Ä¢ Microsoft 365 : <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">admin.microsoft.com</code> ‚Üí Utilisateurs ‚Üí Utilisateurs actifs ‚Üí colonnes ¬´ MFA activee ¬ª<br>
          &nbsp;&nbsp;‚Ä¢ Google Workspace : <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">admin.google.com</code> ‚Üí Rapports ‚Üí Comptes ‚Üí Verification en 2 etapes<br>
          <strong>Test 3 ‚Äî Test de l'offboarding :</strong> Creer un compte test, le supprimer, tenter de se reconnecter avec ses identifiants. L'acces doit etre refuse immediatement.<br><br>
          <span style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            üìã <strong>Preuve a archiver :</strong> Capture ecran du portail admin montrant 100 % des comptes en MFA actif. A dater et stocker dans le dossier ¬´ Gouvernance SI ¬ª.
          </span>
        </div>
      </div>

      <!-- ===== PROCEDURE 2 : CHIFFREMENT ===== -->
      <div class="category-title">üîí Procedure n¬∞2 ‚Äî Chiffrer les postes de travail et supports amovibles</div>

      <div style="background: #fef2f2; border-left: 4px solid var(--danger); padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 16px; font-size: 13px;">
        <strong>Pourquoi c'est critique :</strong> Le vol ou la perte d'un ordinateur portable non chiffre contenant des donnees clients constitue une violation RGPD notifiable a la CNIL sous 72 heures (art. 33 du RGPD). Le chiffrement rend les donnees illisibles sans la cle : la notification peut alors etre evitee (considerant 87 du RGPD).
      </div>

      <!-- Niveau 1 -->
      <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--success); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 1</span>
          <strong style="color: var(--success);">Methode directe ‚Äî L'EC fait lui-meme (‚âà 5 min par poste)</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Windows 11 Pro (BitLocker) :</strong><br>
          <span style="color: var(--gray-500); font-size: 12px;">Prerequis : Windows 11 Pro ou Entreprise (BitLocker n'est pas disponible sur Windows Home).</span><br><br>
          <strong>Etape 1 :</strong> <em>Parametres</em> ‚Üí <em>Confidentialite et securite</em> ‚Üí <em>Chiffrement de l'appareil</em><br>
          <strong>Etape 2 :</strong> Activer le curseur ¬´ Chiffrement de l'appareil ¬ª<br>
          <strong>Etape 3 :</strong> Sauvegarder la cle de recuperation dans le compte Microsoft professionnel<br><br>
          <span style="background: #dcfce7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            ‚úÖ <strong>Resultat :</strong> Le disque entier est chiffre en AES-256. En cas de vol, les donnees sont inaccessibles sans le mot de passe de session Windows.
          </span><br><br>
          <strong>macOS (FileVault) :</strong><br>
          <strong>Etape 1 :</strong> <em>Reglages Systeme</em> ‚Üí <em>Confidentialite et securite</em> ‚Üí <em>FileVault</em><br>
          <strong>Etape 2 :</strong> Cliquer sur <em>Activer</em><br>
          <strong>Etape 3 :</strong> Choisir la methode de recuperation (compte iCloud ou cle locale)<br><br>
          <span style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            ‚ö†Ô∏è <strong>Attention :</strong> La cle de recuperation est VITALE. Sans elle, les donnees sont perdues definitivement. La stocker hors du poste (coffre-fort numerique ou impression papier en lieu sur).
          </span>
        </div>
      </div>

      <!-- Niveau 2 -->
      <div style="background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--info); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 2</span>
          <strong style="color: var(--info);">Cahier des charges prestataire ‚Äî Specifications a exiger</strong>
        </div>
        <div class="script-box" style="margin-top: 0;">
          <div class="script-header">
            <span class="script-title">Specifications techniques chiffrement ‚Äî a transmettre au prestataire</span>
            <button class="script-copy" onclick="copyScript(this)">Copier</button>
          </div>
          <div class="script-code"><span class="script-comment"># CAHIER DES CHARGES ‚Äî CHIFFREMENT DES POSTES ET SUPPORTS</span>

<span class="script-keyword">PERIMETRE :</span>
- Chiffrer 100 % des disques durs (postes fixes, portables, disques externes)
- Algorithme minimum : AES-256 (BitLocker XTS-AES 256 ou FileVault 2)
- Cles USB utilisees pour le cabinet : chiffrement materiel ou logiciel obligatoire

<span class="script-keyword">GESTION DES CLES :</span>
- Centraliser les cles de recuperation dans un coffre-fort numerique securise
  <span class="script-comment"># Exemple : Azure AD (Entra ID) pour Microsoft, Jamf pour Apple</span>
- Inventorier chaque poste avec son identifiant de cle
- Tester la restauration d'une cle au moins une fois par an

<span class="script-keyword">CAS PARTICULIER ‚Äî CABINET 100 % SaaS :</span>
- Les donnees metier sont dans le cloud (logiciel comptable, GED)
- Le poste local contient neanmoins : cache navigateur, fichiers temporaires,
  exports Excel, mots de passe memorises ‚Üí le chiffrement reste OBLIGATOIRE

<span class="script-keyword">LIVRABLES ATTENDUS DU PRESTATAIRE :</span>
1. Inventaire des postes avec statut de chiffrement (modele, n¬∞ serie, methode)
2. Registre des cles de recuperation (localisation, derniere verification)
3. Procedure de remplacement de poste (reinstallation + rechiffrement)

<span class="script-comment"># Reference : ANSSI, Guide d'hygiene informatique, mesure n¬∞20</span>
<span class="script-comment"># Reference : RGPD, art. 32 ‚Äî mesures techniques appropriees</span>
<span class="script-comment"># Reference : CNIL, Guide securite des donnees personnelles, fiche 12</span></div>
        </div>
      </div>

      <!-- Niveau 3 -->
      <div style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 10px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--accent); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 3</span>
          <strong style="color: var(--warning);">Verification ‚Äî Comment l'EC controle</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Windows :</strong> Ouvrir le menu Demarrer ‚Üí taper <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">BitLocker</code> ‚Üí ¬´ Gerer BitLocker ¬ª. Le statut doit afficher <em>¬´ Le chiffrement BitLocker est active ¬ª</em> avec une icone de cadenas.<br>
          <strong>macOS :</strong> <em>Reglages Systeme</em> ‚Üí <em>Confidentialite et securite</em> ‚Üí <em>FileVault</em> ‚Üí Le statut doit afficher <em>¬´ FileVault est active ¬ª</em>.<br>
          <strong>Cle USB :</strong> Brancher une cle non chiffree et tenter d'y copier un fichier. Si la politique de securite bloque la copie ‚Üí la protection est active.<br><br>
          <span style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            üìã <strong>Preuve a archiver :</strong> Capture ecran du statut BitLocker/FileVault par poste + inventaire des cles de recuperation. A mettre a jour a chaque changement de materiel.
          </span>
        </div>
      </div>

      <!-- ===== PROCEDURE 3 : SPF/DKIM/DMARC ===== -->
      <div class="category-title">üìß Procedure n¬∞3 ‚Äî Proteger la messagerie contre l'usurpation (SPF/DKIM/DMARC)</div>

      <div style="background: #fef2f2; border-left: 4px solid var(--danger); padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 16px; font-size: 13px;">
        <strong>Pourquoi c'est critique :</strong> Le phishing reste le vecteur d'attaque n¬∞1 (68 % des violations, Verizon DBIR 2024). Sans SPF/DKIM/DMARC, un attaquant peut envoyer des emails en se faisant passer pour le cabinet. Un faux email ¬´ cabinet@votredomaine.fr ¬ª demandant un virement = perte financiere directe pour le client et responsabilite de l'EC.
      </div>

      <!-- Niveau 1 -->
      <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--success); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 1</span>
          <strong style="color: var(--success);">Methode directe ‚Äî Ce que l'EC peut verifier seul (‚âà 5 min)</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Comprendre en 30 secondes :</strong><br>
          &nbsp;&nbsp;‚Ä¢ <strong>SPF</strong> = ¬´ Seuls ces serveurs ont le droit d'envoyer des emails au nom de mon domaine ¬ª<br>
          &nbsp;&nbsp;‚Ä¢ <strong>DKIM</strong> = ¬´ Chaque email envoye porte une signature numerique infalsifiable ¬ª<br>
          &nbsp;&nbsp;‚Ä¢ <strong>DMARC</strong> = ¬´ Si un email echoue aux deux tests ci-dessus, le rejeter ou le mettre en spam ¬ª<br><br>
          <strong>Verification immediate :</strong> Se rendre sur <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">mxtoolbox.com/SuperTool</code> ‚Üí saisir le nom de domaine du cabinet ‚Üí verifier que SPF, DKIM et DMARC sont tous les trois au vert.<br><br>
          <span style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            ‚ö†Ô∏è <strong>Important :</strong> La configuration SPF/DKIM/DMARC ne se fait pas dans le logiciel de messagerie. Elle se fait chez l'hebergeur du nom de domaine (OVH, Gandi, Ionos, etc.), dans la zone DNS. Sauf competence technique, il est recommande de deleguer cette operation.
          </span>
        </div>
      </div>

      <!-- Niveau 2 -->
      <div style="background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--info); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 2</span>
          <strong style="color: var(--info);">Cahier des charges prestataire ‚Äî Enregistrements DNS a configurer</strong>
        </div>
        <div class="script-box" style="margin-top: 0;">
          <div class="script-header">
            <span class="script-title">Enregistrements DNS ‚Äî a transmettre au prestataire ou a l'hebergeur</span>
            <button class="script-copy" onclick="copyScript(this)">Copier</button>
          </div>
          <div class="script-code"><span class="script-comment"># ENREGISTREMENTS DNS A CREER POUR LE DOMAINE DU CABINET</span>
<span class="script-comment"># A configurer chez l'hebergeur DNS (OVH, Gandi, Ionos, Cloudflare...)</span>

<span class="script-keyword">1. SPF (Sender Policy Framework)</span>
Type : TXT
Nom  : @  <span class="script-comment">(racine du domaine)</span>
Valeur :

  <span class="script-comment"># Si Microsoft 365 :</span>
  <span class="script-string">"v=spf1 include:spf.protection.outlook.com -all"</span>

  <span class="script-comment"># Si Google Workspace :</span>
  <span class="script-string">"v=spf1 include:_spf.google.com -all"</span>

  <span class="script-comment"># Le "-all" (hard fail) est recommande : tout serveur non autorise est rejete.</span>
  <span class="script-comment"># Ne PAS combiner deux includes si un seul fournisseur est utilise.</span>

<span class="script-keyword">2. DKIM (DomainKeys Identified Mail)</span>
  <span class="script-comment"># DKIM est genere AUTOMATIQUEMENT par votre fournisseur email.</span>
  <span class="script-comment"># Microsoft 365 : Centre d'admin Exchange ‚Üí Protection ‚Üí DKIM ‚Üí Activer</span>
  <span class="script-comment"># Google Workspace : admin.google.com ‚Üí Applications ‚Üí Gmail ‚Üí Authentifier</span>
  <span class="script-comment"># L'hebergeur DNS doit creer les enregistrements CNAME fournis par le fournisseur.</span>

<span class="script-keyword">3. DMARC (Domain-based Message Authentication)</span>
Type : TXT
Nom  : _dmarc
Valeur :

  <span class="script-comment"># Mise en place progressive recommandee :</span>

  <span class="script-comment"># ETAPE 1 (semaine 1-4) : mode surveillance uniquement</span>
  <span class="script-string">"v=DMARC1; p=none; rua=mailto:dmarc@votredomaine.fr; pct=100"</span>

  <span class="script-comment"># ETAPE 2 (mois 2-3) : quarantaine (spam) pour les echecs</span>
  <span class="script-string">"v=DMARC1; p=quarantine; rua=mailto:dmarc@votredomaine.fr; pct=100"</span>

  <span class="script-comment"># ETAPE 3 (a partir du mois 4) : rejet des emails frauduleux</span>
  <span class="script-string">"v=DMARC1; p=reject; rua=mailto:dmarc@votredomaine.fr; pct=100"</span>

<span class="script-keyword">LIVRABLES ATTENDUS DU PRESTATAIRE :</span>
1. Capture ecran des enregistrements DNS crees (SPF + DKIM + DMARC)
2. Test de verification via mxtoolbox.com (rapport au format PDF)
3. Calendrier de passage progressif none ‚Üí quarantine ‚Üí reject
4. Rapport DMARC mensuel (emails rejetes, anomalies)

<span class="script-comment"># Reference : ANSSI, Guide d'hygiene informatique, mesure n¬∞23</span>
<span class="script-comment"># Outil de verification gratuit : mxtoolbox.com/SuperTool</span></div>
        </div>
      </div>

      <!-- Niveau 3 -->
      <div style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 10px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--accent); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 3</span>
          <strong style="color: var(--warning);">Verification ‚Äî Comment l'EC controle (2 min)</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Test rapide :</strong> Aller sur <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">mxtoolbox.com/SuperTool</code>, saisir le nom de domaine du cabinet, et verifier :<br>
          &nbsp;&nbsp;‚Ä¢ <strong>SPF :</strong> Resultat vert + mention du fournisseur email (outlook.com ou google.com)<br>
          &nbsp;&nbsp;‚Ä¢ <strong>DKIM :</strong> Resultat vert (cle publique trouvee)<br>
          &nbsp;&nbsp;‚Ä¢ <strong>DMARC :</strong> Resultat vert + politique ¬´ quarantine ¬ª ou ¬´ reject ¬ª<br><br>
          <strong>Test supplementaire :</strong> S'envoyer un email a soi-meme et consulter l'en-tete du message (dans Gmail : menu ‚ãÆ ‚Üí Afficher l'original / dans Outlook : Proprietes du message). Les mentions <em>spf=pass</em>, <em>dkim=pass</em>, <em>dmarc=pass</em> doivent apparaitre.<br><br>
          <span style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            üìã <strong>Preuve a archiver :</strong> Rapport PDF de mxtoolbox.com + capture d'en-tete d'email montrant les trois ¬´ pass ¬ª. Frequence : a chaque modification DNS ou changement de fournisseur email.
          </span>
        </div>
      </div>

      <!-- ===== PROCEDURE 4 : TEST DE RESTAURATION ===== -->
      <div class="category-title">üîÑ Procedure n¬∞4 ‚Äî Tester la restauration des sauvegardes</div>

      <div style="background: #fef2f2; border-left: 4px solid var(--danger); padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 16px; font-size: 13px;">
        <strong>Pourquoi c'est critique :</strong> Une sauvegarde non testee n'est pas une sauvegarde. L'incident COAXIS de d√©cembre 2023 ‚Äî un hebergeur de donnees comptables paralyse par un rancongiciel ‚Äî a laisse de nombreux cabinets sans acces a leur production pendant plusieurs semaines. Sans test de restauration, le RTO (temps de reprise) est inconnu et le PCA inoperant.
      </div>

      <!-- Niveau 1 -->
      <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--success); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 1</span>
          <strong style="color: var(--success);">Methode directe ‚Äî L'EC teste lui-meme (‚âà 30 min/mois)</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Frequence :</strong> Le premier lundi de chaque mois. Inscrire un rappel recurrent dans l'agenda du cabinet.<br><br>
          <strong>Etape 1 ‚Äî Choisir un dossier test :</strong> Selectionner un dossier client non critique (par exemple un dossier de demonstration ou un ancien dossier archive).<br>
          <strong>Etape 2 ‚Äî Lancer la restauration :</strong> Depuis l'outil de sauvegarde (Synology, Veeam, BackBlaze, ou espace cloud), restaurer le dossier selectionne dans un repertoire temporaire isole.<br>
          <strong>Etape 3 ‚Äî Verifier l'integrite :</strong> Ouvrir au moins 5 fichiers restaures (balances, FEC, bulletins de paie). Comparer avec les originaux : dates, montants, mise en page.<br>
          <strong>Etape 4 ‚Äî Mesurer le temps :</strong> Noter l'heure de debut et de fin. Le temps obtenu est le RTO reel du cabinet ‚Äî celui sur lequel fonder le PCA.<br>
          <strong>Etape 5 ‚Äî Documenter :</strong> Remplir le PV de test ci-dessous.
        </div>
      </div>

      <!-- PV de test -->
      <div class="script-box" style="margin-bottom: 12px;">
        <div class="script-header">
          <span class="script-title">Modele de PV de test de restauration ‚Äî a remplir chaque mois</span>
          <button class="script-copy" onclick="copyScript(this)">Copier</button>
        </div>
        <div class="script-code"><span class="script-comment">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
<span class="script-keyword">     PROCES-VERBAL DE TEST DE RESTAURATION</span>
<span class="script-comment">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>

Date du test         : ____/____/________
Responsable du test  : _______________________________
N¬∞ du test (annuel)  : ____

<span class="script-keyword">SAUVEGARDE TESTEE</span>
Type de sauvegarde   : [ ] Cloud  [ ] NAS  [ ] Disque externe
Date de la sauvegarde: ____/____/________
Outil utilise        : _______________________________

<span class="script-keyword">DOSSIER RESTAURE</span>
Nom du dossier       : _______________________________
Volume (nb fichiers) : ____
Repertoire cible     : _______________________________

<span class="script-keyword">RESULTATS</span>
Heure de debut       : ____:____
Heure de fin         : ____:____
<span class="script-string">RTO mesure            : ____ minutes</span>

Fichiers verifies (min. 5) :
  1. __________________________ [ ] OK  [ ] KO
  2. __________________________ [ ] OK  [ ] KO
  3. __________________________ [ ] OK  [ ] KO
  4. __________________________ [ ] OK  [ ] KO
  5. __________________________ [ ] OK  [ ] KO

Integrite globale    : [ ] CONFORME  [ ] NON CONFORME

<span class="script-keyword">ANOMALIES CONSTATEES</span>
_______________________________________________________________
_______________________________________________________________

<span class="script-keyword">ACTIONS CORRECTIVES</span>
_______________________________________________________________
_______________________________________________________________

<span class="script-keyword">VALIDATION</span>
Resultat final       : [ ] REUSSI  [ ] ECHOUE
Signature            : _______________________________

<span class="script-comment"># Ce PV est un element de preuve au titre de la NPMQ (¬ß17)</span>
<span class="script-comment"># et du RGPD (art. 32 ‚Äî capacite a retablir la disponibilite)</span>
<span class="script-comment"># A archiver dans : Gouvernance SI / Tests restauration / AAAA-MM</span></div>
      </div>

      <!-- Niveau 3 -->
      <div style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 10px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--accent); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 3</span>
          <strong style="color: var(--warning);">Verification ‚Äî Signaux d'alerte</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Resultats attendus :</strong> 100 % des fichiers ouverts et lisibles, RTO inferieur a 4 heures, aucun fichier corrompu.<br>
          <strong>Signaux d'alerte :</strong><br>
          &nbsp;&nbsp;‚Ä¢ Un fichier ne s'ouvre pas ou affiche des caracteres illisibles ‚Üí sauvegarde potentiellement corrompue<br>
          &nbsp;&nbsp;‚Ä¢ Le RTO depasse 8 heures ‚Üí revoir la strategie de sauvegarde (proximite du stockage, bande passante)<br>
          &nbsp;&nbsp;‚Ä¢ Les metadonnees sont incoherentes (dates modifiees, droits perdus) ‚Üí probleme de format d'export<br>
          &nbsp;&nbsp;‚Ä¢ La sauvegarde la plus recente date de plus de 7 jours ‚Üí verifier l'automatisation<br><br>
          <span style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            üìã <strong>Preuve a archiver :</strong> PV de test date et signe + registre annuel des tests (minimum 12 tests/an). Ce registre constitue un element de conformite NPMQ ¬ß17 et RGPD art. 32.
          </span>
        </div>
      </div>

      <!-- ===== PROCEDURE 5 : REVUE DES DROITS ===== -->
      <div class="category-title">üë• Procedure n¬∞5 ‚Äî Revue trimestrielle des droits d'acces</div>

      <div style="background: #fef2f2; border-left: 4px solid var(--danger); padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 16px; font-size: 13px;">
        <strong>Pourquoi c'est critique :</strong> Le principe du moindre privilege impose que chaque collaborateur n'accede qu'aux ressources strictement necessaires a ses fonctions (ANSSI, mesure n¬∞30). Un stagiaire ne doit pas avoir acces aux dossiers de tous les clients. Un collaborateur parti depuis deux mois ne doit plus avoir aucun acces.
      </div>

      <!-- Niveau 1 -->
      <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 10px; padding: 20px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--success); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 1</span>
          <strong style="color: var(--success);">Methode directe ‚Äî L'EC fait lui-meme (‚âà 20 min/trimestre)</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          <strong>Frequence :</strong> Chaque debut de trimestre (janvier, avril, juillet, octobre).<br><br>
          <strong>Etape 1 :</strong> Lister tous les collaborateurs actuels du cabinet (y compris stagiaires, interimaires, prestataires).<br>
          <strong>Etape 2 :</strong> Pour chaque outil (logiciel comptable, GED, messagerie, portail client), verifier la liste des comptes actifs.<br>
          <strong>Etape 3 :</strong> Supprimer ou desactiver tout compte correspondant a une personne qui n'est plus dans le cabinet.<br>
          <strong>Etape 4 :</strong> Verifier que chaque collaborateur a le niveau d'acces adapte a son role actuel (pas plus, pas moins).<br>
          <strong>Etape 5 :</strong> Documenter dans le registre des habilitations (tableau ci-dessous).
        </div>
      </div>

      <!-- Registre des habilitations -->
      <div class="script-box" style="margin-bottom: 12px;">
        <div class="script-header">
          <span class="script-title">Modele de registre des habilitations ‚Äî a tenir a jour en continu</span>
          <button class="script-copy" onclick="copyScript(this)">Copier</button>
        </div>
        <div class="script-code"><span class="script-comment">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
<span class="script-keyword">                    REGISTRE DES HABILITATIONS SI</span>
<span class="script-comment">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</span>
Date de la revue : ____/____/________
Responsable      : _______________________________

<span class="script-keyword">COLLABORATEUR   | ROLE        | EMAIL 365/GW | LOGICIEL   | GED    | PORTAIL | OBSERVATIONS</span>
<span class="script-comment">----------------|-------------|--------------|------------|--------|---------|-------------</span>
________________| ___________| [ ] Actif     | [ ] Admin  | [ ] RW | [ ] Oui | ____________
                |            | [ ] MFA actif | [ ] Collab | [ ] RO | [ ] Non |
<span class="script-comment">----------------|-------------|--------------|------------|--------|---------|-------------</span>
________________| ___________| [ ] Actif     | [ ] Admin  | [ ] RW | [ ] Oui | ____________
                |            | [ ] MFA actif | [ ] Collab | [ ] RO | [ ] Non |
<span class="script-comment">----------------|-------------|--------------|------------|--------|---------|-------------</span>
________________| ___________| [ ] Actif     | [ ] Admin  | [ ] RW | [ ] Oui | ____________
                |            | [ ] MFA actif | [ ] Collab | [ ] RO | [ ] Non |

<span class="script-keyword">COMPTES A DESACTIVER (collaborateurs partis) :</span>
Nom : ___________________ Date depart : ____/____/____  Comptes supprimes le : ____/____/____
Nom : ___________________ Date depart : ____/____/____  Comptes supprimes le : ____/____/____

<span class="script-keyword">ANOMALIES CONSTATEES :</span>
_______________________________________________________________

<span class="script-keyword">VALIDATION</span>
Signature : _______________________________

<span class="script-comment"># Reference : ANSSI, Guide d'hygiene informatique, mesures n¬∞29-32</span>
<span class="script-comment"># Reference : NPMQ ¬ß15 ‚Äî conformite du personnel</span>
<span class="script-comment"># Reference : Code de deontologie, art. 148 ‚Äî secret professionnel</span></div>
      </div>

      <!-- Niveau 3 -->
      <div style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 10px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <span style="background: var(--accent); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700;">NIVEAU 3</span>
          <strong style="color: var(--warning);">Verification ‚Äî Questions a se poser</strong>
        </div>
        <div style="font-size: 13px; line-height: 1.8; color: var(--gray-700);">
          &nbsp;&nbsp;‚Ä¢ Y a-t-il un compte actif pour une personne qui n'est plus dans le cabinet ? ‚Üí <strong>Risque critique</strong><br>
          &nbsp;&nbsp;‚Ä¢ Un stagiaire a-t-il un acces administrateur ? ‚Üí Reduire au niveau ¬´ collaborateur ¬ª<br>
          &nbsp;&nbsp;‚Ä¢ Existe-t-il des comptes partages (type ¬´ accueil@ ¬ª ou ¬´ compta@ ¬ª) ? ‚Üí Les supprimer et creer des comptes nominatifs<br>
          &nbsp;&nbsp;‚Ä¢ Le MFA est-il actif sur 100 % des comptes ? ‚Üí Sinon, revenir a la Procedure n¬∞1<br><br>
          <span style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">
            üìã <strong>Preuve a archiver :</strong> Registre des habilitations date et signe a chaque revue trimestrielle. Conserver les versions anterieures pour tracer l'historique.
          </span>
        </div>
      </div>

      <!-- ===== SYNTHESE ===== -->
      <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: var(--radius); padding: 24px; color: white; margin-top: 8px;">
        <h3 style="margin-bottom: 16px; font-size: 16px;">üìÖ Calendrier recapitulatif des procedures SI</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
          <div style="background: rgba(255,255,255,0.12); border-radius: 10px; padding: 14px;">
            <div style="font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Ponctuel (installation)</div>
            <div style="font-size: 14px; font-weight: 700;">MFA + Chiffrement + SPF/DKIM/DMARC</div>
            <div style="font-size: 11px; opacity: 0.8; margin-top: 6px;">A realiser AVANT le demarrage de l'activite (J-60, cf. onglet Calendrier)</div>
          </div>
          <div style="background: rgba(255,255,255,0.12); border-radius: 10px; padding: 14px;">
            <div style="font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Mensuel</div>
            <div style="font-size: 14px; font-weight: 700;">Test de restauration + PV</div>
            <div style="font-size: 11px; opacity: 0.8; margin-top: 6px;">1er lundi de chaque mois ‚Äî 30 min</div>
          </div>
          <div style="background: rgba(255,255,255,0.12); border-radius: 10px; padding: 14px;">
            <div style="font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Trimestriel</div>
            <div style="font-size: 14px; font-weight: 700;">Revue des droits d'acces</div>
            <div style="font-size: 11px; opacity: 0.8; margin-top: 6px;">Debut de trimestre ‚Äî 20 min</div>
          </div>
          <div style="background: rgba(255,255,255,0.12); border-radius: 10px; padding: 14px;">
            <div style="font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">A chaque evenement</div>
            <div style="font-size: 14px; font-weight: 700;">Onboarding / Offboarding</div>
            <div style="font-size: 11px; opacity: 0.8; margin-top: 6px;">Arrivee ou depart d'un collaborateur ‚Äî immediat</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ==================== PANEL 8: REFERENCES ==================== -->
  <div id="references" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üìö</div>
        <div>
          <h3>References et sources</h3>
          <div class="subtitle">Textes officiels, normes et bonnes pratiques 2025-2026</div>
        </div>
      </div>

      <div class="category-title">üìú Textes reglementaires</div>
      <ul style="margin-left: 24px; color: var(--gray-700); margin-bottom: 20px; line-height: 1.8;">
        <li><strong>RGPD</strong> - Reglement (UE) 2016/679 - Protection des donnees personnelles</li>
        <li><strong>Directive NIS2</strong> - (UE) 2022/2555 - Transposition en cours (projet de loi adopte par le Senat, mars 2025)</li>
        <li><strong>Loi n¬∞ 2023-1322 (art. 91)</strong> + decret n¬∞ 2024-266 - Calendrier facturation electronique</li>
        <li><strong>Code de deontologie EC</strong> - Decret n¬∞2012-432, ed. janv. 2026 - Art. 147 (secret professionnel), art. 148 (qualifications collaborateurs), art. 150 (examen periodique des missions)</li>
        <li><strong>Ordonnance n¬∞45-2138</strong> du 19 sept. 1945 - Art. 17 (assurance RCP obligatoire), art. 21 (secret professionnel)</li>
        <li><strong>NPMQ 2025</strong> - ¬ß15 (conformite deontologique du personnel), ¬ß24 (ressources technologiques), ¬ß28 (confidentialite et documentation des dossiers)</li>
        <li><strong>AI Act</strong> - Reglement (UE) 2024/1689 - Art. 4 : obligation de maitrise de l'IA (applicable depuis le 2 fevrier 2025)</li>
        <li><strong>eIDAS 2.0</strong> - Reglement (UE) 2024/1183 - Trois niveaux de signature electronique (SES, AES, QES), en vigueur depuis le 20 mai 2024</li>
      </ul>

      <div class="category-title">üìä Sources statistiques</div>
      <ul style="margin-left: 24px; color: var(--gray-700); margin-bottom: 20px; line-height: 1.8;">
        <li><strong>CESIN, 10e Barometre (janv. 2025)</strong> - 47% des entreprises ont subi une cyberattaque significative en 2024</li>
        <li><strong>ANSSI / Rapport Cour des Comptes 2025</strong> - Cout moyen ransomware PME : 466 000 EUR</li>
        <li><strong>Verizon, DBIR 2024</strong> - 68% des violations impliquent le facteur humain (hors insiders malveillants)</li>
        <li><strong>CNIL, Bilan d'activite 2024</strong> - 5 629 violations notifiees (+20% vs 2023), 87 sanctions</li>
        <li><strong>Cybermalveillance.gouv.fr, Rapport 2024</strong> - Les TPE/PME representent la majorite des victimes</li>
        <li><strong>Dext, Cartographie logiciels comptables 2025-2026</strong> - 232 logiciels recenses en 13 categories fonctionnelles</li>
      </ul>

      <div class="category-title">üîó Ressources officielles</div>
      <div class="grid">
        <div class="insight-box">
          <strong>ANSSI</strong><br>
          <a href="https://www.ssi.gouv.fr" target="_blank" style="color: var(--info);">Guide d'hygiene informatique</a><br>
          <span style="font-size: 11px; color: var(--gray-600);">42 mesures de securite essentielles</span>
        </div>
        <div class="insight-box">
          <strong>CNIL</strong><br>
          <a href="https://www.cnil.fr" target="_blank" style="color: var(--info);">Guide RGPD pour les PME</a><br>
          <span style="font-size: 11px; color: var(--gray-600);">Registre, DPA, violations</span>
        </div>
        <div class="insight-box warning">
          <strong>Facturation electronique</strong><br>
          <a href="https://www.impots.gouv.fr/professionnel" target="_blank" style="color: var(--info);">Portail DGFIP</a><br>
          <span style="font-size: 11px; color: var(--gray-600);">Calendrier et PA immatriculees (ex-PDP)</span>
        </div>
      </div>

      <div class="category-title" style="margin-top: 24px;">üìê Normes et referentiels</div>
      <ul style="margin-left: 24px; color: var(--gray-700); margin-bottom: 20px; line-height: 1.8;">
        <li><strong>NPMQ 2025</strong> - Norme Professionnelle de Management de la Qualite (arrete 30 mai 2024, applicable 1er janv. 2025)</li>
        <li><strong>ISO 27001:2022</strong> - Management de la securite de l'information</li>
        <li><strong>ISO 27701</strong> - Extension vie privee (RGPD)</li>
        <li><strong>Regle 3-2-1-1-0</strong> - 3 copies, 2 supports, 1 hors site, 1 immuable, 0 erreur</li>
        <li><strong>Principe du moindre privilege</strong> - Acces limite au strict necessaire</li>
        <li><strong>ANSSI, Guide d'hygiene informatique</strong> - 42 mesures essentielles (v. 2.0)</li>
      </ul>

      <div class="disclaimer">
        <div class="disclaimer-icon">‚ö†Ô∏è</div>
        <div>
          <strong>Clause de non-exhaustivite :</strong> Outil d'orientation. <strong>Verifiez les textes officiels</strong> et adaptez les recommandations a votre contexte.
          <br><br>
          <strong>Source : Candidat </strong> - Document de travail
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Information</div>
      <button class="modal-close" onclick="closeModal()">Fermer</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const STORAGE_KEY = "annexe6_si_v3";

// Base de donnees des fiches techniques
const fiches = [
  // SECURITE
  {
    id: "mfa", nom: "MFA / SSO - Authentification multi-facteurs", categorie: "securite", tags: ["obligatoire", "critique"],
    keywords: "mfa 2fa sso authentification double facteur mot passe identite acces",
    description: "L'authentification multi-facteurs (MFA) exige au moins 2 preuves d'identite. Bloque plus de 99,9% des attaques par vol de mot de passe (source : Microsoft, 2019).",
    pourquoi: "Meme si un mot de passe est vole (phishing), l'attaquant est bloque sans le 2e facteur. Exigence NPMQ ¬ß24 (ressources technologiques appropriees) et guide ANSSI (42 mesures essentielles).",
    solutions: ["Microsoft Authenticator", "Google Authenticator", "Duo Security", "YubiKey", "SSO : Microsoft Entra ID, Okta"],
    actions: ["Activer MFA sur TOUS les comptes", "Interdire les comptes partages", "Utiliser un gestionnaire de mots de passe", "Revue trimestrielle des droits"],
    preuve: "Export MFA active + registre des habilitations + procedure onboarding/offboarding",
    risqueAssocie: "Acces non autorise, vol d'identifiants, phishing",
    cout: "Gratuit a 50 EUR/utilisateur/an",
    roiGain: "Blocage de plus de 99,9% des attaques par credential stuffing (Microsoft, 2019)",
    liens: [{ label: "Guide ANSSI MFA", url: "https://www.ssi.gouv.fr" }]
  },
  {
    id: "edr", nom: "EDR / Antivirus - Protection des postes", categorie: "securite", tags: ["obligatoire", "critique"],
    keywords: "edr antivirus endpoint detection response malware ransomware",
    description: "L'EDR surveille en continu les postes pour detecter et bloquer les menaces avancees (ransomware, malware zero-day).",
    pourquoi: "L'antivirus classique ne suffit plus. L'EDR detecte les comportements suspects.",
    solutions: ["Microsoft Defender for Endpoint", "CrowdStrike Falcon", "SentinelOne", "Sophos Intercept X"],
    actions: ["Deployer EDR sur TOUS les postes", "Configurer les alertes", "Surveiller la console", "Mettre a jour"],
    preuve: "Console EDR avec liste des postes + rapport d'activite",
    risqueAssocie: "Ransomware, malware, vol de donnees",
    cout: "20 a 80 EUR/poste/an",
    roiGain: "Evitement ransomware (cout moyen PME : 466 000 EUR, ANSSI / Cour des Comptes 2025)",
    liens: []
  },
  {
    id: "chiffrement", nom: "Chiffrement des postes - BitLocker / FileVault", categorie: "securite", tags: ["obligatoire"],
    keywords: "chiffrement bitlocker filevault disque donnees vol",
    description: "Le chiffrement rend les donnees illisibles sans la cle. Protege en cas de vol ou perte.",
    pourquoi: "Un PC vole non chiffre = toutes les donnees clients accessibles.",
    solutions: ["BitLocker (Windows Pro)", "FileVault (Mac)", "VeraCrypt"],
    actions: ["Activer BitLocker/FileVault sur tous les postes", "Sauvegarder les cles", "Verifier via MDM"],
    preuve: "Capture statut chiffrement + cles de recuperation",
    risqueAssocie: "Vol de materiel, perte de PC",
    cout: "Gratuit (inclus dans OS)",
    roiGain: "Protection donnees en cas de vol",
    liens: []
  },
  {
    id: "cloud", nom: "Cloud / GED SaaS - Stockage centralise", categorie: "stockage", tags: ["recommande"],
    keywords: "cloud ged saas stockage sharepoint onedrive google drive",
    description: "Stockage centralise en cloud avec gestion des droits, versioning et synchronisation. Secret professionnel (art. 21, ordonnance 1945 ; art. 147, code de deontologie). Documentation obligatoire (NPMQ, ¬ß28).",
    pourquoi: "Centraliser evite la dispersion. Le cloud offre disponibilite et securite natives.",
    solutions: ["Microsoft 365", "Google Workspace", "Zeendoc", "MyCompanyFiles", "Welyb"],
    actions: ["Definir arborescence standard", "Configurer droits par roles", "Activer versioning", "Interdire stockage local"],
    preuve: "Export des droits + journal d'activite + procedure nommage",
    risqueAssocie: "Dispersion, acces non maitrise, perte documents",
    cout: "10 a 30 EUR/utilisateur/mois",
    roiGain: "Gain de temps recherche documents (estimation sectorielle)",
    liens: []
  },
  {
    id: "nas", nom: "NAS chiffre - Stockage local securise", categorie: "stockage", tags: ["optionnel"],
    keywords: "nas synology qnap stockage local chiffre",
    description: "Serveur de stockage reseau local en complement du cloud (approche hybride).",
    pourquoi: "Second emplacement maitrise (archives, coffre de preuves).",
    solutions: ["Synology DS series", "QNAP", "Asustor"],
    actions: ["Activer chiffrement", "Comptes nominatifs", "Snapshots", "Acces VPN uniquement"],
    preuve: "Configuration + export comptes + politique snapshots",
    risqueAssocie: "Ransomware si expose, vol physique, panne",
    cout: "300 a 1 500 EUR + disques",
    roiGain: "Copie locale pour restauration rapide",
    liens: []
  },
  {
    id: "sauvegarde", nom: "Sauvegarde 3-2-1 + immuable", categorie: "stockage", tags: ["obligatoire", "critique"],
    keywords: "sauvegarde backup 3-2-1 immuable restauration pra",
    description: "3 copies, 2 supports, 1 hors site, + copie immuable (anti-ransomware).",
    pourquoi: "Une sauvegarde non testee n'existe pas. L'immuabilite protege du ransomware.",
    solutions: ["Veeam", "Acronis", "Synology Hyper Backup", "Backblaze B2"],
    actions: ["Sauvegarde automatique quotidienne", "Copie hors site", "Immuabilite WORM", "Test mensuel"],
    preuve: "Rapport sauvegarde + PV test restauration + RPO/RTO",
    risqueAssocie: "Ransomware, panne, catastrophe, perte donnees",
    cout: "50 a 200 EUR/mois",
    roiGain: "Evitement perte totale donnees",
    liens: []
  },
  {
    id: "compta", nom: "Logiciel comptable SaaS", categorie: "production", tags: ["obligatoire"],
    keywords: "logiciel comptable saas sage cegid pennylane quadra",
    description: "Logiciel de production comptable en SaaS pour collaboration temps reel. Marche structure : 232 logiciels recenses en 13 categories fonctionnelles (Dext, Cartographie 2025-2026).",
    pourquoi: "Le SaaS garantit disponibilite, mises a jour automatiques, collaboration.",
    solutions: ["Sage For Accountants", "Cegid Loop", "Pennylane", "ACD", "Quadratus"],
    actions: ["Choisir editeur avec MFA natif", "Configurer profils", "Former equipe", "Verifier API"],
    preuve: "Contrat editeur + configuration droits + plan formation",
    risqueAssocie: "Dependance editeur, securite, disponibilite",
    cout: "50 a 150 EUR/utilisateur/mois",
    roiGain: "Gains de productivite sur la saisie (enquete Annexe 24, Q9 : saisie/OCR = tache la plus automatisee, citee par ~65% des repondants)",
    liens: []
  },
  {
    id: "facturation", nom: "Facturation electronique ‚Äì PA (ex-PDP)", categorie: "production", tags: ["obligatoire"],
    keywords: "facturation electronique pa ex-pdp plateforme agreee choruspro reforme 2026",
    description: "Plateforme Agreee (PA, ex-PDP) pour la reforme facturation electronique.",
    pourquoi: "Obligation legale : reception sept. 2026, emission sept. 2027.",
    solutions: ["Chorus Pro (public)", "PA immatriculees (liste DGFiP, 101 plateformes au 16/01/2026)"],
    actions: ["Structurer portefeuille clients", "Etudier flux", "Former collaborateurs", "Tester PA"],
    preuve: "Cartographie flux + choix PA + plan deploiement",
    risqueAssocie: "Non-conformite, penalites, retard",
    cout: "Variable selon PA et volume",
    roiGain: "Reduction significative du temps de traitement des factures",
    liens: []
  },
  {
    id: "signature", nom: "Signature electronique", categorie: "production", tags: ["recommande"],
    keywords: "signature electronique eidas docusign yousign",
    description: "Solution de signature electronique conforme eIDAS 2.0 (Reglement UE 2024/1183). Trois niveaux : SES (simple), AES (avancee, recommandee pour lettres de mission), QES (qualifiee, valeur probante maximale).",
    pourquoi: "Gain de temps, valeur juridique, tracabilite.",
    solutions: ["DocuSign", "Yousign", "Universign", "Adobe Sign"],
    actions: ["Choisir niveau de signature", "Integrer avec GED", "Former", "Archiver preuves"],
    preuve: "Contrat editeur + procedure + exemples",
    risqueAssocie: "Contestation juridique, non-conformite eIDAS",
    cout: "20 a 50 EUR/mois",
    roiGain: "Reduction majeure des delais de signature et suppression frais postaux",
    liens: []
  },
  {
    id: "reseau", nom: "Reseau / Wi-Fi / VPN", categorie: "infra", tags: ["recommande"],
    keywords: "reseau wifi vpn pare-feu firewall segmentation",
    description: "Infrastructure reseau securisee avec segmentation et VPN.",
    pourquoi: "Un reseau mal configure est une porte d'entree pour les attaquants.",
    solutions: ["Ubiquiti", "Fortinet", "pfSense", "WireGuard", "OpenVPN"],
    actions: ["Separer reseau invites/cabinet", "Configurer pare-feu", "VPN pour acces distant", "Changer mots de passe defaut"],
    preuve: "Schema reseau + configuration pare-feu + politique VPN",
    risqueAssocie: "Intrusion, propagation laterale, interception",
    cout: "200 a 1 000 EUR (materiel)",
    roiGain: "Reduction surface d'attaque",
    liens: []
  },
  {
    id: "email", nom: "Email securise - SPF/DKIM/DMARC", categorie: "infra", tags: ["obligatoire"],
    keywords: "email phishing spf dkim dmarc anti-spam messagerie",
    description: "Configuration email avec protections anti-phishing et anti-usurpation.",
    pourquoi: "L'email est le premier vecteur de cyberattaque (phishing, usurpation, fraude au president).",
    solutions: ["Microsoft 365", "Google Workspace", "Barracuda", "Proofpoint"],
    actions: ["Configurer SPF/DKIM/DMARC", "Activer filtrage anti-phishing", "Sensibiliser", "Surveiller rapports"],
    preuve: "Capture DNS + rapport filtrage + registre formation",
    risqueAssocie: "Phishing, usurpation, fraude au president",
    cout: "Inclus dans Microsoft 365 / Google Workspace",
    roiGain: "Reduction massive des emails frauduleux (SPF/DKIM/DMARC)",
    liens: []
  },
  {
    id: "mdm", nom: "MDM - Gestion des postes", categorie: "infra", tags: ["recommande"],
    keywords: "mdm mobile device management gestion postes intune jamf",
    description: "Gestion centralisee des postes : mises a jour, politiques, effacement distant.",
    pourquoi: "Gerer les postes a distance, forcer mises a jour, effacer appareil vole.",
    solutions: ["Microsoft Intune", "Jamf (Mac)", "Mosyle", "VMware Workspace ONE"],
    actions: ["Deployer MDM", "Configurer politiques", "Activer effacement distant", "Inventorier"],
    preuve: "Console MDM avec inventaire + politiques",
    risqueAssocie: "Postes non maitrises, failles non patchees, vol",
    cout: "5 a 15 EUR/poste/mois",
    roiGain: "Centralisation et gain de temps sur la gestion du parc",
    liens: []
  },
  {
    id: "ia", nom: "IA / Automatisation", categorie: "infra", tags: ["optionnel"],
    keywords: "ia intelligence artificielle automatisation chatgpt copilot",
    description: "Utilisation de l'IA pour automatiser les taches repetitives. Obligation de maitrise (AI Act, art. 4, applicable depuis le 2 fevrier 2025) : tout utilisateur professionnel doit comprendre les capacites et limites du systeme d'IA.",
    pourquoi: "L'IA agentique (2026) peut traiter des dossiers complexes.",
    solutions: ["ChatGPT / GPT-4", "Microsoft Copilot", "IA integree (Pennylane, Dext)"],
    actions: ["Former aux prompts", "Identifier taches automatisables", "Attention confidentialite", "Usage responsable"],
    preuve: "Politique d'utilisation IA + cas d'usage",
    risqueAssocie: "Fuite donnees, biais, dependance",
    cout: "0 a 30 EUR/utilisateur/mois",
    roiGain: "Gain de rapidite ~25% et qualite ~40% sur taches adaptees (Dell'Acqua et al., Harvard, 2023)",
    liens: []
  },
  {
    id: "portail", nom: "Portail client / GED collaborative", categorie: "client", tags: ["recommande"],
    keywords: "portail client ged collaborative depot documents echange",
    description: "Plateforme d'echange securisee avec les clients.",
    pourquoi: "Standardise les echanges, evite emails non securises, trace les depots.",
    solutions: ["Welyb", "MyCompanyFiles", "Zeendoc", "Portails integres"],
    actions: ["Definir canal unique", "Former clients", "Configurer notifications", "Archiver"],
    preuve: "Procedure circulation donnee + regles depot + nommage",
    risqueAssocie: "Dispersion, perte documents, non-tracabilite",
    cout: "10 a 30 EUR/client/mois",
    roiGain: "Amelioration retention client + reduction emails non securises (enquete Annexe 24, Q5 et Q13)",
    liens: []
  },
  {
    id: "crm", nom: "CRM / Ticketing", categorie: "client", tags: ["optionnel"],
    keywords: "crm ticketing gestion relation client suivi",
    description: "Outil de gestion de la relation client et suivi des demandes.",
    pourquoi: "Ameliore le suivi et la satisfaction. Utile a partir de 5+ collaborateurs.",
    solutions: ["HubSpot CRM", "Pipedrive", "Zendesk", "Freshdesk", "Notion/Trello"],
    actions: ["Centraliser demandes", "Definir SLA", "Former equipe", "Analyser metriques"],
    preuve: "Configuration CRM + rapports activite",
    risqueAssocie: "Demandes perdues, insatisfaction",
    cout: "0 a 50 EUR/utilisateur/mois",
    roiGain: "Amelioration du suivi client et reduction des demandes perdues",
    liens: []
  },
  {
    id: "communication", nom: "Communication securisee", categorie: "client", tags: ["recommande"],
    keywords: "communication securisee messagerie chat teams slack",
    description: "Outils de communication interne et externe securises.",
    pourquoi: "Evite l'utilisation d'outils personnels non securises.",
    solutions: ["Microsoft Teams", "Slack", "Google Chat", "Zoom"],
    actions: ["Deployer outil unique", "Configurer securite", "Former", "Interdire outils perso"],
    preuve: "Politique d'utilisation + configuration",
    risqueAssocie: "Fuite donnees, shadow IT",
    cout: "Inclus dans Microsoft 365 / Google Workspace",
    roiGain: "Tracabilite echanges",
    liens: []
  },
  {
    id: "rgpd", nom: "RGPD / DPA - Protection des donnees", categorie: "conformite", tags: ["obligatoire"],
    keywords: "rgpd dpo registre traitements sous-traitant dpa cnil",
    description: "Conformite RGPD : registre, DPA, gestion des violations.",
    pourquoi: "Obligation legale. Sanctions jusqu'a 4% du CA.",
    solutions: ["Registre CNIL (gratuit)", "Dastra", "OneTrust"],
    actions: ["Tenir registre", "Signer DPA avec SaaS", "Politique conservation", "Procedure incident"],
    preuve: "Registre RGPD + DPA signes + procedure incident",
    risqueAssocie: "Sanction CNIL, reputation, responsabilite civile",
    cout: "Gratuit a 500+ EUR/mois",
    roiGain: "Evitement sanctions (jusqu'a 4% CA)",
    liens: []
  },
  {
    id: "logs", nom: "Logs / Tracabilite / Audit", categorie: "conformite", tags: ["recommande"],
    keywords: "logs tracabilite audit piste journal evenements",
    description: "Journalisation pour repondre a 'qui a fait quoi, quand'.",
    pourquoi: "Indispensable pour enquetes post-incident et audits.",
    solutions: ["Logs natifs SaaS", "SIEM : Splunk, Azure Sentinel"],
    actions: ["Activer journaux audit", "Definir retention", "Controler periodiquement", "Exporter logs critiques"],
    preuve: "Exports logs + politique retention + controles",
    risqueAssocie: "Impossibilite enqueter, non-conformite",
    cout: "Inclus dans la plupart des SaaS",
    roiGain: "Capacite investigation",
    liens: []
  },
  {
    id: "pca", nom: "PCA / PRA - Continuite et reprise", categorie: "securite", tags: ["obligatoire", "critique"],
    keywords: "pca pra continuite reprise activite rpo rto incident plan",
    description: "Plan de Continuite (PCA) et Plan de Reprise (PRA) d'activite.",
    pourquoi: "Maintenir l'activite en cas de crise (PCA) et la relancer apres (PRA).",
    solutions: ["Documentation interne", "Acronis", "Veeam"],
    actions: ["Definir RPO/RTO", "Documenter procedures", "Lister contacts", "Tester annuellement"],
    preuve: "Document PCA/PRA + PV test annuel + contacts",
    risqueAssocie: "Arret prolonge, perte clients, faillite",
    cout: "Temps documentation + tests",
    roiGain: "Survie de l'entreprise",
    liens: []
  },
  {
    id: "incident", nom: "Gestion des incidents", categorie: "securite", tags: ["recommande"],
    keywords: "incident cyberattaque reponse crise notification cnil anssi",
    description: "Procedures de detection, reponse et notification.",
    pourquoi: "Reponse rapide limite les degats. Notification CNIL sous 72h.",
    solutions: ["Procedure interne", "Contacts : ANSSI, CNIL, assureur"],
    actions: ["Rediger procedure urgence", "Identifier contacts", "Preparer message clients", "Former equipe"],
    preuve: "Procedure incident + contacts + modele communication",
    risqueAssocie: "Mauvaise gestion crise, sanctions, reputation",
    cout: "Temps documentation",
    roiGain: "Reduction impact incident",
    liens: []
  },
  {
    id: "api", nom: "API / Integrations", categorie: "infra", tags: ["recommande"],
    keywords: "api integration connecteur zapier make n8n",
    description: "Connecteurs entre outils pour eviter la ressaisie.",
    pourquoi: "Reduire les outils non connectes ameliore la productivite.",
    solutions: ["API natives", "Zapier", "Make", "n8n"],
    actions: ["Cartographier flux", "Prioriser integrations", "Documenter", "Surveiller erreurs"],
    preuve: "Cartographie flux + liste integrations",
    risqueAssocie: "Donnees en silo, ressaisie, erreurs",
    cout: "0 a 100 EUR/mois",
    roiGain: "Reduction de la ressaisie et des erreurs de transfert",
    liens: []
  }
];

// Points d'audit
const auditPoints = [
  // CRITIQUE (8)
  { id: "audit-mfa", titre: "MFA active sur tous les comptes critiques", desc: "Email, GED, logiciel comptable, banque", preuve: "Export MFA active", criticite: "critique", fiche: "mfa" },
  { id: "audit-edr", titre: "EDR/Antivirus professionnel deploye", desc: "Sur tous les postes Windows et Mac", preuve: "Console EDR avec liste postes", criticite: "critique", fiche: "edr" },
  { id: "audit-chiffrement", titre: "Chiffrement disque active", desc: "BitLocker/FileVault sur 100% des postes", preuve: "Capture statut chiffrement", criticite: "critique", fiche: "chiffrement" },
  { id: "audit-sauvegarde", titre: "Sauvegarde 3-2-1 + copie immuable", desc: "3 copies, 2 supports, 1 hors site, 1 immuable", preuve: "Configuration sauvegarde", criticite: "critique", fiche: "sauvegarde" },
  { id: "audit-test-restauration", titre: "Test de restauration effectue ce mois", desc: "Une sauvegarde non testee n'existe pas", preuve: "PV de test date", criticite: "critique", fiche: "sauvegarde" },
  { id: "audit-email", titre: "SPF/DKIM/DMARC configures", desc: "Protections anti-phishing et anti-usurpation", preuve: "Capture DNS + rapport", criticite: "critique", fiche: "email" },
  { id: "audit-rgpd", titre: "Registre RGPD a jour", desc: "Registre des traitements complet", preuve: "Export registre", criticite: "critique", fiche: "rgpd" },
  { id: "audit-pca", titre: "PCA/PRA documente", desc: "Plan avec RPO/RTO definis", preuve: "Document PCA/PRA", criticite: "critique", fiche: "pca" },
  // IMPORTANT (10)
  { id: "audit-comptes-nominatifs", titre: "Comptes nominatifs uniquement", desc: "1 compte = 1 personne", preuve: "Liste comptes", criticite: "important", fiche: "mfa" },
  { id: "audit-mdp", titre: "Gestionnaire de mots de passe", desc: "Coffre-fort pour mots de passe forts", preuve: "Capture gestionnaire", criticite: "important", fiche: "mfa" },
  { id: "audit-revue-droits", titre: "Revue des droits ce trimestre", desc: "Verification habilitations", preuve: "PV revue droits", criticite: "important", fiche: "mfa" },
  { id: "audit-mises-a-jour", titre: "Mises a jour automatiques", desc: "OS, logiciels, antivirus a jour", preuve: "Configuration MDM", criticite: "important", fiche: "mdm" },
  { id: "audit-portail", titre: "Canal unique d'echange client", desc: "Portail/GED = canal officiel", preuve: "Procedure circulation", criticite: "important", fiche: "portail" },
  { id: "audit-dpa", titre: "DPA signes avec editeurs SaaS", desc: "Contrats sous-traitance RGPD", preuve: "DPA signes", criticite: "important", fiche: "rgpd" },
  { id: "audit-logs", titre: "Logs/audit actives", desc: "GED, email, logiciel comptable", preuve: "Configuration logs", criticite: "important", fiche: "logs" },
  { id: "audit-wifi", titre: "Reseau Wi-Fi separe", desc: "Invites vs cabinet", preuve: "Configuration reseau", criticite: "important", fiche: "reseau" },
  { id: "audit-vpn", titre: "VPN pour acces distant", desc: "Ressources internes via VPN", preuve: "Configuration VPN", criticite: "important", fiche: "reseau" },
  { id: "audit-offboarding", titre: "Procedure offboarding formalisee", desc: "Suppression immediate des acces", preuve: "Procedure ecrite", criticite: "important", fiche: "mfa" },
  // STANDARD (7)
  { id: "audit-charte", titre: "Charte informatique signee", desc: "Regles d'utilisation SI", preuve: "Chartes signees", criticite: "standard", fiche: "rgpd" },
  { id: "audit-formation", titre: "Formation cybersecurite cette annee", desc: "Sensibilisation phishing", preuve: "Attestation formation", criticite: "standard", fiche: "email" },
  { id: "audit-contacts", titre: "Liste contacts incidents a jour", desc: "IT, assureur, ANSSI, Ordre", preuve: "Document contacts", criticite: "standard", fiche: "incident" },
  { id: "audit-facturation", titre: "Preparation facturation electronique", desc: "Cartographie flux, choix PA (ex-PDP)", preuve: "Document preparation", criticite: "standard", fiche: "facturation" },
  { id: "audit-archi", titre: "Architecture SI documentee", desc: "Schema outils et flux", preuve: "Schema architecture", criticite: "standard", fiche: "compta" },
  { id: "audit-cloud-droits", titre: "Droits cloud par roles", desc: "Moindre privilege", preuve: "Export droits", criticite: "standard", fiche: "cloud" },
  { id: "audit-nas-securise", titre: "NAS non expose sur Internet", desc: "VPN uniquement, chiffrement", preuve: "Configuration NAS", criticite: "standard", fiche: "nas" }
];

let auditState = {};

function initState() {
  auditPoints.forEach(p => { auditState[p.id] = false; });
}
initState();

function showPanel(panelId) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(panelId).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.remove('active');
    if (t.getAttribute('onclick') && t.getAttribute('onclick').indexOf(panelId) !== -1) {
      t.classList.add('active');
    }
  });
  if (panelId === 'fiches') renderFiches();
  if (panelId === 'audit') renderAudit();
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

function openModal(title, body) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = body;
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal(e) {
  if (e && e.target.id !== 'modalOverlay') return;
  document.getElementById('modalOverlay').classList.remove('show');
}

function getArchitCenterContent() {
  return `
    <p>Le cabinet 100% numerique repose sur une architecture pensee pour la <strong>securite</strong>, la <strong>productivite</strong> et la <strong>conformite</strong>.</p>
    <ul>
      <li><strong>Securite</strong> : MFA obligatoire, EDR, chiffrement, sauvegardes immuables</li>
      <li><strong>Stockage</strong> : Cloud/GED SaaS + sauvegarde 3-2-1</li>
      <li><strong>Production</strong> : Logiciel comptable SaaS, signature electronique, facturation electronique</li>
      <li><strong>Relation client</strong> : Portail client securise, communication maitrisee</li>
      <li><strong>Conformite</strong> : RGPD, tracabilite, PCA/PRA</li>
    </ul>
    <p style="margin-top: 16px;"><strong>Principe cle :</strong> Reduire le nombre d'outils, privilegier les integrations (API), et garantir que chaque brique soit securisee.</p>
  `;
}

function focusFiche(id) {
  showPanel('fiches');
  setTimeout(() => {
    const el = document.getElementById('fiche-' + id);
    if (el) {
      el.classList.add('highlight');
      el.classList.add('open');
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => el.classList.remove('highlight'), 3000);
    }
  }, 100);
}

function toggleFiche(id) {
  const el = document.getElementById('fiche-' + id);
  if (el) el.classList.toggle('open');
}

function copyScript(btn) {
  const codeEl = btn.parentElement.nextElementSibling;
  const text = codeEl.innerText;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copie !';
    setTimeout(() => { btn.textContent = 'Copier'; }, 2000);
  });
}

function renderAll() {
  renderRecommandationsSI();
  renderAudit();
  renderFiches();
  updateAuditScore();
}

function renderRecommandationsSI() {
  const container = document.getElementById('recommandationsSI');
  const taille = document.getElementById('tailleCabinet').value;
  const cloud = document.getElementById('niveauCloud').value;
  const priorite = document.getElementById('prioriteSI').value;
  const facture = document.getElementById('factureElec').value;
  
  let html = '';
  
  if (priorite === 'securite') {
    html += '<div class="insight-box danger"><strong>Priorite Securite detectee</strong><br>Concentrez-vous sur : 1. MFA partout 2. EDR/chiffrement 3. Sauvegardes immuables 4. Formation phishing</div>';
  }
  
  if (cloud === 'local') {
    html += '<div class="insight-box warning"><strong>Attention : approche locale</strong><br>Renforcez la securite du NAS (chiffrement, VPN, snapshots) et assurez des sauvegardes hors site.</div>';
  }
  
  if (facture === 'non') {
    html += '<div class="insight-box info"><strong>Facturation electronique : anticipez !</strong><br>Reception obligatoire en septembre 2026. Commencez a structurer vos flux et evaluez les PA (ex-PDP) immatriculees par la DGFiP (101 au 16/01/2026).</div>';
  }
  
  if (taille === 'growth') {
    html += '<div class="insight-box"><strong>Cabinet 10+ collaborateurs</strong><br>Privilegiez un MDM, une gestion centralisee des identites (SSO), et des procedures formalisees.</div>';
  }
  
  container.innerHTML = html;
}

function renderAudit() {
  const container = document.getElementById('auditContainer');
  
  const categories = [
    { id: 'critique', nom: 'Points critiques (prioritaires)', icon: 'üî¥', points: auditPoints.filter(p => p.criticite === 'critique') },
    { id: 'important', nom: 'Points importants', icon: 'üü†', points: auditPoints.filter(p => p.criticite === 'important') },
    { id: 'standard', nom: 'Points standards (bonnes pratiques)', icon: 'üü¢', points: auditPoints.filter(p => p.criticite === 'standard') }
  ];
  
  let html = '';
  categories.forEach(cat => {
    html += `<div class="audit-section">`;
    html += `<div class="audit-section-title"><span>${cat.icon}</span>${cat.nom}</div>`;
    
    cat.points.forEach(point => {
      const checked = auditState[point.id] ? 'checked' : '';
      const checkedClass = auditState[point.id] ? 'checked' : '';
      html += `
        <div class="audit-item ${checkedClass}">
          <input type="checkbox" class="audit-checkbox" ${checked} onchange="toggleAudit('${point.id}')">
          <div class="audit-item-content">
            <div class="audit-item-title">${point.titre}</div>
            <div class="audit-item-desc">${point.desc}</div>
            <div class="audit-item-proof">üìã Preuve : ${point.preuve}</div>
          </div>
          <span class="audit-item-criticite ${point.criticite}">${point.criticite.toUpperCase()}</span>
        </div>
      `;
    });
    
    html += `</div>`;
  });
  
  container.innerHTML = html;
  updateAuditScore();
}

function toggleAudit(id) {
  auditState[id] = !auditState[id];
  renderAudit();
  autoSave();
}

function updateAuditScore() {
  const total = auditPoints.length;
  const checked = Object.values(auditState).filter(v => v).length;
  const pct = Math.round((checked / total) * 100);
  
  document.getElementById('auditScoreValue').textContent = pct + '%';
  document.getElementById('auditScoreFill').style.width = pct + '%';
  
  const critiques = auditPoints.filter(p => p.criticite === 'critique');
  const importants = auditPoints.filter(p => p.criticite === 'important');
  const standards = auditPoints.filter(p => p.criticite === 'standard');
  
  const critiquesOK = critiques.filter(p => auditState[p.id]).length;
  const importantsOK = importants.filter(p => auditState[p.id]).length;
  const standardsOK = standards.filter(p => auditState[p.id]).length;
  
  document.getElementById('statCritique').querySelector('.stat-value').textContent = `${critiquesOK}/${critiques.length}`;
  document.getElementById('statImportant').querySelector('.stat-value').textContent = `${importantsOK}/${importants.length}`;
  document.getElementById('statStandard').querySelector('.stat-value').textContent = `${standardsOK}/${standards.length}`;
  
  renderActionPlan(pct, critiques, importants, standards, critiquesOK, importantsOK, standardsOK);
}

function renderActionPlan(pct, critiques, importants, standards, critiquesOK, importantsOK, standardsOK) {
  const container = document.getElementById('actionPlanContainer');
  if (!container) return;
  
  // D√©terminer le niveau de maturit√©
  let niveau, couleur, couleurBg, icone, message, conseil;
  if (critiquesOK < critiques.length) {
    niveau = 'CRITIQUE';
    couleur = '#dc2626';
    couleurBg = '#fef2f2';
    icone = 'üî¥';
    message = 'Des points critiques ne sont pas couverts. Le cabinet est expose a des risques majeurs (violation RGPD, cyberattaque, perte de donnees).';
    conseil = 'Traitez EN PRIORITE les points critiques ci-dessous avant toute autre action. Chaque point non couvert represente une faille exploitable.';
  } else if (pct < 70) {
    niveau = 'A RENFORCER';
    couleur = '#d97706';
    couleurBg = '#fffbeb';
    icone = 'üü†';
    message = 'Les points critiques sont couverts, mais la maturite globale reste insuffisante. Des failles secondaires persistent.';
    conseil = 'Concentrez-vous sur les points importants non couverts pour atteindre un niveau de securite acceptable.';
  } else if (pct < 90) {
    niveau = 'SATISFAISANT';
    couleur = '#2563eb';
    couleurBg = '#eff6ff';
    icone = 'üîµ';
    message = 'Le cabinet atteint un bon niveau de maturite. Quelques points restent a traiter pour viser l\'excellence.';
    conseil = 'Finalisez les derniers points et mettez en place la revue semestrielle pour maintenir ce niveau.';
  } else {
    niveau = 'EXCELLENT';
    couleur = '#059669';
    couleurBg = '#f0fdf4';
    icone = 'üü¢';
    message = 'Le cabinet atteint un niveau de maturite exemplaire. Maintenez cette discipline avec des revues regulieres.';
    conseil = 'Programmez votre prochain auto-audit dans 6 mois (art. 150, code de deontologie). Documentez les preuves.';
  }
  
  // Collecter les actions non faites, tri√©es par criticit√©
  const actionsCritiques = critiques.filter(p => !auditState[p.id]);
  const actionsImportantes = importants.filter(p => !auditState[p.id]);
  const actionsStandards = standards.filter(p => !auditState[p.id]);
  const totalRestant = actionsCritiques.length + actionsImportantes.length + actionsStandards.length;
  
  let html = '';
  
  // === Encadr√© diagnostic ===
  html += `<div style="background: ${couleurBg}; border: 2px solid ${couleur}30; border-radius: 12px; padding: 24px; margin-bottom: 20px;">`;
  html += `<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">`;
  html += `<span style="font-size: 28px;">${icone}</span>`;
  html += `<div>`;
  html += `<div style="font-size: 18px; font-weight: 800; color: ${couleur};">DIAGNOSTIC : ${niveau}</div>`;
  html += `<div style="font-size: 13px; color: var(--gray-600); margin-top: 2px;">Score ${pct}% ‚Äî Critiques : ${critiquesOK}/${critiques.length} | Importants : ${importantsOK}/${importants.length} | Standards : ${standardsOK}/${standards.length}</div>`;
  html += `</div></div>`;
  html += `<div style="font-size: 13px; color: var(--gray-700); line-height: 1.7; margin-bottom: 12px;">${message}</div>`;
  html += `<div style="font-size: 13px; color: var(--gray-700); line-height: 1.7; padding: 10px 14px; background: white; border-radius: 8px; border-left: 4px solid ${couleur};">`;
  html += `<strong>Recommandation :</strong> ${conseil}</div>`;
  html += `</div>`;
  
  // === Plan d'action d√©taill√© (si des actions restent) ===
  if (totalRestant > 0) {
    html += `<div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">`;
    html += `<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-200);">`;
    html += `<div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white;">üìã</div>`;
    html += `<div><h3 style="font-size: 18px; font-weight: 700; color: var(--gray-800);">Plan d'action ‚Äî ${totalRestant} point${totalRestant > 1 ? 's' : ''} a traiter</h3>`;
    html += `<div style="color: var(--gray-500); font-size: 13px;">Actions classees par ordre de priorite. Commencez par les points critiques.</div></div></div>`;
    
    function renderActionGroup(actions, label, badgeColor, priorityNum) {
      if (actions.length === 0) return '';
      let groupHtml = `<div style="margin-bottom: 20px;">`;
      groupHtml += `<div style="font-size: 13px; font-weight: 700; color: ${badgeColor}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">`;
      groupHtml += `<span style="background: ${badgeColor}; color: white; padding: 2px 10px; border-radius: 10px; font-size: 11px;">PRIORITE ${priorityNum}</span> ${label} (${actions.length})</div>`;
      
      actions.forEach(function(point, idx) {
        const ficheLink = point.fiche ? ` <span style="font-size: 11px; color: var(--info); cursor: pointer;" onclick="showPanel('fiches'); setTimeout(function(){ document.getElementById('searchFiches').value='${point.fiche}'; filterFiches(); }, 100);">‚Üí Voir fiche technique</span>` : '';
        
        groupHtml += `<div style="display: flex; gap: 12px; padding: 14px; background: var(--gray-50); border-radius: 10px; margin-bottom: 8px; border-left: 4px solid ${badgeColor};">`;
        groupHtml += `<div style="width: 28px; height: 28px; background: ${badgeColor}15; color: ${badgeColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0;">${idx + 1}</div>`;
        groupHtml += `<div style="flex: 1;">`;
        groupHtml += `<div style="font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px;">${point.titre}</div>`;
        groupHtml += `<div style="font-size: 12px; color: var(--gray-500); margin-bottom: 6px;">${point.desc}</div>`;
        groupHtml += `<div style="font-size: 11px; color: var(--info); padding: 4px 8px; background: #eff6ff; border-radius: 6px; display: inline-block;">üìã Preuve a constituer : ${point.preuve}</div>`;
        groupHtml += ficheLink;
        groupHtml += `</div></div>`;
      });
      
      groupHtml += `</div>`;
      return groupHtml;
    }
    
    html += renderActionGroup(actionsCritiques, 'Points critiques', '#dc2626', '1');
    html += renderActionGroup(actionsImportantes, 'Points importants', '#d97706', '2');
    html += renderActionGroup(actionsStandards, 'Points standards', '#2563eb', '3');
    
    // Renvoi vers onglet Guides Param√©trage
    html += `<div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 10px; padding: 16px 20px; color: white; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">`;
    html += `<div><div style="font-size: 14px; font-weight: 700;">Comment mettre en oeuvre ces actions ?</div>`;
    html += `<div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">L'onglet Guides Parametrage contient les procedures pas-a-pas (Niveau 1 : methode directe, Niveau 2 : cahier des charges prestataire, Niveau 3 : verification).</div></div>`;
    html += `<button class="btn btn-primary" style="background: white; color: var(--primary); flex-shrink: 0;" onclick="showPanel('scripts')">‚öôÔ∏è Ouvrir les Guides</button>`;
    html += `</div>`;
    
    html += `</div>`; // fin card plan d'action
  } else {
    // Tout est OK
    html += `<div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 12px; padding: 20px; text-align: center;">`;
    html += `<div style="font-size: 24px; margin-bottom: 8px;">üéâ</div>`;
    html += `<div style="font-size: 16px; font-weight: 700; color: var(--success); margin-bottom: 8px;">Tous les points de controle sont couverts</div>`;
    html += `<div style="font-size: 13px; color: var(--gray-600);">Programmez votre prochain auto-audit dans 6 mois. Exportez le rapport PDF comme preuve de conformite (NPMQ ¬ß17, RGPD art. 32).</div>`;
    html += `</div>`;
  }
  
  container.innerHTML = html;
}

function renderFiches() {
  const container = document.getElementById('fichesContainer');
  const search = (document.getElementById('searchFiches')?.value || '').toLowerCase();
  
  const categories = [
    { id: 'securite', nom: 'A. Securite', icon: 'üîí' },
    { id: 'stockage', nom: 'B. Stockage', icon: 'üíæ' },
    { id: 'production', nom: 'C. Production', icon: 'üìä' },
    { id: 'infra', nom: 'D. Infrastructure', icon: 'üåê' },
    { id: 'client', nom: 'E. Relation Client', icon: 'üë•' },
    { id: 'conformite', nom: 'F. Conformite', icon: 'üìã' }
  ];
  
  let html = '';
  categories.forEach(cat => {
    const items = fiches.filter(f => {
      if (f.categorie !== cat.id) return false;
      if (search) {
        return (f.nom + ' ' + f.keywords + ' ' + f.description).toLowerCase().includes(search);
      }
      return true;
    });
    
    if (items.length === 0) return;
    
    html += `<div class="category-section"><div class="category-title"><span>${cat.icon}</span> ${cat.nom}</div>`;
    
    items.forEach(fiche => {
      const tags = fiche.tags.map(t => {
        let cls = 'tag-optionnel';
        if (t === 'obligatoire') cls = 'tag-obligatoire';
        if (t === 'recommande') cls = 'tag-recommande';
        if (t === 'critique') cls = 'tag-critique';
        return `<span class="tag ${cls}">${t.charAt(0).toUpperCase() + t.slice(1)}</span>`;
      }).join('');
      
      const solutionsList = fiche.solutions ? fiche.solutions.map(s => `<li>${s}</li>`).join('') : '';
      const actionsList = fiche.actions ? fiche.actions.map(a => `<li>${a}</li>`).join('') : '';
      
      let liensHtml = '';
      if (fiche.liens && fiche.liens.length > 0) {
        liensHtml = `<div class="fiche-actions"><h5>Liens utiles</h5>${fiche.liens.map(l => `<div class="fiche-action-item"><span>üîó</span><a href="${l.url}" target="_blank">${l.label}</a></div>`).join('')}</div>`;
      }
      
      html += `
        <div class="fiche-card" id="fiche-${fiche.id}">
          <div class="fiche-header ${fiche.categorie}" onclick="toggleFiche('${fiche.id}')">
            <div class="fiche-title">
              <div>
                <div class="fiche-title-text">${fiche.nom}</div>
                <div class="fiche-title-sub">${fiche.description.substring(0, 80)}...</div>
              </div>
            </div>
            <div class="fiche-tags">${tags}</div>
          </div>
          <div class="fiche-body">
            <div class="fiche-grid">
              <div class="fiche-label">Description</div>
              <div class="fiche-value">${fiche.description}</div>
              
              <div class="fiche-label">Pourquoi</div>
              <div class="fiche-value">${fiche.pourquoi}</div>
              
              <div class="fiche-label">Solutions</div>
              <div class="fiche-value"><ul>${solutionsList}</ul></div>
              
              <div class="fiche-label">Actions</div>
              <div class="fiche-value"><ul>${actionsList}</ul></div>
              
              <div class="fiche-label">Preuve</div>
              <div class="fiche-value" style="background: var(--gray-50); padding: 10px; border-radius: 8px; font-weight: 600;">${fiche.preuve}</div>
              
              <div class="fiche-label">Risque associe</div>
              <div class="fiche-value">${fiche.risqueAssocie}</div>
              
              <div class="fiche-label">Cout indicatif</div>
              <div class="fiche-value">${fiche.cout}</div>
              
              <div class="fiche-label">ROI / Gain</div>
              <div class="fiche-value" style="color: var(--success); font-weight: 600;">${fiche.roiGain}</div>
            </div>
            ${liensHtml}
          </div>
        </div>
      `;
    });
    html += `</div>`;
  });
  
  container.innerHTML = html || '<p style="text-align: center; color: var(--gray-500);">Aucune fiche trouvee.</p>';
}

function filterFiches() { renderFiches(); }

function getStateObject() {
  return {
    meta: {
      savedAt: new Date().toISOString(),
      tailleCabinet: document.getElementById('tailleCabinet').value,
      niveauCloud: document.getElementById('niveauCloud').value,
      prioriteSI: document.getElementById('prioriteSI').value,
      factureElec: document.getElementById('factureElec').value
    },
    auditState
  };
}

function applyStateObject(state) {
  if (!state) return;
  document.getElementById('tailleCabinet').value = state.meta?.tailleCabinet || 'solo';
  document.getElementById('niveauCloud').value = state.meta?.niveauCloud || 'saas';
  document.getElementById('prioriteSI').value = state.meta?.prioriteSI || 'securite';
  document.getElementById('factureElec').value = state.meta?.factureElec || 'non';
  
  if (state.auditState) {
    Object.keys(state.auditState).forEach(k => { auditState[k] = state.auditState[k]; });
  }
  
  renderAll();
}

let autoSaveTimeout;
function autoSave() {
  clearTimeout(autoSaveTimeout);
  autoSaveTimeout = setTimeout(() => {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(getStateObject())); } catch (e) {}
  }, 500);
}

function resetAll() {
  if (!confirm('Reinitialiser toutes les donnees ?')) return;
  initState();
  try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
  location.reload();
}

function exportJSON() {
  const obj = getStateObject();
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'annexe6-audit-si-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Audit exporte avec succes');
}

function importJSON(event) {
  const file = event.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      applyStateObject(JSON.parse(reader.result));
      toast('Audit charge avec succes');
    } catch (e) {
      toast('Fichier invalide');
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

function exportPDF() {
  toast('Generation du PDF en cours...');
  
  setTimeout(function() {
    try {
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF('p', 'mm', 'a4');
      var pageWidth = doc.internal.pageSize.getWidth();
      var pageHeight = doc.internal.pageSize.getHeight();
      var margin = 15;
      var contentWidth = pageWidth - 2 * margin;
      var y = 0;
      var pageNum = 0;
      var totalPages = 5;

      var primaryR = 30, primaryG = 58, primaryB = 95;
      var secondaryR = 13, secondaryG = 148, secondaryB = 136;

      function cleanText(text) {
        if (!text) return '';
        return String(text)
          .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
          .replace(/[\u{2600}-\u{26FF}]/gu, '')
          .replace(/[\u{2700}-\u{27BF}]/gu, '')
          .replace(/[üèóÔ∏èüîíüìã‚ö†Ô∏èüìÖüìöüîêüõ°Ô∏èüíæ‚òÅÔ∏èüîÑüìäüìÑ‚úçÔ∏èüåêüìßüì±üö™üë•üí¨ü§ñüîóüî¥üü†üü¢üìùüö®üí°‚úÖüé£üí≥üîìüíªüî•‚ö°üåä‚öôÔ∏èüè¢]/g, '')
          .replace(/√©/g, 'e').replace(/√®/g, 'e').replace(/√™/g, 'e').replace(/√´/g, 'e')
          .replace(/√†/g, 'a').replace(/√¢/g, 'a').replace(/√§/g, 'a')
          .replace(/√π/g, 'u').replace(/√ª/g, 'u').replace(/√º/g, 'u')
          .replace(/√Æ/g, 'i').replace(/√Ø/g, 'i')
          .replace(/√¥/g, 'o').replace(/√∂/g, 'o')
          .replace(/√ß/g, 'c').replace(/√á/g, 'C')
          .replace(/√â/g, 'E').replace(/√à/g, 'E').replace(/√ä/g, 'E')
          .replace(/√Ä/g, 'A').replace(/√Ç/g, 'A')
          .replace(/['']/g, "'").replace(/[""]/g, '"')
          .replace(/‚Ä¶/g, '...').replace(/[‚Äì‚Äî]/g, '-')
          .replace(/¬∞/g, ' ')
          .trim();
      }

      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      }

      function checkPageBreak(neededSpace) {
        if (y + neededSpace > pageHeight - 25) {
          addPageFooter();
          doc.addPage();
          pageNum++;
          y = 20;
          return true;
        }
        return false;
      }

      function addPageFooter() {
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        doc.line(margin, pageHeight - 18, pageWidth - margin, pageHeight - 18);
        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.setFont('helvetica', 'normal');
        doc.text('Annexe 6 - Cartographie SI Cabinet 100% Numerique |', margin, pageHeight - 12);
        doc.text('Page ' + pageNum + ' / ' + totalPages, pageWidth - margin - 20, pageHeight - 12);
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100);
        doc.text('Source : r√©alis√© par le candidat', margin, pageHeight - 7);
      }

      function addSectionHeader(title) {
        checkPageBreak(18);
        doc.setFillColor(primaryR, primaryG, primaryB);
        doc.rect(margin, y, contentWidth, 12, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text(cleanText(title), margin + 5, y + 8);
        y += 18;
        doc.setTextColor(0, 0, 0);
      }

      function addSubHeader(title) {
        checkPageBreak(10);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(primaryR, primaryG, primaryB);
        doc.text(cleanText(title), margin, y);
        y += 6;
        doc.setTextColor(0, 0, 0);
      }

      function addParagraph(text) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(60, 60, 60);
        var lines = doc.splitTextToSize(cleanText(text), contentWidth);
        for (var i = 0; i < lines.length; i++) {
          checkPageBreak(5);
          doc.text(lines[i], margin, y);
          y += 4.5;
        }
        y += 2;
      }

      function addBullet(text) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(60, 60, 60);
        var bulletText = '- ' + cleanText(text);
        var lines = doc.splitTextToSize(bulletText, contentWidth - 5);
        for (var i = 0; i < lines.length; i++) {
          checkPageBreak(5);
          doc.text(lines[i], margin + 3, y);
          y += 4.5;
        }
      }

      function addTable(headers, rows, colWidths) {
        var tableWidth = 0;
        for (var i = 0; i < colWidths.length; i++) tableWidth += colWidths[i];
        var startX = margin;
        var rowH = 8;
        var headerH = 9;

        checkPageBreak(headerH + Math.min(rows.length, 5) * rowH + 5);

        doc.setFillColor(primaryR, primaryG, primaryB);
        doc.rect(startX, y, tableWidth, headerH, 'F');
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(255, 255, 255);
        
        var x = startX;
        for (var h = 0; h < headers.length; h++) {
          doc.text(cleanText(headers[h]), x + 3, y + 6);
          x += colWidths[h];
        }
        y += headerH;

        for (var r = 0; r < rows.length; r++) {
          checkPageBreak(rowH + 2);
          
          if (r % 2 === 0) {
            doc.setFillColor(245, 247, 250);
          } else {
            doc.setFillColor(255, 255, 255);
          }
          doc.rect(startX, y, tableWidth, rowH, 'F');
          doc.setDrawColor(220, 220, 220);
          doc.setLineWidth(0.1);
          doc.rect(startX, y, tableWidth, rowH, 'S');
          
          x = startX;
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(50, 50, 50);
          
          for (var c = 0; c < rows[r].length; c++) {
            var cellText = cleanText(String(rows[r][c]));
            var maxW = colWidths[c] - 6;
            while (doc.getTextWidth(cellText) > maxW && cellText.length > 3) {
              cellText = cellText.slice(0, -1);
            }
            doc.text(cellText, x + 3, y + 5.5);
            x += colWidths[c];
          }
          y += rowH;
        }
        y += 5;
      }

      // Recuperation des donnees
      var taille = document.getElementById('tailleCabinet')?.value || 'solo';
      var cloud = document.getElementById('niveauCloud')?.value || 'saas';
      var priorite = document.getElementById('prioriteSI')?.value || 'securite';
      
      var total = auditPoints.length;
      var checked = Object.values(auditState).filter(function(v) { return v; }).length;
      var pct = Math.round((checked / total) * 100);

      var tailleLabels = {
        'solo': 'Solo / 0-1 collaborateur',
        'small': '2-10 collaborateurs',
        'growth': '10+ collaborateurs / multi-sites'
      };

      var cloudLabels = {
        'saas': 'SaaS majoritaire (cloud-first)',
        'hybrid': 'Hybride (SaaS + NAS local)',
        'local': 'Local maitrise (NAS / serveur)'
      };

      // ==================== PAGE 1 ====================
      pageNum = 1;

      // En-tete
      doc.setFillColor(primaryR, primaryG, primaryB);
      doc.rect(0, 0, pageWidth, 45, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('ANNEXE 6', margin, 18);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text('Cartographie SI d\'un Cabinet 100% Numerique', margin, 28);
      
      doc.setFontSize(9);
      doc.text('Architecture, Securite, ROI et Plan d\'action', margin, 37);
      
      doc.setFontSize(8);
      doc.text('Genere le ' + new Date().toLocaleDateString('fr-FR'), pageWidth - margin - 35, 37);

      y = 53;

      // Encadre profil
      doc.setFillColor(245, 247, 250);
      doc.roundedRect(margin, y, contentWidth, 28, 2, 2, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.roundedRect(margin, y, contentWidth, 28, 2, 2, 'S');
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(primaryR, primaryG, primaryB);
      doc.text('PROFIL DU CABINET', margin + 5, y + 7);
      
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(60, 60, 60);
      doc.setFontSize(8);
      doc.text('Taille : ' + cleanText(tailleLabels[taille] || taille), margin + 5, y + 14);
      doc.text('Niveau cloud : ' + cleanText(cloudLabels[cloud] || cloud), margin + 5, y + 20);
      doc.text('Priorite : ' + cleanText(priorite), margin + 100, y + 14);
      doc.text('Score audit : ' + pct + '%', margin + 100, y + 20);

      y += 36;

      // Score audit
      doc.setFillColor(secondaryR, secondaryG, secondaryB);
      doc.roundedRect(margin, y, contentWidth, 20, 3, 3, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text('SCORE AUDIT SECURITE', margin + 5, y + 8);
      doc.setFontSize(16);
      doc.text(pct + ' %', pageWidth - margin - 30, y + 13);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      doc.text(checked + ' / ' + total + ' points de controle valides', margin + 5, y + 15);

      y += 28;

      addSectionHeader('1. ARCHITECTURE SI CIBLE');
      
      addSubHeader('A. Securite (Obligatoire)');
      addBullet('MFA / SSO : Authentification multi-facteurs sur tous les comptes');
      addBullet('EDR / Antivirus : Protection avancee des postes (ransomware, malware)');
      addBullet('Chiffrement : BitLocker (Windows) / FileVault (Mac) sur tous les postes');
      
      y += 2;
      
      addSubHeader('B. Stockage');
      addBullet('Cloud / GED SaaS : Stockage centralise avec gestion des droits');
      addBullet('Sauvegarde 3-2-1 + immuable : 3 copies, 2 supports, 1 hors site, 1 immuable');
      addBullet('NAS chiffre (option hybride) : Coffre local securise');
      
      y += 2;
      
      addSubHeader('C. Production');
      addBullet('Logiciel comptable SaaS : Collaboration temps reel, mises a jour auto');
      addBullet('Facturation electronique (PA, ex-PDP) : Reception obligatoire septembre 2026');
      addBullet('Signature electronique : Gain de temps, valeur juridique');

      addPageFooter();

      // ==================== PAGE 2 ====================
      doc.addPage();
      pageNum = 2;
      y = 20;

      addSectionHeader('2. RESULTAT AUTO-AUDIT SECURITE');

      var critiques = auditPoints.filter(function(p) { return p.criticite === 'critique'; });
      var importants = auditPoints.filter(function(p) { return p.criticite === 'important'; });
      var standards = auditPoints.filter(function(p) { return p.criticite === 'standard'; });
      
      var critiquesOK = critiques.filter(function(p) { return auditState[p.id]; }).length;
      var importantsOK = importants.filter(function(p) { return auditState[p.id]; }).length;
      var standardsOK = standards.filter(function(p) { return auditState[p.id]; }).length;

      addSubHeader('Points critiques (' + critiquesOK + '/' + critiques.length + ')');
      critiques.forEach(function(p) {
        var status = auditState[p.id] ? '[OK]' : '[A FAIRE]';
        addBullet(status + ' ' + p.titre);
      });
      
      y += 4;
      
      addSubHeader('Points importants (' + importantsOK + '/' + importants.length + ')');
      importants.forEach(function(p) {
        var status = auditState[p.id] ? '[OK]' : '[A FAIRE]';
        addBullet(status + ' ' + p.titre);
      });

      y += 4;

      addSubHeader('Points standards (' + standardsOK + '/' + standards.length + ')');
      standards.forEach(function(p) {
        var status = auditState[p.id] ? '[OK]' : '[A FAIRE]';
        addBullet(status + ' ' + p.titre);
      });

      addPageFooter();

      // ==================== PAGE 3 ====================
      doc.addPage();
      pageNum = 3;
      y = 20;

      addSectionHeader('3. PLAN D\'ACTION PRIORITAIRE');
      
      // Calcul dynamique des actions restantes
      var actionsCrit = critiques.filter(function(p) { return !auditState[p.id]; });
      var actionsImp = importants.filter(function(p) { return !auditState[p.id]; });
      var actionsSt = standards.filter(function(p) { return !auditState[p.id]; });
      
      var totalRestant = actionsCrit.length + actionsImp.length + actionsSt.length;
      
      if (totalRestant === 0) {
        addParagraph('Tous les points de controle sont couverts. Le cabinet atteint un niveau de maturite exemplaire. Programmez le prochain auto-audit dans 6 mois (art. 150, code de deontologie).');
      } else {
        addParagraph('Sur ' + auditPoints.length + ' points de controle, ' + totalRestant + ' restent a traiter. Les actions ci-dessous sont classees par ordre de priorite.');
        
        y += 2;
        
        if (actionsCrit.length > 0) {
          addSubHeader('PRIORITE 1 ‚Äî Points critiques (' + actionsCrit.length + ')');
          actionsCrit.forEach(function(p) {
            addBullet(p.titre + ' ‚Äî Preuve : ' + p.preuve);
          });
          y += 2;
        }
        
        if (actionsImp.length > 0) {
          addSubHeader('PRIORITE 2 ‚Äî Points importants (' + actionsImp.length + ')');
          actionsImp.forEach(function(p) {
            addBullet(p.titre + ' ‚Äî Preuve : ' + p.preuve);
          });
          y += 2;
        }
        
        if (actionsSt.length > 0) {
          addSubHeader('PRIORITE 3 ‚Äî Points standards (' + actionsSt.length + ')');
          actionsSt.forEach(function(p) {
            addBullet(p.titre + ' ‚Äî Preuve : ' + p.preuve);
          });
        }
      }
      
      y += 4;
      
      addSubHeader('Calendrier de mise en oeuvre');
      addBullet('J-60 : MFA, chiffrement, SPF/DKIM/DMARC (cf. onglet Guides Parametrage)');
      addBullet('J-30 : Sauvegardes, GED, test de restauration');
      addBullet('J0 : Demarrage activite, charte signee, formation initiale');
      addBullet('J+30 : Registre RGPD, DPA editeurs, revue des droits');
      addBullet('J+90 : Premier auto-audit complet, plan d\'amelioration');
      addBullet('Tous les 6 mois : Renouvellement auto-audit (art. 150, code de deontologie)');
      
      y += 4;

      addSubHeader('Note ‚Äî Volet RH & Formation');
      addParagraph('Le plan de formation, les procedures d\'onboarding/offboarding et le suivi des competences sont traites dans la Partie III du memoire (Annexes 18 a 23). Les aspects SI de l\'onboarding (creation comptes MFA, attribution droits, charte informatique) sont couverts par la Procedure n¬∞5 de l\'onglet Guides Parametrage.');

      addPageFooter();

      // ==================== PAGE 4 ====================
      doc.addPage();
      pageNum = 4;
      y = 20;

      addSectionHeader('4. SCENARIOS DE REVERSIBILITE');
      
      addParagraph('Le SaaS cree une dependance editeur. Anticipez toujours une strategie de sortie.');
      
      y += 2;

      var reversRows = [
        ['Logiciel comptable', 'Export FEC, plan comptable, ecritures', 'Mensuel'],
        ['GED / Portail client', 'Export masse (ZIP), metadonnees', 'Hebdomadaire'],
        ['Email / Messagerie', 'Export PST/MBOX, DNS (MX)', 'Mensuel'],
        ['CRM / Base clients', 'Export CSV contacts, historique', 'Mensuel']
      ];
      addTable(['Outil', 'Elements a exporter', 'Frequence'], reversRows, [45, 90, 45]);

      y += 4;

      addSubHeader('Clauses contractuelles a verifier');
      addBullet('Duree de preavis (souvent 3 mois)');
      addBullet('Format d\'export (formats standards, sans surcout)');
      addBullet('Delai de mise a disposition apres resiliation');
      addBullet('Accompagnement migration (inclus ou payant)');
      addBullet('Attestation de destruction des donnees post-migration');

      y += 6;

      addSectionHeader('5. PRINCIPAUX RISQUES SI');

      var risquesRows = [
        ['Phishing / Ingenierie sociale', 'CRITIQUE', 'MFA + Formation + SPF/DKIM/DMARC'],
        ['Ransomware', 'CRITIQUE', 'EDR + Sauvegarde immuable'],
        ['Vol de donnees clients', 'CRITIQUE', 'Chiffrement + Droits + Logs'],
        ['Acces non autorise', 'ELEVE', 'MFA + Revue des droits'],
        ['Vol de materiel', 'ELEVE', 'Chiffrement disque + MDM'],
        ['Defaillance prestataire', 'ELEVE', 'Sauvegarde hors site + PCA']
      ];
      addTable(['Risque', 'Niveau', 'Mesure principale'], risquesRows, [55, 30, 95]);

      addPageFooter();

      // ==================== PAGE 5 ====================
      doc.addPage();
      pageNum = 5;
      y = 20;

      addSectionHeader('6. CALENDRIER D\'INSTALLATION SI (J-90 A J+90)');

      var calRows = [
        ['J-90', 'Choix des outils', 'Selection logiciel comptable, GED, email'],
        ['J-60', 'Securite fondamentale', 'MFA, chiffrement, EDR, SPF/DKIM/DMARC'],
        ['J-30', 'Stockage et sauvegardes', 'Sauvegarde 3-2-1, GED, test restauration'],
        ['J0', 'Demarrage activite', 'Validation, formation, charte signee'],
        ['J+30', 'Conformite', 'Registre RGPD, DPA, revue des droits'],
        ['J+90', 'Audit initial', 'Premier auto-audit, plan amelioration']
      ];
      addTable(['Echeance', 'Action', 'Detail'], calRows, [25, 50, 105]);

      y += 4;

      addSectionHeader('7. REFERENCES ET SOURCES');
      
      addSubHeader('Textes reglementaires');
      addBullet('RGPD - Reglement (UE) 2016/679 - Protection des donnees personnelles');
      addBullet('Directive NIS2 - (UE) 2022/2555 - Transposition en cours (loi Resilience)');
      addBullet('Loi n 2023-1322 (art. 91) + decret n 2024-266 - Calendrier facturation electronique');
      addBullet('Code de deontologie EC - Decret n 2012-432, ed. janv. 2026');
      
      y += 2;
      
      addSubHeader('Sources statistiques');
      addBullet('CESIN, 10e Barometre (janv. 2025) : 47% des entreprises touchees en 2024');
      addBullet('ANSSI / Rapport Cour des Comptes 2025 : Cout moyen ransomware PME : 466 000 EUR');
      addBullet('Verizon DBIR 2024 : 68% des violations impliquent le facteur humain');

      y += 6;

      // Encadre final
      doc.setFillColor(245, 247, 250);
      doc.roundedRect(margin, y, contentWidth, 22, 2, 2, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.roundedRect(margin, y, contentWidth, 22, 2, 2, 'S');
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(primaryR, primaryG, primaryB);
      doc.text('SOURCE : CANDIDAT', margin + 5, y + 7);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.setTextColor(100, 100, 100);
      doc.text('Document genere le ' + new Date().toLocaleDateString('fr-FR') + ' a ' + new Date().toLocaleTimeString('fr-FR'), margin + 5, y + 12);
      doc.text('Outil d\'orientation - Verifiez les textes officiels avant toute demarche.', margin + 5, y + 17);

      addPageFooter();

      doc.save('Annexe_6_Cartographie_SI_Cabinet.pdf');
      toast('PDF exporte avec succes !');

    } catch (e) {
      console.error('Erreur PDF:', e);
      alert('Erreur lors de la generation du PDF : ' + e.message);
    }
  }, 200);
}

// Initialisation au chargement
const CABINET_X_STATE = {
  meta: {
    savedAt: new Date().toISOString(),
    tailleCabinet: 'small',
    niveauCloud: 'saas',
    prioriteSI: 'securite',
    factureElec: 'oui'
  },
  auditState: {
    'audit-mfa': true,
    'audit-edr': true,
    'audit-chiffrement': true,
    'audit-sauvegarde': true,
    'audit-test-restauration': false,
    'audit-email': true,
    'audit-rgpd': false,
    'audit-pca': false,
    'audit-comptes-nominatifs': true,
    'audit-mdp': true,
    'audit-revue-droits': false,
    'audit-mises-a-jour': true,
    'audit-portail': true,
    'audit-dpa': false,
    'audit-logs': false,
    'audit-wifi': true,
    'audit-vpn': false,
    'audit-offboarding': false,
    'audit-charte': false,
    'audit-formation': true,
    'audit-contacts': false,
    'audit-facturation': true,
    'audit-archi': false,
    'audit-cloud-droits': false,
    'audit-nas-securise': true
  }
};

function loadCabinetX() {
  if (!confirm('Charger les donnees du Cabinet X (exemple du memoire) ?\nCela remplacera vos donnees actuelles.')) return;
  applyStateObject(CABINET_X_STATE);
  toast('Exemple Cabinet X charge avec succes');
}

document.addEventListener('DOMContentLoaded', function() {
  try {
    var saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      applyStateObject(JSON.parse(saved));
    } else {
      renderAll();
    }
  } catch (e) {
    renderAll();
  }
});
</script>

</body>
</html>