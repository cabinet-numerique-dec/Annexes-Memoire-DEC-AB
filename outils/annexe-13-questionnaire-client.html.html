<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annexe 13 ‚Äî Questionnaire de Prise de Connaissance Client | Cabinet 100% Num√©rique</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #1e3a5f; --primary-light: #2d5a8a;
      --secondary: #0d9488; --secondary-light: #14b8a6;
      --accent: #f59e0b; --danger: #dc2626; --success: #059669;
      --warning: #d97706; --info: #2563eb;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-500: #6b7280; --gray-600: #4b5563;
      --gray-700: #374151; --gray-800: #1f2937;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, var(--gray-100) 0%, #e0e7ef 100%); color: var(--gray-700); line-height: 1.6; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border-radius: var(--radius); padding: 28px 32px; margin-bottom: 24px; position: relative; overflow: hidden; }
    .header::before { content: ""; position: absolute; top: -50%; right: -10%; width: 300px; height: 300px; background: rgba(255,255,255,0.05); border-radius: 50%; }
    .header h1 { font-size: 21px; font-weight: 700; margin-bottom: 6px; position: relative; }
    .header p { opacity: 0.9; font-size: 13px; max-width: 900px; position: relative; }
    .header-meta { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .badge { display: inline-flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-accent { background: var(--secondary); } .badge-warning { background: var(--accent); }
    .action-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); }
    .btn-secondary { background: var(--gray-200); color: var(--gray-700); } .btn-secondary:hover { background: var(--gray-300); }
    .btn-success { background: var(--success); color: white; } .btn-success:hover { background: #047857; }
    .btn-warning { background: var(--accent); color: white; } .btn-warning:hover { background: var(--warning); }
    .btn-danger { background: var(--danger); color: white; } .btn-danger:hover { background: #b91c1c; }
    .tabs { display: flex; gap: 3px; background: white; padding: 6px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; flex-wrap: wrap; }
    .tab { padding: 8px 13px; border: none; background: transparent; font-size: 12px; font-weight: 600; color: var(--gray-600); border-radius: 8px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .tab:hover { background: var(--gray-100); } .tab.active { background: var(--primary); color: white; }
    .panel { display: none; animation: fadeIn 0.3s ease; } .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: white; border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow); margin-bottom: 18px; }
    .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid var(--gray-200); }
    .card-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; }
    .card-icon.secondary { background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%); }
    .card-icon.accent { background: linear-gradient(135deg, var(--accent) 0%, #fbbf24 100%); }
    .card-icon.danger { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); }
    .card-icon.success { background: linear-gradient(135deg, var(--success) 0%, #34d399 100%); }
    .card h3 { font-size: 17px; font-weight: 700; color: var(--gray-800); }
    .card .subtitle { color: var(--gray-500); font-size: 12px; margin-top: 2px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 11px; font-weight: 600; color: var(--gray-600); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 13px; font-family: inherit; transition: all 0.2s; background: white; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-hint { font-size: 10px; color: var(--gray-500); margin-top: 4px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .checkbox-group, .radio-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; }
    .checkbox-item, .radio-item { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--gray-50); border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .checkbox-item:hover, .radio-item:hover { background: #edf2f7; }
    .checkbox-item.checked, .radio-item.checked { border-color: var(--primary); background: #eef2ff; }
    .checkbox-item input[type="checkbox"], .radio-item input[type="radio"] { width: 16px; height: 16px; accent-color: var(--primary); cursor: pointer; }
    .checkbox-item label, .radio-item label { font-weight: 500; color: var(--gray-700); cursor: pointer; text-transform: none; letter-spacing: normal; font-size: 13px; margin: 0; }
    .insight-box { padding: 14px 18px; border-radius: 10px; margin-bottom: 16px; font-size: 13px; line-height: 1.5; }
    .insight-box.info { background: #ecfdf5; border-left: 4px solid var(--secondary); }
    .insight-box.warning { background: #fef3c7; border-left: 4px solid var(--accent); }
    .insight-box.danger { background: #fee2e2; border-left: 4px solid var(--danger); }
    .insight-box.neutral { background: #eff6ff; border-left: 4px solid var(--info); }
    .insight-box strong { display: block; margin-bottom: 4px; color: var(--gray-800); font-size: 13px; }
    .progress-container { background: white; padding: 16px 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
    .progress-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 12px; font-weight: 600; color: var(--gray-700); }
    .progress-bar-bg { width: 100%; height: 10px; background: var(--gray-200); border-radius: 20px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--secondary) 0%, var(--secondary-light) 100%); transition: width 0.3s ease; border-radius: 20px; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; margin-top: 16px; }
    .summary-item { background: var(--gray-50); padding: 14px; border-radius: 10px; border-left: 4px solid var(--primary); }
    .summary-item-title { font-size: 11px; font-weight: 700; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .summary-item-value { font-size: 14px; font-weight: 600; color: var(--gray-800); }
    .risk-score { text-align: center; padding: 20px; background: linear-gradient(135deg, var(--gray-50) 0%, white 100%); border-radius: 10px; margin-top: 16px; }
    .risk-score-label { font-size: 12px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; margin-bottom: 8px; }
    .risk-score-value { font-size: 42px; font-weight: 700; }
    .risk-score-desc { font-size: 13px; color: var(--gray-600); margin-top: 6px; }
    .decision-box { padding: 20px; border-radius: 10px; margin-top: 16px; text-align: center; }
    .decision-box.accept { background: #ecfdf5; border: 2px solid var(--success); }
    .decision-box.conditional { background: #fef3c7; border: 2px solid var(--accent); }
    .decision-box.refuse { background: #fee2e2; border: 2px solid var(--danger); }
    .decision-box h4 { font-size: 18px; margin-bottom: 8px; }
    .decision-box p { font-size: 13px; color: var(--gray-600); }
    .npmq-score { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; }
    .npmq-item { flex: 1; min-width: 180px; text-align: center; padding: 16px; border-radius: 10px; background: var(--gray-50); }
    .npmq-item .label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--gray-500); margin-bottom: 6px; }
    .npmq-item .status { font-size: 20px; font-weight: 700; }
    .npmq-item .status.ok { color: var(--success); }
    .npmq-item .status.warn { color: var(--warning); }
    .npmq-item .status.ko { color: var(--danger); }
    .siret-status { display: inline-block; margin-left: 8px; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 4px; }
    .siret-status.valid { background: #ecfdf5; color: var(--success); }
    .siret-status.invalid { background: #fee2e2; color: var(--danger); }
    .doc-missing { color: var(--danger); font-weight: 600; font-size: 12px; margin-top: 8px; }
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--gray-800); color: white; padding: 12px 18px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 9999; font-size: 13px; font-weight: 500; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99999; display: none; align-items: center; justify-content: center; }
    .loading-overlay.show { display: flex; }
    .loading-content { background: white; padding: 32px; border-radius: 16px; text-align: center; min-width: 280px; }
    .spinner { width: 40px; height: 40px; margin: 0 auto 16px; border: 3px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .consent-box { background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: 10px; padding: 16px; margin-top: 12px; }
    .consent-box label { font-size: 13px !important; text-transform: none !important; letter-spacing: normal !important; line-height: 1.5; color: var(--gray-700) !important; }
    @media (max-width: 768px) { .header { padding: 18px; } .header h1 { font-size: 17px; } .container { padding: 14px; } .form-row, .form-row-3 { grid-template-columns: 1fr; } .checkbox-group, .radio-group { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>Annexe 13 ‚Äî Questionnaire de Prise de Connaissance Client</h1>
    <p>Outil d'aide √† la d√©cision d'acceptation de mission pour un cabinet d'expertise comptable 100 % num√©rique. Conforme NPMQ (¬ß18-20), obligations LCB-FT (art. L.561-4-1 CMF) et RGPD.</p>
    <div class="header-meta">
      <span class="badge badge-accent">NPMQ ¬ß18-20</span>
      <span class="badge badge-warning">LCB-FT 3 axes</span>
      <span class="badge">RGPD</span>
      <span class="badge">Export PDF</span>
    </div>
  </div>

  <div class="progress-container">
    <div class="progress-label"><span>Progression du questionnaire</span><span id="progressPercent">0%</span></div>
    <div class="progress-bar-bg"><div id="progressBar" class="progress-bar-fill" style="width: 0%"></div></div>
  </div>

  <div class="action-bar">
    <button class="btn btn-success" onclick="validateForm()">‚úì Valider & D√©cider</button>
    <button class="btn btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
    <button class="btn btn-secondary" onclick="saveData()">üíæ Sauvegarder</button>
    <button class="btn btn-secondary" onclick="loadData()">üìÇ Charger</button>
    <button class="btn btn-warning" onclick="loadCasPratique()">üìã Cas pratique Cabinet X</button>
    <button class="btn btn-danger" onclick="resetForm()">üîÑ Reset</button>
  </div>

  <div class="tabs" id="tabBar">
    <button class="tab active" data-panel="identification">1. Identification</button>
    <button class="tab" data-panel="situation">2. Finances</button>
    <button class="tab" data-panel="besoins">3. Besoins</button>
    <button class="tab" data-panel="lcbft">4. LCB-FT</button>
    <button class="tab" data-panel="npmq">5. NPMQ & RGPD</button>
    <button class="tab" data-panel="recap">6. D√©cision</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL 1: IDENTIFICATION (enrichi) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="identification" class="panel active">
    <div class="card">
      <div class="card-header"><div class="card-icon">üè¢</div><div><h3>Informations g√©n√©rales</h3><div class="subtitle">Identification du client et informations de contact</div></div></div>
      <div class="form-row">
        <div class="form-group"><label for="clientName">Raison sociale *</label><input type="text" id="clientName" placeholder="Ex : SARL TechStartup" required></div>
        <div class="form-group"><label for="contactName">Nom contact principal *</label><input type="text" id="contactName" placeholder="Ex: Jean Dupont" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label for="email">Email *</label><input type="email" id="email" placeholder="jean.dupont@example.com" required></div>
        <div class="form-group"><label for="phone">T√©l√©phone *</label><input type="tel" id="phone" placeholder="+33 6 12 34 56 78" required></div>
      </div>
      <div class="form-row-3">
        <div class="form-group"><label for="siret">SIRET (14 chiffres) * <span id="siretStatus"></span></label><input type="text" id="siret" placeholder="12345678901234" maxlength="14" required oninput="validateSiret()"><div class="form-hint">Validation automatique du format et cl√© de contr√¥le</div></div>
        <div class="form-group"><label for="naf">Code NAF/APE *</label><input type="text" id="naf" placeholder="Ex: 6920Z" maxlength="6" required><div class="form-hint">Comptabilit√© = 6920Z</div></div>
        <div class="form-group"><label for="creationDate">Date de cr√©ation *</label><input type="date" id="creationDate" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label for="sector">Secteur d'activit√© *</label>
          <select id="sector" required><option value="">-- S√©lectionner --</option><option value="tech">Technologie / SaaS</option><option value="startup">Startup innovante</option><option value="ecommerce">E-commerce</option><option value="btp">BTP / Construction</option><option value="services">Services aux entreprises</option><option value="sante">Sante / Medical</option><option value="immobilier">Immobilier</option><option value="restauration">Restauration / H√¥tellerie</option><option value="transport">Transport / Logistique</option><option value="industrie">Industrie / Fabrication</option><option value="autre">Autre</option></select>
        </div>
        <div class="form-group"><label for="previousEC">Expert-comptable pr√©c√©dent</label>
          <select id="previousEC"><option value="none">Aucun (cr√©ation)</option><option value="yes-voluntary">Oui - Changement volontaire</option><option value="yes-issue">Oui - Suite √† un diff√©rend</option><option value="yes-cessation">Oui - Cessation d'activit√© du cabinet</option></select>
          <div class="form-hint">Obligation d√©ontologique : contact du confr√®re pr√©c√©dent</div>
        </div>
      </div>
      <div class="form-group"><label for="description">Description de l'activit√© *</label><textarea id="description" placeholder="Activit√© principale, produits/services, mod√®le √©conomique..." required></textarea></div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-icon secondary">‚öñÔ∏è</div><div><h3>Structure juridique & gouvernance</h3><div class="subtitle">Forme juridique, r√©gime fiscal et cl√¥ture</div></div></div>
      <div class="form-row-3">
        <div class="form-group"><label for="legalForm">Forme juridique *</label>
          <select id="legalForm" required><option value="">-- S√©lectionner --</option><option value="micro">Micro-entreprise</option><option value="eirl">EIRL</option><option value="sarl">SARL / EURL</option><option value="sasu">SASU</option><option value="sa">SA / SAS</option><option value="sci">SCI</option><option value="autre">Autre</option></select>
        </div>
        <div class="form-group"><label for="fiscalRegime">R√©gime fiscal *</label>
          <select id="fiscalRegime" required><option value="">-- S√©lectionner --</option><option value="micro">Micro-entreprise</option><option value="reel">R√©el normal</option><option value="reel-simple">R√©el simplifi√©</option><option value="ir">IR (profession lib√©rale)</option><option value="autre">Autre</option></select>
        </div>
        <div class="form-group"><label for="tvaRegime">R√©gime de TVA *</label>
          <select id="tvaRegime" required><option value="">-- S√©lectionner --</option><option value="mensuel">Mensuel (CA3)</option><option value="trimestriel">Trimestriel</option><option value="simplifie">Simplifi√© (CA12)</option><option value="franchise">Franchise en base de TVA</option><option value="exonere">Exon√©r√©</option></select>
        </div>
      </div>
      <div class="form-row-3">
        <div class="form-group"><label for="fiscalYearEnd">Date cl√¥ture exercice *</label><input type="text" id="fiscalYearEnd" placeholder="Ex: 31/12 ou 30/06" required><div class="form-hint">JJ/MM de fin d'exercice</div></div>
        <div class="form-group"><label for="shareholders">Nombre d'associ√©s *</label><input type="number" id="shareholders" min="1" placeholder="1" required></div>
        <div class="form-group"><label for="employees">Nombre de salari√©s *</label><input type="number" id="employees" min="0" placeholder="0" required></div>
      </div>
      <div class="form-group"><label>Structures li√©es</label>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="groupRelated"><label for="groupRelated">Groupe / entit√©s li√©es</label></div>
          <div class="checkbox-item"><input type="checkbox" id="multiActivity"><label for="multiActivity">Plusieurs activit√©s</label></div>
          <div class="checkbox-item"><input type="checkbox" id="international"><label for="international">Op√©rations internationales</label></div>
          <div class="checkbox-item"><input type="checkbox" id="holding"><label for="holding">Structure holding</label></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL 2: SITUATION FINANCIERE (enrichi) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="situation" class="panel">
    <div class="card">
      <div class="card-header"><div class="card-icon accent">üí∞</div><div><h3>Situation financi√®re</h3><div class="subtitle">Donn√©es √©conomiques, volumes et facturation</div></div></div>
      <div class="form-row-3">
        <div class="form-group"><label for="turnover">CA annuel HT (‚Ç¨) *</label><input type="number" id="turnover" min="0" step="1000" placeholder="50000" required></div>
        <div class="form-group"><label for="growth">Croissance pr√©vue (%) *</label><input type="number" id="growth" min="-100" max="500" step="5" placeholder="20" required></div>
        <div class="form-group"><label for="invoiceVolume">Nb factures ventes / mois *</label><input type="number" id="invoiceVolume" min="0" placeholder="50" required><div class="form-hint">Dimensionnement mission</div></div>
      </div>
      <div class="form-row-3">
        <div class="form-group"><label for="purchaseVolume">Nb factures achats / mois *</label><input type="number" id="purchaseVolume" min="0" placeholder="30" required></div>
        <div class="form-group"><label for="avgInvoice">Facture moyenne (‚Ç¨) *</label><input type="number" id="avgInvoice" min="0" step="100" placeholder="2500" required></div>
        <div class="form-group"><label for="paymentDelay">D√©lai paiement (jours) *</label><input type="number" id="paymentDelay" min="0" max="120" placeholder="30" required></div>
      </div>
      <div class="form-group"><label>Mod√®le de facturation</label>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="invoicingDelayed"><label for="invoicingDelayed">Apr√®s livraison</label></div>
          <div class="checkbox-item"><input type="checkbox" id="invoicingAdvance"><label for="invoicingAdvance">Acomptes/avances</label></div>
          <div class="checkbox-item"><input type="checkbox" id="invoicingMilestone"><label for="invoicingMilestone">Par jalons</label></div>
          <div class="checkbox-item"><input type="checkbox" id="invoicingRetainer"><label for="invoicingRetainer">Forfaits / abonnements</label></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon success">üíª</div><div><h3>Syst√®me d'information</h3><div class="subtitle">Outils actuels et maturit√© num√©rique</div></div></div>
      <div class="form-group"><label>Outils comptables / gestion actuels</label>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="toolExcel"><label for="toolExcel">Excel / Calc</label></div>
          <div class="checkbox-item"><input type="checkbox" id="toolQuadratus"><label for="toolQuadratus">Quadratus / Ciel</label></div>
          <div class="checkbox-item"><input type="checkbox" id="toolSage"><label for="toolSage">Sage</label></div>
          <div class="checkbox-item"><input type="checkbox" id="toolPennylane"><label for="toolPennylane">Pennylane</label></div>
          <div class="checkbox-item"><input type="checkbox" id="toolFulll"><label for="toolFulll">FULLL</label></div>
          <div class="checkbox-item"><input type="checkbox" id="toolOther"><label for="toolOther">Autre</label></div>
        </div>
      </div>
      <div class="form-group"><label for="otherTools">Autres outils (CRM, collecte...)</label><textarea id="otherTools" placeholder="Ex: HubSpot CRM, Dext, Teams..."></textarea></div>
      <div class="form-group"><label>Maturit√© num√©rique *</label>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="maturityLow" name="maturity" value="faible"><label for="maturityLow">Faible</label></div>
          <div class="radio-item"><input type="radio" id="maturityMedium" name="maturity" value="moyen"><label for="maturityMedium">Moyen</label></div>
          <div class="radio-item"><input type="radio" id="maturityHigh" name="maturity" value="eleve"><label for="maturityHigh">√âlev√©</label></div>
          <div class="radio-item"><input type="radio" id="maturityVeryHigh" name="maturity" value="tres-eleve"><label for="maturityVeryHigh">Tr√®s √©lev√©</label></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL 3: BESOINS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="besoins" class="panel">
    <div class="card">
      <div class="card-header"><div class="card-icon accent">üéØ</div><div><h3>Besoins et attentes</h3><div class="subtitle">Missions souhait√©es et niveau de support</div></div></div>
      <div class="form-group"><label>Missions comptables souhait√©es *</label>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="missionAccounting"><label for="missionAccounting">Tenue comptabilit√©</label></div>
          <div class="checkbox-item"><input type="checkbox" id="missionReporting"><label for="missionReporting">Reportings mensuels</label></div>
          <div class="checkbox-item"><input type="checkbox" id="missionAudit"><label for="missionAudit">R√©vision / audit</label></div>
          <div class="checkbox-item"><input type="checkbox" id="missionDeclarations"><label for="missionDeclarations">D√©clarations fiscales</label></div>
          <div class="checkbox-item"><input type="checkbox" id="missionPayroll"><label for="missionPayroll">Paie et social</label></div>
          <div class="checkbox-item"><input type="checkbox" id="missionDaf"><label for="missionDaf">DAF externalis√©</label></div>
          <div class="checkbox-item"><input type="checkbox" id="missionConsulting"><label for="missionConsulting">Conseil gestion</label></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Niveau de support *</label>
          <div class="radio-group">
            <div class="radio-item"><input type="radio" id="supportBasic" name="support" value="basique"><label for="supportBasic">Basique</label></div>
            <div class="radio-item"><input type="radio" id="supportStandard" name="support" value="standard"><label for="supportStandard">Standard</label></div>
            <div class="radio-item"><input type="radio" id="supportPremium" name="support" value="premium"><label for="supportPremium">Premium</label></div>
            <div class="radio-item"><input type="radio" id="supportVip" name="support" value="vip"><label for="supportVip">VIP / DAF</label></div>
          </div>
        </div>
        <div class="form-group"><label>Fr√©quence de communication *</label>
          <div class="radio-group">
            <div class="radio-item"><input type="radio" id="freqQuarterly" name="frequency" value="trimestrielle"><label for="freqQuarterly">Trimestrielle</label></div>
            <div class="radio-item"><input type="radio" id="freqMonthly" name="frequency" value="mensuelle"><label for="freqMonthly">Mensuelle</label></div>
            <div class="radio-item"><input type="radio" id="freqWeekly" name="frequency" value="hebdomadaire"><label for="freqWeekly">Hebdomadaire</label></div>
            <div class="radio-item"><input type="radio" id="freqDemand" name="frequency" value="demande"><label for="freqDemand">√Ä la demande</label></div>
          </div>
        </div>
      </div>
      <div class="form-group"><label for="specificNeeds">Besoins sp√©cifiques / projets</label><textarea id="specificNeeds" placeholder="Lev√©e de fonds, facturation √©lectronique, audit avant cession..."></textarea></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL 4: LCB-FT 3 AXES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="lcbft" class="panel">
    <div class="card">
      <div class="card-header"><div class="card-icon danger">‚ö†Ô∏è</div><div><h3>√âvaluation des risques LCB-FT</h3><div class="subtitle">Approche par les risques ‚Äî 3 axes (client, g√©ographique, op√©rations) ‚Äî art. L.561-4-1 CMF</div></div></div>
      
      <div class="insight-box danger"><strong>Obligations l√©gales :</strong> L'expert-comptable, professionnel assujetti (art. L.561-2 CMF), doit proc√©der √† une √©valuation des risques selon trois axes conform√©ment aux lignes directrices TRACFIN et √† la 4·µâ directive anti-blanchiment (UE) 2015/849.</div>

      <div class="card" style="border: 2px solid var(--gray-200); box-shadow: none;">
        <h3 style="font-size: 14px; color: var(--primary); margin-bottom: 12px;">AXE 1 ‚Äî Risque li√© au client</h3>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="riskPPE" value="5"><label for="riskPPE">Personne politiquement expos√©e (PPE)</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskComplex" value="3"><label for="riskComplex">Structure juridique complexe / opaque</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskNewClient" value="1"><label for="riskNewClient">Client nouveau sans historique connu</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskBenefOpaque" value="3"><label for="riskBenefOpaque">B√©n√©ficiaire effectif difficile √† identifier</label></div>
        </div>
      </div>

      <div class="card" style="border: 2px solid var(--gray-200); box-shadow: none;">
        <h3 style="font-size: 14px; color: var(--primary); margin-bottom: 12px;">AXE 2 ‚Äî Risque g√©ographique</h3>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="riskSanction" value="5"><label for="riskSanction">Pays sous sanctions (UE / OFAC / ONU)</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskGAFI" value="4"><label for="riskGAFI">Pays liste grise/noire GAFI</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskInternational" value="2"><label for="riskInternational">Op√©rations hors UE (hors pays √† risque)</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskFiscalParadise" value="4"><label for="riskFiscalParadise">Paradis fiscal (liste UE des ETNC)</label></div>
        </div>
      </div>

      <div class="card" style="border: 2px solid var(--gray-200); box-shadow: none;">
        <h3 style="font-size: 14px; color: var(--primary); margin-bottom: 12px;">AXE 3 ‚Äî Risque li√© aux op√©rations / produits</h3>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="riskCash" value="3"><label for="riskCash">Transactions en esp√®ces importantes</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskCrypto" value="3"><label for="riskCrypto">Crypto-actifs / actifs num√©riques</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskAtypical" value="2"><label for="riskAtypical">Op√©rations atypiques / injustifi√©es</label></div>
          <div class="checkbox-item"><input type="checkbox" id="riskHighCA" value="1"><label for="riskHighCA">CA incoh√©rent avec l'activit√© d√©clar√©e</label></div>
        </div>
      </div>

      <div class="form-group"><label>Origine des fonds *</label>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="fundsActivity" name="funds" value="activite"><label for="fundsActivity">Activit√© professionnelle</label></div>
          <div class="radio-item"><input type="radio" id="fundsInvestment" name="funds" value="investissement"><label for="fundsInvestment">Investissement / lev√©e de fonds</label></div>
          <div class="radio-item"><input type="radio" id="fundsLoan" name="funds" value="emprunt"><label for="fundsLoan">Emprunt bancaire</label></div>
          <div class="radio-item"><input type="radio" id="fundsPersonal" name="funds" value="personnel"><label for="fundsPersonal">Apport personnel</label></div>
          <div class="radio-item"><input type="radio" id="fundsMixed" name="funds" value="mixte"><label for="fundsMixed">Mixte</label></div>
        </div>
      </div>
      <div class="form-group"><label for="beneficiaries">B√©n√©ficiaires effectifs (> 25 % capital) *</label><textarea id="beneficiaries" placeholder="Nom, pr√©nom, % d√©tention, nationalit√©..." required></textarea><div class="form-hint">Art. L.561-2-2 CMF ‚Äî Identification obligatoire</div></div>

      <div class="form-group"><label>Documents KYC fournis *</label>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="docKbis"><label for="docKbis">Kbis < 3 mois</label></div>
          <div class="checkbox-item"><input type="checkbox" id="docStatuts"><label for="docStatuts">Statuts a jour</label></div>
          <div class="checkbox-item"><input type="checkbox" id="docId"><label for="docId">Pi√®ces d'identit√© dirigeants</label></div>
          <div class="checkbox-item"><input type="checkbox" id="docProof"><label for="docProof">Justificatif de domicile</label></div>
          <div class="checkbox-item"><input type="checkbox" id="docBenef"><label for="docBenef">D√©claration b√©n√©ficiaires effectifs (INPI)</label></div>
          <div class="checkbox-item"><input type="checkbox" id="docRib"><label for="docRib">RIB professionnel</label></div>
        </div>
        <div id="missingDocsAlert" class="doc-missing" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL 5: NPMQ & RGPD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="npmq" class="panel">
    <div class="card">
      <div class="card-header"><div class="card-icon">üìã</div><div><h3>V√©rification NPMQ ‚Äî Acceptation de mission</h3><div class="subtitle">Norme professionnelle de ma√Ætrise de la qualit√©, ¬ß18 √† 20</div></div></div>
      
      <div class="insight-box neutral"><strong>R√©f. normative :</strong> Avant toute acceptation de mission, l'expert-comptable doit v√©rifier trois conditions cumulatives (NPMQ ¬ß18-20, Code de d√©ontologie art. 145 et 146). L'absence de v√©rification formalis√©e engage la responsabilit√© du professionnel.</div>

      <div class="card" style="border: 2px solid var(--gray-200); box-shadow: none;">
        <h3 style="font-size: 14px; color: var(--primary); margin-bottom: 12px;">1. COMP√âTENCE ‚Äî Art. 145 Code de d√©ontologie</h3>
        <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 10px;">Le cabinet dispose-t-il des comp√©tences techniques pour la mission demand√©e ?</p>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="compOk" name="competence" value="ok"><label for="compOk">Oui ‚Äî Comp√©tences ma√Ætris√©es</label></div>
          <div class="radio-item"><input type="radio" id="compPartial" name="competence" value="partial"><label for="compPartial">Partiellement ‚Äî Formation n√©cessaire</label></div>
          <div class="radio-item"><input type="radio" id="compNo" name="competence" value="no"><label for="compNo">Non ‚Äî Hors domaine de comp√©tence</label></div>
        </div>
        <div class="form-group" style="margin-top: 10px;"><label for="compComment">Commentaire comp√©tence</label><textarea id="compComment" placeholder="Pr√©ciser les comp√©tences disponibles ou √† acqu√©rir..." style="min-height: 50px;"></textarea></div>
      </div>

      <div class="card" style="border: 2px solid var(--gray-200); box-shadow: none;">
        <h3 style="font-size: 14px; color: var(--primary); margin-bottom: 12px;">2. IND√âPENDANCE ‚Äî Art. 146 Code de d√©ontologie</h3>
        <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 10px;">Existe-t-il des liens personnels, financiers ou professionnels susceptibles d'alt√©rer l'ind√©pendance ?</p>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="indepOk" name="independance" value="ok"><label for="indepOk">Aucun lien identifi√©</label></div>
          <div class="radio-item"><input type="radio" id="indepRisk" name="independance" value="risk"><label for="indepRisk">Lien identifi√© mais ma√Ætrisable</label></div>
          <div class="radio-item"><input type="radio" id="indepNo" name="independance" value="no"><label for="indepNo">Ind√©pendance compromise</label></div>
        </div>
        <div class="form-group" style="margin-top: 10px;"><label for="indepComment">Commentaire ind√©pendance</label><textarea id="indepComment" placeholder="Pr√©ciser les liens identifi√©s le cas √©ch√©ant..." style="min-height: 50px;"></textarea></div>
      </div>

      <div class="card" style="border: 2px solid var(--gray-200); box-shadow: none;">
        <h3 style="font-size: 14px; color: var(--primary); margin-bottom: 12px;">3. MOYENS DISPONIBLES ‚Äî NPMQ ¬ß18-c</h3>
        <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 10px;">Le cabinet dispose-t-il des ressources humaines et techniques pour assurer la mission dans les d√©lais ?</p>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="moyensOk" name="moyens" value="ok"><label for="moyensOk">Oui ‚Äî Ressources suffisantes</label></div>
          <div class="radio-item"><input type="radio" id="moyensPartial" name="moyens" value="partial"><label for="moyensPartial">Sous r√©serve de recrutement / sous-traitance</label></div>
          <div class="radio-item"><input type="radio" id="moyensNo" name="moyens" value="no"><label for="moyensNo">Non ‚Äî Surcharge / moyens insuffisants</label></div>
        </div>
        <div class="form-group" style="margin-top: 10px;"><label for="moyensComment">Commentaire moyens</label><textarea id="moyensComment" placeholder="Charge actuelle, disponibilit√© √©quipe, √©ch√©ances..." style="min-height: 50px;"></textarea></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-icon secondary">üîí</div><div><h3>Consentement RGPD</h3><div class="subtitle">R√®glement (UE) 2016/679 ‚Äî Collecte et traitement des donn√©es</div></div></div>
      <div class="consent-box">
        <div style="display: flex; gap: 10px; align-items: flex-start;">
          <input type="checkbox" id="rgpdConsent" style="margin-top: 4px; width: 18px; height: 18px; flex-shrink: 0;">
          <label for="rgpdConsent">Le client est inform√© que les donn√©es collect√©es dans le pr√©sent questionnaire sont trait√©es par le cabinet dans le cadre de l'ex√©cution pr√©contractuelle et de l'obligation l√©gale (LCB-FT). Les donn√©es sont conserv√©es 5 ans apr√®s la fin de la mission (10 ans pour les pi√®ces comptables). Le client dispose d'un droit d'acc√®s, de rectification, d'effacement et de portabilit√© (art. 15 √† 20 RGPD). Contact DPO : adresse indiqu√©e dans la lettre de mission.</label>
        </div>
      </div>
      <div class="form-group" style="margin-top: 12px;">
        <label for="rgpdDate">Date du consentement</label>
        <input type="date" id="rgpdDate">
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL 6: RECAPITULATIF & DECISION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="recap" class="panel">
    <div class="card">
      <div class="card-header"><div class="card-icon success">‚úì</div><div><h3>Synth√®se et d√©cision d'acceptation</h3><div class="subtitle">R√©sultat de l'√©valuation ‚Äî NPMQ + LCB-FT</div></div></div>

      <div id="summaryContent">
        <div class="insight-box warning"><strong>Compl√©tez le questionnaire</strong> puis cliquez sur ¬´ Valider & D√©cider ¬ª pour g√©n√©rer la synth√®se et la recommandation d'acceptation.</div>
      </div>

      <div id="npmqScoreDisplay" style="display: none;">
        <h4 style="font-size: 14px; margin-top: 20px; margin-bottom: 10px; color: var(--gray-800);">V√©rification NPMQ (¬ß18-20)</h4>
        <div class="npmq-score" id="npmqScoreContent"></div>
      </div>

      <div class="risk-score" id="riskScoreDisplay" style="display: none;">
        <div class="risk-score-label">Score de Risque LCB-FT (3 axes)</div>
        <div class="risk-score-value" id="riskScoreValue">‚Äî</div>
        <div class="risk-score-desc" id="riskScoreDesc">‚Äî</div>
        <div id="riskAxisDetail" style="margin-top: 12px; font-size: 12px; color: var(--gray-500);"></div>
      </div>

      <div id="decisionDisplay" style="display: none;"></div>

      <div id="nextStepDisplay" style="display: none; margin-top: 16px;" class="insight-box neutral">
        <strong>√âtape suivante :</strong> En cas d'acceptation, proc√©der √† la formalisation contractuelle via la signature de la lettre de mission (signature √©lectronique conforme eIDAS).
      </div>
    </div>
  </div>

</div>

<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-content"><div class="spinner"></div><div style="font-size: 15px; font-weight: 600; color: var(--gray-700);">G√©n√©ration du PDF...</div></div>
</div>
<div id="toast" class="toast"></div>

<script>
var STORAGE_KEY = 'annexe13_v3';

document.addEventListener('DOMContentLoaded', function() {
  updateProgress();
  setupInputListeners();
  setupTabs();
  setupMissingDocs();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupTabs() {
  document.querySelectorAll('.tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      var panelId = this.getAttribute('data-panel');
      document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById(panelId).classList.add('active');
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      this.classList.add('active');
    });
  });
}

function showPanel(id) {
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(function(t) {
    t.classList.toggle('active', t.getAttribute('data-panel') === id);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupInputListeners() {
  document.querySelectorAll('input, select, textarea').forEach(function(el) {
    el.addEventListener('change', updateProgress);
    el.addEventListener('input', updateProgress);
  });
}

function updateProgress() {
  var fields = document.querySelectorAll('[required]');
  var filled = 0;
  fields.forEach(function(f) {
    if (f.type === 'checkbox' || f.type === 'radio') {
      var nm = f.name || f.id;
      if (document.querySelector('input[name="'+nm+'"]:checked, input[id="'+nm+'"]:checked')) filled++;
    } else if (f.value.trim() !== '') filled++;
  });
  var pct = Math.round((filled / fields.length) * 100);
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressPercent').textContent = pct + '%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIRET VALIDATION (Luhn) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function validateSiret() {
  var val = document.getElementById('siret').value.replace(/\s/g, '');
  var el = document.getElementById('siretStatus');
  if (val.length < 14) { el.innerHTML = ''; return; }
  if (!/^\d{14}$/.test(val)) { el.innerHTML = '<span class="siret-status invalid">Format invalide</span>'; return; }
  var sum = 0;
  for (var i = 0; i < 14; i++) {
    var d = parseInt(val[i]);
    if (i % 2 === 1) { d *= 2; if (d > 9) d -= 9; }
    sum += d;
  }
  if (sum % 10 === 0) { el.innerHTML = '<span class="siret-status valid">‚úì Valide</span>'; }
  else { el.innerHTML = '<span class="siret-status invalid">‚úó Cle incorrecte</span>'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MISSING DOCS ALERT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupMissingDocs() {
  ['docKbis','docStatuts','docId','docProof','docBenef','docRib'].forEach(function(id) {
    document.getElementById(id).addEventListener('change', checkMissingDocs);
  });
}

function checkMissingDocs() {
  var missing = [];
  if (!document.getElementById('docKbis').checked) missing.push('Kbis');
  if (!document.getElementById('docStatuts').checked) missing.push('Statuts');
  if (!document.getElementById('docId').checked) missing.push('Pi√®ces d\'identit√©');
  if (!document.getElementById('docBenef').checked) missing.push('D√©claration b√©n√©ficiaires (INPI)');
  var el = document.getElementById('missingDocsAlert');
  if (missing.length > 0) {
    el.style.display = 'block';
    el.textContent = 'Documents manquants √† collecter : ' + missing.join(', ');
  } else { el.style.display = 'none'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RISK CALCULATION (3 AXES) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calculateRisk() {
  var axe1 = 0, axe2 = 0, axe3 = 0;
  // Axe 1 - Client
  if (document.getElementById('riskPPE').checked) axe1 += 5;
  if (document.getElementById('riskComplex').checked) axe1 += 3;
  if (document.getElementById('riskNewClient').checked) axe1 += 1;
  if (document.getElementById('riskBenefOpaque').checked) axe1 += 3;
  // Axe 2 - Geo
  if (document.getElementById('riskSanction').checked) axe2 += 5;
  if (document.getElementById('riskGAFI').checked) axe2 += 4;
  if (document.getElementById('riskInternational').checked) axe2 += 2;
  if (document.getElementById('riskFiscalParadise').checked) axe2 += 4;
  // Axe 3 - Operations
  if (document.getElementById('riskCash').checked) axe3 += 3;
  if (document.getElementById('riskCrypto').checked) axe3 += 3;
  if (document.getElementById('riskAtypical').checked) axe3 += 2;
  if (document.getElementById('riskHighCA').checked) axe3 += 1;
  // Structures liees
  if (document.getElementById('groupRelated').checked) axe1 += 1;
  if (document.getElementById('international').checked) axe2 += 1;

  var total = axe1 + axe2 + axe3;
  var level, desc;
  if (total === 0) { level = 'FAIBLE'; desc = 'Vigilance simplifi√©e applicable'; }
  else if (total <= 4) { level = 'MOD√âR√â'; desc = 'Vigilance normale ‚Äî Diligences standard'; }
  else if (total <= 10) { level = '√âLEV√â'; desc = 'Vigilance renforc√©e obligatoire (art. L.561-10-1 CMF)'; }
  else { level = 'TR√àS √âLEV√â'; desc = 'Risque majeur ‚Äî Validation de la direction requise'; }
  return { axe1: axe1, axe2: axe2, axe3: axe3, total: total, level: level, desc: desc };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NPMQ CHECK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkNPMQ() {
  var comp = document.querySelector('input[name="competence"]:checked');
  var indep = document.querySelector('input[name="independance"]:checked');
  var moyens = document.querySelector('input[name="moyens"]:checked');
  return {
    competence: comp ? comp.value : 'none',
    independance: indep ? indep.value : 'none',
    moyens: moyens ? moyens.value : 'none'
  };
}

function getDecision(npmq, risk) {
  // Refus automatique
  if (npmq.competence === 'no' || npmq.independance === 'no' || npmq.moyens === 'no') {
    return { decision: 'REFUS', css: 'refuse', reason: 'Une ou plusieurs conditions NPMQ ne sont pas remplies. Mission √† d√©cliner avec orientation vers un confr√®re.' };
  }
  if (risk.total > 10) {
    return { decision: 'REFUS RECOMMANDE', css: 'refuse', reason: 'Risque LCB-FT tr√®s √©lev√©. Refus de mission recommand√© sauf justification exceptionnelle document√©e et valid√©e par la direction.' };
  }
  // Acceptation sous conditions
  if (npmq.competence === 'partial' || npmq.moyens === 'partial' || npmq.independance === 'risk' || risk.total > 4) {
    var conditions = [];
    if (npmq.competence === 'partial') conditions.push('Formation compl√©mentaire pr√©alable');
    if (npmq.moyens === 'partial') conditions.push('Recrutement ou sous-traitance √† planifier');
    if (npmq.independance === 'risk') conditions.push('Mesures de sauvegarde de l\'independance');
    if (risk.total > 4) conditions.push('Diligences LCB-FT renforc√©es √† mettre en ≈ìuvre');
    return { decision: 'ACCEPTATION SOUS CONDITIONS', css: 'conditional', reason: 'Conditions pr√©alables : ' + conditions.join(' ; ') + '.' };
  }
  // Acceptation
  return { decision: 'ACCEPTATION', css: 'accept', reason: 'Toutes les conditions NPMQ sont remplies et le niveau de risque LCB-FT est ma√Ætris√©. Proc√©der √† la formalisation contractuelle (lettre de mission avec signature √©lectronique eIDAS).' };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VALIDATE & GENERATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function validateForm() {
  var npmq = checkNPMQ();
  var risk = calculateRisk();
  var dec = getDecision(npmq, risk);

  // Summary
  var cn = document.getElementById('clientName').value || 'Non renseigne';
  var ct = document.getElementById('contactName').value || '-';
  var se = document.getElementById('sector');
  var sector = se.selectedIndex > 0 ? se.options[se.selectedIndex].text : '-';
  var lf = document.getElementById('legalForm');
  var legal = lf.selectedIndex > 0 ? lf.options[lf.selectedIndex].text : '-';
  var to = parseFloat(document.getElementById('turnover').value || 0);
  var missions = [];
  ['missionAccounting','missionReporting','missionAudit','missionDeclarations','missionPayroll','missionDaf','missionConsulting'].forEach(function(id) {
    if (document.getElementById(id).checked) missions.push(document.querySelector('label[for="'+id+'"]').textContent);
  });
  var maturityEl = document.querySelector('input[name="maturity"]:checked');
  var maturityVal = maturityEl ? maturityEl.nextElementSibling.textContent : 'Non √©valu√©';

  document.getElementById('summaryContent').innerHTML = '<div class="summary-grid">'
    + '<div class="summary-item"><div class="summary-item-title">Client</div><div class="summary-item-value">' + cn + '</div></div>'
    + '<div class="summary-item"><div class="summary-item-title">Contact</div><div class="summary-item-value">' + ct + '</div></div>'
    + '<div class="summary-item"><div class="summary-item-title">Secteur</div><div class="summary-item-value">' + sector + '</div></div>'
    + '<div class="summary-item"><div class="summary-item-title">Forme juridique</div><div class="summary-item-value">' + legal + '</div></div>'
    + '<div class="summary-item"><div class="summary-item-title">CA annuel HT</div><div class="summary-item-value">' + fmtNum(to) + ' ‚Ç¨</div></div>'
    + '<div class="summary-item"><div class="summary-item-title">Maturit√© num√©rique</div><div class="summary-item-value">' + maturityVal + '</div></div>'
    + '<div class="summary-item"><div class="summary-item-title">Missions</div><div class="summary-item-value">' + (missions.join(', ') || 'Aucune') + '</div></div>'
    + '</div>';

  // NPMQ display
  function npmqLabel(v) { return v === 'ok' ? '<span class="status ok">CONFORME</span>' : v === 'partial' || v === 'risk' ? '<span class="status warn">SOUS R√âSERVE</span>' : v === 'no' ? '<span class="status ko">NON CONFORME</span>' : '<span class="status warn">NON √âVALU√â</span>'; }
  document.getElementById('npmqScoreContent').innerHTML =
    '<div class="npmq-item"><div class="label">Comp√©tence</div><div>' + npmqLabel(npmq.competence) + '</div></div>'
    + '<div class="npmq-item"><div class="label">Ind√©pendance</div><div>' + npmqLabel(npmq.independance) + '</div></div>'
    + '<div class="npmq-item"><div class="label">Moyens</div><div>' + npmqLabel(npmq.moyens) + '</div></div>';
  document.getElementById('npmqScoreDisplay').style.display = 'block';

  // Risk display
  var riskColor = risk.total === 0 ? '#059669' : risk.total <= 4 ? '#1e3a5f' : risk.total <= 10 ? '#d97706' : '#dc2626';
  document.getElementById('riskScoreValue').textContent = risk.level;
  document.getElementById('riskScoreValue').style.color = riskColor;
  document.getElementById('riskScoreValue').style.webkitTextFillColor = riskColor;
  document.getElementById('riskScoreValue').style.background = 'none';
  document.getElementById('riskScoreDesc').textContent = risk.desc;
  document.getElementById('riskAxisDetail').innerHTML = 'Axe client : ' + risk.axe1 + ' pts | Axe g√©ographique : ' + risk.axe2 + ' pts | Axe op√©rations : ' + risk.axe3 + ' pts | Total : ' + risk.total + ' pts';
  document.getElementById('riskScoreDisplay').style.display = 'block';

  // Decision
  document.getElementById('decisionDisplay').innerHTML = '<div class="decision-box ' + dec.css + '"><h4>' + dec.decision + '</h4><p>' + dec.reason + '</p></div>';
  document.getElementById('decisionDisplay').style.display = 'block';
  document.getElementById('nextStepDisplay').style.display = dec.css === 'refuse' ? 'none' : 'block';

  showPanel('recap');
  toast('√âvaluation termin√©e ‚Äî D√©cision g√©n√©r√©e', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORMAT HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtNum(n) {
  if (n === null || n === undefined || isNaN(n)) return '0';
  var s = Math.abs(n).toFixed(0);
  var r = '';
  for (var i = s.length - 1, c = 0; i >= 0; i--, c++) {
    if (c > 0 && c % 3 === 0) r = ' ' + r;
    r = s[i] + r;
  }
  return (n < 0 ? '-' : '') + r;
}
function fmtDate(d) { if (!d) return '-'; var p = d.split('-'); return p.length === 3 ? p[2]+'.'+p[1]+'.'+p[0] : d; }
function fmtNow() { var d = new Date(); return String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+d.getFullYear()+' a '+String(d.getHours()).padStart(2,'0')+'h'+String(d.getMinutes()).padStart(2,'0'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF EXPORT (compact 2 pages) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF() {
  showLoading();
  setTimeout(function() {
    try {
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF('p', 'mm', 'a4');
      var pw = doc.internal.pageSize.getWidth(), ph = doc.internal.pageSize.getHeight();
      var m = 12, cw = pw - 2*m, y = 0, pn = 1;
      var P=[30,58,95], S=[13,148,136], OK=[5,150,105], KO=[220,38,38], WN=[217,119,6];

      function safe(t) {
        if(!t)return'';return String(t)
        .replace(/[\u{1F300}-\u{1FAFF}]/gu,'').replace(/[\u{2600}-\u{27BF}]/gu,'')
        .replace(/[\u00A0\u202F\u2007\u2009\u200A]/g,' ')
        .replace(/['']/g,"'").replace(/[""]/g,'"').replace(/[‚Ä¶]/g,'...').replace(/[‚Äì‚Äî]/g,'-')
        .replace(/\u00e9/g,'e').replace(/\u00e8/g,'e').replace(/\u00ea/g,'e').replace(/\u00eb/g,'e')
        .replace(/\u00e0/g,'a').replace(/\u00e2/g,'a').replace(/\u00e4/g,'a')
        .replace(/\u00f9/g,'u').replace(/\u00fb/g,'u').replace(/\u00fc/g,'u')
        .replace(/\u00ee/g,'i').replace(/\u00ef/g,'i').replace(/\u00f4/g,'o').replace(/\u00f6/g,'o')
        .replace(/\u00e7/g,'c').replace(/\u00c7/g,'C').replace(/\u00c9/g,'E').replace(/\u00c8/g,'E').replace(/\u00ca/g,'E')
        .replace(/\u00c0/g,'A').replace(/\u00c2/g,'A').replace(/\u20ac/g,'EUR').replace(/\u2265/g,'>=').replace(/\u2264/g,'<=').trim();
      }
      function footer() { doc.setDrawColor(180,180,180);doc.setLineWidth(0.2);doc.line(m,ph-12,pw-m,ph-12);doc.setFontSize(6.5);doc.setTextColor(130,130,130);doc.setFont('helvetica','normal');doc.text('Annexe 13 ‚Äî Questionnaire de Prise de Connaissance Client | Cabinet 100% num√©rique',m,ph-8);doc.text('Page '+pn+' | Genere le '+safe(fmtNow()),pw-m-55,ph-8); }
      function chk(need) { if(y+need>ph-18){footer();doc.addPage();pn++;y=12;} }
      function hdr(t,c) { chk(10);doc.setFillColor(c[0],c[1],c[2]);doc.rect(m,y,cw,8,'F');doc.setTextColor(255,255,255);doc.setFontSize(9);doc.setFont('helvetica','bold');doc.text(safe(t),m+3,y+5.5);y+=10;doc.setTextColor(0,0,0); }
      function sub(t) { chk(6);doc.setFontSize(8);doc.setFont('helvetica','bold');doc.setTextColor(P[0],P[1],P[2]);doc.text(safe(t),m,y);y+=4.5;doc.setTextColor(0,0,0); }
      function txt(t,sz) { sz=sz||7;doc.setFontSize(sz);doc.setFont('helvetica','normal');doc.setTextColor(50,50,50);var ls=doc.splitTextToSize(safe(t),cw);for(var i=0;i<ls.length;i++){chk(3.5);doc.text(ls[i],m,y);y+=3.5;} }
      function tbl(h,rows,w) {
        var tw=0;for(var i=0;i<w.length;i++)tw+=w[i];var rh=5,hh=6;chk(hh+rows.length*rh+2);
        doc.setFillColor(P[0],P[1],P[2]);doc.rect(m,y,tw,hh,'F');doc.setFontSize(7);doc.setFont('helvetica','bold');doc.setTextColor(255,255,255);
        var x=m;for(var i=0;i<h.length;i++){doc.text(safe(h[i]),x+2,y+4);x+=w[i];}y+=hh;
        for(var r=0;r<rows.length;r++){doc.setFillColor(r%2===0?248:255,r%2===0?250:255,r%2===0?252:255);doc.rect(m,y,tw,rh,'F');x=m;doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(40,40,40);for(var c=0;c<rows[r].length;c++){var ct=safe(String(rows[r][c]));var mx=w[c]-4;while(doc.getTextWidth(ct)>mx&&ct.length>3)ct=ct.slice(0,-1);doc.text(ct,x+2,y+3.5);x+=w[c];}y+=rh;}
        doc.setDrawColor(200,200,200);doc.setLineWidth(0.15);doc.rect(m,y-rows.length*rh-hh,tw,rows.length*rh+hh);y+=3;
      }
      function bul(items) { for(var i=0;i<items.length;i++){chk(3.5);doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(50,50,50);doc.text('  - '+safe(items[i]),m,y);y+=3.5;} }

      // Data collection
      var cn=document.getElementById('clientName').value||'-';
      var ct=document.getElementById('contactName').value||'-';
      var em=document.getElementById('email').value||'-';
      var ph2=document.getElementById('phone').value||'-';
      var si=document.getElementById('siret').value||'-';
      var naf=document.getElementById('naf').value||'-';
      var cd=document.getElementById('creationDate').value||'';
      var se=document.getElementById('sector');var sector=se.selectedIndex>0?se.options[se.selectedIndex].text:'-';
      var lf=document.getElementById('legalForm');var legal=lf.selectedIndex>0?lf.options[lf.selectedIndex].text:'-';
      var fr=document.getElementById('fiscalRegime');var fiscal=fr.selectedIndex>0?fr.options[fr.selectedIndex].text:'-';
      var tv=document.getElementById('tvaRegime');var tva=tv.selectedIndex>0?tv.options[tv.selectedIndex].text:'-';
      var fy=document.getElementById('fiscalYearEnd').value||'-';
      var sh=document.getElementById('shareholders').value||'0';
      var emp=document.getElementById('employees').value||'0';
      var to=parseFloat(document.getElementById('turnover').value||0);
      var gr=document.getElementById('growth').value||'0';
      var iv=document.getElementById('invoiceVolume').value||'0';
      var pv=document.getElementById('purchaseVolume').value||'0';
      var ai=parseFloat(document.getElementById('avgInvoice').value||0);
      var pd=document.getElementById('paymentDelay').value||'0';
      var risk=calculateRisk();
      var npmq=checkNPMQ();
      var dec=getDecision(npmq,risk);
      var rc=risk.total===0?OK:risk.total<=4?P:risk.total<=10?WN:KO;

      var missions=[];
      ['missionAccounting','missionReporting','missionAudit','missionDeclarations','missionPayroll','missionDaf','missionConsulting'].forEach(function(id){if(document.getElementById(id).checked)missions.push(safe(document.querySelector('label[for="'+id+'"]').textContent));});
      var matEl=document.querySelector('input[name="maturity"]:checked');var matV=matEl?safe(matEl.nextElementSibling.textContent):'Non evalue';
      var sup=document.querySelector('input[name="support"]:checked');var supV=sup?safe(sup.nextElementSibling.textContent):'-';
      var freq=document.querySelector('input[name="frequency"]:checked');var freqV=freq?safe(freq.nextElementSibling.textContent):'-';
      var sn=document.getElementById('specificNeeds').value||'';
      var funds=document.querySelector('input[name="funds"]:checked');var fundsV=funds?safe(funds.nextElementSibling.textContent):'-';
      var benef=document.getElementById('beneficiaries').value||'-';
      var rgpd=document.getElementById('rgpdConsent').checked?'Oui':'Non';
      var rgpdDate=document.getElementById('rgpdDate').value;

      // Docs
      var docs=[];
      if(document.getElementById('docKbis').checked)docs.push('Kbis');
      if(document.getElementById('docStatuts').checked)docs.push('Statuts');
      if(document.getElementById('docId').checked)docs.push('Pieces identite');
      if(document.getElementById('docProof').checked)docs.push('Justif. domicile');
      if(document.getElementById('docBenef').checked)docs.push('Benef. effectifs');
      if(document.getElementById('docRib').checked)docs.push('RIB');
      var missingDocs=[];
      if(!document.getElementById('docKbis').checked)missingDocs.push('Kbis');
      if(!document.getElementById('docStatuts').checked)missingDocs.push('Statuts');
      if(!document.getElementById('docId').checked)missingDocs.push('Pieces identite');
      if(!document.getElementById('docBenef').checked)missingDocs.push('Benef. effectifs (INPI)');

      // ‚ïê‚ïê‚ïê PAGE 1 ‚ïê‚ïê‚ïê
      doc.setFillColor(P[0],P[1],P[2]);doc.rect(0,0,pw,32,'F');
      doc.setTextColor(255,255,255);doc.setFontSize(16);doc.setFont('helvetica','bold');
      doc.text('ANNEXE 13 ‚Äî Questionnaire de Prise de Connaissance Client',m,12);
      doc.setFontSize(8);doc.setFont('helvetica','normal');
      doc.text('Cabinet 100% num√©rique | NPMQ ¬ß18-20 | LCB-FT art. L.561-4-1 CMF | RGPD',m,20);
      doc.text('Genere le : '+safe(fmtNow()),m,26);
      doc.text('Consentement RGPD : '+rgpd+(rgpdDate?' ('+fmtDate(rgpdDate)+')':''),pw-m-70,26);

      // Decision banner
      y=34;
      var decColor=dec.css==='accept'?OK:dec.css==='conditional'?WN:KO;
      doc.setFillColor(decColor[0],decColor[1],decColor[2]);doc.roundedRect(m,y,cw,10,1.5,1.5,'F');
      doc.setTextColor(255,255,255);doc.setFontSize(9);doc.setFont('helvetica','bold');
      doc.text('DECISION : '+safe(dec.decision),m+3,y+4.5);
      doc.setFontSize(7);doc.setFont('helvetica','normal');
      doc.text('Risque LCB-FT : '+safe(risk.level)+' ('+risk.total+' pts)',m+3,y+8);
      doc.text('NPMQ : Comp='+npmq.competence+' | Indep='+npmq.independance+' | Moyens='+npmq.moyens,pw-m-80,y+8);
      y+=14;

      hdr('1. IDENTIFICATION',P);
      tbl(['Element','Valeur'],[
        ['Raison sociale',safe(cn)],['Contact',safe(ct)],['Email / Tel',safe(em)+' | '+safe(ph2)],
        ['SIRET / NAF',safe(si)+' / '+safe(naf)],['Creation / Cloture',fmtDate(cd)+' / '+safe(fy)],
        ['Secteur',safe(sector)],['Forme juridique',safe(legal)],['Regime fiscal / TVA',safe(fiscal)+' / '+safe(tva)],
        ['Associes / Salaries',sh+' / '+emp],
        ['Maturite numerique',matV]
      ],[50,cw-50]);

      hdr('2. SITUATION FINANCIERE',S);
      tbl(['Indicateur','Valeur'],[
        ['CA annuel HT',fmtNum(to)+' EUR'],['Croissance',gr+' %'],
        ['Factures ventes/mois',iv],['Factures achats/mois',pv],
        ['Facture moyenne',fmtNum(ai)+' EUR'],['Delai paiement',pd+' jours']
      ],[50,cw-50]);

      hdr('3. BESOINS ET ATTENTES',[245,158,11]);
      tbl(['Critere','Valeur'],[['Support',supV],['Frequence',freqV],['Missions',missions.join(', ')||'-']],[50,cw-50]);
      if(sn.trim()){sub('Besoins specifiques');txt(sn);y+=1;}

      hdr('4. CONFORMITE LCB-FT (3 axes)',KO);
      tbl(['Axe','Score','Detail'],[
        ['Axe 1 - Client',String(risk.axe1)+' pts','PPE, structure complexe, beneficiaires'],
        ['Axe 2 - Geographique',String(risk.axe2)+' pts','Sanctions, GAFI, paradis fiscaux'],
        ['Axe 3 - Operations',String(risk.axe3)+' pts','Especes, crypto, operations atypiques'],
        ['TOTAL',String(risk.total)+' pts',safe(risk.level)]
      ],[45,25,cw-70]);

      tbl(['Element','Valeur'],[['Origine des fonds',fundsV],['Beneficiaires effectifs',safe(benef)]],[50,cw-50]);
      sub('Documents KYC');
      if(docs.length>0)bul(docs);else txt('Aucun document fourni');
      if(missingDocs.length>0){y+=1;doc.setFontSize(7);doc.setFont('helvetica','bold');doc.setTextColor(KO[0],KO[1],KO[2]);doc.text('A collecter : '+missingDocs.join(', '),m,y);y+=4;doc.setTextColor(0,0,0);}

      footer();

      // ‚ïê‚ïê‚ïê PAGE 2 ‚ïê‚ïê‚ïê
      doc.addPage();pn=2;y=12;

      hdr('5. VERIFICATION NPMQ (¬ß18-20)',P);
      tbl(['Critere','Statut','Commentaire'],[
        ['Competence (art. 145)',npmq.competence==='ok'?'CONFORME':npmq.competence==='partial'?'SOUS RESERVE':'NON CONFORME',safe(document.getElementById('compComment').value||'-')],
        ['Independance (art. 146)',npmq.independance==='ok'?'CONFORME':npmq.independance==='risk'?'SOUS RESERVE':'NON CONFORME',safe(document.getElementById('indepComment').value||'-')],
        ['Moyens (NPMQ ¬ß18-c)',npmq.moyens==='ok'?'CONFORME':npmq.moyens==='partial'?'SOUS RESERVE':'NON CONFORME',safe(document.getElementById('moyensComment').value||'-')]
      ],[40,28,cw-68]);

      y+=3;
      hdr('6. DECISION D\'ACCEPTATION',decColor);
      doc.setFillColor(decColor[0],decColor[1],decColor[2]);doc.roundedRect(m,y,cw,12,1.5,1.5,'F');
      doc.setTextColor(255,255,255);doc.setFontSize(12);doc.setFont('helvetica','bold');
      doc.text(safe(dec.decision),m+cw/2,y+5,{align:'center'});
      doc.setFontSize(7);doc.setFont('helvetica','normal');
      doc.text(safe(dec.reason),m+cw/2,y+10,{align:'center',maxWidth:cw-10});
      y+=16;doc.setTextColor(0,0,0);

      if(dec.css!=='refuse'){
        sub('Prochaines etapes');
        bul(['1. Finaliser la collecte des documents KYC manquants','2. Formaliser les diligences LCB-FT dans le dossier permanent','3. Pr√©parer et signer la lettre de mission (signature √©lectronique eIDAS)','4. Param√©trer les acc√®s client (portail, GED, API bancaire)','5. Lancer le processus d\'onboarding du nouveau client']);
      } else {
        sub('En cas de refus');
        bul(['1. Documenter le refus dans le dossier d\'entr√©e en relation','2. Informer le prospect par √©crit avec motif','3. Orienter vers un confr√®re si possible','4. Conserver le dossier 5 ans (art. L.561-12 CMF)']);
      }

      y+=6;sub('Conformite RGPD');
      txt('Consentement : '+rgpd+(rgpdDate?' le '+fmtDate(rgpdDate):'')+' | Conservation : 5 ans apr√®s fin de mission (10 ans pi√®ces comptables) | Droits : acc√®s, rectification, effacement, portabilit√© (art. 15-20 RGPD).');

      // Signatures
      y+=6;chk(28);
      doc.setFillColor(248,250,252);doc.rect(m,y,cw,26,'F');doc.setDrawColor(200,200,200);doc.setLineWidth(0.2);doc.rect(m,y,cw,26);
      doc.setFontSize(7);doc.setTextColor(80,80,80);doc.setFont('helvetica','bold');doc.text('SIGNATURES',m+3,y+4);
      doc.setFont('helvetica','normal');
      doc.text('Expert-comptable :',m+3,y+9);doc.text('Date : _______________',m+3,y+13);doc.text('Signature :',m+3,y+17);doc.line(m+25,y+22,m+70,y+22);
      doc.text('Client :',m+cw/2+3,y+9);doc.text('Date : _______________',m+cw/2+3,y+13);doc.text('Signature :',m+cw/2+3,y+17);doc.line(m+cw/2+25,y+22,m+cw/2+70,y+22);

      footer();
      var fn='Questionnaire_'+safe(cn).replace(/\s+/g,'_')+'_'+new Date().toISOString().split('T')[0]+'.pdf';
      doc.save(fn);
      hideLoading();toast('PDF g√©n√©r√© (2 pages) ‚Äî '+safe(dec.decision),'success');
    } catch(e) { console.error(e);hideLoading();toast('Erreur PDF : '+e.message,'error'); }
  },300);
}

function showLoading(){document.getElementById('loadingOverlay').classList.add('show');}
function hideLoading(){document.getElementById('loadingOverlay').classList.remove('show');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERSISTENCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveData() {
  var data={};document.querySelectorAll('input, select, textarea').forEach(function(el){
    if(el.type==='checkbox')data[el.id]=el.checked;
    else if(el.type==='radio'){if(el.checked)data[el.name]=el.value;}
    else data[el.id]=el.value;
  });localStorage.setItem(STORAGE_KEY,JSON.stringify(data));toast('Sauvegarde effectu√©e','success');
}
function loadData() {
  var s=localStorage.getItem(STORAGE_KEY);if(!s){toast('Aucune sauvegarde trouv√©e','error');return;}
  var d=JSON.parse(s);Object.keys(d).forEach(function(k){
    var el=document.getElementById(k)||document.querySelector('input[name="'+k+'"]');if(!el)return;
    if(el.type==='checkbox')el.checked=d[k];
    else if(el.type==='radio'){var r=document.querySelector('input[name="'+k+'"][value="'+d[k]+'"]');if(r)r.checked=true;}
    else el.value=d[k];
  });updateProgress();toast('Donn√©es charg√©es','success');
}
function resetForm() {
  if(!confirm('R√©initialiser le formulaire ?'))return;
  document.querySelectorAll('input, select, textarea').forEach(function(el){if(el.type==='checkbox'||el.type==='radio')el.checked=false;else el.value='';});
  localStorage.removeItem(STORAGE_KEY);updateProgress();showPanel('identification');toast('Formulaire r√©initialis√©','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAS PRATIQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadCasPratique() {
  document.getElementById('clientName').value='Cabinet X - Startup IA';
  document.getElementById('contactName').value='Monsieur X';
  document.getElementById('email').value='contact@cabinetx.fr';
  document.getElementById('phone').value='+33 6 12 34 56 78';
  document.getElementById('siret').value='12345678901234';
  document.getElementById('naf').value='6201Z';
  document.getElementById('creationDate').value='2025-01-15';
  document.getElementById('sector').value='tech';
  document.getElementById('description').value='Startup IA sp√©cialis√©e en comptabilit√© ‚Äî SaaS de reconnaissance automatique de factures. Mod√®le abonnement mensuel.';
  document.getElementById('legalForm').value='sasu';
  document.getElementById('fiscalRegime').value='reel-simple';
  document.getElementById('tvaRegime').value='mensuel';
  document.getElementById('fiscalYearEnd').value='31/12';
  document.getElementById('shareholders').value='2';
  document.getElementById('employees').value='5';
  document.getElementById('international').checked=true;
  document.getElementById('turnover').value='250000';
  document.getElementById('growth').value='150';
  document.getElementById('invoiceVolume').value='80';
  document.getElementById('purchaseVolume').value='40';
  document.getElementById('invoicingRetainer').checked=true;
  document.getElementById('avgInvoice').value='500';
  document.getElementById('paymentDelay').value='0';
  document.getElementById('toolPennylane').checked=true;
  document.getElementById('maturityHigh').checked=true;
  document.getElementById('missionAccounting').checked=true;
  document.getElementById('missionReporting').checked=true;
  document.getElementById('missionDaf').checked=true;
  document.getElementById('supportPremium').checked=true;
  document.getElementById('freqMonthly').checked=true;
  document.getElementById('specificNeeds').value='Pr√©paration lev√©e de fonds S√©rie A (2M‚Ç¨) ‚Äî Reporting investisseurs mensuel + contr√¥le de gestion avanc√©';
  document.getElementById('riskInternational').checked=true;
  document.getElementById('riskNewClient').checked=true;
  document.getElementById('fundsInvestment').checked=true;
  document.getElementById('beneficiaries').value='Monsieur X (75% capital), Co-fondateur Y (25% capital)';
  document.getElementById('docKbis').checked=true;
  document.getElementById('docStatuts').checked=true;
  document.getElementById('docId').checked=true;
  document.getElementById('compOk').checked=true;
  document.getElementById('compComment').value='Comp√©tences en comptabilit√© SaaS / start-up et reporting investisseurs ma√Ætris√©es.';
  document.getElementById('indepOk').checked=true;
  document.getElementById('indepComment').value='Aucun lien personnel, financier ou professionnel avec le client.';
  document.getElementById('moyensOk').checked=true;
  document.getElementById('moyensComment').value='Capacit√© disponible ‚Äî 1 collaborateur d√©di√© sur le dossier.';
  document.getElementById('rgpdConsent').checked=true;
  document.getElementById('rgpdDate').value=new Date().toISOString().split('T')[0];
  validateSiret();checkMissingDocs();updateProgress();
  toast('Cas pratique charg√© ‚Äî Cabinet X','success');
}

function toast(msg,type){type=type||'success';var el=document.getElementById('toast');el.textContent=msg;el.style.background=type==='success'?'linear-gradient(135deg,#059669,#047857)':'linear-gradient(135deg,#dc2626,#b91c1c)';el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2500);}
</script>
</body>
</html>
