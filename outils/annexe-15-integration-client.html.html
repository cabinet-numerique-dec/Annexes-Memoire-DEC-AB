<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annexe 15 ‚Äî Parcours d'int√©gration num√©rique du client [v7.0]</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--primary:#1e3a5f;--primary-light:#2d5a8a;--secondary:#0d9488;--secondary-light:#14b8a6;--accent:#f59e0b;--danger:#dc2626;--success:#059669;--warning:#d97706;--info:#2563eb;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--p1:#1e3a5f;--p2:#047857;--p3:#b45309;--p4:#7c3aed;--p5:#dc2626;--radius:12px;--shadow:0 4px 6px -1px rgb(0 0 0/.1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:linear-gradient(135deg,var(--gray-100),#e0e7ef);color:var(--gray-700);line-height:1.6;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:24px}
.header{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border-radius:var(--radius);padding:28px 32px;margin-bottom:24px;position:relative;overflow:hidden}
.header::before{content:"";position:absolute;top:-50%;right:-10%;width:300px;height:300px;background:rgba(255,255,255,.05);border-radius:50%}
.header h1{font-size:22px;font-weight:700;margin-bottom:6px;position:relative}
.header p{opacity:.9;font-size:13px;max-width:900px;position:relative}
.header-meta{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.15);padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600}
.back-link{display:inline-flex;align-items:center;gap:6px;color:rgba(255,255,255,.85);font-size:12px;text-decoration:none;margin-top:10px;padding:4px 10px;border:1px solid rgba(255,255,255,.3);border-radius:6px;transition:all .2s}
.back-link:hover{background:rgba(255,255,255,.15);color:#fff}
.client-section{background:#fff;border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow)}
.client-section h3{font-size:14px;font-weight:700;color:var(--gray-800);margin-bottom:12px}
.client-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px}
.client-row label{display:block;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.client-row input,.client-row select{width:100%;padding:8px 12px;border:2px solid var(--gray-200);border-radius:8px;font-size:13px;font-family:inherit}
.client-row input:focus,.client-row select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,58,95,.1)}
.profil-result{display:none;margin-top:14px;padding:16px 20px;background:var(--gray-50);border:2px solid var(--gray-200);border-radius:var(--radius)}
.profil-result.show{display:block}
.profil-kpis{display:flex;gap:24px;flex-wrap:wrap;margin-bottom:8px}
.profil-kpi{text-align:center}.profil-kpi-val{font-size:20px;font-weight:800;color:var(--primary)}.profil-kpi-lbl{font-size:10px;color:var(--gray-500);margin-top:2px}
.profil-alerts{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.profil-alert{font-size:12px;padding:8px 12px;border-radius:8px;line-height:1.4}
.profil-alert.red{background:#fee2e2;color:#991b1b;border-left:3px solid var(--danger)}
.profil-alert.orange{background:#fef3c7;color:#92400e;border-left:3px solid var(--accent)}
.profil-alert.blue{background:#dbeafe;color:#1e40af;border-left:3px solid var(--info)}
.profil-alert.purple{background:#ede9fe;color:#5b21b6;border-left:3px solid #7c3aed}
.profil-echeancier{font-size:11px;color:var(--gray-600);margin-top:8px;padding-top:8px;border-top:1px solid var(--gray-200)}

/* DASHBOARD */
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px}
.dash-card{background:#fff;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);text-align:center;border-top:3px solid var(--gray-300);transition:all .3s}
.dash-card.ok{border-top-color:var(--success)}.dash-card.warn{border-top-color:var(--warning)}.dash-card.err{border-top-color:var(--danger)}.dash-card.info{border-top-color:var(--info)}
.dash-val{font-size:24px;font-weight:800;line-height:1}.dash-lbl{font-size:10px;color:var(--gray-500);margin-top:4px}.dash-sub{font-size:9px;margin-top:2px;font-weight:600}
.dash-sub.green{color:var(--success)}.dash-sub.orange{color:var(--warning)}.dash-sub.red{color:var(--danger)}

/* ALERT BANNER */
.alert-banner{padding:12px 18px;border-radius:var(--radius);margin-bottom:16px;font-size:13px;font-weight:600;display:none;align-items:center;gap:10px}
.alert-banner.show{display:flex}
.alert-banner.err{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
.alert-banner.warn{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
.alert-banner.ok{background:#dcfce7;color:#166534;border:1px solid #86efac}

.action-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-light)}
.btn-secondary{background:var(--gray-200);color:var(--gray-700)}.btn-secondary:hover{background:var(--gray-300)}
.btn-warning{background:var(--accent);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-sm{padding:6px 14px;font-size:12px}
.tabs{display:flex;gap:3px;background:#fff;padding:6px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:20px;flex-wrap:wrap}
.tab{padding:10px 16px;border:none;background:transparent;font-size:13px;font-weight:600;color:var(--gray-600);border-radius:8px;cursor:pointer;transition:all .2s;white-space:nowrap}
.tab:hover{background:var(--gray-100)}.tab.active{background:var(--primary);color:#fff}
.panel{display:none;animation:fadeIn .3s ease}.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card{background:#fff;border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);margin-bottom:18px}
.card-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--gray-200)}
.card-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;flex-shrink:0}
.card h3{font-size:17px;font-weight:700;color:var(--gray-800)}
.card .subtitle{color:var(--gray-500);font-size:12px;margin-top:2px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px}
table{width:100%;border-collapse:collapse;margin:12px 0;font-size:13px}
th{background:var(--primary);color:#fff;padding:10px 12px;text-align:left;font-weight:600;font-size:12px}
th:first-child{border-radius:8px 0 0 0}th:last-child{border-radius:0 8px 0 0}
td{padding:10px 12px;border-bottom:1px solid var(--gray-200);vertical-align:top}
tr:hover{background:var(--gray-50)}
.st{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:600}
.st-ok{background:#d1fae5;color:var(--success)}.st-warn{background:#fef3c7;color:var(--warning)}.st-err{background:#fee2e2;color:var(--danger)}.st-info{background:#dbeafe;color:var(--info)}.st-p{background:#ede9fe;color:#7c3aed}
.info-box{padding:14px 18px;border-radius:0 10px 10px 0;margin:14px 0;font-size:13px;line-height:1.5}
.info-box.info{background:#eff6ff;border-left:4px solid var(--info)}.info-box.warn{background:#fef3c7;border-left:4px solid var(--accent)}.info-box.ok{background:#ecfdf5;border-left:4px solid var(--success)}.info-box.err{background:#fee2e2;border-left:4px solid var(--danger)}
.info-box strong{display:block;margin-bottom:4px;color:var(--gray-800)}
.phase-card{background:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border-left:4px solid;transition:all .2s}
.phase-card:hover{transform:translateY(-2px)}
.phase-card h4{font-size:14px;font-weight:700;margin-bottom:6px}.phase-card p{font-size:12px;color:var(--gray-600)}
.phase-period{font-size:11px;font-weight:600;color:var(--gray-500);margin-bottom:4px}
.phase-actions{font-size:11px;color:var(--gray-500);margin-top:6px;font-style:italic}
.phase-tags{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}

/* CHECKLIST */
.check-section{margin-bottom:18px}
.check-header{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--radius) var(--radius) 0 0;color:#fff;font-weight:700;font-size:14px}
.check-header.p1{background:var(--p1)}.check-header.p2{background:var(--p2)}.check-header.p3{background:var(--p3)}.check-header.p4{background:var(--p4)}.check-header.p5{background:var(--p5)}
.check-header .prog{margin-left:auto;font-size:12px;font-weight:500;opacity:.9}
.check-body{background:#fff;border-radius:0 0 var(--radius) var(--radius);box-shadow:var(--shadow);padding:8px}
.check-item{display:flex;align-items:flex-start;gap:12px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent}
.check-item:hover{background:var(--gray-50);border-color:var(--gray-200)}
.check-item.done{background:#ecfdf5;border-color:#a7f3d0}
.check-item.done .ci-title{opacity:.85}
.check-item.blocked{opacity:.5;cursor:not-allowed;background:#f9fafb}
.check-item.blocked:hover{background:#f9fafb;border-color:transparent}
.check-box{width:20px;height:20px;border:2px solid var(--gray-300);border-radius:5px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;font-size:12px;font-weight:700;color:#fff;transition:all .2s}
.check-item.done .check-box{background:var(--success);border-color:var(--success)}
.check-item.blocked .check-box{background:var(--gray-200);border-color:var(--gray-300)}
.ci-title{font-size:13px;font-weight:600;color:var(--gray-800)}.ci-desc{font-size:11px;color:var(--gray-500);margin-top:2px}
.ci-ref{font-size:10px;color:var(--gray-500);font-style:italic;margin-top:3px}
.ci-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.ci-tag{font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600}
.ci-tag-r{background:#fee2e2;color:#991b1b}.ci-tag-b{background:#dbeafe;color:#1e40af}.ci-tag-g{background:#dcfce7;color:#166534}.ci-tag-p{background:#ede9fe;color:#6d28d9}
.ci-lock{font-size:10px;color:var(--danger);font-weight:600;margin-top:3px}
.progress-bg{background:var(--gray-200);border-radius:10px;height:10px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--secondary),var(--secondary-light));border-radius:10px;transition:width .5s ease}

/* BILAN */
.bilan-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
.bilan-card{background:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border-left:4px solid var(--gray-300)}
.bilan-card.ok{border-left-color:var(--success)}.bilan-card.warn{border-left-color:var(--warning)}.bilan-card.err{border-left-color:var(--danger)}
.bilan-card h4{font-size:13px;font-weight:700;color:var(--gray-800);margin-bottom:8px}
.bilan-help-btn{background:none;border:none;color:var(--info);font-size:11px;font-weight:600;cursor:pointer;padding:6px 0 0;text-decoration:underline;text-underline-offset:2px}
.bilan-help-btn:hover{color:var(--primary)}
.bilan-help{display:none;margin-top:8px;padding:10px 12px;background:var(--gray-50);border-radius:8px;border:1px solid var(--gray-200)}
.bilan-help.show{display:block}
.bh-row{display:flex;gap:8px;font-size:11px;padding:4px 0;border-bottom:1px solid var(--gray-100);align-items:flex-start}
.bh-row:last-child{border-bottom:none}
.bh-label{flex-shrink:0;width:52px;font-weight:700;color:var(--primary);font-size:10px;text-transform:uppercase;letter-spacing:.3px;padding-top:1px}
.bilan-val{font-size:28px;font-weight:800;line-height:1;margin-bottom:4px}
.bilan-target{font-size:11px;color:var(--gray-500)}
.bilan-status{font-size:11px;font-weight:700;margin-top:6px;padding:3px 8px;border-radius:12px;display:inline-block}
.bilan-status.ok{background:#dcfce7;color:#166534}.bilan-status.warn{background:#fef3c7;color:#92400e}.bilan-status.err{background:#fee2e2;color:#991b1b}
.bilan-input{width:100%;padding:8px;border:2px solid var(--gray-200);border-radius:8px;font-size:14px;font-weight:700;text-align:center;margin-bottom:6px;font-family:inherit}
.bilan-input:focus{outline:none;border-color:var(--primary)}
.diagnostic-box{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-top:18px;border-left:4px solid var(--primary)}
.diagnostic-box h4{font-size:15px;font-weight:700;color:var(--gray-800);margin-bottom:10px}
.diag-line{font-size:12px;padding:6px 0;border-bottom:1px solid var(--gray-100);display:flex;justify-content:space-between;align-items:center}
.diag-line:last-child{border-bottom:none}

/* TIMELINE */
.timeline{position:relative;padding-left:30px}.timeline::before{content:"";position:absolute;left:10px;top:0;bottom:0;width:2px;background:linear-gradient(var(--p1),var(--p2),var(--p3),var(--p4),var(--p5))}
.timeline-item{position:relative;padding-bottom:20px}.timeline-item::before{content:"";position:absolute;left:-24px;top:4px;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:var(--shadow)}
.timeline-item.p1::before{background:var(--p1)}.timeline-item.p2::before{background:var(--p2)}.timeline-item.p3::before{background:var(--p3)}.timeline-item.p4::before{background:var(--p4)}.timeline-item.p5::before{background:var(--p5)}
.timeline-date{font-size:11px;font-weight:600;margin-bottom:3px}
.timeline-title{font-size:14px;font-weight:600;color:var(--gray-800);margin-bottom:3px}
.timeline-desc{font-size:12px;color:var(--gray-600)}

.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}
.legal-ref{font-size:10px;color:var(--gray-500);margin-top:6px;font-style:italic}
.toast{position:fixed;bottom:24px;right:24px;background:var(--gray-800);color:#fff;padding:12px 18px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.2);transform:translateY(100px);opacity:0;transition:all .3s;z-index:9999;font-size:13px;font-weight:500}
.toast.show{transform:translateY(0);opacity:1}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:99999;display:none;align-items:center;justify-content:center}
.loading-overlay.show{display:flex}
.loading-content{background:#fff;padding:32px;border-radius:16px;text-align:center;min-width:280px}
.spinner{width:40px;height:40px;margin:0 auto 16px;border:3px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.container{padding:14px}.header h1{font-size:17px}.grid,.form-row,.client-row,.dashboard{grid-template-columns:1fr}}
@media print{.tabs,.action-bar,.btn,.back-link{display:none!important}.panel{display:block!important}.card{box-shadow:none;border:1px solid #ddd}}

/* GUIDE ACTION PANEL */
.guide-panel{display:none;background:var(--gray-50);border:2px solid var(--gray-200);border-radius:0 0 10px 10px;margin:-1px 0 0 0;padding:18px 20px;animation:fadeIn .3s ease}
.guide-panel.open{display:block}
.guide-section{margin-bottom:14px}
.guide-section:last-child{margin-bottom:0}
.guide-label{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.guide-label .gl-icon{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;flex-shrink:0}
.guide-steps{counter-reset:gs;padding:0;margin:0;list-style:none}
.guide-steps li{counter-increment:gs;font-size:12px;color:var(--gray-700);padding:5px 0 5px 28px;position:relative;line-height:1.5;border-bottom:1px solid var(--gray-100)}
.guide-steps li:last-child{border-bottom:none}
.guide-steps li::before{content:counter(gs);position:absolute;left:0;top:5px;width:20px;height:20px;background:var(--primary);color:#fff;border-radius:50%;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center}
.guide-text{font-size:12px;color:var(--gray-600);line-height:1.5}
.guide-tool-badge{display:inline-flex;align-items:center;gap:5px;background:#dbeafe;color:#1e40af;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;margin-top:4px}
.guide-unlock{font-size:12px;color:var(--success);font-weight:600;padding:8px 12px;background:#ecfdf5;border-radius:8px;border-left:3px solid var(--success)}
.guide-tip{font-size:12px;color:#92400e;padding:8px 12px;background:#fef3c7;border-radius:8px;border-left:3px solid var(--accent);font-style:italic}
.guide-meta{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
.guide-meta-item{font-size:11px;color:var(--gray-500);display:flex;align-items:center;gap:4px}
.guide-toggle{background:none;border:1px solid var(--gray-300);border-radius:6px;padding:3px 8px;font-size:10px;font-weight:600;color:var(--primary);cursor:pointer;transition:all .2s;margin-left:auto;flex-shrink:0}
.guide-toggle:hover{background:var(--primary);color:#fff}
.check-item .ci-top{display:flex;align-items:flex-start;gap:12px;width:100%}

/* NEXT ACTION WIDGET */
.next-action{background:#fff;border-radius:var(--radius);padding:16px 20px;box-shadow:var(--shadow);margin-bottom:16px;border-left:4px solid var(--accent);display:none}
.next-action.show{display:block}
.next-action-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.next-action-header span:first-child{font-size:16px}
.next-action-header strong{font-size:13px;color:var(--gray-800)}
.next-action-task{font-size:14px;font-weight:700;color:var(--primary);margin-bottom:4px}
.next-action-why{font-size:12px;color:var(--gray-600);line-height:1.4}
.next-action-btn{display:inline-flex;align-items:center;gap:5px;margin-top:8px;padding:6px 14px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.next-action-btn:hover{background:#d97706}

/* PHASE COMPLETION */
.phase-complete-msg{padding:12px 16px;border-radius:8px;margin:6px;font-size:12px;line-height:1.5;display:none}
.phase-complete-msg.show{display:block}
.phase-complete-msg.done{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46}
.phase-complete-msg .pcm-title{font-weight:700;font-size:13px;margin-bottom:4px}
.phase-complete-msg .pcm-next{font-weight:600;color:var(--primary);margin-top:6px}

/* (vigilance is rendered inline in profil) */
</style>
</head>
<body>
<div class="container">

<div class="header">
  <h1>Annexe 15 ‚Äî Parcours d'int√©gration num√©rique du client</h1>
  <p>R√©f√©rentiel op√©rationnel de l'entr√©e en relation d'affaires ‚Äî cinq phases, vingt-quatre t√¢ches, conformit√© LCB-FT, NPMQ, NPLAB et RGPD.</p>
  <div class="header-meta">
    <span class="badge">5 phases | J-7 √† J+30</span>
    <span class="badge">24 t√¢ches</span>
    <span class="badge">LCB-FT | NPLAB | NPMQ ¬ß26-28</span>
    <span class="badge">RGPD</span>
  </div>
  
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IDENTIFICATION CLIENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="client-section">
  <h3>Identification du client et profil d'int√©gration</h3>
  <div class="client-row">
    <div><label>Client *</label><input type="text" id="clientName" placeholder="Ex : SAS TechShop"></div>
    <div><label>Date de d√©but</label><input type="date" id="startDate"></div>
    <div><label>Collaborateur r√©f√©rent</label><input type="text" id="referent" placeholder="Nom du collaborateur"></div>
    <div><label>Type de structure *</label><select id="simType"><option value="">-- S√©lectionner --</option><option value="ei">Entreprise individuelle</option><option value="eurl">EURL / SASU</option><option value="sarl">SARL / SAS</option><option value="sci">SCI / Soci√©t√© civile</option><option value="association">Association</option></select></div>
    <div><label>Maturit√© num√©rique *</label><select id="simDigital"><option value="">-- S√©lectionner --</option><option value="debutant">D√©butant</option><option value="intermediaire">Interm√©diaire</option><option value="avance">Avanc√©</option></select></div>
    <div><label>Risque LAB *</label><select id="simRisk"><option value="">-- S√©lectionner --</option><option value="faible">Faible</option><option value="normal">Normal</option><option value="eleve">√âlev√©</option></select></div>
  </div>
  <div class="profil-result" id="profilResult">
    <div class="profil-kpis" id="profilKpis"></div>
    <div class="profil-alerts" id="profilAlerts"></div>
    <div class="profil-echeancier" id="profilEcheancier"></div>
    <!-- KYC + Vigilance contextuel -->
    <div id="profilRegZone" style="display:none;margin-top:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div style="background:#fff;border-radius:10px;padding:14px 16px;border:1px solid var(--gray-200)">
          <div style="font-weight:700;font-size:13px;color:var(--gray-800);margin-bottom:8px">üìã Documents KYC requis ‚Äî <span id="kycStructLabel"></span></div>
          <div id="kycDocsList"></div>
        </div>
        <div style="background:#fff;border-radius:10px;padding:14px 16px;border:1px solid var(--gray-200)">
          <div style="font-weight:700;font-size:13px;color:var(--gray-800);margin-bottom:8px">‚ö° Niveau de vigilance applicable</div>
          <div id="vigPanel"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD AUTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="dashboard" id="dashboard">
  <div class="dash-card" id="dashProg"><div class="dash-val" id="dashProgVal">0 %</div><div class="dash-lbl">Progression globale</div><div class="dash-sub" id="dashProgSub">0/24 t√¢ches</div></div>
  <div class="dash-card" id="dashConf"><div class="dash-val" id="dashConfVal">0 %</div><div class="dash-lbl">T√¢ches obligatoires</div><div class="dash-sub" id="dashConfSub">0/10 items obligatoires</div></div>
  <div class="dash-card" id="dashDocs"><div class="dash-val" id="dashDocsVal">‚Äî</div><div class="dash-lbl">Documents collect√©s</div><div class="dash-sub" id="dashDocsSub">Renseigner le profil</div></div>
  <div class="dash-card" id="dashJours"><div class="dash-val" id="dashJoursVal">‚Äî</div><div class="dash-lbl">Jours √©coul√©s / cible</div><div class="dash-sub" id="dashJoursSub">‚Äî</div></div>
  <div class="dash-card" id="dashPhase"><div class="dash-val" id="dashPhaseVal">‚Äî</div><div class="dash-lbl">Phase en cours</div><div class="dash-sub" id="dashPhaseSub">‚Äî</div></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEXT ACTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="next-action" id="nextAction">
  <div class="next-action-header"><span>üéØ</span><strong>Prochaine action recommand√©e</strong></div>
  <div class="next-action-task" id="nextActionTask"></div>
  <div class="next-action-why" id="nextActionWhy"></div>
  <button class="next-action-btn" id="nextActionBtn" onclick="jumpToNextAction()">Voir la t√¢che ‚Üí</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ALERT BANNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="alert-banner" id="alertBanner"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="action-bar">
  <button class="btn btn-primary" onclick="exportPDF()">Exporter PDF (preuve dossier permanent)</button>
  <button class="btn btn-warning" onclick="loadCasPratique()">Cas pratique Cabinet X</button>
  <button class="btn btn-secondary" onclick="exportJSON()">Sauvegarder (.json)</button>
  <label class="btn btn-secondary" style="margin:0"><input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">Restaurer (.json)</label>
  <button class="btn btn-danger btn-sm" onclick="resetAll()" style="margin-left:auto">R√©initialiser</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tabs">
  <button class="tab active" data-panel="checklist">Checklist (24 t√¢ches)</button>
  <button class="tab" data-panel="bilan">Bilan post-onboarding</button>
  <button class="tab" data-panel="howto">Mode op√©ratoire</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê 1. CHECKLIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="checklist" class="panel active">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;font-size:13px">Progression globale</span><span id="progText" style="font-weight:700;color:var(--primary);font-size:14px">0/24 ‚Äî 0 %</span></div>
  <div class="progress-bg"><div id="progBar" class="progress-fill" style="width:0%"></div></div>
  <div id="checklistContainer" style="margin-top:16px"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê 2. BILAN POST-ONBOARDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="bilan" class="panel">
  <div class="info-box info"><strong>Bilan √† J+30 :</strong> Saisir les r√©sultats constat√©s √† partir des sources identifi√©es. Cliquer sur ¬´ Comment mesurer ? ¬ª sous chaque indicateur pour acc√©der √† la source de donn√©es, la m√©thode de calcul et un exemple concret. Le diagnostic se g√©n√®re automatiquement.</div>
  <div class="bilan-grid" id="bilanGrid">
    <div class="bilan-card" id="bc1">
      <h4>Taux d'adoption des outils</h4>
      <input type="number" class="bilan-input" id="bAdopt" min="0" max="100" placeholder="‚Äî" oninput="updBilan()">
      <div class="bilan-target">Cible : &gt; 80 %</div>
      <div id="bAdoptSt"></div>
      <button class="bilan-help-btn" onclick="this.nextElementSibling.classList.toggle('show')">Comment mesurer ?</button>
      <div class="bilan-help">
        <div class="bh-row"><span class="bh-label">Source</span><span>Tableau de bord du logiciel de production (ex : Pennylane, Dext, MyCompanyFiles)</span></div>
        <div class="bh-row"><span class="bh-label">Calcul</span><span>(Nombre de documents d√©pos√©s via le portail √∑ Total des documents attendus sur la p√©riode) √ó 100</span></div>
        <div class="bh-row"><span class="bh-label">Exemple</span><span>34 factures d√©pos√©es via Dext sur 40 attendues = <strong>85 %</strong></span></div>
        <div class="bh-row"><span class="bh-label">Quand</span><span>√Ä J+30, extraire le rapport d'activit√© du portail client sur les 30 premiers jours</span></div>
      </div>
    </div>
    <div class="bilan-card" id="bc2">
      <h4>D√©lai moyen de d√©p√¥t</h4>
      <input type="number" class="bilan-input" id="bDelai" min="0" placeholder="‚Äî" oninput="updBilan()">
      <div class="bilan-target">Cible : &lt; 48 heures</div>
      <div id="bDelaiSt"></div>
      <button class="bilan-help-btn" onclick="this.nextElementSibling.classList.toggle('show')">Comment mesurer ?</button>
      <div class="bilan-help">
        <div class="bh-row"><span class="bh-label">Source</span><span>Historique des d√©p√¥ts dans l'outil de collecte (Dext, AutoEntry, portail cabinet)</span></div>
        <div class="bh-row"><span class="bh-label">Calcul</span><span>Moyenne de (Date de d√©p√¥t sur le portail ‚àí Date de la pi√®ce) sur les 30 derniers jours, en heures</span></div>
        <div class="bh-row"><span class="bh-label">Exemple</span><span>Facture dat√©e du 03/03, d√©pos√©e le 04/03 √† 12h = 36h. Moyenne sur 30 factures = <strong>36 h</strong></span></div>
        <div class="bh-row"><span class="bh-label">Quand</span><span>√Ä J+30, exporter l'historique de d√©p√¥t et calculer la moyenne des d√©lais</span></div>
      </div>
    </div>
    <div class="bilan-card" id="bc3">
      <h4>Satisfaction client</h4>
      <input type="number" class="bilan-input" id="bSat" min="0" max="5" step="0.1" placeholder="‚Äî" oninput="updBilan()">
      <div class="bilan-target">Cible : &gt; 4/5</div>
      <div id="bSatSt"></div>
      <button class="bilan-help-btn" onclick="this.nextElementSibling.classList.toggle('show')">Comment mesurer ?</button>
      <div class="bilan-help">
        <div class="bh-row"><span class="bh-label">Source</span><span>Questionnaire de satisfaction envoy√© √† J+25 (Google Forms, Typeform, ou module CRM)</span></div>
        <div class="bh-row"><span class="bh-label">Calcul</span><span>Note moyenne sur 5, bas√©e sur 3 √† 5 questions : r√©activit√©, clart√©, prise en main outils, satisfaction globale</span></div>
        <div class="bh-row"><span class="bh-label">Exemple</span><span>R√©activit√© 5/5, Clart√© 4/5, Outils 4/5, Global 5/5 ‚Üí Moyenne = <strong>4.5/5</strong></span></div>
        <div class="bh-row"><span class="bh-label">Quand</span><span>Envoyer le questionnaire entre J+25 et J+28, relire les r√©sultats √† J+30</span></div>
      </div>
    </div>
    <div class="bilan-card" id="bc4">
      <h4>Retards d√©claratifs (3 mois)</h4>
      <input type="number" class="bilan-input" id="bRetard" min="0" placeholder="‚Äî" oninput="updBilan()">
      <div class="bilan-target">Cible : 0</div>
      <div id="bRetardSt"></div>
      <button class="bilan-help-btn" onclick="this.nextElementSibling.classList.toggle('show')">Comment mesurer ?</button>
      <div class="bilan-help">
        <div class="bh-row"><span class="bh-label">Source</span><span>Tableau de suivi des obligations d√©claratives du cabinet (agenda fiscal, outil de production)</span></div>
        <div class="bh-row"><span class="bh-label">Calcul</span><span>Nombre de d√©clarations d√©pos√©es apr√®s l'√©ch√©ance l√©gale sur les 3 premiers mois de la mission</span></div>
        <div class="bh-row"><span class="bh-label">Exemple</span><span>TVA de mars d√©pos√©e le 24/04 (√©ch√©ance 20/04) = 1 retard. Si aucun retard = <strong>0</strong></span></div>
        <div class="bh-row"><span class="bh-label">Quand</span><span>√Ä J+90, v√©rifier l'historique des d√©p√¥ts vs. les √©ch√©ances l√©gales sur 3 mois glissants</span></div>
      </div>
    </div>
  </div>
  <div class="diagnostic-box" id="diagBox" style="display:none">
    <h4>Diagnostic automatique</h4>
    <div id="diagContent"></div>
  </div>
  <div class="card" style="margin-top:18px">
    <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,var(--primary),var(--primary-light))">üìã</div><div><h3>R√©f√©rentiel de preuves par phase</h3></div></div>
    <table><thead><tr><th>Phase</th><th>Point de contr√¥le</th><th>Preuve attendue</th><th>Risque couvert</th></tr></thead><tbody>
      <tr><td><span class="st st-err">1</span></td><td>Contractualisation</td><td>LM sign√©e + dossier KYC (Annexes 13+14)</td><td>Non-conformit√© entr√©e en relation</td></tr>
      <tr><td><span class="st st-ok">2</span></td><td>Acc√®s et habilitations</td><td>Comptes cr√©√©s + droits + journalisation</td><td>Rupture secret professionnel</td></tr>
      <tr><td><span class="st st-warn">3</span></td><td>Premier d√©p√¥t valid√©</td><td>Trace d√©p√¥t + affectation GED</td><td>Non-adoption / erreurs de flux</td></tr>
      <tr><td><span class="st st-p">4</span></td><td>Rythme stabilis√©</td><td>Indicateur r√©gularit√© + plan correction</td><td>Relances / retard d√©claratif</td></tr>
      <tr><td><span class="st st-info">5</span></td><td>Mise en r√©gime</td><td>Validation autonomie + bilan KPIs</td><td>Charge support / insatisfaction</td></tr>
    </tbody></table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê 4. MODE OP√âRATOIRE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="howto" class="panel">
  <div class="card">
    <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,var(--secondary),var(--secondary-light))">üìñ</div><div><h3>Comment utiliser cet outil</h3></div></div>
    <div class="timeline">
      <div class="timeline-item p1"><div class="timeline-date" style="color:var(--p1)">√âtape 1 ‚Äî Identification</div><div class="timeline-title">Renseigner le client et son profil</div><div class="timeline-desc">Compl√©ter le nom, la date, le r√©f√©rent, le type de structure, la maturit√© num√©rique et le risque LAB. Le profil adapte automatiquement la dur√©e, les alertes et les documents KYC requis.</div></div>
      <div class="timeline-item p2"><div class="timeline-date" style="color:var(--p2)">√âtape 2 ‚Äî Conformit√©</div><div class="timeline-title">V√©rifier les obligations d'entr√©e en relation</div><div class="timeline-desc">Consulter l'onglet Conformit√© pour les diligences KYC, LCB-FT et RGPD. Les items obligatoires de la Phase 1 doivent √™tre compl√©t√©s avant de pouvoir avancer.</div></div>
      <div class="timeline-item p3"><div class="timeline-date" style="color:var(--p3)">√âtape 3 ‚Äî Checklist</div><div class="timeline-title">D√©rouler les 24 t√¢ches phase par phase</div><div class="timeline-desc">Cocher chaque t√¢che au fur et √† mesure. Les phases suivantes sont d√©bloqu√©es lorsque les items obligatoires de la phase pr√©c√©dente sont compl√©t√©s. Le tableau de bord se met √† jour en temps r√©el.</div></div>
      <div class="timeline-item p4"><div class="timeline-date" style="color:var(--p4)">√âtape 4 ‚Äî Bilan</div><div class="timeline-title">√âvaluer les r√©sultats √† J+30</div><div class="timeline-desc">Saisir les 4 indicateurs post-onboarding dans l'onglet Bilan. Le diagnostic automatique compare chaque r√©sultat √† sa cible et g√©n√®re des recommandations.</div></div>
      <div class="timeline-item p5"><div class="timeline-date" style="color:var(--p5)">√âtape 5 ‚Äî Archivage</div><div class="timeline-title">Exporter la preuve pour le dossier permanent</div><div class="timeline-desc">Le PDF horodat√© int√®gre le profil client, la checklist compl√®te, le statut de conformit√©, le bilan KPIs et le diagnostic. Conservation 5 ans min. (art. L561-12 CMF).</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,var(--info),#3b82f6)">üîó</div><div><h3>R√©f√©rences</h3></div></div>
    <table><thead><tr><th>Source</th><th>Objet</th><th>Lien</th></tr></thead><tbody>
      <tr><td>L√©gifrance</td><td>Art. L561-5 CMF ‚Äî obligations de vigilance</td><td style="font-size:11px"><a href="https://www.legifrance.gouv.fr" target="_blank" rel="noopener">legifrance.gouv.fr</a></td></tr>
      <tr><td>TRACFIN</td><td>Lignes directrices professions du chiffre</td><td style="font-size:11px"><a href="https://www.economie.gouv.fr/tracfin" target="_blank" rel="noopener">economie.gouv.fr/tracfin</a></td></tr>
      <tr><td>CNIL</td><td>Guide pratique RGPD</td><td style="font-size:11px"><a href="https://www.cnil.fr/fr/rgpd-de-quoi-parle-t-on" target="_blank" rel="noopener">cnil.fr</a></td></tr>
      <tr><td>CNOEC</td><td>NPMQ, NPLAB</td><td style="font-size:11px"><a href="https://www.experts-comptables.fr" target="_blank" rel="noopener">experts-comptables.fr</a></td></tr>
      <tr><td>INPI</td><td>Registre b√©n√©ficiaires effectifs</td><td style="font-size:11px"><a href="https://data.inpi.fr" target="_blank" rel="noopener">data.inpi.fr</a></td></tr>
      <tr><td>DGFiP</td><td>Facturation √©lectronique 2026</td><td style="font-size:11px"><a href="https://www.impots.gouv.fr/facturation-electronique" target="_blank" rel="noopener">impots.gouv.fr</a></td></tr>
      <tr><td>ANSSI</td><td>Guide s√©curit√© num√©rique</td><td style="font-size:11px"><a href="https://www.ssi.gouv.fr" target="_blank" rel="noopener">ssi.gouv.fr</a></td></tr>
    </tbody></table>
  </div>
</div>

</div>
<div id="loadingOverlay" class="loading-overlay"><div class="loading-content"><div class="spinner"></div><div style="font-size:15px;font-weight:600;color:var(--gray-700)">G√©n√©ration PDF‚Ä¶</div></div></div>
<div id="toast" class="toast"></div>

<script>
var PHASES=[
  {id:1,name:"Pr√©-onboarding",color:"p1",items:[
    {id:"p1_1",title:"Qualification NPMQ valid√©e (Annexe 13)",desc:"Fiche de qualification compl√®te, risque √©valu√©, d√©cision d'acceptation document√©e.",ref:"NPMQ ¬ß26-28 ; Art. L561-4-1 CMF ; NPLAB",tags:[["Obligatoire","r"],["Annexe 13","b"]],mandatory:true},
    {id:"p1_2",title:"Pi√®ces KYC collect√©es",desc:"CNI/passeport, Kbis < 3 mois ou extrait RNE (EI), statuts, b√©n√©ficiaires effectifs (registre INPI).",ref:"Art. L561-5 CMF ; Art. L561-2-2 CMF",tags:[["Obligatoire","r"],["KYC","r"]],mandatory:true},
    {id:"p1_3",title:"Lettre de mission sign√©e (Annexe 14)",desc:"LM sign√©e √©lectroniquement (AES minimum), p√©rim√®tre et honoraires d√©finis.",ref:"Art. 151 Code de d√©ontologie ; Art. 1367 C. civ.",tags:[["Obligatoire","r"],["Annexe 14","b"]],mandatory:true},
    {id:"p1_4",title:"Dossier permanent cr√©√© dans le SI",desc:"Cr√©ation dossier client dans le logiciel, classement pi√®ces KYC.",ref:"NPMQ ¬ß30",tags:[["SI","b"]],mandatory:false},
    {id:"p1_5",title:"Kit de bienvenue envoy√©",desc:"E-mail de bienvenue avec pr√©sentation √©quipe, guide, contacts, FAQ.",ref:"",tags:[["Communication","g"]],mandatory:false},
    {id:"p1_6",title:"Consentement RGPD recueilli",desc:"Information sur les traitements, consentement √©crit, base l√©gale document√©e.",ref:"R√®glement UE 2016/679, art. 6 et 13",tags:[["RGPD","p"],["Obligatoire","r"]],mandatory:true}
  ]},
  {id:2,name:"Param√©trage",color:"p2",items:[
    {id:"p2_1",title:"Acc√®s portail client cr√©√©s",desc:"Identifiants g√©n√©r√©s et transmis de fa√ßon s√©curis√©e.",ref:"Art. 12 Code de d√©ontologie (secret professionnel)",tags:[["S√©curit√©","r"],["Secret pro.","r"]],mandatory:true},
    {id:"p2_2",title:"Arborescence GED configur√©e",desc:"Dossiers annuels, sous-dossiers par nature (fiscal, social, juridique, comptable).",ref:"",tags:[["GED","b"]],mandatory:false},
    {id:"p2_3",title:"Dossier comptable param√©tr√©",desc:"Plan comptable, journaux, analytique, reprise N-1 si applicable.",ref:"",tags:[["Logiciel comptable","b"]],mandatory:false},
    {id:"p2_4",title:"Collaborateur r√©f√©rent attribu√©",desc:"D√©signation formelle, pr√©sentation au client, droits d'acc√®s configur√©s.",ref:"Art. 12 Code de d√©ontologie",tags:[["Organisation","b"],["Secret pro.","r"]],mandatory:true},
    {id:"p2_5",title:"Connectivit√© et synchro test√©es",desc:"Test d√©p√¥t, synchro bancaire, facturation √©lectronique via PA (ex-PDP).",ref:"Art. 91 LF 2024 ; D√©cret n¬∞ 2024-266",tags:[["Test technique","b"],["E-invoicing","g"]],mandatory:false}
  ]},
  {id:3,name:"Formation",color:"p3",items:[
    {id:"p3_1",title:"Visio d'accueil r√©alis√©e (30-45 min)",desc:"Pr√©sentation √©quipe, m√©thodes de travail, visite guid√©e portail.",ref:"",tags:[["Visio","b"]],mandatory:true},
    {id:"p3_2",title:"Formation outils d√©p√¥t",desc:"Portail web, application mobile, OCR, synchronisation bancaire.",ref:"",tags:[["Formation","b"]],mandatory:false},
    {id:"p3_3",title:"Premier d√©p√¥t test valid√© en direct",desc:"Client d√©pose une pi√®ce en partage d'√©cran, validation OCR et affectation.",ref:"",tags:[["Validation","g"]],mandatory:true},
    {id:"p3_4",title:"Guide utilisateur personnalis√© remis",desc:"Documentation PDF avec contacts, FAQ, proc√©dures adapt√©es au client.",ref:"",tags:[["PDF/Portail","b"]],mandatory:false},
    {id:"p3_5",title:"Premiers √©changes messagerie valid√©s",desc:"Client utilise le canal officiel (portail), pas d'e-mail direct.",ref:"Art. 12 Code de d√©ontologie (tra√ßabilit√©)",tags:[["Messagerie","b"],["Secret pro.","r"]],mandatory:false}
  ]},
  {id:4,name:"Suivi initial",color:"p4",items:[
    {id:"p4_1",title:"Point de suivi J+15 r√©alis√©",desc:"Appel/visio 10-15 min, v√©rification du fonctionnement, identification blocages.",ref:"",tags:[["Suivi","p"]],mandatory:true},
    {id:"p4_2",title:"R√©gularit√© des d√©p√¥ts v√©rifi√©e",desc:"Analyse rythme (alerte si < 3 pi√®ces en 2 semaines), plan de correction.",ref:"",tags:[["KPI","p"]],mandatory:false},
    {id:"p4_3",title:"1re d√©claration TVA accompagn√©e",desc:"Si applicable, accompagnement de la premi√®re √©ch√©ance d√©clarative.",ref:"",tags:[["Fiscal","b"]],mandatory:false},
    {id:"p4_4",title:"Ajustements param√©trage effectu√©s",desc:"Corrections techniques, formation compl√©mentaire si d√©crochage identifi√©.",ref:"",tags:[["Support","b"]],mandatory:false}
  ]},
  {id:5,name:"Autonomie",color:"p5",items:[
    {id:"p5_1",title:"Autonomie client valid√©e",desc:"Ma√Ætrise outils et process confirm√©e : d√©p√¥t r√©gulier, messagerie utilis√©e.",ref:"",tags:[["√âvaluation","p"]],mandatory:true},
    {id:"p5_2",title:"Passage mode r√©current",desc:"Fin int√©gration, fonctionnement normal.",ref:"",tags:[["J+30","g"]],mandatory:false},
    {id:"p5_3",title:"Points r√©guliers planifi√©s",desc:"Calendrier RDV mensuels/trimestriels int√©gr√© dans le CRM.",ref:"",tags:[["Agenda","b"],["CRM","b"]],mandatory:false},
    {id:"p5_4",title:"Enqu√™te satisfaction envoy√©e",desc:"Feedback client sur l'onboarding. Cible : score > 4/5.",ref:"",tags:[["Formulaire","p"]],mandatory:false}
  ]}
];

var state={checked:{},bilan:{}};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FICHES ACTION CONTEXTUELLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var GUIDES={
  "p1_1":{pourquoi:"La qualification NPMQ est le pr√©alable l√©gal √† toute entr√©e en relation. Sans elle, l'expert-comptable s'expose √† une sanction disciplinaire et engage sa responsabilit√©.",comment:["Ouvrir l'Annexe 13 (grille de qualification NPMQ)","Renseigner l'identit√© du prospect, son secteur, sa forme juridique","√âvaluer les 3 axes de risque : client, mission, environnement","Documenter la d√©cision d'acceptation ou de refus","Archiver la fiche dans le dossier permanent (GED)"],outils:"Annexe 13 ‚Äî Grille de qualification et d'acceptation de mission",debloque:"Autorise la signature de la lettre de mission et l'ouverture du dossier client.",duree:"15-30 min",tips:"En cas de doute sur le risque, toujours opter pour le niveau sup√©rieur. Le co√ªt d'un refus est inf√©rieur au co√ªt d'un sinistre."},
  "p1_2":{pourquoi:"L'identification du client et de ses b√©n√©ficiaires effectifs est une obligation LCB-FT. L'absence de pi√®ces KYC expose √† des sanctions TRACFIN et √† la responsabilit√© p√©nale de l'expert-comptable.",comment:["Demander la pi√®ce d'identit√© en cours de validit√© (CNI ou passeport)","Demander le Kbis de moins de 3 mois (soci√©t√©) ou l'extrait RNE (EI)","R√©cup√©rer les statuts √† jour et le RIB","V√©rifier les b√©n√©ficiaires effectifs sur le registre INPI (seuil > 25 %)","Contr√¥ler la coh√©rence des informations et archiver dans la GED"],outils:"Registre INPI (data.inpi.fr) + GED du cabinet",debloque:"Permet de finaliser le dossier permanent et de passer en Phase 2.",duree:"20-45 min selon la structure",tips:"Pour les EI, l'extrait RNE a remplac√© le Kbis depuis le 1er janvier 2023. V√©rifier la date de validit√© des pi√®ces."},
  "p1_3":{pourquoi:"La lettre de mission est obligatoire (art. 151 du Code de d√©ontologie). Elle formalise le p√©rim√®tre, les honoraires et les responsabilit√©s respectives. Sans elle, la mission est irr√©guli√®re.",comment:["Ouvrir l'Annexe 14 (mod√®le de lettre de mission)","Adapter le p√©rim√®tre aux missions accept√©es (tenue, r√©vision, fiscal, social, juridique)","Indiquer les honoraires et les modalit√©s de facturation","Pr√©ciser les obligations respectives et les conditions de r√©siliation","Faire signer √©lectroniquement (AES minimum, art. 1367 C. civ.)","Archiver l'original sign√© dans le dossier permanent"],outils:"Annexe 14 ‚Äî Lettre de mission + outil de signature √©lectronique (ex : Yousign, DocuSign)",debloque:"Valide juridiquement la relation d'affaires. Obligatoire avant toute prestation.",duree:"30-60 min",tips:"Ne jamais commencer une mission sans lettre sign√©e, m√™me pour un ¬´ petit ¬ª dossier. Inclure syst√©matiquement la clause RGPD."},
  "p1_4":{pourquoi:"Le dossier permanent est la m√©moire structur√©e du client. Il centralise toutes les pi√®ces et facilite la revue du dossier et le contr√¥le qualit√©.",comment:["Cr√©er le dossier client dans le logiciel de production","Cr√©er l'arborescence standard (juridique, fiscal, social, comptable, permanent)","Classer les pi√®ces KYC collect√©es","Renseigner la fiche signal√©tique (coordonn√©es, interlocuteurs, r√©gime fiscal)"],outils:"Logiciel de production comptable + GED",debloque:"Permet de commencer le param√©trage technique en Phase 2.",duree:"10-15 min",tips:"Utiliser un mod√®le d'arborescence standard pour garantir l'homog√©n√©it√© entre les dossiers clients."},
  "p1_5":{pourquoi:"Le kit de bienvenue pose le cadre de la relation et donne au client les rep√®res n√©cessaires d√®s le d√©part : qui contacter, comment d√©poser, quels d√©lais respecter.",comment:["Pr√©parer l'e-mail d'accueil avec la pr√©sentation de l'√©quipe","Joindre le guide utilisateur du portail client","Indiquer les coordonn√©es du collaborateur r√©f√©rent","Pr√©ciser les horaires de disponibilit√© et les canaux de communication","Envoyer dans les 24 h suivant la signature de la lettre de mission"],outils:"Mod√®le d'e-mail de bienvenue + guide utilisateur du portail",debloque:"Amorce la relation de confiance et pr√©pare la Phase 3 (Formation).",duree:"10 min",tips:"Un client bien accueilli est un client qui d√©pose plus r√©guli√®rement. L'investissement de 10 min ici √©vite des heures de relance ensuite."},
  "p1_6":{pourquoi:"Le RGPD impose d'informer le client sur les traitements de ses donn√©es personnelles et de recueillir son consentement avant tout traitement. L'absence de conformit√© expose √† des sanctions CNIL.",comment:["Informer le client des traitements r√©alis√©s (art. 13 RGPD)","Recueillir le consentement √©crit pour les traitements non n√©cessaires √† l'ex√©cution du contrat","Documenter la base l√©gale de chaque traitement dans le registre","V√©rifier les DPA (Data Processing Agreements) avec les sous-traitants","Archiver la preuve de consentement dans le dossier permanent"],outils:"Mod√®le de clause RGPD (int√©gr√© √† la lettre de mission) + registre des traitements",debloque:"S√©curise juridiquement le traitement des donn√©es client d√®s l'entr√©e en relation.",duree:"15 min",tips:"Int√©grer la clause RGPD directement dans la lettre de mission pour √©viter un document s√©par√©."},
  "p2_1":{pourquoi:"L'acc√®s s√©curis√© au portail client est le premier point de contact num√©rique. Des identifiants mal transmis compromettent le secret professionnel (art. 12 Code de d√©ontologie).",comment:["Cr√©er le compte client sur le portail","G√©n√©rer un mot de passe temporaire complexe","Transmettre les identifiants par un canal s√©curis√© (pas d'e-mail en clair)","Forcer le changement de mot de passe √† la premi√®re connexion","Journaliser la cr√©ation du compte"],outils:"Portail client + gestionnaire de mots de passe du cabinet",debloque:"Le client peut acc√©der √† son espace et commencer √† d√©poser des documents.",duree:"10 min",tips:"Ne jamais envoyer identifiant et mot de passe dans le m√™me e-mail. Utiliser deux canaux diff√©rents (e-mail + SMS par exemple)."},
  "p2_2":{pourquoi:"Une arborescence GED bien structur√©e garantit la tra√ßabilit√©, facilite les contr√¥les et √©vite la perte de documents. C'est le socle du classement num√©rique.",comment:["Cr√©er les dossiers annuels (N, N-1)","Cr√©er les sous-dossiers par nature : comptable, fiscal, social, juridique, permanent","Param√©trer les r√®gles de nommage des fichiers","Configurer les droits d'acc√®s par collaborateur","Tester le d√©p√¥t et le classement automatique"],outils:"GED du cabinet (ex : MyCompanyFiles, Welyb, Tiime)",debloque:"Permet la r√©ception et le classement des documents client d√®s la Phase 3.",duree:"15-20 min",tips:"Adopter une convention de nommage stricte : AAAA-MM_TypeDoc_D√©tail. Cela simplifie la recherche."},
  "p2_3":{pourquoi:"Un dossier comptable bien param√©tr√© d√®s le d√©part √©vite les corrections chronophages en cours d'exercice. Le plan comptable doit correspondre √† l'activit√© du client.",comment:["Cr√©er le dossier dans le logiciel comptable","Adapter le plan comptable au secteur d'activit√©","Param√©trer les journaux (achats, ventes, banque, OD)","Configurer l'analytique si n√©cessaire","Effectuer la reprise des √†-nouveaux si client existant","Tester la synchronisation bancaire"],outils:"Logiciel de production comptable",debloque:"Le dossier est pr√™t pour la saisie et le traitement des op√©rations courantes.",duree:"30-60 min",tips:"Demander le FEC N-1 au confr√®re pour la reprise des √†-nouveaux. V√©rifier la coh√©rence des soldes avant de commencer."},
  "p2_4":{pourquoi:"Le collaborateur r√©f√©rent est le point de contact unique du client. Sa d√©signation formalise les responsabilit√©s et garantit la tra√ßabilit√© (secret professionnel, art. 12).",comment:["D√©signer le collaborateur en fonction de sa comp√©tence sectorielle","Formaliser la d√©signation dans la fiche client","Configurer les droits d'acc√®s sp√©cifiques au dossier","Pr√©senter le collaborateur au client (e-mail ou visio)","Journaliser les acc√®s"],outils:"Logiciel de gestion interne + portail client",debloque:"Le client sait qui contacter. Le collaborateur peut commencer √† travailler sur le dossier.",duree:"10 min",tips:"Un collaborateur ne devrait pas g√©rer plus de 40-50 dossiers en cabinet num√©rique pour maintenir la qualit√©."},
  "p2_5":{pourquoi:"La connectivit√© est le nerf de la guerre d'un cabinet num√©rique. Un flux qui ne fonctionne pas le premier jour cr√©e de la frustration et retarde tout le processus.",comment:["Tester le d√©p√¥t de document via le portail (upload + OCR)","V√©rifier la synchronisation bancaire (connexion DSP2)","Tester la r√©ception d'une facture √©lectronique via la PA (ex-PDP)","V√©rifier que les flux Factur-X/UBL sont correctement interpr√©t√©s","Documenter les anomalies et les corriger avant la formation client"],outils:"Portail client + logiciel comptable + PA (plateforme agr√©√©e)",debloque:"Garantit que la formation client (Phase 3) se fera sur des outils fonctionnels.",duree:"20-30 min",tips:"Toujours tester AVANT la formation client. Pr√©senter un outil qui plante le jour J d√©truit la confiance."},
  "p3_1":{pourquoi:"La visio d'accueil est le moment cl√© de la relation. C'est l√† que le client comprend comment travailler avec le cabinet et prend confiance dans le dispositif num√©rique.",comment:["Planifier la visio (30-45 min) avec le client et le collaborateur r√©f√©rent","Pr√©parer le support de pr√©sentation (√©quipe, m√©thodes, calendrier)","Faire la visite guid√©e du portail en partage d'√©cran","Montrer comment d√©poser un document, envoyer un message, consulter un document","R√©pondre aux questions et noter les points de vigilance","Envoyer un r√©capitulatif par e-mail dans l'heure"],outils:"Outil de visioconf√©rence + portail client + support de pr√©sentation",debloque:"Le client est familiaris√© avec l'environnement. La formation outils peut commencer.",duree:"30-45 min",tips:"Enregistrer la visio (avec accord) pour pouvoir la renvoyer au client si besoin. Privil√©gier le partage d'√©cran c√¥t√© client, pas c√¥t√© cabinet."},
  "p3_2":{pourquoi:"La formation aux outils de d√©p√¥t est indispensable pour que le client devienne autonome. Un client qui ne sait pas d√©poser est un client qui enverra tout par e-mail.",comment:["Montrer le d√©p√¥t via le portail web (drag & drop)","Montrer le d√©p√¥t via l'application mobile (photo de facture)","Expliquer le fonctionnement de l'OCR et de la reconnaissance automatique","Montrer la synchronisation bancaire et son fonctionnement","R√©pondre aux questions techniques"],outils:"Portail client (web + mobile) + logiciel comptable",debloque:"Le client peut d√©poser ses documents de fa√ßon autonome.",duree:"20-30 min",tips:"Commencer par le mobile : c'est le canal le plus utilis√© par les TPE. Montrer que la photo d'une facture suffit."},
  "p3_3":{pourquoi:"Le premier d√©p√¥t test valid√© en direct est la preuve que le client ma√Ætrise le processus. C'est aussi l'occasion de corriger les erreurs en temps r√©el.",comment:["Demander au client de prendre une facture r√©elle","Le guider pour la d√©poser via le portail (partage d'√©cran client)","V√©rifier que l'OCR extrait correctement les donn√©es","Montrer l'affectation comptable automatique et la validation","Confirmer que le document est bien class√© dans la GED"],outils:"Portail client + logiciel comptable",debloque:"Valide la comp√©tence du client. La phase d'autonomisation peut commencer.",duree:"10-15 min",tips:"Faire d√©poser par le CLIENT, pas √† sa place. C'est la diff√©rence entre formation et simple d√©monstration."},
  "p3_4":{pourquoi:"Le guide utilisateur personnalis√© est la r√©f√©rence du client quand il a un doute. Il √©vite les appels au cabinet pour des questions basiques.",comment:["Adapter le mod√®le standard au profil du client","Inclure les captures d'√©cran du portail avec les donn√©es du client","Lister les contacts (collaborateur r√©f√©rent, urgences, horaires)","Ajouter une FAQ adapt√©e (questions les plus fr√©quentes pour ce profil)","Envoyer en PDF et archiver dans le portail client"],outils:"Mod√®le de guide utilisateur + portail client",debloque:"Le client dispose d'un support d'autonomie disponible 24h/24.",duree:"20 min (personnalisation)"},
  "p3_5":{pourquoi:"Canaliser les √©changes sur le portail officiel garantit la tra√ßabilit√© et le secret professionnel. Les e-mails directs cr√©ent des risques de perte d'information.",comment:["Montrer au client comment envoyer un message via le portail","Expliquer l'avantage (tra√ßabilit√©, historique, pi√®ces jointes archiv√©es)","Configurer les notifications pour que le client soit alert√© des r√©ponses","Tester un premier √©change (question/r√©ponse via le portail)","Rappeler que les e-mails directs ne seront plus trait√©s"],outils:"Messagerie int√©gr√©e du portail client",debloque:"Les √©changes sont centralis√©s et trac√©s. Conformit√© art. 12 Code de d√©ontologie.",duree:"10 min",tips:"√ätre ferme d√®s le d√©but : ne pas r√©pondre aux e-mails envoy√©s en dehors du portail. C'est inconfortable au d√©part mais essentiel."},
  "p4_1":{pourquoi:"Le point J+15 d√©tecte les d√©crochages pr√©coces. Un client qui ne d√©pose rien en 2 semaines est un client en difficult√© qu'il faut accompagner avant qu'il ne d√©croche.",comment:["Planifier un appel ou une visio de 10-15 min","V√©rifier le nombre de documents d√©pos√©s depuis l'onboarding","Identifier les √©ventuels blocages (techniques, organisationnels, psychologiques)","Proposer une mini-formation de rattrapage si n√©cessaire","Documenter les constats et les actions d√©cid√©es"],outils:"CRM / agenda + portail client (indicateurs de d√©p√¥t)",debloque:"Permet d'ajuster le param√©trage et de pr√©venir la d√©sadoption.",duree:"10-15 min",tips:"Ne pas attendre que le client appelle : c'est au cabinet de prendre l'initiative. Le suivi proactif est la marque d'un cabinet num√©rique."},
  "p4_2":{pourquoi:"La r√©gularit√© des d√©p√¥ts est l'indicateur cl√© de l'adoption. Moins de 3 pi√®ces en 2 semaines signale un probl√®me √† traiter imm√©diatement.",comment:["Consulter les statistiques de d√©p√¥t du client","Comparer au rythme attendu pour ce type de structure","Si < 3 pi√®ces en 2 semaines : d√©clencher une relance t√©l√©phonique","Identifier la cause (technique, manque de temps, incompr√©hension)","Mettre en place un plan de correction (rappels automatiques, formation)"],outils:"Tableau de bord portail client + CRM",debloque:"Stabilise le flux de documents et pr√©pare l'autonomie du client.",duree:"5-10 min",tips:"Configurer des alertes automatiques quand un client n'a rien d√©pos√© depuis 7 jours."},
  "p4_3":{pourquoi:"La premi√®re √©ch√©ance d√©clarative est un moment critique. Un retard de TVA d√®s le premier mois cr√©e un pr√©c√©dent n√©gatif difficile √† rattraper.",comment:["Identifier la prochaine √©ch√©ance d√©clarative du client","Pr√©parer la d√©claration en amont avec les √©l√©ments disponibles","Accompagner le client dans la validation (explication des montants)","D√©poser la d√©claration dans les d√©lais","Archiver la preuve de d√©p√¥t"],outils:"Logiciel comptable + portail de d√©claration (impots.gouv.fr / net-entreprises.fr)",debloque:"Le client constate que le cabinet tient ses engagements. Renforce la confiance.",duree:"Variable selon la complexit√©",tips:"Envoyer un rappel au client 10 jours avant l'√©ch√©ance avec la liste des pi√®ces manquantes."},
  "p4_4":{pourquoi:"Les ajustements de param√©trage sont normaux et n√©cessaires. Un onboarding qui ne corrige rien en Phase 4 est un onboarding qui n'a pas assez observ√©.",comment:["Revoir les remont√©es du point J+15","Corriger les probl√®mes techniques identifi√©s (flux, synchronisation, droits)","Adapter le plan comptable si n√©cessaire","Proposer une formation compl√©mentaire cibl√©e si d√©crochage identifi√©","Documenter les modifications dans le dossier client"],outils:"Logiciel comptable + portail client + GED",debloque:"Le param√©trage est stabilis√©. Le client peut entrer en r√©gime de croisi√®re.",duree:"Variable",tips:"Chaque ajustement doit √™tre document√© : pourquoi, quoi, quand. C'est une preuve de qualit√© pour le contr√¥le NPMQ."},
  "p5_1":{pourquoi:"La validation de l'autonomie marque la fin officielle de l'onboarding. Le client est consid√©r√© op√©rationnel quand il d√©pose r√©guli√®rement et utilise les canaux pr√©vus.",comment:["V√©rifier que le client d√©pose au moins 3 documents par semaine (ou au rythme attendu)","Confirmer qu'il utilise la messagerie du portail (pas d'e-mails directs)","√âvaluer sa capacit√© √† retrouver un document dans la GED","Valider avec le collaborateur r√©f√©rent","Documenter la validation dans le dossier client"],outils:"Portail client (indicateurs) + dossier client",debloque:"Le client passe en mode r√©current. L'onboarding est termin√©.",duree:"10 min",tips:"L'autonomie ne signifie pas l'absence de contact. Planifier les points r√©guliers d√®s maintenant."},
  "p5_2":{pourquoi:"Le passage en mode r√©current formalise la fin de l'onboarding. Le client est d√©sormais trait√© comme un dossier courant avec le rythme normal du cabinet.",comment:["D√©sactiver les alertes d'onboarding dans le CRM","Basculer le dossier en statut ¬´ actif ¬ª (hors int√©gration)","Informer le client que l'onboarding est termin√©","Transmettre le calendrier des √©ch√©ances et des rendez-vous p√©riodiques","Archiver le dossier d'onboarding dans le permanent"],outils:"CRM + portail client + GED",debloque:"Le collaborateur r√©f√©rent peut se concentrer sur la production courante.",duree:"5 min"},
  "p5_3":{pourquoi:"Les points r√©guliers sont le fil conducteur de la relation. Sans eux, le client se sent abandonn√© et le cabinet perd la visibilit√© sur les besoins.",comment:["Planifier les RDV p√©riodiques (mensuel ou trimestriel selon la taille du dossier)","Int√©grer dans le CRM avec rappels automatiques","Pr√©parer un ordre du jour type (situation financi√®re, √©ch√©ances, questions)","Proposer des missions compl√©mentaires si opportunit√© identifi√©e"],outils:"CRM / agenda + portail client",debloque:"Fid√©lise le client et g√©n√®re des opportunit√©s de missions compl√©mentaires.",duree:"5 min (planification)",tips:"Le RDV bilan est aussi l'occasion de proposer des missions √† valeur ajout√©e (pr√©visionnel, tableaux de bord, conseil)."},
  "p5_4":{pourquoi:"L'enqu√™te de satisfaction mesure la qualit√© per√ßue de l'onboarding. Un score < 4/5 doit d√©clencher un plan d'am√©lioration. Les retours alimentent aussi le Bilan post-onboarding.",comment:["Envoyer le questionnaire de satisfaction (formulaire en ligne)","Analyser les r√©ponses (score global + commentaires libres)","Si score < 4/5 : planifier un entretien de rattrapage","Int√©grer les retours dans le bilan post-onboarding","Utiliser les donn√©es pour am√©liorer le processus d'int√©gration"],outils:"Formulaire en ligne (Google Forms, Typeform) + Bilan post-onboarding",debloque:"Alimente le Bilan post-onboarding (onglet Bilan) et le processus d'am√©lioration continue.",duree:"5 min (envoi) + 10 min (analyse)",tips:"Envoyer le questionnaire entre J+25 et J+30, quand l'exp√©rience est encore fra√Æche. Ne pas attendre J+60."}
};

var openGuide=null; // track which guide is open

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFORMIT√â INTERACTIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFORMIT√â AUTO-CALCUL√âE (z√©ro double saisie) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Mapping : chaque obligation r√©glementaire est li√©e √† une t√¢che de la checklist
// Docs KYC par structure
var KYC_DOCS={
  ei:{label:"Entreprise individuelle",docs:["Pi√®ce d'identit√© du dirigeant","Extrait RNE (remplace le Kbis depuis 01/01/2023)","RIB professionnel"]},
  eurl:{label:"EURL / SASU",docs:["Pi√®ce d'identit√© du repr√©sentant l√©gal","Kbis < 3 mois","Statuts √† jour","B√©n√©ficiaires effectifs (INPI, > 25 %)","RIB professionnel"]},
  sarl:{label:"SARL / SAS",docs:["Pi√®ce d'identit√© du repr√©sentant l√©gal","Kbis < 3 mois","Statuts √† jour","B√©n√©ficiaires effectifs (INPI, > 25 %)","RIB professionnel"]},
  sci:{label:"SCI / Soci√©t√© civile",docs:["Pi√®ce d'identit√© de tous les g√©rants","Kbis < 3 mois","Statuts (objet social, r√©partition)","B√©n√©ficiaires effectifs ‚Äî vigilance renforc√©e","RIB de la SCI"]},
  association:{label:"Association",docs:["Pi√®ce d'identit√© du repr√©sentant l√©gal","Statuts d√©pos√©s en pr√©fecture + r√©c√©piss√©","Dirigeants et tr√©sorier identifi√©s","RIB de l'association"]}
};

var VIG_DATA={
  faible:{level:"Simplifi√©e",color:"var(--success)",bg:"#ecfdf5",ref:"Art. L561-9 CMF",desc:"Risque faible document√©. All√®gement des mesures autoris√©.",actions:"Identification standard, v√©rification dans un d√©lai raisonnable, conservation 5 ans."},
  normal:{level:"Normale",color:"var(--warning)",bg:"#fef3c7",ref:"Art. L561-5 CMF",desc:"R√©gime standard. Identification compl√®te avant entr√©e en relation.",actions:"Identification + v√©rification pr√©-relation, √©valuation risque, KYC complet, surveillance continue, conservation 5 ans."},
  eleve:{level:"Renforc√©e",color:"var(--danger)",bg:"#fee2e2",ref:"Art. L561-10-1 CMF",desc:"PEP, pays GAFI, op√©rations atypiques. Validation EC obligatoire.",actions:"Identification renforc√©e, origine des fonds, validation EC √† chaque √©tape, examen renforc√©, d√©claration TRACFIN si doute."}
};

function renderProfilReg(){
  var type=document.getElementById("simType").value;
  var risk=document.getElementById("simRisk").value;
  var zone=document.getElementById("profilRegZone");
  if(!type&&!risk){zone.style.display="none";return;}
  zone.style.display="block";

  // KYC docs
  var kycEl=document.getElementById("kycDocsList");
  var kycLabel=document.getElementById("kycStructLabel");
  if(type&&KYC_DOCS[type]){
    var kd=KYC_DOCS[type];
    kycLabel.textContent=kd.label;
    var h='';
    for(var i=0;i<kd.docs.length;i++){
      h+='<div style="font-size:12px;padding:5px 0;border-bottom:1px solid var(--gray-100)">‚Ä¢ '+kd.docs[i]+'</div>';
    }
    if(type==="sci")h+='<div style="font-size:11px;color:#92400e;margin-top:6px;padding:6px 8px;background:#fef3c7;border-radius:6px">‚ö† SCI : v√©rifier la cha√Æne de d√©tention et les conventions r√©glement√©es.</div>';
    if(risk==="eleve")h+='<div style="font-size:11px;color:#991b1b;margin-top:6px;padding:6px 8px;background:#fee2e2;border-radius:6px">‚ö† Risque √©lev√© : v√©rification approfondie de l\'authenticit√© des pi√®ces (art. L561-10-1 CMF).</div>';
    kycEl.innerHTML=h;
  }else{
    kycLabel.textContent="structure non s√©lectionn√©e";
    kycEl.innerHTML='<div style="font-size:12px;color:var(--gray-500);font-style:italic">S√©lectionner le type de structure pour afficher les documents requis.</div>';
  }

  // Vigilance
  var vigEl=document.getElementById("vigPanel");
  if(risk&&VIG_DATA[risk]){
    var v=VIG_DATA[risk];
    vigEl.innerHTML='<div style="padding:12px;border-radius:8px;background:'+v.bg+';border-left:4px solid '+v.color+'"><div style="font-weight:700;font-size:14px;color:'+v.color+'">'+v.level+'</div><div style="font-size:12px;color:var(--gray-600);margin-top:4px">'+v.desc+'</div><div style="font-size:10px;color:var(--gray-500);margin-top:4px;font-style:italic">'+v.ref+'</div><div style="font-size:11px;color:var(--gray-700);margin-top:8px;padding-top:6px;border-top:1px solid rgba(0,0,0,.08)"><strong>Mesures :</strong> '+v.actions+'</div></div>';
  }else{
    vigEl.innerHTML='<div style="font-size:12px;color:var(--gray-500);font-style:italic">S√©lectionner le risque LAB pour afficher le niveau de vigilance applicable.</div>';
  }
}

document.addEventListener("DOMContentLoaded",function(){
  // Tabs
  var tabs=document.querySelectorAll(".tab");
  for(var t=0;t<tabs.length;t++){
    tabs[t].addEventListener("click",function(){
      var id=this.getAttribute("data-panel");
      var panels=document.querySelectorAll(".panel");
      for(var p=0;p<panels.length;p++) panels[p].classList.remove("active");
      document.getElementById(id).classList.add("active");
      for(var b=0;b<tabs.length;b++) tabs[b].classList.remove("active");
      this.classList.add("active");
    });
  }
  // Default date
  document.getElementById("startDate").value=new Date().toISOString().split("T")[0];
  // Client fields -> ONLY update profil display, NOT dashboard
  var fields=document.querySelectorAll(".client-section input,.client-section select");
  for(var f=0;f<fields.length;f++){
    fields[f].addEventListener("change",function(){updateProfil();renderProfilReg();});
    fields[f].addEventListener("input",function(){updateProfil();renderProfilReg();});
  }
  renderChecklist();
  renderProfilReg();
  refreshDashboard();
});

function showPanel(id){
  var panels=document.querySelectorAll(".panel");
  for(var p=0;p<panels.length;p++) panels[p].classList.remove("active");
  document.getElementById(id).classList.add("active");
  var tabs=document.querySelectorAll(".tab");
  for(var t=0;t<tabs.length;t++) tabs[t].classList.toggle("active",tabs[t].getAttribute("data-panel")===id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PHASE BLOCKING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isPhaseUnlocked(phaseId){
  if(phaseId===1) return true;
  var prev=PHASES[phaseId-2];
  for(var i=0;i<prev.items.length;i++){
    if(prev.items[i].mandatory===true && state.checked[prev.items[i].id]!==true) return false;
  }
  return true;
}

function getMandatoryMissing(phaseId){
  var ph=PHASES[phaseId-1];
  var missing=[];
  for(var i=0;i<ph.items.length;i++){
    if(ph.items[i].mandatory===true && state.checked[ph.items[i].id]!==true) missing.push(ph.items[i]);
  }
  return missing;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHECKLIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChecklist(){
  var c=document.getElementById("checklistContainer");c.innerHTML="";
  for(var pi=0;pi<PHASES.length;pi++){
    var ph=PHASES[pi];
    var unlocked=isPhaseUnlocked(ph.id);
    var done=0;
    for(var ii=0;ii<ph.items.length;ii++){if(state.checked[ph.items[ii].id]===true)done++;}
    var allDone=done===ph.items.length;
    var html='<div class="check-section"><div class="check-header '+ph.color+'">Phase '+ph.id+" : "+ph.name+(unlocked?"":" üîí")+'<span class="prog">'+done+"/"+ph.items.length+"</span></div>";
    html+='<div class="check-body">';
    // Phase completion message
    if(allDone&&unlocked){
      var nextPhaseName=pi<PHASES.length-1?"Phase "+(ph.id+1)+" ("+PHASES[pi+1].name+") d√©bloqu√©e.":"Toutes les phases sont compl√®tes. Renseigner le Bilan post-onboarding.";
      html+='<div class="phase-complete-msg done show"><div class="pcm-title">‚úÖ Phase '+ph.id+' termin√©e ‚Äî '+done+'/'+ph.items.length+' t√¢ches r√©alis√©es</div>';
      html+='<div class="pcm-next">‚Üí '+nextPhaseName+'</div></div>';
    }
    if(!unlocked){
      var missing=getMandatoryMissing(ph.id-1);
      html+='<div style="padding:12px;font-size:12px;color:#991b1b;background:#fee2e2;border-radius:8px;margin:6px">Phase verrouill√©e ‚Äî compl√©ter d\'abord les t√¢ches obligatoires de la Phase '+(ph.id-1)+' : '+missing.map(function(m){return m.title}).join(", ")+"</div>";
    }
    for(var ii=0;ii<ph.items.length;ii++){
      var it=ph.items[ii];
      var d=state.checked[it.id]===true;
      var blocked=!unlocked;
      var hasGuide=GUIDES[it.id]!==undefined;
      var isOpen=openGuide===it.id;
      html+='<div class="check-item'+(d?" done":"")+(blocked?" blocked":"")+'">';
      html+='<div class="ci-top" onclick="'+(blocked?"":"toggleCheck('"+it.id+"')")+'" style="cursor:'+(blocked?"not-allowed":"pointer")+'">';
      html+='<div class="check-box">'+(d?"‚úì":(blocked?"üîí":""))+"</div><div style='flex:1'>";
      html+='<div class="ci-title">'+(it.mandatory?"‚óè ":"")+it.title+"</div>";
      html+='<div class="ci-desc">'+it.desc+"</div>";
      if(it.ref)html+='<div class="ci-ref">Ref. : '+it.ref+"</div>";
      html+='<div class="ci-tags">';
      for(var ti=0;ti<it.tags.length;ti++){html+='<span class="ci-tag ci-tag-'+it.tags[ti][1]+'">'+it.tags[ti][0]+"</span>";}
      html+="</div></div>";
      if(hasGuide&&!blocked)html+='<button class="guide-toggle" onclick="event.stopPropagation();toggleGuide(\''+it.id+'\')">'+(isOpen?"Fermer":"Mode op√©ratoire")+"</button>";
      html+="</div>";
      // Guide panel
      if(hasGuide&&isOpen&&!blocked){
        var g=GUIDES[it.id];
        html+='<div class="guide-panel open">';
        // Pourquoi
        html+='<div class="guide-section"><div class="guide-label"><span class="gl-icon" style="background:var(--info)">?</span><span style="color:var(--info)">Pourquoi</span></div>';
        html+='<div class="guide-text">'+g.pourquoi+'</div></div>';
        // Comment
        html+='<div class="guide-section"><div class="guide-label"><span class="gl-icon" style="background:var(--primary)">‚Üí</span><span style="color:var(--primary)">Comment faire</span></div>';
        html+='<ol class="guide-steps">';
        for(var si=0;si<g.comment.length;si++){html+="<li>"+g.comment[si]+"</li>";}
        html+='</ol></div>';
        // Outils
        html+='<div class="guide-section"><div class="guide-label"><span class="gl-icon" style="background:var(--secondary)">‚öô</span><span style="color:var(--secondary)">Outil / Annexe</span></div>';
        html+='<div class="guide-tool-badge">'+g.outils+'</div></div>';
        // D√©bloque
        html+='<div class="guide-section"><div class="guide-unlock">üîì '+g.debloque+'</div></div>';
        // Tips
        if(g.tips){html+='<div class="guide-section"><div class="guide-tip">üí° '+g.tips+'</div></div>';}
        // Meta
        html+='<div class="guide-meta">';
        if(g.duree)html+='<span class="guide-meta-item">‚è± Dur√©e estim√©e : '+g.duree+'</span>';
        html+='</div>';
        html+='</div>';
      }
      html+="</div>";
    }
    html+="</div></div>";
    c.innerHTML+=html;
  }
  refreshNextAction();
}

function toggleCheck(id){
  state.checked[id]=state.checked[id]===true?false:true;
  renderChecklist();
  renderProfilReg();
  refreshDashboard();
  // Phase completion toast
  for(var p=0;p<PHASES.length;p++){
    var ph=PHASES[p];
    var allDone=true;
    for(var i=0;i<ph.items.length;i++){
      if(state.checked[ph.items[i].id]!==true){allDone=false;break;}
    }
    // Find item in this phase
    var inPhase=false;
    for(var i=0;i<ph.items.length;i++){if(ph.items[i].id===id){inPhase=true;break;}}
    if(inPhase&&allDone&&state.checked[id]===true){
      toast("Phase "+ph.id+" termin√©e ‚Äî "+ph.name);
    }
  }
}

function toggleGuide(id){
  if(openGuide===id){openGuide=null;}else{openGuide=id;}
  renderChecklist();
  // Scroll to the guide panel
  setTimeout(function(){
    var panels=document.querySelectorAll(".guide-panel.open");
    if(panels.length>0)panels[0].scrollIntoView({behavior:"smooth",block:"nearest"});
  },100);
}

function refreshNextAction(){
  var widget=document.getElementById("nextAction");
  var nextItem=null;var nextPhase=null;
  // Find next unchecked mandatory item first, then any unchecked
  for(var p=0;p<PHASES.length;p++){
    var ph=PHASES[p];
    if(!isPhaseUnlocked(ph.id))break;
    for(var i=0;i<ph.items.length;i++){
      var it=ph.items[i];
      if(state.checked[it.id]!==true&&it.mandatory){
        nextItem=it;nextPhase=ph;break;
      }
    }
    if(nextItem)break;
  }
  // If no mandatory left, find any unchecked
  if(!nextItem){
    for(var p=0;p<PHASES.length;p++){
      var ph=PHASES[p];
      if(!isPhaseUnlocked(ph.id))break;
      for(var i=0;i<ph.items.length;i++){
        var it=ph.items[i];
        if(state.checked[it.id]!==true){
          nextItem=it;nextPhase=ph;break;
        }
      }
      if(nextItem)break;
    }
  }
  if(nextItem&&GUIDES[nextItem.id]){
    widget.classList.add("show");
    document.getElementById("nextActionTask").textContent="Phase "+nextPhase.id+" ‚Üí "+nextItem.title;
    document.getElementById("nextActionWhy").textContent=GUIDES[nextItem.id].pourquoi.substring(0,150)+"‚Ä¶";
    widget.setAttribute("data-target",nextItem.id);
  }else if(!nextItem){
    // All done
    var total=0,done=0;
    for(var p=0;p<PHASES.length;p++){for(var i=0;i<PHASES[p].items.length;i++){total++;if(state.checked[PHASES[p].items[i].id]===true)done++;}}
    if(done===total&&total>0){
      widget.classList.add("show");
      document.getElementById("nextActionTask").textContent="Onboarding termin√© ‚Äî 24/24 t√¢ches";
      document.getElementById("nextActionWhy").textContent="Renseigner les 4 indicateurs du Bilan post-onboarding, puis exporter le PDF pour archivage au dossier permanent.";
      document.getElementById("nextActionBtn").textContent="Aller au Bilan ‚Üí";
      widget.setAttribute("data-target","bilan");
    }else{
      widget.classList.remove("show");
    }
  }else{
    widget.classList.remove("show");
  }
}

function jumpToNextAction(){
  var target=document.getElementById("nextAction").getAttribute("data-target");
  if(target==="bilan"){
    showPanel("bilan");
    window.scrollTo({top:0,behavior:"smooth"});
    return;
  }
  showPanel("checklist");
  // Open the guide for this task
  openGuide=target;
  renderChecklist();
  // Scroll to the item
  setTimeout(function(){
    var panels=document.querySelectorAll(".guide-panel.open");
    if(panels.length>0)panels[0].scrollIntoView({behavior:"smooth",block:"center"});
  },150);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD AUTO-CALC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshDashboard(){
  try{
  try{updateProfil();}catch(e){console.error("updateProfil error:",e);}
  var total=0,done=0,mandTotal=0,mandDone=0;
  for(var p=0;p<PHASES.length;p++){
    for(var i=0;i<PHASES[p].items.length;i++){
      var it=PHASES[p].items[i];
      total++;
      if(state.checked[it.id]===true) done++;
      if(it.mandatory===true){
        mandTotal++;
        if(state.checked[it.id]===true) mandDone++;
      }
    }
  }
  var pct=total>0?Math.round(done/total*100):0;
  var confPct=mandTotal>0?Math.round(mandDone/mandTotal*100):0;

  document.getElementById("progText").textContent=done+"/"+total+" ‚Äî "+pct+" %";
  document.getElementById("progBar").style.width=pct+"%";

  // Dashboard
  document.getElementById("dashProgVal").textContent=pct+" %";
  document.getElementById("dashProgSub").textContent=done+"/"+total+" t√¢ches";
  var dP=document.getElementById("dashProg");
  dP.className="dash-card "+(pct===100?"ok":pct>=50?"warn":"err");

  document.getElementById("dashConfVal").textContent=confPct+" %";
  document.getElementById("dashConfSub").textContent=mandDone+"/"+mandTotal+" items obligatoires";
  var dC=document.getElementById("dashConf");
  dC.className="dash-card "+(confPct===100?"ok":confPct>=50?"warn":"err");

  // Phase en cours
  var currentPhase="‚Äî";var currentPhaseSub="";
  for(var i=0;i<PHASES.length;i++){
    var allDone=true;
    for(var j=0;j<PHASES[i].items.length;j++){
      if(state.checked[PHASES[i].items[j].id]!==true){allDone=false;break;}
    }
    if(!allDone){currentPhase="Phase "+(i+1);currentPhaseSub=PHASES[i].name;break;}
  }
  if(done===total&&total>0){currentPhase="Termine";currentPhaseSub="24/24 - pret pour bilan"}
  document.getElementById("dashPhaseVal").textContent=currentPhase;
  document.getElementById("dashPhaseSub").textContent=currentPhaseSub;
  document.getElementById("dashPhase").className="dash-card "+(done===total?"ok":"info");

  // Jours
  var startD=document.getElementById("startDate").value;
  var digital=document.getElementById("simDigital").value;
  var dur=digital==="debutant"?45:digital==="avance"?20:30;
  if(startD){
    var start=new Date(startD);var now=new Date();
    var elapsed=Math.max(0,Math.round((now-start)/(1000*60*60*24)));
    document.getElementById("dashJoursVal").textContent="J+"+elapsed+" / "+dur;
    var cls=elapsed>dur?"red":elapsed>dur*0.8?"orange":"green";
    document.getElementById("dashJoursSub").textContent=elapsed>dur?"D√©passement de "+Math.round(elapsed-dur)+" jours":Math.round(dur-elapsed)+" jours restants";
    document.getElementById("dashJoursSub").className="dash-sub "+cls;
    document.getElementById("dashJours").className="dash-card "+(elapsed>dur?"err":elapsed>dur*0.8?"warn":"ok");
  }

  // Docs
  var type=document.getElementById("simType").value;
  if(type){
    var docsReq=type==="ei"?3:type==="association"?4:5;
    var docsCollected=state.checked["p1_2"]===true?docsReq:0;
    document.getElementById("dashDocsVal").textContent=docsCollected+"/"+docsReq;
    document.getElementById("dashDocsSub").textContent=docsCollected===docsReq?"KYC complet":"KYC incomplet";
    document.getElementById("dashDocs").className="dash-card "+(docsCollected===docsReq?"ok":"err");
  }

  // Alert banner
  var banner=document.getElementById("alertBanner");
  var missing1=getMandatoryMissing(1);
  if(done===total){
    banner.className="alert-banner ok show";
    banner.innerHTML="‚úÖ Onboarding termin√© ‚Äî 24/24 t√¢ches compl√©t√©es. Renseigner le bilan post-onboarding puis exporter le PDF pour archivage.";
  }else if(missing1.length>0&&done>0){
    banner.className="alert-banner err show";
    banner.innerHTML="‚ö† Items obligatoires Phase 1 incomplets : "+missing1.map(function(m){return m.title}).join(", ")+". Les phases suivantes sont verrouill√©es.";
  }else if(done>0){
    banner.className="alert-banner warn show";
    banner.innerHTML="En cours ‚Äî Phase "+currentPhase.replace("Phase ","")+". "+done+"/"+total+" t√¢ches r√©alis√©es.";
  }else{
    banner.className="alert-banner";
  }
  }catch(e){console.error("refreshDashboard error:",e);document.title="ERR:"+e.message;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateProfil(){
  var type=document.getElementById("simType").value;
  var digital=document.getElementById("simDigital").value;
  var risk=document.getElementById("simRisk").value;
  var startD=document.getElementById("startDate").value;
  var panel=document.getElementById("profilResult");
  if(!type||!digital||!risk){panel.classList.remove("show");return}
  var dur=digital==="debutant"?45:digital==="avance"?20:30;
  var vig=risk==="eleve"?"Renforc√©e":risk==="faible"?"Simplifi√©e":"Normale";
  var form=digital==="debutant"?"Renforc√©e":digital==="avance"?"All√©g√©e":"Standard";
  var docs=type==="ei"?3:type==="association"?4:5;
  var khtml='<div class="profil-kpi"><div class="profil-kpi-val">'+dur+' j</div><div class="profil-kpi-lbl">Dur√©e estim√©e</div></div>';
  khtml+='<div class="profil-kpi"><div class="profil-kpi-val">'+vig+'</div><div class="profil-kpi-lbl">Vigilance LAB</div></div>';
  khtml+='<div class="profil-kpi"><div class="profil-kpi-val">'+form+'</div><div class="profil-kpi-lbl">Formation</div></div>';
  khtml+='<div class="profil-kpi"><div class="profil-kpi-val">'+docs+'</div><div class="profil-kpi-lbl">Docs KYC</div></div>';
  document.getElementById("profilKpis").innerHTML=khtml;
  var alerts="";
  if(risk==="eleve")alerts+='<div class="profil-alert red">Vigilance renforc√©e (NPLAB) : v√©rification approfondie obligatoire, validation EC √† chaque √©tape.</div>';
  if(digital==="debutant")alerts+='<div class="profil-alert orange">Formation renforc√©e : pr√©voir 2 sessions suppl√©mentaires et suivi rapproch√© J+7, J+15, J+21.</div>';
  if(type==="sci")alerts+='<div class="profil-alert purple">SCI : v√©rification b√©n√©ficiaires effectifs renforc√©e, obligations d√©claratives sp√©cifiques (2072).</div>';
  if(type==="ei")alerts+='<div class="profil-alert blue">EI : extrait RNE requis (remplace le Kbis depuis le 1er janvier 2023).</div>';
  document.getElementById("profilAlerts").innerHTML=alerts;
  if(startD){var start=new Date(startD);var fmt=function(d){return d.toLocaleDateString("fr-FR")};var add=function(d,n){var r=new Date(d);r.setDate(r.getDate()+n);return r};document.getElementById("profilEcheancier").innerHTML="<strong>√âch√©ancier :</strong> Phase 1 : "+fmt(start)+" ‚Üí Phase 2 : "+fmt(add(start,3))+" ‚Üí Phase 3 : "+fmt(add(start,10))+" ‚Üí Point J+15 : "+fmt(add(start,15))+" ‚Üí Cl√¥ture : "+fmt(add(start,dur))}
  panel.classList.add("show");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BILAN AUTO-DIAGNOSTIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updBilan(){
  var a=document.getElementById("bAdopt").value;
  var d=document.getElementById("bDelai").value;
  var s=document.getElementById("bSat").value;
  var r=document.getElementById("bRetard").value;
  state.bilan={adopt:a,delai:d,sat:s,retard:r};
  var cardMap={"bAdopt":"bc1","bDelai":"bc2","bSat":"bc3","bRetard":"bc4"};
  function setStatus(el,card,ok,warn){
    if(!el)return;
    var cls=ok?"ok":(warn?"warn":"err");
    var txt=ok?"Conforme":(warn?"Attention":"Alerte");
    document.getElementById(card+"St").innerHTML='<span class="bilan-status '+cls+'">'+txt+'</span>';
    var bcId=cardMap[card];
    if(bcId)document.getElementById(bcId).className="bilan-card "+cls;
  }
  if(a!=="")setStatus(a,"bAdopt",parseFloat(a)>=80,parseFloat(a)>=60);
  if(d!=="")setStatus(d,"bDelai",parseFloat(d)<=48,parseFloat(d)<=72);
  if(s!=="")setStatus(s,"bSat",parseFloat(s)>=4,parseFloat(s)>=3);
  if(r!=="")setStatus(r,"bRetard",parseFloat(r)===0,parseFloat(r)<=1);

  // Diagnostic
  var hasAny=a!==""||d!==""||s!==""||r!=="";
  var diagBox=document.getElementById("diagBox");
  if(!hasAny){diagBox.style.display="none";return}
  diagBox.style.display="block";
  var lines=[];var score=0;var count=0;
  if(a!==""){count++;var av=parseFloat(a);if(av>=80){score++;lines.push(["Adoption outils","‚úÖ "+a+" % ‚Äî Conforme (cible > 80 %)","green"])}else if(av>=60){lines.push(["Adoption outils","‚ö† "+a+" % ‚Äî Insuffisant. Pr√©voir une relance de formation.","orange"])}else{lines.push(["Adoption outils","‚ùå "+a+" % ‚Äî Critique. Le client n'utilise pas les outils. Reprogrammer une visio de prise en main.","red"])}}
  if(d!==""){count++;var dv=parseFloat(d);if(dv<=48){score++;lines.push(["D√©lai de d√©p√¥t","‚úÖ "+d+" h ‚Äî Conforme (cible < 48 h)","green"])}else if(dv<=72){lines.push(["D√©lai de d√©p√¥t","‚ö† "+d+" h ‚Äî Acceptable mais √† surveiller. V√©rifier les rappels automatiques.","orange"])}else{lines.push(["D√©lai de d√©p√¥t","‚ùå "+d+" h ‚Äî Trop long. Identifier le blocage (technique ? organisationnel ?).","red"])}}
  if(s!==""){count++;var sv=parseFloat(s);if(sv>=4){score++;lines.push(["Satisfaction","‚úÖ "+s+"/5 ‚Äî Conforme (cible > 4/5)","green"])}else if(sv>=3){lines.push(["Satisfaction","‚ö† "+s+"/5 ‚Äî Mitig√©. Planifier un entretien pour recueillir les irritants.","orange"])}else{lines.push(["Satisfaction","‚ùå "+s+"/5 ‚Äî Insatisfaction. Revoir le processus d'onboarding.","red"])}}
  if(r!==""){count++;var rv=parseInt(r);if(rv===0){score++;lines.push(["Retards d√©claratifs","‚úÖ 0 retard ‚Äî Conforme","green"])}else if(rv<=1){lines.push(["Retards d√©claratifs","‚ö† "+r+" retard(s) ‚Äî Analyser la cause et mettre en place un rappel anticip√©.","orange"])}else{lines.push(["Retards d√©claratifs","‚ùå "+r+" retards ‚Äî Probl√®me structurel. V√©rifier le param√©trage et la formation client.","red"])}}
  var verdict=count>0?(score===count?"Onboarding r√©ussi ‚Äî client op√©rationnel.":(score>=count/2?"Onboarding partiel ‚Äî actions correctives n√©cessaires.":"Onboarding en √©chec ‚Äî reprise du parcours recommand√©e.")):"";
  var verdictCls=score===count?"green":(score>=count/2?"orange":"red");
  var html=lines.map(function(l){return'<div class="diag-line"><span>'+l[0]+'</span><span style="color:var(--'+l[2]+');font-weight:600;font-size:11px">'+l[1]+'</span></div>'}).join("");
  if(count>0)html+='<div style="margin-top:12px;padding:10px 14px;border-radius:8px;background:var(--gray-50);font-weight:700;font-size:13px;color:var(--'+verdictCls+')">'+verdict+" ("+score+"/"+count+" indicateurs conformes)</div>";
  document.getElementById("diagContent").innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAS PRATIQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadCasPratique(){
  // 1. Reset state
  state={checked:{},bilan:{}};
  openGuide=null;
  // 2. Fill client fields
  document.getElementById("clientName").value="SAS TechShop (e-commerce)";
  document.getElementById("referent").value="Collaborateur A";
  document.getElementById("startDate").value="2026-03-01";
  document.getElementById("simType").value="sarl";
  document.getElementById("simDigital").value="intermediaire";
  document.getElementById("simRisk").value="normal";
  // 3. Check ALL 24 items
  for(var p=0;p<PHASES.length;p++){
    for(var i=0;i<PHASES[p].items.length;i++){
      state.checked[PHASES[p].items[i].id]=true;
    }
  }
  // 4. Fill bilan
  state.bilan={adopt:"85",delai:"36",sat:"4.5",retard:"0"};
  document.getElementById("bAdopt").value="85";
  document.getElementById("bDelai").value="36";
  document.getElementById("bSat").value="4.5";
  document.getElementById("bRetard").value="0";
  // 5. Compliance is now auto-calculated from checklist ‚Äî no separate state
  // 6. Render all
  renderChecklist();
  renderProfilReg();
  try{updBilan();}catch(e){console.error("updBilan error:",e);}
  refreshDashboard();
  showPanel("checklist");
  toast("Cas pratique Cabinet X charg√© ‚Äî 24/24 t√¢ches, bilan renseign√©");
}

function resetAll(){if(!confirm("Tout r√©initialiser ?"))return;state={checked:{},bilan:{}};openGuide=null;["clientName","referent"].forEach(function(id){document.getElementById(id).value=""});["simType","simDigital","simRisk"].forEach(function(id){document.getElementById(id).value=""});["bAdopt","bDelai","bSat","bRetard"].forEach(function(id){document.getElementById(id).value=""});["bAdoptSt","bDelaiSt","bSatSt","bRetardSt"].forEach(function(id){document.getElementById(id).innerHTML=""});document.getElementById("profilResult").classList.remove("show");document.getElementById("diagBox").style.display="none";["bc1","bc2","bc3","bc4"].forEach(function(id){document.getElementById(id).className="bilan-card"});document.getElementById("nextAction").classList.remove("show");document.getElementById("nextActionBtn").textContent="Voir la t√¢che ‚Üí";renderChecklist();renderProfilReg();refreshDashboard();toast("Donn√©es r√©initialis√©es")}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JSON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportJSON(){var data={version:"6.0",exportDate:new Date().toISOString(),client:{name:document.getElementById("clientName").value,startDate:document.getElementById("startDate").value,referent:document.getElementById("referent").value,type:document.getElementById("simType").value,digital:document.getElementById("simDigital").value,risk:document.getElementById("simRisk").value},checklist:state.checked,bilan:state.bilan};var blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});var a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="onboarding_"+(document.getElementById("clientName").value||"client").replace(/\s+/g,"_")+"_"+new Date().toISOString().slice(0,10)+".json";a.click();toast("Sauvegarde JSON t√©l√©charg√©e")}

function importJSON(event){var file=event.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(e){try{var data=JSON.parse(e.target.result);if(data.client){document.getElementById("clientName").value=data.client.name||"";document.getElementById("startDate").value=data.client.startDate||"";document.getElementById("referent").value=data.client.referent||"";if(data.client.type)document.getElementById("simType").value=data.client.type;if(data.client.digital)document.getElementById("simDigital").value=data.client.digital;if(data.client.risk)document.getElementById("simRisk").value=data.client.risk}if(data.checklist)state.checked=data.checklist;if(data.bilan){state.bilan=data.bilan;if(data.bilan.adopt){document.getElementById("bAdopt").value=data.bilan.adopt;document.getElementById("bDelai").value=data.bilan.delai;document.getElementById("bSat").value=data.bilan.sat;document.getElementById("bRetard").value=data.bilan.retard;try{updBilan();}catch(err){console.error("updBilan import error:",err);}}}openGuide=null;renderChecklist();renderProfilReg();refreshDashboard();toast("Donn√©es restaur√©es")}catch(err){toast("Erreur d'import")}};reader.readAsText(file)}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF(){document.getElementById("loadingOverlay").classList.add("show");setTimeout(function(){try{var jsPDF=window.jspdf.jsPDF;var doc=new jsPDF("p","mm","a4");var pw=doc.internal.pageSize.getWidth(),pgh=doc.internal.pageSize.getHeight();var m=12,cw=pw-2*m,y=0,pn=1;var P=[30,58,95];function safe(t){if(!t)return"";return String(t).replace(/[\u{1F300}-\u{1FAFF}]/gu,"").replace(/[\u{2600}-\u{27BF}]/gu,"").replace(/[\u00A0\u202F]/g," ").replace(/['']/g,"'").replace(/[""]/g,'"').replace(/[‚Ä¶]/g,"...").replace(/[‚Äì‚Äî]/g,"-").replace(/[\u00e9\u00e8\u00ea\u00eb]/g,"e").replace(/[\u00e0\u00e2\u00e4]/g,"a").replace(/[\u00f9\u00fb\u00fc]/g,"u").replace(/[\u00ee\u00ef]/g,"i").replace(/[\u00f4\u00f6]/g,"o").replace(/\u00e7/g,"c").replace(/[\u00c9\u00c8]/g,"E").replace(/\u00c0/g,"A").replace(/\u20ac/g,"EUR").replace(/[\u2265\u2264]/g,"").replace(/[\u00b0\u2019\u00b7]/g,"").trim()}
  function footer(){doc.setDrawColor(180);doc.setLineWidth(.2);doc.line(m,pgh-12,pw-m,pgh-12);doc.setFontSize(6.5);doc.setTextColor(130);doc.setFont("helvetica","normal");doc.text("Annexe 15 - Parcours d'integration client | Memoire DEC",m,pgh-8);doc.text("Page "+pn+" | "+safe(fmtNow()),pw-m-38,pgh-8)}
  function chk(n){if(y+n>pgh-18){footer();doc.addPage();pn++;y=12}}
  function hdr(t){chk(12);doc.setFillColor(P[0],P[1],P[2]);doc.rect(m,y,cw,8,"F");doc.setTextColor(255);doc.setFontSize(9);doc.setFont("helvetica","bold");doc.text(safe(t),m+3,y+5.5);y+=12;doc.setTextColor(0)}
  function sub(t){chk(6);doc.setFontSize(8);doc.setFont("helvetica","bold");doc.setTextColor(P[0],P[1],P[2]);doc.text(safe(t),m,y);y+=5;doc.setTextColor(0)}
  function txt(t){doc.setFontSize(7);doc.setFont("helvetica","normal");doc.setTextColor(50);var ls=doc.splitTextToSize(safe(t),cw);for(var i=0;i<ls.length;i++){chk(3.5);doc.text(ls[i],m,y);y+=3.5}}
  function tbl(h,rows,w){var tw=0;for(var i=0;i<w.length;i++)tw+=w[i];var rh=5,hh=6;chk(hh+rows.length*rh+2);doc.setFillColor(P[0],P[1],P[2]);doc.rect(m,y,tw,hh,"F");doc.setFontSize(7);doc.setFont("helvetica","bold");doc.setTextColor(255);var x=m;for(var i=0;i<h.length;i++){doc.text(safe(h[i]),x+2,y+4);x+=w[i]}y+=hh;for(var r=0;r<rows.length;r++){doc.setFillColor(r%2===0?248:255,r%2===0?250:255,r%2===0?252:255);doc.rect(m,y,tw,rh,"F");x=m;doc.setFontSize(6.5);doc.setFont("helvetica","normal");doc.setTextColor(40);for(var c=0;c<rows[r].length;c++){var ct=safe(String(rows[r][c]));var mx=w[c]-4;while(doc.getTextWidth(ct)>mx&&ct.length>3)ct=ct.slice(0,-1);doc.text(ct,x+2,y+3.5);x+=w[c]}y+=rh}doc.setDrawColor(200);doc.setLineWidth(.15);doc.rect(m,y-rows.length*rh-hh,tw,rows.length*rh+hh);y+=3}
  var client=document.getElementById("clientName").value||"Client";var ref=document.getElementById("referent").value||"";var startDv=document.getElementById("startDate").value||"";var digital=document.getElementById("simDigital").value;var risk=document.getElementById("simRisk").value;var dur=digital==="debutant"?45:digital==="avance"?20:30;var vig=risk==="eleve"?"Renforcee":risk==="faible"?"Simplifiee":"Normale";
  doc.setFillColor(P[0],P[1],P[2]);doc.rect(0,0,pw,30,"F");doc.setTextColor(255);doc.setFontSize(16);doc.setFont("helvetica","bold");doc.text("ANNEXE 15 - Parcours d'integration client",m,12);doc.setFontSize(8);doc.setFont("helvetica","normal");doc.text("LCB-FT | NPMQ | NPLAB | RGPD | 5 phases, 24 taches",m,18);doc.text("Client : "+safe(client)+" | Referent : "+safe(ref)+" | Debut : "+safe(startDv),m,24);doc.text("Duree : "+dur+"j | Vigilance : "+safe(vig)+" | "+safe(fmtNow()),m,28);y=34;
  var total=0,done=0,mT=0,mD=0;for(var p=0;p<PHASES.length;p++){for(var i=0;i<PHASES[p].items.length;i++){var it=PHASES[p].items[i];total++;if(state.checked[it.id]===true)done++;if(it.mandatory){mT++;if(state.checked[it.id]===true)mD++;}}}var pct=total>0?Math.round(done/total*100):0;var confPct=mT>0?Math.round(mD/mT*100):0;
  doc.setFillColor(236,253,245);doc.roundedRect(m,y,cw,8,2,2,"F");doc.setFontSize(9);doc.setFont("helvetica","bold");doc.setTextColor(5,150,105);doc.text("Progression : "+done+"/"+total+" ("+pct+"%) | Conformite obligatoire : "+confPct+"%",m+cw/2,y+5.5,{align:"center"});y+=12;doc.setTextColor(0);
  hdr("1. CHECKLIST");for(var p=0;p<PHASES.length;p++){var ph=PHASES[p];var pd=0;for(var i=0;i<ph.items.length;i++){if(state.checked[ph.items[i].id]===true)pd++;}sub("Phase "+ph.id+" : "+ph.name+" ("+pd+"/"+ph.items.length+")");var rows=[];for(var i=0;i<ph.items.length;i++){var it=ph.items[i];rows.push([state.checked[it.id]===true?"[X]":"[ ]",(it.mandatory?"* ":"")+it.title,it.ref||""]);}tbl(["","Etape (* = obligatoire)","Ref."],rows,[8,cw-50,42]);}
  footer();doc.addPage();pn++;y=12;
  hdr("2. PROFIL REGLEMENTAIRE");
  var type2=document.getElementById("simType").value;var risk2=document.getElementById("simRisk").value;
  sub("Structure : "+(type2||"Non renseigne")+" | Risque LAB : "+(risk2||"Non renseigne"));
  if(type2&&KYC_DOCS[type2]){sub("Documents KYC requis ("+KYC_DOCS[type2].label+") :");var kycRows=[];for(var ki=0;ki<KYC_DOCS[type2].docs.length;ki++){kycRows.push(["‚Ä¢",safe(KYC_DOCS[type2].docs[ki])]);}tbl(["","Document"],kycRows,[8,cw-8]);}
  if(risk2&&VIG_DATA[risk2]){sub("Vigilance : "+safe(VIG_DATA[risk2].level)+" ("+safe(VIG_DATA[risk2].ref)+")");}
  tbl(["Obligation","Fondement","Action"],[["Identification client","Art. L561-5 CMF","CNI, Kbis/RNE, statuts"],["Benef. effectifs","Art. L561-2-2 CMF","Registre INPI (> 25 %)"],["Evaluation risque","Art. L561-4-1 CMF ; NPLAB","Grille Annexe 13"],["Conservation preuves","Art. L561-12 CMF","5 ans GED"],["Lettre de mission","Art. 151 Deontologie","AES (Annexe 14)"],["RGPD","Regl. UE 2016/679","Consentement, DPA, registre"],["E-facture","Art. 91 LF 2024","PA (ex-PDP), Factur-X"]],[45,40,cw-85]);
  if(state.bilan&&state.bilan.adopt){hdr("3. BILAN POST-ONBOARDING");tbl(["Indicateur","Resultat","Cible","Statut"],[["Adoption outils",(state.bilan.adopt||"-")+" %","> 80 %",parseFloat(state.bilan.adopt)>=80?"Conforme":"Alerte"],["Delai depot",(state.bilan.delai||"-")+" h","< 48 h",parseFloat(state.bilan.delai)<=48?"Conforme":"Alerte"],["Satisfaction",(state.bilan.sat||"-")+"/5","> 4/5",parseFloat(state.bilan.sat)>=4?"Conforme":"Alerte"],["Retards",(state.bilan.retard||"-"),"0",parseInt(state.bilan.retard)===0?"Conforme":"Alerte"]],[40,30,30,cw-100])}
  footer();doc.save("Annexe15_"+client.replace(/\s+/g,"_")+"_"+new Date().toISOString().split("T")[0]+".pdf");document.getElementById("loadingOverlay").classList.remove("show");toast("PDF g√©n√©r√©")}catch(e){console.error(e);document.getElementById("loadingOverlay").classList.remove("show");toast("Erreur : "+e.message)}},300)}

function fmtNow(){var d=new Date();return String(d.getDate()).padStart(2,"0")+"."+String(d.getMonth()+1).padStart(2,"0")+"."+d.getFullYear()+" a "+String(d.getHours()).padStart(2,"0")+"h"+String(d.getMinutes()).padStart(2,"0")}
function toast(msg){var el=document.getElementById("toast");el.textContent=msg;el.style.background="linear-gradient(135deg,#059669,#047857)";el.classList.add("show");setTimeout(function(){el.classList.remove("show")},2500)}
</script>
</body>
</html>
