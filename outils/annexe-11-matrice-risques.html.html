<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annexe 11 ‚Äì Matrice d'identification et d'√©valuation des risques</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #1e3a5f;
      --primary-light: #2d5a8a;
      --secondary: #0d9488;
      --secondary-light: #14b8a6;
      --accent: #f59e0b;
      --danger: #dc2626;
      --success: #059669;
      --warning: #d97706;
      --info: #2563eb;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --cat-responsabilite: #dc2626;
      --cat-cyber: #7c3aed;
      --cat-conformite: #059669;
      --cat-operationnel: #2563eb;
      --cat-financier: #db2777;
      --cat-strategique: #d97706;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--gray-100) 0%, #e0e7ef 100%);
      color: var(--gray-700); line-height: 1.6; min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    /* HEADER */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white; border-radius: var(--radius); padding: 28px 32px; margin-bottom: 20px;
      position: relative; overflow: hidden;
    }
    .header::before {
      content: ""; position: absolute; top: -50%; right: -10%;
      width: 300px; height: 300px; background: rgba(255,255,255,0.05); border-radius: 50%;
    }
    .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 6px; position: relative; }
    .header p { opacity: 0.9; font-size: 13px; max-width: 900px; position: relative; }
    .header-badges { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 20px;
      font-size: 11px; font-weight: 600;
    }

    /* STATS BAR */
    .stats-bar {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px; margin-bottom: 20px;
    }
    .stat-mini {
      background: white; border-radius: 10px; padding: 14px 16px;
      box-shadow: var(--shadow); text-align: center; border-top: 3px solid var(--primary);
    }
    .stat-mini.critical { border-top-color: var(--danger); }
    .stat-mini.success { border-top-color: var(--success); }
    .stat-mini.warning { border-top-color: var(--warning); }
    .stat-mini.info { border-top-color: var(--info); }
    .stat-val { font-size: 22px; font-weight: 800; color: var(--primary); }
    .stat-mini.critical .stat-val { color: var(--danger); }
    .stat-mini.success .stat-val { color: var(--success); }
    .stat-mini.warning .stat-val { color: var(--warning); }
    .stat-mini.info .stat-val { color: var(--info); }
    .stat-lbl { font-size: 11px; color: var(--gray-500); font-weight: 600; text-transform: uppercase; margin-top: 2px; }

    /* ACTION BAR */
    .action-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 20px; border: none; border-radius: 8px;
      font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
    .btn-success { background: var(--success); color: white; }
    .btn-accent { background: var(--accent); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-sm { padding: 6px 14px; font-size: 12px; }

    /* TABS */
    .tabs {
      display: flex; gap: 3px; background: white; padding: 6px;
      border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; flex-wrap: wrap;
    }
    .tab {
      padding: 10px 18px; border: none; background: transparent;
      font-size: 13px; font-weight: 600; color: var(--gray-600);
      border-radius: 8px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
    }
    .tab:hover { background: var(--gray-100); }
    .tab.active { background: var(--primary); color: white; }

    /* PANELS */
    .panel { display: none; animation: fadeIn 0.3s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS */
    .card {
      background: white; border-radius: var(--radius);
      padding: 24px; box-shadow: var(--shadow); margin-bottom: 16px;
    }
    .card-header {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 16px; padding-bottom: 14px; border-bottom: 1px solid var(--gray-200);
    }
    .card-icon {
      width: 44px; height: 44px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: white; flex-shrink: 0; font-weight: 700;
    }
    .card h3 { font-size: 16px; font-weight: 700; color: var(--gray-800); }
    .card .subtitle { color: var(--gray-500); font-size: 12px; margin-top: 2px; }

    /* CATALOGUE */
    .cat-section {
      border: 1px solid var(--gray-200); border-radius: 10px;
      margin-bottom: 12px; overflow: hidden;
    }
    .cat-header {
      display: flex; align-items: center; gap: 12px; padding: 14px 18px;
      cursor: pointer; transition: background 0.2s; background: var(--gray-50);
    }
    .cat-header:hover { background: var(--gray-100); }
    .cat-icon {
      width: 36px; height: 36px; border-radius: 8px; display: flex;
      align-items: center; justify-content: center; font-size: 14px;
      color: white; font-weight: 700; flex-shrink: 0;
    }
    .cat-name { font-weight: 700; font-size: 14px; color: var(--gray-800); }
    .cat-desc { font-size: 11px; color: var(--gray-500); }
    .cat-badges { margin-left: auto; display: flex; gap: 6px; }
    .cat-badge {
      padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
    }
    .cat-badge-total { background: var(--gray-100); color: var(--gray-600); }
    .cat-badge-eval { background: #dbeafe; color: var(--info); }
    .cat-arrow { margin-left: 8px; transition: transform 0.3s; font-size: 12px; color: var(--gray-500); }
    .cat-arrow.open { transform: rotate(180deg); }
    .cat-body { display: none; padding: 0 18px 14px; }
    .cat-body.open { display: block; }

    .risk-item {
      display: grid; grid-template-columns: 50px 1fr auto;
      gap: 12px; align-items: center; padding: 12px 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .risk-item:last-child { border-bottom: none; }
    .risk-id {
      font-weight: 700; font-size: 12px; color: white; background: var(--primary);
      padding: 4px 8px; border-radius: 6px; text-align: center;
    }
    .risk-name { font-weight: 600; font-size: 13px; color: var(--gray-800); }
    .risk-desc { font-size: 11px; color: var(--gray-500); margin-top: 2px; }
    .risk-refs { font-size: 10px; color: var(--gray-500); margin-top: 3px; font-style: italic; }
    .risk-impact-range {
      font-size: 11px; color: var(--danger); font-weight: 600;
      background: #fef2f2; padding: 3px 8px; border-radius: 6px; white-space: nowrap;
    }
    .risk-actions { display: flex; gap: 6px; align-items: center; }
    .score-badge {
      padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;
      min-width: 24px; text-align: center;
    }
    .score-critique { background: #fef2f2; color: #991b1b; }
    .score-eleve { background: #fff7ed; color: #c2410c; }
    .score-modere { background: #fefce8; color: #a16207; }
    .score-faible { background: #f0fdf4; color: #15803d; }
    .score-na { background: var(--gray-100); color: var(--gray-500); }

    /* EVALUATION */
    .eval-form { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .eval-section {
      background: var(--gray-50); border-radius: 8px; padding: 14px;
      border: 2px solid var(--gray-200);
    }
    .eval-section.brut { border-color: #fca5a5; background: #fef2f2; }
    .eval-section.residuel { border-color: #86efac; background: #f0fdf4; }
    .eval-section h4 { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
    .eval-section.brut h4 { color: #991b1b; }
    .eval-section.residuel h4 { color: #15803d; }
    .eval-full { grid-column: 1 / -1; }
    .form-group { margin-bottom: 10px; }
    .form-group label {
      display: block; font-size: 11px; font-weight: 600;
      color: var(--gray-600); margin-bottom: 4px;
    }
    .form-group select, .form-group textarea, .form-group input {
      width: 100%; padding: 7px 10px; border: 1px solid var(--gray-300);
      border-radius: 6px; font-size: 12px; font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-group select:focus, .form-group textarea:focus, .form-group input:focus {
      outline: none; border-color: var(--primary);
    }
    .score-display {
      font-size: 20px; font-weight: 800; text-align: center;
      padding: 8px; border-radius: 6px; margin-top: 6px;
    }
    .score-display.brut { color: #991b1b; background: rgba(239,68,68,0.1); }
    .score-display.residuel { color: #15803d; background: rgba(34,197,94,0.1); }

    .eval-summary { margin-top: 14px; }
    .eval-table {
      width: 100%; border-collapse: collapse; font-size: 12px;
    }
    .eval-table th {
      background: var(--primary); color: white; padding: 10px 12px;
      text-align: left; font-weight: 600;
    }
    .eval-table td { padding: 8px 12px; border-bottom: 1px solid var(--gray-200); }
    .eval-table tr:hover { background: var(--gray-50); }
    .eval-table tr:nth-child(even) { background: var(--gray-50); }

    /* RISK SELECTOR */
    .risk-selector {
      background: white; border-radius: 8px; padding: 12px;
      border: 2px solid var(--primary); margin-bottom: 14px;
    }
    .risk-selector-info {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;
    }
    .risk-selector-info .info-item {
      background: var(--gray-50); padding: 8px; border-radius: 6px;
    }
    .info-label { font-size: 9px; color: var(--gray-500); font-weight: 600; text-transform: uppercase; }
    .info-value { font-size: 12px; color: var(--gray-800); font-weight: 600; margin-top: 2px; }

    /* MATRICES */
    .matrices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .matrix-card { background: white; border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
    .matrix-card h4 { font-size: 14px; font-weight: 700; margin-bottom: 14px; text-align: center; }
    .matrix-card.brut h4 { color: #991b1b; }
    .matrix-card.residuel h4 { color: #15803d; }
    .matrix-wrapper { position: relative; padding-left: 30px; padding-bottom: 30px; }
    .matrix-ylabel {
      position: absolute; left: 0; top: 50%; transform: rotate(-90deg) translateX(-50%);
      font-size: 11px; font-weight: 700; color: var(--gray-600); white-space: nowrap;
    }
    .matrix-xlabel {
      text-align: center; font-size: 11px; font-weight: 700; color: var(--gray-600); margin-top: 6px;
    }
    .matrix-grid {
      display: grid; grid-template-columns: 30px repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr) 30px; gap: 2px;
    }
    .matrix-cell {
      aspect-ratio: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; border-radius: 6px; font-size: 9px; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s; position: relative; min-height: 52px;
    }
    .matrix-cell:hover { transform: scale(1.08); box-shadow: var(--shadow-lg); z-index: 2; }
    .matrix-cell.critique { background: #fecaca; border: 1px solid #fca5a5; }
    .matrix-cell.eleve { background: #fed7aa; border: 1px solid #fdba74; }
    .matrix-cell.modere { background: #fef08a; border: 1px solid #fde047; }
    .matrix-cell.faible { background: #bbf7d0; border: 1px solid #86efac; }
    .matrix-label-row, .matrix-label-col {
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; color: var(--gray-600);
    }
    .matrix-dot {
      display: inline-flex; align-items: center; justify-content: center;
      width: 20px; height: 16px; border-radius: 3px; font-size: 8px;
      font-weight: 700; color: white; background: var(--primary); margin: 1px;
    }
    .matrix-cell-dots { display: flex; flex-wrap: wrap; justify-content: center; gap: 1px; }

    /* MIGRATION */
    .migration-card { background: white; border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-top: 20px; }
    .migration-item {
      display: flex; align-items: center; gap: 12px; padding: 8px 0;
      border-bottom: 1px solid var(--gray-100); font-size: 13px;
    }
    .migration-item:last-child { border-bottom: none; }
    .migration-arrow { color: var(--success); font-weight: 700; font-size: 16px; }
    .migration-improved { color: var(--success); font-weight: 600; }
    .migration-unchanged { color: var(--warning); font-weight: 600; }
    .migration-worsened { color: var(--danger); font-weight: 600; }

    /* ACTION PLAN */
    .priority-section { margin-bottom: 20px; }
    .priority-header {
      display: flex; align-items: center; gap: 10px; padding: 12px 16px;
      border-radius: 8px; font-weight: 700; font-size: 14px; margin-bottom: 12px;
    }
    .priority-header.immediate { background: #fef2f2; color: #991b1b; border-left: 4px solid #dc2626; }
    .priority-header.court { background: #fff7ed; color: #c2410c; border-left: 4px solid #f97316; }
    .priority-header.moyen { background: #fefce8; color: #a16207; border-left: 4px solid #eab308; }
    .priority-header.maitrise { background: #f0fdf4; color: #15803d; border-left: 4px solid #22c55e; }
    .action-item {
      background: white; border-radius: 10px; padding: 16px; margin-bottom: 10px;
      box-shadow: var(--shadow); border-left: 4px solid var(--gray-300);
      display: grid; grid-template-columns: 60px 1fr auto; gap: 12px; align-items: start;
    }
    .action-item.critique { border-left-color: #dc2626; }
    .action-item.eleve { border-left-color: #f97316; }
    .action-item.modere { border-left-color: #eab308; }
    .action-item.faible { border-left-color: #22c55e; }
    .action-scores { display: flex; gap: 6px; align-items: center; }

    /* GUIDE */
    .guide-section { margin-bottom: 20px; }
    .guide-section h4 { color: var(--primary); font-size: 15px; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid var(--gray-200); }
    .scale-table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 10px 0; }
    .scale-table th { background: var(--primary); color: white; padding: 8px 12px; text-align: left; }
    .scale-table td { padding: 8px 12px; border-bottom: 1px solid var(--gray-200); }
    .scale-table tr:nth-child(even) { background: var(--gray-50); }

    /* MODAL */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white; border-radius: var(--radius); padding: 28px;
      max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-lg);
    }
    .modal h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--primary); }
    .modal-close {
      float: right; background: none; border: none; font-size: 20px;
      cursor: pointer; color: var(--gray-500); padding: 4px;
    }

    /* TOAST */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 12px 24px;
      background: var(--primary); color: white; border-radius: 8px;
      font-size: 13px; font-weight: 600; box-shadow: var(--shadow-lg);
      transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.warning { background: var(--warning); }

    /* EMPTY STATE */
    .empty-state {
      text-align: center; padding: 40px; color: var(--gray-500); font-style: italic;
    }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      .eval-form { grid-template-columns: 1fr; }
      .matrices-grid { grid-template-columns: 1fr; }
      .risk-selector-info { grid-template-columns: 1fr; }
      .stats-bar { grid-template-columns: repeat(3, 1fr); }
      .action-item { grid-template-columns: 50px 1fr; }
    }
    @media (max-width: 600px) {
      .container { padding: 12px; }
      .stats-bar { grid-template-columns: repeat(2, 1fr); }
    }

    /* PRINT */
    @media print {
      body { background: white; }
      .action-bar, .tabs, .btn { display: none !important; }
      .panel { display: block !important; page-break-inside: avoid; margin-bottom: 20px; }
      .card { box-shadow: none; border: 1px solid #ddd; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <h1>Annexe 11 ‚Äì Matrice d'identification et d'√©valuation des risques</h1>
    <p>Outil d'√©valuation des risques professionnels avec double cotation brut/r√©siduel conforme ISO 31000. Identification, √©valuation et plan de ma√Ætrise des 29 risques sp√©cifiques au cabinet d'expertise comptable 100 % num√©rique.</p>
    <div class="header-badges">
      <span class="badge">üìã ISO 31000:2018</span>
      <span class="badge">‚öñÔ∏è NPMQ (01/01/2025)</span>
      <span class="badge">üîí Code de d√©ontologie 2026</span>
      <span class="badge">üõ°Ô∏è RGPD / NIS2</span>
      <span class="badge">üìä 29 risques ‚Äì 6 cat√©gories</span>
    </div>
  </div>

  <!-- STATS BAR -->
  <div class="stats-bar">
    <div class="stat-mini info">
      <div class="stat-val" id="statTotal">0/29</div>
      <div class="stat-lbl">Risques √©valu√©s</div>
    </div>
    <div class="stat-mini critical">
      <div class="stat-val" id="statBrut">‚Äì</div>
      <div class="stat-lbl">Score brut moyen</div>
    </div>
    <div class="stat-mini success">
      <div class="stat-val" id="statResiduel">‚Äì</div>
      <div class="stat-lbl">Score r√©siduel moyen</div>
    </div>
    <div class="stat-mini warning">
      <div class="stat-val" id="statReduction">‚Äì</div>
      <div class="stat-lbl">R√©duction globale</div>
    </div>
    <div class="stat-mini">
      <div class="stat-val" id="statCritiques">0</div>
      <div class="stat-lbl">Risques critiques r√©siduels</div>
    </div>
  </div>

  <!-- ACTION BAR -->
  <div class="action-bar">
    <button class="btn btn-primary" onclick="saveState()">üíæ Sauvegarder</button>
    <button class="btn btn-secondary" onclick="exportPDF()">üìÑ Export PDF</button>
    <button class="btn btn-accent" onclick="loadCabinetX()">üìÇ Cas pratique Cabinet X</button>
    <button class="btn btn-danger" onclick="resetAll()">üîÑ R√©initialiser</button>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab" onclick="showTab('catalogue')">üìã Catalogue</button>
    <button class="tab" onclick="showTab('evaluation')">üéØ √âvaluation</button>
    <button class="tab active" onclick="showTab('matrice')">üìä Matrices</button>
    <button class="tab" onclick="showTab('actions')">‚ö° Plan d'action</button>
    <button class="tab" onclick="showTab('guide')">üìñ Guide</button>
  </div>

  <!-- TAB 1: CATALOGUE -->
  <div id="catalogue" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">üìã</div>
        <div>
          <h3>Catalogue des risques du cabinet num√©rique</h3>
          <div class="subtitle">29 risques identifi√©s dans 6 cat√©gories ‚Äì Sources professionnelles 2024-2026</div>
        </div>
      </div>
      <div id="catalogueContent"></div>
    </div>
  </div>

  <!-- TAB 2: EVALUATION -->
  <div id="evaluation" class="panel">
    <div class="risk-selector">
      <div class="form-group" style="margin-bottom:0;">
        <label>S√©lectionner un risque √† √©valuer</label>
        <select id="riskSelect" onchange="onRiskSelect()">
          <option value="">-- Choisir un risque --</option>
        </select>
      </div>
      <div id="riskInfo" class="risk-selector-info" style="display:none;"></div>
    </div>

    <div id="evalFormContainer" style="display:none;">
      <div class="eval-form">
        <div class="eval-section brut">
          <h4>üî¥ Risque BRUT (avant mesures)</h4>
          <p style="font-size:10px;color:#991b1b;margin-bottom:10px;">Niveau d'exposition ¬´ naturel ¬ª du cabinet, sans aucune mesure de ma√Ætrise.</p>
          <div class="form-group">
            <label>Probabilit√© (1 = Rare ‚Üí 5 = Quasi-certain)</label>
            <select id="brutProb" onchange="calcScores()">
              <option value="">‚Äì</option>
              <option value="1">1 ‚Äì Rare</option>
              <option value="2">2 ‚Äì Peu probable</option>
              <option value="3">3 ‚Äì Possible</option>
              <option value="4">4 ‚Äì Probable</option>
              <option value="5">5 ‚Äì Quasi-certain</option>
            </select>
          </div>
          <div class="form-group">
            <label>Impact (1 = N√©gligeable ‚Üí 5 = Catastrophique)</label>
            <select id="brutImpact" onchange="calcScores()">
              <option value="">‚Äì</option>
              <option value="1">1 ‚Äì N√©gligeable</option>
              <option value="2">2 ‚Äì Mineur</option>
              <option value="3">3 ‚Äì Mod√©r√©</option>
              <option value="4">4 ‚Äì Majeur</option>
              <option value="5">5 ‚Äì Catastrophique</option>
            </select>
          </div>
          <div class="score-display brut" id="scoreBrut">‚Äì</div>
        </div>

        <div class="eval-section residuel">
          <h4>üü¢ Risque R√âSIDUEL (apr√®s mesures)</h4>
          <p style="font-size:10px;color:#15803d;margin-bottom:10px;">Niveau de risque cible apr√®s application des mesures de ma√Ætrise identifi√©es.</p>
          <div class="form-group">
            <label>Probabilit√© r√©siduelle (1 ‚Üí 5)</label>
            <select id="resProb" onchange="calcScores()">
              <option value="">‚Äì</option>
              <option value="1">1 ‚Äì Rare</option>
              <option value="2">2 ‚Äì Peu probable</option>
              <option value="3">3 ‚Äì Possible</option>
              <option value="4">4 ‚Äì Probable</option>
              <option value="5">5 ‚Äì Quasi-certain</option>
            </select>
          </div>
          <div class="form-group">
            <label>Impact r√©siduel (1 ‚Üí 5)</label>
            <select id="resImpact" onchange="calcScores()">
              <option value="">‚Äì</option>
              <option value="1">1 ‚Äì N√©gligeable</option>
              <option value="2">2 ‚Äì Mineur</option>
              <option value="3">3 ‚Äì Mod√©r√©</option>
              <option value="4">4 ‚Äì Majeur</option>
              <option value="5">5 ‚Äì Catastrophique</option>
            </select>
          </div>
          <div class="score-display residuel" id="scoreRes">‚Äì</div>
        </div>

        <div class="eval-section eval-full" style="background:white;border-color:var(--gray-200);">
          <h4 style="color:var(--primary);">üîß Mesures de ma√Ætrise</h4>
          <div class="form-group">
            <label>Description des mesures mises en place ou pr√©vues</label>
            <textarea id="evalControls" rows="3" placeholder="Ex : MFA activ√© sur tous les acc√®s, sauvegarde 3-2-1, formation √©quipe..."></textarea>
          </div>
          <div style="text-align:right;margin-top:10px;">
            <button class="btn btn-success" onclick="saveEvaluation()">‚úÖ Enregistrer l'√©valuation</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SUMMARY TABLE -->
    <div class="eval-summary">
      <div class="card" style="margin-top:20px;">
        <div class="card-header">
          <div class="card-icon" style="background:linear-gradient(135deg,var(--secondary),var(--secondary-light));">üìä</div>
          <div>
            <h3>Synth√®se des √©valuations</h3>
            <div class="subtitle" id="evalCount">0 risque(s) √©valu√©(s) sur 29</div>
          </div>
        </div>
        <div id="evalSummaryTable"></div>
      </div>
    </div>
  </div>

  <!-- TAB 3: MATRICES -->
  <div id="matrice" class="panel">
    <div class="matrices-grid">
      <div class="matrix-card brut">
        <h4>üî¥ Matrice Risque BRUT</h4>
        <div class="matrix-wrapper">
          <div class="matrix-ylabel">Probabilit√© ‚Üí</div>
          <div class="matrix-grid" id="matrixBrut"></div>
          <div class="matrix-xlabel">Impact ‚Üí</div>
        </div>
      </div>
      <div class="matrix-card residuel">
        <h4>üü¢ Matrice Risque R√âSIDUEL</h4>
        <div class="matrix-wrapper">
          <div class="matrix-ylabel">Probabilit√© ‚Üí</div>
          <div class="matrix-grid" id="matrixRes"></div>
          <div class="matrix-xlabel">Impact ‚Üí</div>
        </div>
      </div>
    </div>

    <div class="migration-card">
      <div class="card-header">
        <div class="card-icon" style="background:linear-gradient(135deg,var(--success),#34d399);">‚Üì</div>
        <div>
          <h3>Migration des risques (Brut ‚Üí R√©siduel)</h3>
          <div class="subtitle">Efficacit√© des mesures de ma√Ætrise par risque √©valu√©</div>
        </div>
      </div>
      <div id="migrationContent"></div>
    </div>
  </div>

  <!-- TAB 4: PLAN D'ACTION -->
  <div id="actions" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-icon" style="background:linear-gradient(135deg,var(--accent),#fbbf24);">‚ö°</div>
        <div>
          <h3>Plan d'action ‚Äì Mesures de ma√Ætrise prioritaires</h3>
          <div class="subtitle" id="actionSummary">√âvaluez les risques pour g√©n√©rer le plan d'action.</div>
        </div>
      </div>
      <div id="actionPlanContent"></div>
    </div>
  </div>

  <!-- TAB 5: GUIDE -->
  <div id="guide" class="panel">
    <div class="card">
      <div class="card-header">
        <div class="card-icon" style="background:linear-gradient(135deg,var(--info),#60a5fa);">üìñ</div>
        <div>
          <h3>Guide d'utilisation</h3>
          <div class="subtitle">M√©thodologie, √©chelles de cotation et r√©f√©rences normatives</div>
        </div>
      </div>

      <div class="guide-section">
        <h4>1. M√©thodologie de double cotation (ISO 31000:2018)</h4>
        <p style="font-size:13px;margin-bottom:10px;">L'outil applique une <strong>double cotation</strong> conforme √† la norme ISO 31000 et aux exigences de la NPMQ (entr√©e en vigueur le 1<sup>er</sup> janvier 2025) :</p>
        <p style="font-size:13px;margin-bottom:6px;"><strong>Risque Brut :</strong> niveau d'exposition ¬´ naturel ¬ª du cabinet, <em>avant</em> toute mesure de ma√Ætrise. Il repr√©sente le risque inh√©rent √† l'activit√©.</p>
        <p style="font-size:13px;margin-bottom:14px;"><strong>Risque R√©siduel :</strong> niveau de risque <em>apr√®s</em> application des mesures de ma√Ætrise. C'est le risque effectivement port√© par le cabinet et la cible √† atteindre.</p>
        <p style="font-size:13px;"><strong>Score = Probabilit√© √ó Impact</strong> (√©chelle 1 √† 25)</p>
      </div>

      <div class="guide-section">
        <h4>2. √âchelle de probabilit√©</h4>
        <table class="scale-table">
          <thead><tr><th>Niveau</th><th>Libell√©</th><th>Fr√©quence indicative</th></tr></thead>
          <tbody>
            <tr><td><strong>1</strong></td><td>Rare</td><td>Moins d'une fois tous les 5 ans</td></tr>
            <tr><td><strong>2</strong></td><td>Peu probable</td><td>Une fois tous les 2 √† 5 ans</td></tr>
            <tr><td><strong>3</strong></td><td>Possible</td><td>Une fois par an</td></tr>
            <tr><td><strong>4</strong></td><td>Probable</td><td>Plusieurs fois par an</td></tr>
            <tr><td><strong>5</strong></td><td>Quasi-certain</td><td>Plusieurs fois par trimestre</td></tr>
          </tbody>
        </table>
      </div>

      <div class="guide-section">
        <h4>3. √âchelle d'impact</h4>
        <table class="scale-table">
          <thead><tr><th>Niveau</th><th>Libell√©</th><th>Cons√©quence type</th></tr></thead>
          <tbody>
            <tr><td><strong>1</strong></td><td>N√©gligeable</td><td>Impact mineur, pas de cons√©quence durable</td></tr>
            <tr><td><strong>2</strong></td><td>Mineur</td><td>D√©sagr√©ment g√©rable sans aide externe</td></tr>
            <tr><td><strong>3</strong></td><td>Mod√©r√©</td><td>Perturbation significative, intervention n√©cessaire</td></tr>
            <tr><td><strong>4</strong></td><td>Majeur</td><td>Impact financier ou r√©putationnel important</td></tr>
            <tr><td><strong>5</strong></td><td>Catastrophique</td><td>Menace la continuit√© d'activit√© du cabinet</td></tr>
          </tbody>
        </table>
      </div>

      <div class="guide-section">
        <h4>4. Grille d'interpr√©tation des scores</h4>
        <table class="scale-table">
          <thead><tr><th>Score</th><th>Niveau</th><th>Action requise</th></tr></thead>
          <tbody>
            <tr><td><span class="score-badge score-critique">16-25</span></td><td>Critique</td><td>Action imm√©diate (0-30 jours). Traitement prioritaire, escalade direction.</td></tr>
            <tr><td><span class="score-badge score-eleve">10-15</span></td><td>√âlev√©</td><td>Court terme (30-90 jours). Plan d'action formalis√©, suivi mensuel.</td></tr>
            <tr><td><span class="score-badge score-modere">5-9</span></td><td>Mod√©r√©</td><td>Moyen terme (90-180 jours). Surveillance, am√©lioration continue.</td></tr>
            <tr><td><span class="score-badge score-faible">1-4</span></td><td>Faible</td><td>Sous ma√Ætrise. Maintien des mesures, revue annuelle.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="guide-section">
        <h4>5. Les 6 cat√©gories de risques</h4>
        <table class="scale-table">
          <thead><tr><th>Cat√©gorie</th><th>P√©rim√®tre</th><th>R√©f√©rences cl√©s</th></tr></thead>
          <tbody>
            <tr><td style="color:var(--cat-responsabilite);font-weight:700;">Responsabilit√© professionnelle</td><td>Devoir de conseil, secret professionnel, conflits d'int√©r√™ts</td><td>Code de d√©ontologie art. 145-161, RC Pro</td></tr>
            <tr><td style="color:var(--cat-cyber);font-weight:700;">Cybers√©curit√© et donn√©es</td><td>Cyberattaques, RGPD, s√©curit√© SI, protection des donn√©es</td><td>RGPD art. 32-34, ANSSI, NIS2</td></tr>
            <tr><td style="color:var(--cat-conformite);font-weight:700;">Conformit√© r√©glementaire</td><td>LCB-FT, lettre de mission, NPMQ, facture √©lectronique</td><td>NPMQ, CMF L.561-15, CGI art. 289 bis</td></tr>
            <tr><td style="color:var(--cat-operationnel);font-weight:700;">Risques op√©rationnels</td><td>D√©faillance SI, d√©part collaborateur, surcharge, d√©pendance</td><td>PCA/PRA, Code du travail, QVT</td></tr>
            <tr><td style="color:var(--cat-financier);font-weight:700;">Risques financiers</td><td>D√©faillance client, sous-tarification, co√ªts, RC Pro</td><td>Art. 157-161 Code d√©ontologie, gestion</td></tr>
            <tr><td style="color:var(--cat-strategique);font-weight:700;">Risques strat√©giques</td><td>Obsolescence, concurrence, r√©glementation, e-r√©putation</td><td>Formation continue obligatoire, veille</td></tr>
          </tbody>
        </table>
      </div>

      <div class="guide-section">
        <h4>6. Mode d'emploi</h4>
        <p style="font-size:13px;margin-bottom:8px;"><strong>√âtape 1 ‚Äì Catalogue :</strong> Parcourir les 29 risques identifi√©s, regroup√©s en 6 cat√©gories. Chaque risque est document√© avec ses r√©f√©rences normatives et une fourchette d'impact financier.</p>
        <p style="font-size:13px;margin-bottom:8px;"><strong>√âtape 2 ‚Äì √âvaluation :</strong> S√©lectionner chaque risque et attribuer une double cotation (brut puis r√©siduel). D√©crire les mesures de ma√Ætrise mises en place ou pr√©vues.</p>
        <p style="font-size:13px;margin-bottom:8px;"><strong>√âtape 3 ‚Äì Matrices :</strong> Visualiser le positionnement de chaque risque sur les matrices 5√ó5 et constater la migration brut ‚Üí r√©siduel.</p>
        <p style="font-size:13px;margin-bottom:8px;"><strong>√âtape 4 ‚Äì Plan d'action :</strong> Consulter le plan d'action auto-g√©n√©r√©, hi√©rarchis√© par niveau de priorit√© (imm√©diat, court terme, moyen terme, sous ma√Ætrise).</p>
        <p style="font-size:13px;"><strong>üíæ Sauvegarder :</strong> Les donn√©es sont conserv√©es dans le navigateur. Utilisez ¬´ Export PDF ¬ª pour g√©n√©rer un document imprimable.</p>
      </div>

      <div class="guide-section">
        <h4>7. Sources et r√©f√©rences</h4>
        <p style="font-size:12px;color:var(--gray-600);line-height:1.8;">
          ISO 31000:2018 ‚Äì Management du risque ‚Ä¢ NPMQ (entr√©e en vigueur 01/01/2025) ‚Ä¢
          Code de d√©ontologie des professionnels de l'expertise comptable (√©dition janvier 2026) ‚Ä¢
          RGPD ‚Äì R√®glement UE 2016/679, art. 32-34 ‚Ä¢ Directive NIS2 ‚Äì 2022/2555 ‚Ä¢
          ANSSI ‚Äì Guide d'hygi√®ne informatique (2024) ‚Ä¢ CMF ‚Äì Art. L.561-15 (LCB-FT) ‚Ä¢
          CGI ‚Äì Art. 289 bis (facturation √©lectronique) ‚Ä¢ D√©cret 2012-432, art. 135 (RC Pro obligatoire) ‚Ä¢
          Ordonnance du 19/09/1945 (exercice professionnel) ‚Ä¢
          NPLAB ‚Äì Norme anti-blanchiment, plateforme Ermes (01/02/2025) ‚Ä¢
          Barom√®tre OMECA S2 2025 (publi√© 19/01/2026) ‚Äì sinistralit√© cyber et tensions RH.
        </p>
      </div>
    </div>
  </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="riskModal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modalContent"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// =====================================================
// CATEGORIES
// =====================================================
const CATEGORIES = {
  responsabilite: { name: "Responsabilit√© professionnelle", color: "#dc2626", icon: "R", description: "Obligations d√©ontologiques et RC" },
  cyber: { name: "Cybers√©curit√© et donn√©es", color: "#7c3aed", icon: "C", description: "S√©curit√© informatique et RGPD" },
  conformite: { name: "Conformit√© r√©glementaire", color: "#059669", icon: "F", description: "Obligations l√©gales et normatives" },
  operationnel: { name: "Risques op√©rationnels", color: "#2563eb", icon: "O", description: "Fonctionnement quotidien" },
  financier: { name: "Risques financiers", color: "#db2777", icon: "$", description: "Sant√© financi√®re du cabinet" },
  strategique: { name: "Risques strat√©giques", color: "#d97706", icon: "S", description: "Positionnement et p√©rennit√©" }
};

// =====================================================
// CATALOGUE DES 29 RISQUES
// =====================================================
const RISKS = [
  // RESPONSABILIT√â PROFESSIONNELLE
  { id:"R01", cat:"responsabilite", name:"Manquement au devoir de conseil", desc:"Non-respect de l'obligation de conseil et d'information envers le client", refs:"Art. 155 Code d√©ontologie ¬∑ RC contractuelle", impact:{min:5000,max:80000,typical:25000}, measures:"Formaliser les conseils par √©crit, tracer les √©changes, actualiser les connaissances" },
  { id:"R02", cat:"responsabilite", name:"Violation du secret professionnel", desc:"Divulgation d'informations confidentielles clients", refs:"Art. 147 Code d√©ontologie ¬∑ Art. 226-13 Code p√©nal", impact:{min:10000,max:200000,typical:40000}, measures:"Politique de confidentialit√©, clauses NDA, s√©curisation des acc√®s" },
  { id:"R03", cat:"responsabilite", name:"Conflit d'int√©r√™ts", desc:"Acceptation de missions incompatibles ou int√©r√™ts personnels conflictuels", refs:"Art. 145-149 Code d√©ontologie ¬∑ NPMQ", impact:{min:5000,max:50000,typical:15000}, measures:"Proc√©dure d'acceptation des missions, d√©claration d'int√©r√™ts" },
  { id:"R04", cat:"responsabilite", name:"Erreur dans les comptes annuels", desc:"Erreurs significatives dans l'√©tablissement ou la r√©vision des comptes", refs:"Normes professionnelles ¬∑ RC civile", impact:{min:15000,max:150000,typical:50000}, measures:"Revue de dossier, contr√¥le qualit√©, formation continue" },
  { id:"R05", cat:"responsabilite", name:"Non-respect des d√©lais l√©gaux", desc:"Retard dans les d√©clarations fiscales ou sociales", refs:"CGI ¬∑ Code S√©curit√© sociale", impact:{min:1000,max:30000,typical:8000}, measures:"Planning centralis√©, alertes automatiques, supervision" },
  // CYBERS√âCURIT√â
  { id:"C01", cat:"cyber", name:"Cyberattaque par ransomware", desc:"Chiffrement des donn√©es par logiciel malveillant avec demande de ran√ßon", refs:"RGPD art. 32 ¬∑ NIS2 ¬∑ ANSSI", impact:{min:150000,max:350000,typical:225000}, measures:"Sauvegarde 3-2-1, MFA, formation √©quipes, PRA/PCA, EDR/XDR" },
  { id:"C02", cat:"cyber", name:"Phishing et ing√©nierie sociale", desc:"Compromission par e-mail frauduleux ou manipulation", refs:"RGPD ¬∑ ANSSI", impact:{min:5000,max:100000,typical:30000}, measures:"Sensibilisation √©quipes, filtrage e-mails, simulations phishing" },
  { id:"C03", cat:"cyber", name:"Violation de donn√©es personnelles", desc:"Fuite ou acc√®s non autoris√© aux donn√©es personnelles (RGPD)", refs:"RGPD art. 33-34 ¬∑ CNIL", impact:{min:28000,max:125000,typical:63000}, measures:"Chiffrement, contr√¥le d'acc√®s, registre traitements, notification 72 h" },
  { id:"C04", cat:"cyber", name:"D√©faillance prestataire Cloud/SaaS", desc:"Indisponibilit√© ou faille chez un √©diteur de logiciel m√©tier", refs:"RGPD art. 28 ¬∑ Contrats SLA", impact:{min:10000,max:80000,typical:35000}, measures:"Audit prestataires, clauses contractuelles, plan B, sauvegardes locales" },
  { id:"C05", cat:"cyber", name:"Perte de donn√©es", desc:"Perte accidentelle de donn√©es (erreur humaine, d√©faillance technique)", refs:"RGPD art. 32 ¬∑ Normes archivage", impact:{min:5000,max:50000,typical:20000}, measures:"Politique de sauvegarde 3-2-1, tests restauration mensuels, GED s√©curis√©e" },
  { id:"C06", cat:"cyber", name:"Non-conformit√© RGPD", desc:"Non-respect des obligations du r√®glement sur la protection des donn√©es", refs:"RGPD ¬∑ CNIL", impact:{min:5000,max:25000,typical:15000}, measures:"Registre traitements, base l√©gale, droits des personnes, privacy by design" },
  // CONFORMIT√â R√âGLEMENTAIRE
  { id:"F01", cat:"conformite", name:"Manquement LCB-FT / TRACFIN", desc:"Non-respect des obligations de lutte contre le blanchiment", refs:"NPLAB ¬∑ CMF L.561-15 ¬∑ Ermes (01/02/2025)", impact:{min:5000,max:22500,typical:12000}, measures:"Proc√©dures KYC, formation ReflexLab, d√©claration via Ermes" },
  { id:"F02", cat:"conformite", name:"D√©faut de lettre de mission", desc:"Absence ou insuffisance de la lettre de mission", refs:"Art. 151 Code d√©ontologie ¬∑ Normes pro.", impact:{min:2000,max:20000,typical:8000}, measures:"Mod√®les √† jour, signature √©lectronique, archivage GED" },
  { id:"F03", cat:"conformite", name:"Non-respect NPMQ", desc:"Non-conformit√© √† la norme de management de la qualit√©", refs:"NPMQ (30/05/2024, vigueur 01/01/2025)", impact:{min:0,max:50000,typical:10000}, measures:"Manuel qualit√©, revue annuelle, pr√©paration contr√¥le Ordre" },
  { id:"F04", cat:"conformite", name:"Exercice ill√©gal", desc:"Exercice d'activit√©s r√©serv√©es sans qualifications requises", refs:"Ordonnance 19/09/1945 ¬∑ Code p√©nal", impact:{min:10000,max:100000,typical:30000}, measures:"P√©rim√®tre missions clair, partenariats r√©gul√©s, veille r√©glementaire" },
  { id:"F05", cat:"conformite", name:"Non-conformit√© facturation √©lectronique", desc:"Non-respect des obligations e-facture (calendrier 2026-2027)", refs:"CGI art. 289 bis ¬∑ LF 2024 art. 91", impact:{min:1000,max:15000,typical:5000}, measures:"Anticipation PA agr√©√©e, mise √† jour outils, accompagnement clients" },
  // OP√âRATIONNEL
  { id:"O01", cat:"operationnel", name:"D√©faillance du syst√®me d'information", desc:"Panne mat√©rielle ou logicielle impactant la production", refs:"PCA/PRA ¬∑ Continuit√© d'activit√©", impact:{min:5000,max:40000,typical:15000}, measures:"Redondance, maintenance pr√©ventive, support r√©actif, PRA document√©" },
  { id:"O02", cat:"operationnel", name:"D√©part de collaborateur cl√©", desc:"Perte de comp√©tences critiques ou de la relation client", refs:"Gestion RH ¬∑ Clause non-concurrence", impact:{min:15000,max:80000,typical:35000}, measures:"Documentation processus, polyvalence, fid√©lisation, assurance homme-cl√©" },
  { id:"O03", cat:"operationnel", name:"Surcharge de travail", desc:"Inad√©quation charge/capacit√© en p√©riodes fiscales", refs:"Code du travail ¬∑ QVT", impact:{min:5000,max:30000,typical:12000}, measures:"Planification, recrutement anticip√©, sous-traitance, outils productivit√©" },
  { id:"O04", cat:"operationnel", name:"D√©pendance technologique", desc:"D√©pendance excessive √† un outil ou √©diteur unique", refs:"Strat√©gie SI ¬∑ Gestion fournisseurs", impact:{min:10000,max:50000,typical:25000}, measures:"Multi-sourcing, portabilit√© donn√©es, veille alternatives" },
  { id:"O05", cat:"operationnel", name:"Erreur de manipulation", desc:"Erreur humaine dans le traitement des donn√©es ou d√©clarations", refs:"Contr√¥le interne ¬∑ Qualit√©", impact:{min:1000,max:15000,typical:5000}, measures:"Checklists, double validation, automatisation contr√¥les" },
  // FINANCIER
  { id:"FI01", cat:"financier", name:"D√©faillance client important", desc:"Impay√©s ou faillite d'un client repr√©sentant une part significative du CA", refs:"Gestion risque client ¬∑ Concentration", impact:{min:5000,max:30000,typical:15000}, measures:"Diversification portefeuille (max 15 %/client), acomptes, suivi cr√©ances" },
  { id:"FI02", cat:"financier", name:"Sous-tarification des missions", desc:"Honoraires insuffisants par rapport au temps pass√©", refs:"Art. 158 Code d√©ontologie", impact:{min:5000,max:25000,typical:12000}, measures:"Suivi temps pass√© (Toggl), rentabilit√© par mission, ren√©gociation" },
  { id:"FI03", cat:"financier", name:"Hausse des co√ªts technologiques", desc:"Augmentation non anticip√©e des abonnements SaaS", refs:"Budget pr√©visionnel ¬∑ Gestion contrats", impact:{min:2000,max:10000,typical:5000}, measures:"Benchmark, n√©gociation pluriannuelle, arbitrage outils" },
  { id:"FI04", cat:"financier", name:"Mise en cause RC Pro", desc:"Sinistre d√©clench√© par une r√©clamation client", refs:"Art. 135 D√©cret 2012-432 ¬∑ Assurance obligatoire", impact:{min:5000,max:50000,typical:15000}, measures:"Couverture adapt√©e (1,5 M‚Ç¨), pr√©vention, gestion pr√©-contentieuse" },
  // STRAT√âGIQUE
  { id:"S01", cat:"strategique", name:"Obsolescence des comp√©tences", desc:"Retard dans l'acquisition des comp√©tences num√©riques et r√©glementaires", refs:"Formation continue obligatoire ¬∑ Code d√©ontologie", impact:{min:5000,max:30000,typical:15000}, measures:"Plan formation 40 h/an, veille, certifications, abonnements sp√©cialis√©s" },
  { id:"S02", cat:"strategique", name:"Concurrence des nouveaux entrants", desc:"Disruption par fintech, legaltech ou acteurs num√©riques", refs:"Analyse concurrentielle ¬∑ Positionnement", impact:{min:10000,max:50000,typical:25000}, measures:"Diff√©renciation, services √† valeur ajout√©e, partenariats" },
  { id:"S03", cat:"strategique", name:"√âvolution r√©glementaire majeure", desc:"Changement l√©gislatif impactant le mod√®le √©conomique", refs:"Veille juridique ¬∑ Ordres professionnels", impact:{min:5000,max:40000,typical:15000}, measures:"Veille active (OEC, CSOEC), anticipation, diversification, agilit√©" },
  { id:"S04", cat:"strategique", name:"Atteinte √† la r√©putation", desc:"E-r√©putation n√©gative, avis d√©favorables, bad buzz", refs:"Communication digitale ¬∑ Gestion de crise", impact:{min:10000,max:60000,typical:25000}, measures:"Veille e-r√©putation, qualit√© service, gestion avis, communication crise" }
];

// =====================================================
// CABINET X - √âVALUATIONS PR√â-REMPLIES
// =====================================================
function getCabinetXData() {
  // Profil : cabinet 100% num√©rique en phase de lancement (ann√©e 1)
  // Les scores r√©siduels refl√®tent des mesures planifi√©es mais pas encore toutes √©prouv√©es.
  // Certains risques restent ¬´ mod√©r√©s ¬ª car la maturit√© s'acquiert avec l'exp√©rience.
  return {
    // RESPONSABILIT√â PROFESSIONNELLE ‚Äî l'EC est dipl√¥m√© et form√©, mesures m√©tier classiques
    "R01":{bP:3,bI:4,rP:2,rI:3,ctrl:"Conseils trac√©s par e-mail, archivage GED. Limite : pas encore de revue par un pair (cabinet solo au d√©marrage)"},
    "R02":{bP:2,bI:5,rP:1,rI:3,ctrl:"Politique confidentialit√© sign√©e, acc√®s restreints par r√¥le, chiffrement AES-256. Risque r√©siduel : erreur humaine non √©liminable"},
    "R03":{bP:2,bI:3,rP:1,rI:2,ctrl:"Proc√©dure d'acceptation des missions formalis√©e, d√©claration d'int√©r√™ts annuelle"},
    "R04":{bP:3,bI:4,rP:2,rI:3,ctrl:"Revue de dossier syst√©matique, checklist cl√¥ture. Limite : pas de second regard tant que l'√©quipe est r√©duite"},
    "R05":{bP:4,bI:3,rP:2,rI:2,ctrl:"Planning centralis√© Notion, alertes automatiques J-15/J-7. Fiable d√®s M+3 une fois le portefeuille stabilis√©"},
    // CYBERS√âCURIT√â ‚Äî mesures techniques d√©ploy√©es mais maturit√© organisationnelle √† confirmer
    "C01":{bP:3,bI:5,rP:2,rI:4,ctrl:"MFA g√©n√©ralis√©, sauvegarde 3-2-1 hors ligne, EDR install√©. Limite : PRA non encore test√© en conditions r√©elles"},
    "C02":{bP:4,bI:4,rP:3,rI:2,ctrl:"Filtrage e-mails activ√©, premi√®re sensibilisation faite. Limite : √©quipe junior, pas encore de simulation phishing"},
    "C03":{bP:3,bI:4,rP:2,rI:3,ctrl:"Chiffrement donn√©es, registre RGPD initialis√©. Limite : proc√©dure notification 72 h document√©e mais non test√©e"},
    "C04":{bP:3,bI:3,rP:2,rI:2,ctrl:"SLA contractualis√©s avec 3 √©diteurs, sauvegarde locale hebdomadaire"},
    "C05":{bP:3,bI:3,rP:1,rI:2,ctrl:"Sauvegarde 3-2-1 op√©rationnelle, tests restauration mensuels programm√©s"},
    "C06":{bP:3,bI:3,rP:2,rI:2,ctrl:"Registre traitements initialis√©, DPO externalis√©, privacy by design int√©gr√© aux outils"},
    // CONFORMIT√â ‚Äî premier exercice = courbe d'apprentissage
    "F01":{bP:2,bI:4,rP:1,rI:3,ctrl:"KYC syst√©matique, formation ReflexLab effectu√©e, d√©claration via Ermes. Limite : peu de dossiers complexes pour l'instant"},
    "F02":{bP:3,bI:3,rP:1,rI:2,ctrl:"Mod√®les de lettre de mission √† jour, signature √©lectronique Yousign, archivage GED"},
    "F03":{bP:3,bI:3,rP:2,rI:3,ctrl:"Manuel qualit√© en cours de r√©daction. Limite : premier contr√¥le Ordre non encore pass√©, maturit√© √† confirmer"},
    "F04":{bP:1,bI:5,rP:1,rI:4,ctrl:"P√©rim√®tre missions clairement d√©fini, partenariats CAC encadr√©s. Risque r√©siduel : impact grave si franchissement"},
    "F05":{bP:3,bI:3,rP:2,rI:2,ctrl:"PA agr√©√©e s√©lectionn√©e, param√©trage en cours, formation √©quipe planifi√©e avant septembre 2026"},
    // OP√âRATIONNEL ‚Äî les vrais points de vigilance d'un cabinet qui d√©marre
    "O01":{bP:3,bI:3,rP:2,rI:2,ctrl:"Infrastructure 100 % cloud, redondance native. PRA document√© mais non encore √©prouv√©"},
    "O02":{bP:3,bI:4,rP:3,rI:3,ctrl:"Documentation processus initi√©e, polyvalence limit√©e (√©quipe de 2). Risque structurel en phase de lancement"},
    "O03":{bP:4,bI:3,rP:3,rI:2,ctrl:"Planification p√©riode fiscale, sous-traitance identifi√©e. Limite : premi√®re saison fiscale = incertitude sur la charge"},
    "O04":{bP:3,bI:3,rP:2,rI:2,ctrl:"3 √©diteurs distincts (compta, GED, CRM), portabilit√© donn√©es v√©rifi√©e"},
    "O05":{bP:3,bI:2,rP:2,rI:1,ctrl:"Checklists obligatoires, double validation sur liasses. Automatisation partielle via IA"},
    // FINANCIER ‚Äî tension normale en ann√©e 1
    "FI01":{bP:3,bI:3,rP:2,rI:3,ctrl:"Plafond 15 % CA/client vis√©. Limite : portefeuille concentr√© en phase de d√©marrage, objectif atteint √† M+12"},
    "FI02":{bP:4,bI:3,rP:3,rI:2,ctrl:"Suivi temps pass√© Toggl d√©ploy√©. Limite : premi√®res missions souvent sous-tarif√©es pour conqu√©rir le march√©"},
    "FI03":{bP:3,bI:2,rP:2,rI:1,ctrl:"Benchmark effectu√©, contrats annuels n√©goci√©s, arbitrage outils semestriel"},
    "FI04":{bP:2,bI:4,rP:1,rI:3,ctrl:"RC Pro souscrite √† 1,5 M‚Ç¨ (obligatoire art. 135 D√©cret 2012-432), pr√©vention document√©e"},
    // STRAT√âGIQUE ‚Äî positionnement √† consolider
    "S01":{bP:3,bI:3,rP:2,rI:2,ctrl:"Plan formation 40 h/an, veille hebdo, certifications num√©riques engag√©es"},
    "S02":{bP:3,bI:3,rP:2,rI:3,ctrl:"Positionnement expert-conseil d√©fini. Limite : notori√©t√© faible en ann√©e 1, diff√©renciation √† prouver"},
    "S03":{bP:3,bI:3,rP:2,rI:2,ctrl:"Veille OEC/CSOEC active, structure agile par nature (petite taille = adaptabilit√©)"},
    "S04":{bP:2,bI:4,rP:1,rI:3,ctrl:"Veille e-r√©putation, NPS pr√©vu d√®s M+6. Limite : un seul avis n√©gatif peut peser fort avec peu de r√©f√©rences"}
  };
}

// =====================================================
// STATE
// =====================================================
let state = { evaluations: {} };

// =====================================================
// UTILITIES
// =====================================================
function getScoreLevel(score) {
  if (score >= 16) return 'critique';
  if (score >= 10) return 'eleve';
  if (score >= 5) return 'modere';
  return 'faible';
}
function getScoreLabel(score) {
  if (score >= 16) return 'Critique';
  if (score >= 10) return '√âlev√©';
  if (score >= 5) return 'Mod√©r√©';
  return 'Faible';
}
function getScoreClass(score) { return 'score-' + getScoreLevel(score); }

function formatEUR(n) {
  return n.toLocaleString('fr-FR') + ' ‚Ç¨';
}

function toast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function escapeHtml(s) {
  return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
}

// =====================================================
// TABS
// =====================================================
function showTab(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const tabMap = { catalogue:'catalogue', evaluation:'valuation', matrice:'matrice', actions:'action', guide:'guide' };
  const keyword = tabMap[id] || id;
  document.querySelectorAll('.tab').forEach(t => {
    if (t.textContent.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().includes(keyword)) t.classList.add('active');
  });
  if (id === 'matrice') renderMatrices();
  if (id === 'actions') renderActionPlan();
}

// =====================================================
// SAVE / LOAD
// =====================================================
function saveState() {
  try {
    localStorage.setItem('annexe11_state', JSON.stringify(state));
    toast('Donn√©es sauvegard√©es', 'success');
  } catch(e) { toast('Erreur de sauvegarde', 'warning'); }
}

function loadState() {
  try {
    const saved = localStorage.getItem('annexe11_state');
    if (saved) { state = JSON.parse(saved); return true; }
  } catch(e) {}
  return false;
}

function resetAll() {
  if (!confirm('R√©initialiser toutes les √©valuations ?')) return;
  state = { evaluations: {} };
  localStorage.removeItem('annexe11_state');
  renderAll();
  toast('Donn√©es r√©initialis√©es');
}

function loadCabinetX() {
  if (Object.keys(state.evaluations).length > 0) {
    if (!confirm('Charger les donn√©es Cabinet X ? Les √©valuations actuelles seront remplac√©es.')) return;
  }
  const data = getCabinetXData();
  state.evaluations = {};
  for (const [id, d] of Object.entries(data)) {
    state.evaluations[id] = {
      brutProb: d.bP, brutImpact: d.bI, brutScore: d.bP * d.bI,
      resProb: d.rP, resImpact: d.rI, resScore: d.rP * d.rI,
      controls: d.ctrl
    };
  }
  renderAll();
  toast('Cabinet X charg√© ‚Äì 29 risques √©valu√©s', 'success');
}

// =====================================================
// STATS
// =====================================================
function updateStats() {
  const evals = Object.values(state.evaluations);
  const n = evals.length;
  document.getElementById('statTotal').textContent = n + '/29';
  if (n === 0) {
    document.getElementById('statBrut').textContent = '‚Äì';
    document.getElementById('statResiduel').textContent = '‚Äì';
    document.getElementById('statReduction').textContent = '‚Äì';
    document.getElementById('statCritiques').textContent = '0';
    return;
  }
  const avgB = (evals.reduce((s,e) => s + e.brutScore, 0) / n).toFixed(1);
  const avgR = (evals.reduce((s,e) => s + e.resScore, 0) / n).toFixed(1);
  const reduction = Math.round((1 - avgR / avgB) * 100);
  const critiques = evals.filter(e => e.resScore >= 16).length;
  document.getElementById('statBrut').textContent = avgB;
  document.getElementById('statResiduel').textContent = avgR;
  document.getElementById('statReduction').textContent = (reduction > 0 ? '-' : '') + reduction + '%';
  document.getElementById('statCritiques').textContent = critiques;
}

// =====================================================
// CATALOGUE
// =====================================================
function renderCatalogue() {
  let html = '';
  for (const [catId, cat] of Object.entries(CATEGORIES)) {
    const catRisks = RISKS.filter(r => r.cat === catId);
    const evaluated = catRisks.filter(r => state.evaluations[r.id]).length;
    html += `<div class="cat-section">
      <div class="cat-header" onclick="toggleCat('${catId}')">
        <div class="cat-icon" style="background:${cat.color}">${cat.icon}</div>
        <div>
          <div class="cat-name">${cat.name}</div>
          <div class="cat-desc">${cat.description}</div>
        </div>
        <div class="cat-badges">
          <span class="cat-badge cat-badge-total">${catRisks.length} risques</span>
          <span class="cat-badge cat-badge-eval">${evaluated} √©valu√©s</span>
        </div>
        <span class="cat-arrow" id="arrow-${catId}">‚ñº</span>
      </div>
      <div class="cat-body" id="body-${catId}">`;
    for (const r of catRisks) {
      const ev = state.evaluations[r.id];
      html += `<div class="risk-item">
        <div class="risk-id" style="background:${cat.color}">${r.id}</div>
        <div>
          <div class="risk-name">${escapeHtml(r.name)}</div>
          <div class="risk-desc">${escapeHtml(r.desc)}</div>
          <div class="risk-refs">${escapeHtml(r.refs)}</div>
        </div>
        <div class="risk-actions">
          <span class="risk-impact-range">${formatEUR(r.impact.min)} ‚Äì ${formatEUR(r.impact.max)}</span>
          ${ev ? `<span class="score-badge ${getScoreClass(ev.brutScore)}">${ev.brutScore}</span>
                  <span style="color:var(--gray-400)">‚Üí</span>
                  <span class="score-badge ${getScoreClass(ev.resScore)}">${ev.resScore}</span>` :
                 `<span class="score-badge score-na">‚Äì</span>`}
          <button class="btn btn-sm btn-primary" onclick="goEvaluate('${r.id}')">√âvaluer</button>
        </div>
      </div>`;
    }
    html += '</div></div>';
  }
  document.getElementById('catalogueContent').innerHTML = html;
}

function toggleCat(catId) {
  const body = document.getElementById('body-' + catId);
  const arrow = document.getElementById('arrow-' + catId);
  body.classList.toggle('open');
  arrow.classList.toggle('open');
}

function goEvaluate(riskId) {
  showTab('evaluation');
  document.getElementById('riskSelect').value = riskId;
  onRiskSelect();
}

// =====================================================
// EVALUATION
// =====================================================
function populateRiskSelect() {
  const sel = document.getElementById('riskSelect');
  sel.innerHTML = '<option value="">-- Choisir un risque --</option>';
  for (const [catId, cat] of Object.entries(CATEGORIES)) {
    const group = document.createElement('optgroup');
    group.label = cat.name;
    RISKS.filter(r => r.cat === catId).forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.id;
      const ev = state.evaluations[r.id];
      opt.textContent = r.id + ' ‚Äì ' + r.name + (ev ? ' ‚úì' : '');
      group.appendChild(opt);
    });
    sel.appendChild(group);
  }
}

function onRiskSelect() {
  const riskId = document.getElementById('riskSelect').value;
  const infoDiv = document.getElementById('riskInfo');
  const formDiv = document.getElementById('evalFormContainer');
  if (!riskId) {
    infoDiv.style.display = 'none';
    formDiv.style.display = 'none';
    return;
  }
  const risk = RISKS.find(r => r.id === riskId);
  const cat = CATEGORIES[risk.cat];
  infoDiv.style.display = 'grid';
  formDiv.style.display = 'block';
  infoDiv.innerHTML = `
    <div class="info-item"><div class="info-label">Cat√©gorie</div><div class="info-value" style="color:${cat.color}">${cat.name}</div></div>
    <div class="info-item"><div class="info-label">Impact financier estim√©</div><div class="info-value">${formatEUR(risk.impact.min)} ‚Äì ${formatEUR(risk.impact.max)}</div></div>
    <div class="info-item"><div class="info-label">R√©f√©rences</div><div class="info-value">${risk.refs}</div></div>`;

  // Pre-fill if already evaluated
  const ev = state.evaluations[riskId];
  document.getElementById('brutProb').value = ev ? ev.brutProb : '';
  document.getElementById('brutImpact').value = ev ? ev.brutImpact : '';
  document.getElementById('resProb').value = ev ? ev.resProb : '';
  document.getElementById('resImpact').value = ev ? ev.resImpact : '';
  document.getElementById('evalControls').value = ev ? ev.controls : risk.measures;
  calcScores();
}

function calcScores() {
  const bP = parseInt(document.getElementById('brutProb').value) || 0;
  const bI = parseInt(document.getElementById('brutImpact').value) || 0;
  const rP = parseInt(document.getElementById('resProb').value) || 0;
  const rI = parseInt(document.getElementById('resImpact').value) || 0;
  const bS = bP * bI;
  const rS = rP * rI;
  const brutDisp = document.getElementById('scoreBrut');
  const resDisp = document.getElementById('scoreRes');
  brutDisp.textContent = bS > 0 ? bS + ' ‚Äì ' + getScoreLabel(bS) : '‚Äì';
  resDisp.textContent = rS > 0 ? rS + ' ‚Äì ' + getScoreLabel(rS) : '‚Äì';
}

function saveEvaluation() {
  const riskId = document.getElementById('riskSelect').value;
  if (!riskId) { toast('S√©lectionnez un risque', 'warning'); return; }
  const bP = parseInt(document.getElementById('brutProb').value);
  const bI = parseInt(document.getElementById('brutImpact').value);
  const rP = parseInt(document.getElementById('resProb').value);
  const rI = parseInt(document.getElementById('resImpact').value);
  const ctrl = document.getElementById('evalControls').value.trim();
  if (!bP || !bI || !rP || !rI) { toast('Compl√©tez toutes les cotations', 'warning'); return; }
  if (rP * rI > bP * bI) {
    if (!confirm('Le score r√©siduel est sup√©rieur au score brut. Confirmez-vous ?')) return;
  }
  state.evaluations[riskId] = {
    brutProb: bP, brutImpact: bI, brutScore: bP * bI,
    resProb: rP, resImpact: rI, resScore: rP * rI,
    controls: ctrl
  };
  renderAll();
  toast('√âvaluation enregistr√©e : ' + riskId, 'success');

  // Navigate to next unevaluated risk
  const nextRisk = RISKS.find(r => !state.evaluations[r.id]);
  if (nextRisk) {
    document.getElementById('riskSelect').value = nextRisk.id;
    onRiskSelect();
  }
}

function renderEvalSummary() {
  const evals = Object.entries(state.evaluations);
  document.getElementById('evalCount').textContent = evals.length + ' risque(s) √©valu√©(s) sur 29';
  if (evals.length === 0) {
    document.getElementById('evalSummaryTable').innerHTML = '<div class="empty-state">Aucune √©valuation enregistr√©e. S√©lectionnez un risque ci-dessus ou chargez les donn√©es Cabinet X.</div>';
    return;
  }
  let html = `<table class="eval-table">
    <thead><tr><th>ID</th><th>Risque</th><th>Brut (P√óI)</th><th>R√©siduel (P√óI)</th><th>R√©duction</th><th>Mesures</th></tr></thead><tbody>`;
  // Sort by residual score desc
  const sorted = evals.sort((a,b) => b[1].resScore - a[1].resScore);
  for (const [id, ev] of sorted) {
    const risk = RISKS.find(r => r.id === id);
    const red = Math.round((1 - ev.resScore / ev.brutScore) * 100);
    html += `<tr>
      <td><strong>${id}</strong></td>
      <td>${escapeHtml(risk.name)}</td>
      <td><span class="score-badge ${getScoreClass(ev.brutScore)}">${ev.brutScore}</span> (${ev.brutProb}√ó${ev.brutImpact})</td>
      <td><span class="score-badge ${getScoreClass(ev.resScore)}">${ev.resScore}</span> (${ev.resProb}√ó${ev.resImpact})</td>
      <td style="color:${red > 0 ? 'var(--success)' : 'var(--danger)'};font-weight:700;">${red > 0 ? '-' : ''}${red}%</td>
      <td style="font-size:11px;max-width:200px;">${escapeHtml(ev.controls).substring(0, 80)}${ev.controls.length > 80 ? '‚Ä¶' : ''}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('evalSummaryTable').innerHTML = html;
}

// =====================================================
// MATRICES
// =====================================================
function renderMatrices() {
  renderMatrix('matrixBrut', 'brut');
  renderMatrix('matrixRes', 'residuel');
  renderMigration();
}

function renderMatrix(containerId, type) {
  const grid = document.getElementById(containerId);
  let html = '';
  for (let prob = 5; prob >= 1; prob--) {
    // Row label
    html += `<div class="matrix-label-row">${prob}</div>`;
    for (let imp = 1; imp <= 5; imp++) {
      const score = prob * imp;
      const level = getScoreLevel(score);
      // Find risks in this cell
      const risksHere = [];
      for (const [id, ev] of Object.entries(state.evaluations)) {
        const p = type === 'brut' ? ev.brutProb : ev.resProb;
        const i = type === 'brut' ? ev.brutImpact : ev.resImpact;
        if (p === prob && i === imp) risksHere.push(id);
      }
      html += `<div class="matrix-cell ${level}" title="P=${prob} √ó I=${imp} = ${score}">
        <div style="font-size:8px;color:rgba(0,0,0,0.3);font-weight:700;">${score}</div>
        <div class="matrix-cell-dots">
          ${risksHere.map(id => {
            const r = RISKS.find(x => x.id === id);
            const cat = CATEGORIES[r.cat];
            return `<span class="matrix-dot" style="background:${cat.color}" title="${id}: ${r.name}">${id}</span>`;
          }).join('')}
        </div>
      </div>`;
    }
  }
  // Bottom labels
  html += '<div></div>';
  for (let i = 1; i <= 5; i++) html += `<div class="matrix-label-col">${i}</div>`;
  grid.innerHTML = html;
}

function renderMigration() {
  const container = document.getElementById('migrationContent');
  const evals = Object.entries(state.evaluations);
  if (evals.length === 0) {
    container.innerHTML = '<div class="empty-state">√âvaluez des risques pour voir la migration brut ‚Üí r√©siduel.</div>';
    return;
  }
  // Sort by biggest reduction
  const sorted = evals.map(([id, ev]) => ({
    id, risk: RISKS.find(r => r.id === id), ev,
    reduction: ev.brutScore - ev.resScore,
    pctReduction: Math.round((1 - ev.resScore / ev.brutScore) * 100)
  })).sort((a,b) => b.reduction - a.reduction);

  let html = '';
  for (const item of sorted) {
    const cls = item.reduction > 0 ? 'migration-improved' : (item.reduction === 0 ? 'migration-unchanged' : 'migration-worsened');
    html += `<div class="migration-item">
      <strong style="min-width:40px;">${item.id}</strong>
      <span style="flex:1;">${escapeHtml(item.risk.name)}</span>
      <span class="score-badge ${getScoreClass(item.ev.brutScore)}">${item.ev.brutScore}</span>
      <span class="migration-arrow">‚Üí</span>
      <span class="score-badge ${getScoreClass(item.ev.resScore)}">${item.ev.resScore}</span>
      <span class="${cls}" style="min-width:50px;text-align:right;">${item.reduction > 0 ? '-' : ''}${item.pctReduction}%</span>
    </div>`;
  }
  container.innerHTML = html;
}

// =====================================================
// PLAN D'ACTION
// =====================================================
function renderActionPlan() {
  const container = document.getElementById('actionPlanContent');
  const evals = Object.entries(state.evaluations);
  if (evals.length === 0) {
    container.innerHTML = '<div class="empty-state">√âvaluez des risques pour g√©n√©rer le plan d\'action.</div>';
    document.getElementById('actionSummary').textContent = '√âvaluez les risques pour g√©n√©rer le plan d\'action.';
    return;
  }

  const items = evals.map(([id, ev]) => ({
    id, ev, risk: RISKS.find(r => r.id === id)
  })).sort((a,b) => b.ev.resScore - a.ev.resScore);

  const immediat = items.filter(i => i.ev.resScore >= 16);
  const court = items.filter(i => i.ev.resScore >= 10 && i.ev.resScore < 16);
  const moyen = items.filter(i => i.ev.resScore >= 5 && i.ev.resScore < 10);
  const maitrise = items.filter(i => i.ev.resScore < 5);

  document.getElementById('actionSummary').textContent =
    `${immediat.length} imm√©diat ¬∑ ${court.length} court terme ¬∑ ${moyen.length} moyen terme ¬∑ ${maitrise.length} sous ma√Ætrise`;

  let html = '';
  const sections = [
    { items: immediat, label: 'üö® Action imm√©diate (0-30 jours)', cls: 'immediate', itemCls: 'critique' },
    { items: court, label: '‚ö†Ô∏è Court terme (30-90 jours)', cls: 'court', itemCls: 'eleve' },
    { items: moyen, label: 'üìã Moyen terme (90-180 jours)', cls: 'moyen', itemCls: 'modere' },
    { items: maitrise, label: '‚úÖ Sous ma√Ætrise (revue annuelle)', cls: 'maitrise', itemCls: 'faible' }
  ];

  for (const section of sections) {
    if (section.items.length === 0) continue;
    html += `<div class="priority-section">
      <div class="priority-header ${section.cls}">${section.label} (${section.items.length})</div>`;
    for (const item of section.items) {
      const cat = CATEGORIES[item.risk.cat];
      html += `<div class="action-item ${section.itemCls}">
        <div>
          <div class="risk-id" style="background:${cat.color};font-size:11px;">${item.id}</div>
        </div>
        <div>
          <div style="font-weight:700;font-size:13px;color:var(--gray-800);">${escapeHtml(item.risk.name)}</div>
          <div style="font-size:12px;color:var(--gray-600);margin-top:4px;">${escapeHtml(item.ev.controls)}</div>
          <div style="font-size:11px;color:var(--gray-500);margin-top:4px;font-style:italic;">R√©f. : ${item.risk.refs}</div>
        </div>
        <div class="action-scores">
          <span class="score-badge ${getScoreClass(item.ev.brutScore)}">${item.ev.brutScore}</span>
          <span style="color:var(--gray-400);">‚Üí</span>
          <span class="score-badge ${getScoreClass(item.ev.resScore)}">${item.ev.resScore}</span>
        </div>
      </div>`;
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

// =====================================================
// MODAL
// =====================================================
function closeModal() { document.getElementById('riskModal').classList.remove('show'); }

// =====================================================
// PDF EXPORT
// =====================================================
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const W = 210, M = 15, CW = W - 2*M;
  let y = M;

  function addFooter() {
    doc.setFontSize(8); doc.setTextColor(150);
    doc.text('Annexe 11 ‚Äì Matrice d\'identification des risques | Export ' + new Date().toLocaleDateString('fr-FR'), M, 290);
    doc.text('Page ' + doc.getNumberOfPages(), W - M, 290, { align: 'right' });
  }
  function checkPage(need) {
    if (y + need > 275) { addFooter(); doc.addPage(); y = M; return true; }
    return false;
  }
  function sectionTitle(title) {
    checkPage(20);
    doc.setFillColor(30, 58, 95); doc.rect(M, y, CW, 8, 'F');
    doc.setFontSize(11); doc.setTextColor(255); doc.text(title, M + 4, y + 5.5);
    y += 12; doc.setTextColor(50);
  }

  // COVER
  doc.setFillColor(30, 58, 95); doc.rect(0, 0, W, 50, 'F');
  doc.setFontSize(18); doc.setTextColor(255);
  doc.text('Annexe 11 ‚Äì Matrice d\'identification', M, 20);
  doc.text('et d\'√©valuation des risques', M, 28);
  doc.setFontSize(10);
  doc.text('Cabinet d\'expertise comptable 100 % num√©rique ¬∑ ISO 31000 ¬∑ NPMQ', M, 40);
  doc.setTextColor(50); y = 60;

  // STATS
  const evals = Object.values(state.evaluations);
  const n = evals.length;
  if (n > 0) {
    const avgB = (evals.reduce((s,e) => s + e.brutScore, 0) / n).toFixed(1);
    const avgR = (evals.reduce((s,e) => s + e.resScore, 0) / n).toFixed(1);
    const red = Math.round((1 - avgR / avgB) * 100);
    doc.setFontSize(10);
    doc.text(`Risques √©valu√©s : ${n}/29  |  Score brut moyen : ${avgB}  |  Score r√©siduel moyen : ${avgR}  |  R√©duction : -${red}%`, M, y);
    y += 10;
  }

  // EVALUATIONS TABLE
  sectionTitle('Synth√®se des √©valuations');
  const sorted = Object.entries(state.evaluations).sort((a,b) => b[1].resScore - a[1].resScore);
  doc.setFontSize(8);
  // Header
  doc.setFillColor(230, 230, 230);
  doc.rect(M, y, CW, 6, 'F');
  doc.setTextColor(50);
  doc.text('ID', M+2, y+4); doc.text('Risque', M+14, y+4);
  doc.text('Brut', M+110, y+4); doc.text('R√©sid.', M+125, y+4);
  doc.text('R√©d.', M+142, y+4); doc.text('Mesures', M+155, y+4);
  y += 8;

  for (const [id, ev] of sorted) {
    checkPage(7);
    const risk = RISKS.find(r => r.id === id);
    doc.text(id, M+2, y+3);
    doc.text(risk.name.substring(0, 40), M+14, y+3);
    doc.text(String(ev.brutScore), M+113, y+3);
    doc.text(String(ev.resScore), M+130, y+3);
    const red = Math.round((1 - ev.resScore / ev.brutScore) * 100);
    doc.text('-' + red + '%', M+144, y+3);
    doc.text(ev.controls.substring(0, 30) + '‚Ä¶', M+155, y+3);
    doc.setDrawColor(220); doc.line(M, y+5, M+CW, y+5);
    y += 7;
  }

  // ACTION PLAN
  sectionTitle('Plan d\'action prioritaire');
  doc.setFontSize(9);
  const priorities = [
    { min: 16, label: 'IMM√âDIAT (0-30j)' },
    { min: 10, label: 'COURT TERME (30-90j)' },
    { min: 5, label: 'MOYEN TERME (90-180j)' },
    { min: 0, label: 'SOUS MA√éTRISE' }
  ];
  for (const prio of priorities) {
    const next = priorities[priorities.indexOf(prio) + 1];
    const max = next ? next.min : undefined;
    const items = sorted.filter(([, ev]) =>
      ev.resScore >= prio.min && (max === undefined || ev.resScore < max)
    );
    if (items.length === 0) continue;
    checkPage(12);
    doc.setFontSize(9); doc.setTextColor(30, 58, 95);
    doc.text(prio.label + ' (' + items.length + ')', M, y+3); y += 6;
    doc.setTextColor(50); doc.setFontSize(8);
    for (const [id, ev] of items) {
      checkPage(8);
      const risk = RISKS.find(r => r.id === id);
      doc.text(`${id} ‚Äì ${risk.name} : ${ev.brutScore} ‚Üí ${ev.resScore}`, M+4, y+3);
      y += 5;
    }
    y += 4;
  }

  addFooter();
  doc.save('Annexe_11_Matrice_Risques.pdf');
  toast('PDF export√©', 'success');
}

// =====================================================
// RENDER ALL
// =====================================================
function renderAll() {
  updateStats();
  renderCatalogue();
  populateRiskSelect();
  renderEvalSummary();
}

// =====================================================
// INIT
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
  if (!loadState() || Object.keys(state.evaluations).length === 0) {
    const data = getCabinetXData();
    state.evaluations = {};
    for (const [id, d] of Object.entries(data)) {
      state.evaluations[id] = {
        brutProb: d.bP, brutImpact: d.bI, brutScore: d.bP * d.bI,
        resProb: d.rP, resImpact: d.rI, resScore: d.rP * d.rI,
        controls: d.ctrl
      };
    }
  }
  renderAll();
  showTab('matrice');
});
</script>
</body>
</html>
