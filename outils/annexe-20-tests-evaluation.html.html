<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Annexe 20 — Test de connaissance, savoir-être et savoir-faire — Match valeurs du cabinet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ═══ DESIGN SYSTEM — Harmonisé Annexe 18 ═══ */
:root{--p:#1e3a5f;--pl:#2d5a8a;--s:#0d9488;--sl:#14b8a6;--a:#f59e0b;--d:#dc2626;--ok:#059669;--w:#d97706;--inf:#2563eb;--pu:#7c3aed;--g50:#f9fafb;--g100:#f3f4f6;--g200:#e5e7eb;--g300:#d1d5db;--g500:#6b7280;--g700:#374151;--g800:#1f2937;--r:14px;--sh:0 4px 6px -1px rgb(0 0 0/.08),0 2px 4px -2px rgb(0 0 0/.05)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,var(--g100),#e0e7ef);color:var(--g700);line-height:1.65;min-height:100vh;font-size:15px}
.mx{max-width:1200px;margin:0 auto;padding:24px}

/* HEADER */
.hd{background:linear-gradient(135deg,var(--p),var(--pl));color:#fff;border-radius:var(--r);padding:28px 32px;margin-bottom:22px;position:relative;overflow:hidden}
.hd::before{content:"";position:absolute;top:-50%;right:-10%;width:300px;height:300px;background:rgba(255,255,255,.04);border-radius:50%}
.hd h1{font-size:22px;font-weight:700;margin-bottom:6px;position:relative}
.hd p{opacity:.85;font-size:14px;position:relative;line-height:1.5}
.badges{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.badge{background:rgba(255,255,255,.15);padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:.3px}
.retour{display:inline-block;margin-top:12px;color:rgba(255,255,255,.7);font-size:13px;text-decoration:none;transition:color .15s}
.retour:hover{color:#fff}

/* PROGRESS BAR */
.pbar-wrap{background:#fff;border-radius:var(--r);padding:14px 20px;margin-bottom:16px;box-shadow:var(--sh);display:flex;align-items:center;gap:16px}
.pbar-wrap .plab{font-size:13px;font-weight:700;color:var(--p);white-space:nowrap}
.pbar{flex:1;height:10px;background:var(--g200);border-radius:10px;overflow:hidden}
.pbar-fill{height:100%;background:linear-gradient(90deg,var(--s),var(--sl));border-radius:10px;transition:width .4s ease}
.ppct{font-size:15px;font-weight:700;color:var(--s);min-width:42px;text-align:right}

/* FLUX */
.flux{background:#fff;border-radius:var(--r);padding:16px 20px;margin-bottom:16px;box-shadow:var(--sh);display:flex;align-items:center;justify-content:center;gap:0;flex-wrap:wrap}
.flux-item{text-align:center;padding:8px 18px}
.flux-item .fx-n{font-size:12px;font-weight:700;color:var(--p);text-transform:uppercase;letter-spacing:.5px}
.flux-item .fx-v{font-size:11px;color:var(--ok);font-weight:700;text-transform:uppercase;margin-top:2px}
.flux-item .fx-t{font-size:13px;color:var(--g500)}
.flux-item.cur{background:#eff6ff;border-radius:10px;border:2px solid var(--p)}
.flux-item.cur .fx-t{color:var(--p);font-weight:600}
.flux-arr{font-size:18px;color:var(--g300);padding:0 6px}

/* STEP NAV */
.steps{display:flex;background:#fff;border-radius:var(--r);box-shadow:var(--sh);margin-bottom:16px;overflow:hidden}
.step{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:16px 10px;font-size:14px;font-weight:600;color:var(--g500);cursor:pointer;transition:all .2s;border-bottom:3px solid transparent;text-align:center}
.step:hover{background:var(--g50)}
.step.on{color:var(--p);border-bottom-color:var(--p);background:#eff6ff}
.step.ok2{color:var(--ok);border-bottom-color:var(--ok)}
.step .sn{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;background:var(--g200);color:var(--g500);flex-shrink:0}
.step.on .sn{background:var(--p);color:#fff}
.step.ok2 .sn{background:var(--ok);color:#fff}

/* TOOLBAR */
.tb{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.bt{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s}
.bp{background:var(--p);color:#fff}.bp:hover{background:var(--pl)}
.bs{background:var(--g200);color:var(--g700)}.bs:hover{background:var(--g300)}
.bw{background:var(--a);color:#fff;font-size:14px;padding:12px 22px}.bw:hover{background:#d97706}
.bok{background:var(--ok);color:#fff}.bok:hover{opacity:.9}
.bd{background:var(--d);color:#fff}.bd:hover{opacity:.9}

/* PANELS */
.pn{display:none;animation:fi .25s ease}.pn.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* CARDS */
.cd{background:#fff;border-radius:var(--r);padding:22px;box-shadow:var(--sh);margin-bottom:18px}
.cd h3{font-size:17px;font-weight:700;color:var(--g800);margin-bottom:6px}
.cd .sub{font-size:13px;color:var(--g500);margin-bottom:14px;line-height:1.5}
.gr{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px}

/* HINT BOXES */
.hnt{padding:14px 18px;border-radius:10px;font-size:14px;margin-bottom:16px;display:flex;gap:12px;align-items:flex-start;line-height:1.55}
.hnt .ico{font-size:20px;flex-shrink:0;line-height:1}
.hnt.blue{background:#eff6ff;border:1px solid #bfdbfe}
.hnt.green{background:#ecfdf5;border:1px solid #a7f3d0}
.hnt.amber{background:#fef3c7;border:1px solid #fde68a}
.hnt.red{background:#fef2f2;border:1px solid #fecaca}
.hnt.purple{background:#f5f3ff;border:1px solid #ddd6fe}

/* FORMS */
.fg{margin-bottom:14px}
.fg label{display:block;font-size:12px;font-weight:600;color:var(--g500);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
.fg input,.fg select,.fg textarea{width:100%;padding:11px 14px;border:2px solid var(--g200);border-radius:10px;font-size:15px;font-family:inherit;transition:border .15s}
.fg textarea{resize:vertical;min-height:55px}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--p)}
.fr{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}

/* NAVIGATION */
.nav{display:flex;justify-content:space-between;margin-top:18px;gap:10px}

/* PROFILE CARDS */
.pgr{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.pc{padding:16px;border-radius:12px;border:2px solid var(--g200);cursor:pointer;transition:all .15s;text-align:center}
.pc:hover{border-color:var(--pl);background:var(--g50);transform:translateY(-2px)}
.pc.on{border-color:var(--s);background:#ecfdf5}
.pc .pi{font-size:30px;margin-bottom:8px}
.pc h4{font-size:15px;font-weight:700;color:var(--g800);margin-bottom:3px}
.pc p{font-size:12px;color:var(--g500)}

/* TIMER */
.tmr{background:var(--p);color:#fff;padding:12px 18px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;font-weight:600;font-size:15px}
.tmr.warn{background:var(--w)}.tmr.crit{background:var(--d)}

/* QUESTIONS */
.qc{background:#fff;border-radius:var(--r);padding:18px;box-shadow:var(--sh);margin-bottom:14px;border-left:4px solid var(--g200)}
.qc.ok{border-left-color:var(--ok)}.qc.ko{border-left-color:var(--d)}
.qh{display:flex;justify-content:space-between;margin-bottom:10px;font-size:13px}
.ql{color:var(--g500);font-weight:600}.qp{color:var(--p);font-weight:700}
.qq{font-size:14px;font-weight:600;color:var(--g800);margin-bottom:12px;line-height:1.55}
.qo{padding:10px 14px;border:2px solid var(--g200);border-radius:10px;margin-bottom:8px;cursor:pointer;font-size:14px;transition:all .15s;display:flex;gap:10px;align-items:flex-start}
.qo:hover{border-color:var(--pl);background:var(--g50)}
.qo.sel{border-color:var(--inf);background:#eff6ff}
.qo.ok{border-color:var(--ok);background:#ecfdf5}.qo.ko{border-color:var(--d);background:#fef2f2}
.qo.dis{pointer-events:none;opacity:.7}
.qo .ol{min-width:24px;height:24px;border-radius:50%;border:2px solid var(--g300);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;color:var(--g500)}
.qo.ok .ol{background:var(--ok);border-color:var(--ok);color:#fff}
.qo.ko .ol{background:var(--d);border-color:var(--d);color:#fff}
.qj{margin-top:10px;padding:12px 14px;background:#f0fdf4;border-radius:10px;font-size:13px;color:var(--g700);border-left:3px solid var(--ok);display:none;line-height:1.55}
.qc.ok .qj,.qc.ko .qj{display:block}

/* SECTIONS */
.sec{background:#fff;border-radius:var(--r);padding:18px;box-shadow:var(--sh);margin-bottom:14px}
.sel-q{font-size:13px;color:var(--g700);margin-bottom:10px;font-style:italic;padding:10px 14px;background:var(--g50);border-radius:10px;line-height:1.55}

/* STARS */
.stars{display:flex;gap:5px;margin:10px 0}
.star{width:34px;height:34px;border-radius:8px;border:2px solid var(--g200);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .15s;background:#fff;font-weight:600}
.star:hover{border-color:var(--a);background:#fef3c7}
.star.on{background:var(--a);border-color:var(--a);color:#fff}
.se-tips{display:flex;gap:14px;margin-top:8px;font-size:12px}
.se-pos{color:var(--ok)}.se-neg{color:var(--d)}
.se-com{width:100%;padding:8px 12px;border:2px solid var(--g200);border-radius:8px;font-size:13px;margin-top:8px;font-family:inherit;resize:vertical;min-height:40px}

/* LIVE SCORES */
.lsb{background:var(--g100);border-radius:10px;padding:10px 16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;font-size:14px;font-weight:600}
.lsb .scr{font-size:17px;color:var(--p)}

/* RESULTS GRID */
.rg{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:18px}
.rc{padding:18px;border-radius:var(--r);text-align:center;border:2px solid var(--g200)}
.rc.suc{background:#ecfdf5;border-color:var(--ok)}.rc.wrn{background:#fef3c7;border-color:var(--w)}.rc.dng{background:#fef2f2;border-color:var(--d)}
.rc .rv{font-size:30px;font-weight:800;margin:6px 0}.rc .rl{font-size:12px;color:var(--g500);font-weight:600}.rc .rs{font-size:11px;margin-top:4px}

/* VERDICT */
.verd{padding:22px;border-radius:var(--r);text-align:center;margin-bottom:18px;border:3px solid}
.verd.acc{background:linear-gradient(135deg,#ecfdf5,#d1fae5);border-color:var(--ok);color:var(--ok)}
.verd.con{background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:var(--w);color:var(--w)}
.verd.rej{background:linear-gradient(135deg,#fef2f2,#fecaca);border-color:var(--d);color:var(--d)}
.verd h2{font-size:22px;margin-bottom:6px}.verd p{font-size:14px;color:var(--g700);line-height:1.55}

/* CHECKLIST */
.ck{display:flex;align-items:flex-start;gap:12px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .15s;margin-bottom:4px}
.ck:hover{background:var(--g50)}.ck.dn{background:#ecfdf5}
.ckb{width:22px;height:22px;border:2px solid var(--g300);border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;font-size:13px;font-weight:700;color:#fff;transition:all .15s}
.ck.dn .ckb{background:var(--ok);border-color:var(--ok)}
.ck-t{font-size:14px;font-weight:600;color:var(--g800)}.ck-r{font-size:12px;color:var(--g500);font-style:italic}

/* SUMMARY */
.sum{background:linear-gradient(135deg,var(--p),var(--pl));color:#fff;border-radius:var(--r);padding:24px;margin-bottom:18px}
.sum h3{color:#fff;margin-bottom:12px;font-size:17px}
.sum-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.15);font-size:15px}
.sum-row:last-child{border:none}.sum-l{opacity:.75}.sum-v{font-weight:600;text-align:right;max-width:60%}

/* TABLES */
table{width:100%;border-collapse:collapse;font-size:14px;margin:10px 0}
th{background:var(--p);color:#fff;padding:11px 12px;text-align:left;font-weight:600;font-size:13px}
th:first-child{border-radius:10px 0 0 0}th:last-child{border-radius:0 10px 0 0}
td{padding:11px 12px;border-bottom:1px solid var(--g200)}
tr:hover td{background:var(--g50)}

/* TOAST */
.to{position:fixed;bottom:24px;right:24px;background:var(--g800);color:#fff;padding:12px 20px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.2);transform:translateY(80px);opacity:0;transition:all .25s;z-index:9999;font-size:14px;font-weight:500}
.to.sh{transform:translateY(0);opacity:1}

/* OVERLAY */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99999;display:none;align-items:center;justify-content:center}
.ov.sh{display:flex}
.ovc{background:#fff;padding:32px;border-radius:16px;text-align:center}
.sp{width:40px;height:40px;margin:0 auto 14px;border:3px solid var(--g200);border-top-color:var(--p);border-radius:50%;animation:spn .8s linear infinite}
@keyframes spn{to{transform:rotate(360deg)}}

@media(max-width:768px){.mx{padding:14px}.gr,.fr,.pgr{grid-template-columns:1fr}.steps{flex-wrap:wrap}.step{font-size:12px;padding:12px 6px}.rg{grid-template-columns:1fr}.flux{flex-direction:column;gap:4px}.flux-arr{transform:rotate(90deg)}}
</style>
</head>
<body>
<div class="mx">

<!-- HEADER -->
<div class="hd">
  <h1>Annexe 20 — Test de connaissance, savoir-être et savoir-faire — Match valeurs du cabinet</h1>
  <p>Évaluer objectivement un candidat en cinq dimensions (connaissance, savoir-faire, savoir-être, appétences numériques, valeurs du cabinet) et produire une décision traçable conforme aux exigences d'un cabinet 100 % numérique.</p>
  <div class="badges">
    <span class="badge">Partie III, Chap. 1, §1.2</span>
    <span class="badge">NPMQ §22, A22-1 à A22-4</span>
    <span class="badge">Art. 148 Code de déontologie (Décret n° 2012-432, éd. janv. 2026)</span>
    <span class="badge">RGPD art. 22</span>
    <span class="badge">Code du travail L.1221-6 à L.1221-8</span>
  </div>
  <a href="index.html" class="retour">&#8592; Retour à l'index des annexes</a>
</div>

<!-- PROGRESS BAR -->
<div class="pbar-wrap">
  <span class="plab">Avancement de l'évaluation</span>
  <div class="pbar"><div class="pbar-fill" id="pbarFill" style="width:0%"></div></div>
  <span class="ppct" id="ppct">0 %</span>
</div>

<!-- FLUX PROCESS -->
<div class="flux">
  <div class="flux-item"><div class="fx-n">Annexe 19</div><div class="fx-v">Définir</div><div class="fx-t">Fiche de poste</div></div>
  <div class="flux-arr">&#10132;</div>
  <div class="flux-item"><div class="fx-n">Annexe 18</div><div class="fx-v">Chercher</div><div class="fx-t">Sourcing</div></div>
  <div class="flux-arr">&#10132;</div>
  <div class="flux-item cur"><div class="fx-n">Annexe 20</div><div class="fx-v">Évaluer</div><div class="fx-t">Tests & décision</div></div>
  <div class="flux-arr">&#10132;</div>
  <div class="flux-item"><div class="fx-n">Annexe 21</div><div class="fx-v">Intégrer</div><div class="fx-t">Onboarding</div></div>
</div>

<!-- STEP BAR -->
<div class="steps" id="stepBar">
  <div class="step on" onclick="go(1)"><span class="sn">1</span>Configuration</div>
  <div class="step" onclick="go(2)"><span class="sn">2</span>Connaissance</div>
  <div class="step" onclick="go(3)"><span class="sn">3</span>Savoir-faire</div>
  <div class="step" onclick="go(4)"><span class="sn">4</span>Savoir-être</div>
  <div class="step" onclick="go(5)"><span class="sn">5</span>ADN & Décision</div>
</div>

<!-- TOOLBAR -->
<div class="tb">
  <button class="bt bw" onclick="loadCX()">&#9889; Cas pratique Cabinet X</button>
  <button class="bt bp" onclick="xPDF()">&#128196; Export PDF</button>
  <button class="bt bs" onclick="xJSON()">&#128190; JSON</button>
  <input type="file" id="impF" accept=".json" style="display:none" onchange="iJSON(event)">
  <button class="bt bs" onclick="document.getElementById('impF').click()">&#128194; Importer</button>
  <button class="bt bs" onclick="resetAll()">&#8635; Réinitialiser</button>
</div>

<!-- ═══ ÉTAPE 1 : CONFIGURATION ═══ -->
<div id="p1" class="pn on">
  <div class="hnt blue"><div class="ico">&#9881;&#65039;</div><div><strong>Configurez l'évaluation.</strong> Sélectionnez le niveau du poste, renseignez les informations du candidat, puis lancez les tests. Chaque niveau adapte la difficulté des questions, les cas pratiques et les seuils de réussite.</div></div>
  <div class="hnt purple"><div class="ico">&#128279;</div><div><strong>Étape précédente :</strong> La fiche de poste (<strong>Annexe 19</strong>) a défini le profil recherché et les compétences attendues. Le plan de sourcing (<strong>Annexe 18</strong>) a permis d'identifier les candidats.</div></div>

  <div class="gr">
    <div class="cd">
      <h3>Niveau du poste</h3>
      <div class="sub">Adapte la difficulté des tests et les seuils de validation conformément à la NPMQ §22, A22-2 (proportionnalité de l'évaluation au niveau de compétence attendu).</div>
      <div class="pgr">
        <div class="pc" onclick="selLvl('apprenti')" id="lv-apprenti"><div class="pi">&#128214;</div><h4>Apprenti</h4><p>BTS / DCG — Débutant</p></div>
        <div class="pc" onclick="selLvl('junior')" id="lv-junior"><div class="pi">&#128187;</div><h4>Junior</h4><p>DCG / DSCG — 1-3 ans</p></div>
        <div class="pc" onclick="selLvl('confirme')" id="lv-confirme"><div class="pi">&#128200;</div><h4>Confirmé</h4><p>DSCG+ — 3-5+ ans</p></div>
      </div>
    </div>
    <div class="cd">
      <h3>Informations du candidat</h3>
      <div class="sub">Le candidat doit être informé des méthodes d'évaluation avant les tests (art. L.1221-8 du Code du travail).</div>
      <div class="fr">
        <div class="fg"><label>Nom</label><input type="text" id="cNom" placeholder="Nom du candidat"></div>
        <div class="fg"><label>Prénom</label><input type="text" id="cPrenom" placeholder="Prénom"></div>
      </div>
      <div class="fr">
        <div class="fg"><label>Poste visé</label><input type="text" id="cPoste" placeholder="Ex : Collaborateur confirmé"></div>
        <div class="fg"><label>Date de l'évaluation</label><input type="date" id="cDate"></div>
      </div>
      <div class="fr">
        <div class="fg"><label>Évaluateur</label><input type="text" id="cEval" placeholder="Nom de l'évaluateur"></div>
        <div class="fg"><label>Cabinet</label><input type="text" id="cCab" value="Cabinet X"></div>
      </div>
    </div>
  </div>
  <div class="cd">
    <h3>Paramètres de l'évaluation</h3>
    <div class="sub">Les seuils sont calibrés selon le niveau et la complexité des missions confiées.</div>
    <div id="cfgInfo" style="font-size:14px;color:var(--g500)">Sélectionnez un niveau pour voir les paramètres.</div>
  </div>
  <div class="nav"><div></div><button class="bt bp" onclick="startTest()">Lancer l'évaluation &#8594;</button></div>
</div>

<!-- ═══ ÉTAPE 2 : TEST DE CONNAISSANCE ═══ -->
<div id="p2" class="pn">
  <div class="hnt blue"><div class="ico">&#128218;</div><div><strong>Test de connaissance.</strong> Les questions sont en lien direct avec le poste à pourvoir (art. L.1221-6 du Code du travail). Le timer est indicatif : il mesure la capacité à répondre sous contrainte de temps, compétence requise en cabinet.</div></div>
  <div class="tmr" id="timer"><span>Temps restant :</span><span id="tmrVal">--:--</span></div>
  <div class="lsb"><span>Score en direct</span><span class="scr" id="liveK">0 / 0</span></div>
  <div id="qBox"></div>
  <div class="nav"><div></div><button class="bt bp" onclick="finK()">Valider et passer au savoir-faire &#8594;</button></div>
</div>

<!-- ═══ ÉTAPE 3 : SAVOIR-FAIRE ═══ -->
<div id="p3" class="pn">
  <div class="lsb"><span>Score cas pratiques</span><span class="scr" id="liveSF">0 / 0</span></div>
  <div id="sfBox"></div>
  <div class="nav"><button class="bt bs" onclick="go(2)">&#8592; Connaissance</button><button class="bt bp" onclick="finSF()">Valider et passer au savoir-être &#8594;</button></div>
</div>

<!-- ═══ ÉTAPE 4 : SAVOIR-ÊTRE ═══ -->
<div id="p4" class="pn">
  <div class="hnt blue"><div class="ico">&#129309;</div><div><strong>Évaluation comportementale.</strong> Notez chaque critère de 1 à 5 sur la base de l'entretien. Le critère « Confidentialité » est éliminatoire : une note &lt; 2/5 entraîne un refus automatique, conformément au devoir de discrétion imposé par l'art. 147 du code de déontologie (Décret n° 2012-432, éd. janv. 2026).</div></div>
  <div class="lsb"><span>Culture fit</span><span class="scr" id="liveSE">-- %</span></div>
  <div id="seBox"></div>
  <div class="nav"><button class="bt bs" onclick="go(3)">&#8592; Savoir-faire</button><button class="bt bp" onclick="finSE()">ADN numérique & Décision &#8594;</button></div>
</div>

<!-- ═══ ÉTAPE 5 : ADN NUMÉRIQUE & DÉCISION ═══ -->
<div id="p5" class="pn">
  <div class="hnt green"><div class="ico">&#128640;</div><div><strong>Match valeurs du cabinet 100 % numérique.</strong> Évaluez l'adéquation du candidat avec l'ADN digital du cabinet. Ces critères sont définis dans la fiche de poste (<strong>Annexe 19</strong>) et constituent un différenciant clé pour un cabinet 100 % numérique.</div></div>

  <!-- APPÉTENCES NUMÉRIQUES -->
  <div class="cd" style="border-left:4px solid var(--s)">
    <h3 style="color:var(--s)">&#128640; Appétences numériques — ADN cabinet 100 % digital</h3>
    <div class="sub">Évaluez l'appétence du candidat pour les outils et pratiques numériques (sur la base des réponses à l'entretien et des cas pratiques).</div>
    <div id="appBox"></div>
    <div class="lsb" style="margin-top:14px"><span>Score appétences numériques</span><span class="scr" id="liveApp">-- %</span></div>
  </div>

  <!-- MATCH VALEURS CABINET -->
  <div class="cd" style="border-left:4px solid var(--pu)">
    <h3 style="color:var(--pu)">&#127919; Match valeurs du cabinet</h3>
    <div class="sub">Le cabinet 100 % numérique repose sur des valeurs fondamentales. Évaluez l'alignement du candidat avec chacune d'elles.</div>
    <div id="valBox"></div>
    <div class="lsb" style="margin-top:14px"><span>Score match valeurs</span><span class="scr" id="liveVal">-- %</span></div>
  </div>

  <div style="text-align:center;margin:18px 0"><button class="bt bw" onclick="calcVerdict()" style="font-size:15px;padding:14px 36px">&#9989; Calculer la décision finale</button></div>

  <div id="verdBox"></div>
  <div id="resBox"></div>

  <!-- CONFORMITÉ ÉVALUATION -->
  <div class="cd">
    <h3>Conformité de l'évaluation <span style="font-size:13px;font-weight:400;color:var(--g500)" id="ckLbl">0/0</span></h3>
    <div class="sub">Vérifiez ces points réglementaires avant de finaliser la décision (NPMQ §22, A22-1 à A22-4).</div>
    <div id="cCk"></div>
  </div>

  <div class="hnt purple"><div class="ico">&#128279;</div><div><strong>Étape suivante :</strong> Le candidat retenu intègre le programme d'onboarding de l'<strong>Annexe 21</strong>. Le rapport d'évaluation est archivé conformément aux recommandations CNIL (durée maximale de conservation : 2 ans).</div></div>

  <div class="gr">
    <div class="cd" style="text-align:center;padding:28px">
      <h3 style="margin-bottom:10px">&#128196; Rapport d'évaluation</h3>
      <p style="font-size:14px;color:var(--g500);margin-bottom:14px">PDF professionnel avec détail des scores et conformité</p>
      <button class="bt bp" onclick="xPDF()">Télécharger le PDF</button>
    </div>
    <div class="cd" style="text-align:center;padding:28px">
      <h3 style="margin-bottom:10px">&#128190; Sauvegarder les données</h3>
      <p style="font-size:14px;color:var(--g500);margin-bottom:14px">Exportez en JSON pour archivage ou import ultérieur</p>
      <button class="bt bs" onclick="xJSON()">Télécharger le JSON</button>
    </div>
  </div>
  <div class="nav"><button class="bt bs" onclick="go(4)">&#8592; Savoir-être</button><button class="bt bok" onclick="xPDF()">&#128196; Export PDF final</button></div>
</div>

</div>

<!-- OVERLAY -->
<div id="ov" class="ov"><div class="ovc"><div class="sp"></div><div style="font-size:15px;font-weight:600;color:var(--g700)">Génération PDF...</div></div></div>
<div id="toE" class="to"></div>

<script>
/* ═══════════════════════════════════════════
   DATA : CONFIGURATION, QUESTIONS, CRITÈRES
   ═══════════════════════════════════════════ */

var CFG={
  apprenti:{name:"Apprenti",dur:25,seuil:10,maxK:20,maxSF:20,cfMin:60,adnMin:50},
  junior:{name:"Junior",dur:30,seuil:12,maxK:20,maxSF:20,cfMin:65,adnMin:55},
  confirme:{name:"Confirmé",dur:35,seuil:14,maxK:20,maxSF:20,cfMin:70,adnMin:60}
};

/* ═══ QCM — 10 questions par niveau, 2 pts chacune = 20 pts max ═══ */
var QCM={
apprenti:[
{id:1,sec:"Comptabilité de base",pts:2,q:"Dans le plan comptable, les comptes commençant par 4 correspondent à :",o:["Les comptes de trésorerie (banque, caisse)","Les comptes de tiers (clients, fournisseurs)","Les comptes de charges","Les comptes de produits"],c:1,j:"Les comptes de classe 4 regroupent les comptes de tiers : 401 fournisseurs, 411 clients, 421 personnel, 44 État (TVA)."},
{id:2,sec:"Comptabilité de base",pts:2,q:"Une facture d'achat de fournitures de 100 € HT + TVA 20 % doit être enregistrée :",o:["Au débit du compte 606 pour 120 €","Au débit du 606 pour 100 € et au débit du 44566 pour 20 €","Au crédit du compte 606 pour 100 €","Au débit du compte 401 pour 120 €"],c:1,j:"L'achat est enregistré HT en charge (606 = 100 €), la TVA déductible au 44566 (= 20 €), et la dette fournisseur au crédit du 401 pour le TTC (= 120 €)."},
{id:3,sec:"Fiscalité",pts:2,q:"Quelle est la date limite de dépôt de la déclaration de TVA mensuelle (régime réel normal) ?",o:["Le 15 du mois suivant","Le 19 du mois suivant (ou 24 selon le cas)","Le dernier jour du mois suivant","Le 10 du mois suivant"],c:1,j:"La déclaration CA3 est déposée entre le 15 et le 24 du mois suivant selon la taille et la localisation de l'entreprise (CGI, art. 287)."},
{id:4,sec:"Outils numériques",pts:2,q:"Quel est le rôle principal d'un outil OCR comme Dext dans un cabinet comptable ?",o:["Générer automatiquement les déclarations fiscales","Numériser et extraire les données des factures","Réaliser les rapprochements bancaires","Gérer la relation client"],c:1,j:"Un OCR (Reconnaissance Optique de Caractères) comme Dext numérise les justificatifs et en extrait les données comptables pour intégration automatique dans le logiciel de production."},
{id:5,sec:"Outils numériques",pts:2,q:"Dans Pennylane, à quoi sert la fonctionnalité « rapprochement bancaire automatisé » ?",o:["À envoyer les relevés bancaires aux clients","À associer automatiquement les écritures comptables aux mouvements bancaires","À créer de nouveaux comptes bancaires","À calculer les intérêts bancaires"],c:1,j:"Le rapprochement bancaire automatisé associe les écritures comptables saisies aux mouvements réels du relevé pour identifier les écarts et sécuriser la production."},
{id:6,sec:"Comptabilité de base",pts:2,q:"Lors d'un lettrage, vous constatez un écart de 0,01 € entre la facture et le règlement. Quelle est la bonne pratique ?",o:["Ignorer l'écart et lettrer quand même","Passer une écriture d'écart de règlement (compte 658 ou 758)","Contacter le client pour qu'il paie le centime","Modifier le montant de la facture"],c:1,j:"Les écarts de règlement minimes sont enregistrés en charges financières (658) ou produits financiers (758), conformément aux règles du PCG."},
{id:7,sec:"Réglementation",pts:2,q:"Que signifie le sigle RGPD ?",o:["Règlement Général sur la Productivité Digitale","Règlement Général sur la Protection des Données","Référentiel Général de la Performance Documentaire","Règle Générale de Procédure Déclarative"],c:1,j:"Le RGPD (Règlement UE 2016/679) encadre la collecte, le traitement et la conservation des données personnelles dans l'UE, en vigueur depuis le 25 mai 2018."},
{id:8,sec:"Réglementation",pts:2,q:"Quelle est l'obligation minimale de conservation des pièces comptables en France ?",o:["5 ans","10 ans","3 ans","7 ans"],c:1,j:"Le Code de commerce (art. L.123-22) impose une conservation de 10 ans pour les documents comptables à compter de la clôture de l'exercice."},
{id:9,sec:"Facturation électronique",pts:2,q:"À compter de quelle date toutes les entreprises assujetties à la TVA devront-elles pouvoir recevoir des factures électroniques ?",o:["1er janvier 2025","1er septembre 2026","1er janvier 2027","1er septembre 2027"],c:1,j:"L'article 91 de la loi de finances 2024 fixe l'obligation de réception des e-factures au 1er septembre 2026 pour toutes les entreprises via une plateforme agréée (PA) ou le portail public de facturation (PPF)."},
{id:10,sec:"Cybersécurité",pts:2,q:"Qu'est-ce que l'authentification multifacteur (MFA) ?",o:["Un mot de passe très long","Une méthode qui exige au moins 2 facteurs d'authentification différents","Un antivirus avancé","Un chiffrement de fichiers"],c:1,j:"Le MFA combine au moins 2 facteurs : ce que l'on sait (mot de passe), ce que l'on possède (téléphone), ou ce que l'on est (biométrie). L'ANSSI la recommande pour tout accès aux systèmes d'information sensibles."}
],
junior:[
{id:1,sec:"Comptabilité approfondie",pts:2,q:"Dans quel cas une provision pour dépréciation de créances clients doit-elle être constituée ?",o:["Quand le client a plus de 30 jours de retard","Quand il existe un risque probable de non-recouvrement","Quand le client est en procédure de sauvegarde uniquement","Quand le montant dépasse 10 000 €"],c:1,j:"Une provision est constituée dès qu'il existe un risque probable de non-recouvrement, en application du principe de prudence (PCG, art. 120-3). L'appréciation est individuelle, indépendante du montant ou du délai."},
{id:2,sec:"Comptabilité approfondie",pts:2,q:"Quelle est la différence entre une charge constatée d'avance (CCA) et une charge à payer (CAP) ?",o:["La CCA est une charge future, la CAP une charge passée non facturée","La CCA concerne l'exercice suivant, la CAP est une charge de l'exercice non encore comptabilisée","Aucune différence, ce sont des synonymes","La CCA diminue le résultat, la CAP l'augmente"],c:1,j:"La CCA est une charge enregistrée sur l'exercice mais qui concerne l'exercice suivant (à retrancher du résultat). La CAP est une charge de l'exercice non encore facturée à la clôture (à ajouter au résultat)."},
{id:3,sec:"Fiscalité",pts:2,q:"Quel est le taux normal de l'IS en France pour les exercices ouverts à compter du 1er janvier 2025 ?",o:["25 %","28 %","15 % pour toutes les entreprises","33,1/3 %"],c:0,j:"Le taux normal de l'IS est de 25 % depuis 2022 (LF 2018, art. 84). Le taux réduit de 15 % s'applique aux PME sur les premiers 42 500 € de bénéfice, sous conditions de CA et de capital."},
{id:4,sec:"Fiscalité",pts:2,q:"Qu'est-ce que le FEC (Fichier des Écritures Comptables) ?",o:["Un format de sauvegarde des pièces comptables","Un fichier normalisé des écritures comptables que l'entreprise doit pouvoir produire en cas de contrôle fiscal","Un tableau de bord de suivi fiscal","Un registre des déclarations de TVA"],c:1,j:"Le FEC (art. L.47 A du LPF) est un fichier dématérialisé au format normalisé contenant l'ensemble des écritures comptables, obligatoire en cas de vérification de comptabilité informatisée."},
{id:5,sec:"Révision",pts:2,q:"Lors de la révision du cycle achats-fournisseurs, quel contrôle est prioritaire ?",o:["Vérifier l'orthographe des noms de fournisseurs","Contrôler la séparation des exercices (cut-off) et le rapprochement factures/BL/commandes","Vérifier uniquement les montants supérieurs à 10 000 €","Contrôler les dates de paiement"],c:1,j:"Le contrôle prioritaire est le cut-off (bonne affectation à l'exercice) et le rapprochement triple (commande/BL/facture) pour s'assurer de la réalité et de l'exhaustivité des opérations."},
{id:6,sec:"Outils numériques",pts:2,q:"À quoi sert un connecteur API dans l'écosystème d'un cabinet numérique ?",o:["À protéger les données contre les cyberattaques","À faire communiquer automatiquement deux logiciels entre eux","À compresser les fichiers comptables","À générer des rapports PDF"],c:1,j:"Un connecteur API permet l'échange automatique de données entre applications (ex : Dext vers Pennylane) sans ressaisie manuelle — pilier de l'automatisation en cabinet numérique."},
{id:7,sec:"Réglementation",pts:2,q:"Quelle obligation impose l'article L.561-2 du Code monétaire et financier aux experts-comptables ?",o:["L'obligation de publier leurs honoraires","L'obligation de vigilance en matière de lutte contre le blanchiment (LCB-FT)","L'obligation de souscrire une assurance cyber","L'obligation de former leurs collaborateurs au numérique"],c:1,j:"L'art. L.561-2 du CMF fait des experts-comptables des professionnels assujettis à la LCB-FT : vigilance à l'égard du client, déclaration de soupçon à TRACFIN, classification des risques."},
{id:8,sec:"Cybersécurité",pts:2,q:"Que recommande la stratégie de sauvegarde « 3-2-1 » préconisée par l'ANSSI ?",o:["3 sauvegardes par jour, 2 hebdomadaires, 1 mensuelle","3 copies des données, sur 2 supports différents, dont 1 hors site","3 niveaux de chiffrement, 2 mots de passe, 1 clé physique","3 antivirus, 2 pare-feux, 1 VPN"],c:1,j:"La règle 3-2-1 : 3 copies des données, stockées sur 2 types de supports différents, dont 1 copie externalisée (hors site ou cloud sécurisé) pour protéger contre les sinistres locaux."},
{id:9,sec:"Facturation électronique",pts:2,q:"Quel est le rôle d'une plateforme agréée (PA) dans le dispositif de facturation électronique ?",o:["Remplacer l'expert-comptable dans l'établissement des factures","Recevoir, émettre et transmettre les factures au format structuré à la DGFiP via le PPF","Stocker les archives comptables pendant 10 ans","Calculer automatiquement la TVA à déclarer"],c:1,j:"Les PA (anciennement PDP) reçoivent et transmettent les factures au format structuré. Elles assurent le relais entre les entreprises et le portail public de facturation (PPF) de la DGFiP, et transmettent les données de transaction et de paiement."},
{id:10,sec:"Déontologie",pts:2,q:"Que prévoit l'article 147 du code de déontologie des experts-comptables (Décret n° 2012-432, éd. janv. 2026) ?",o:["L'obligation de formation continue","Le devoir de discrétion et le secret professionnel","L'obligation de publicité des honoraires","Le devoir de conseil fiscal"],c:1,j:"L'article 147 du code de déontologie (Décret n° 2012-432, éd. janv. 2026) dispose que les professionnels de l'expertise comptable sont soumis à un devoir de discrétion dans l'utilisation de toutes les informations dont ils ont connaissance dans le cadre de leur activité, sans préjudice de l'obligation au secret professionnel."}
],
confirme:[
{id:1,sec:"Comptabilité complexe",pts:2,q:"Lors de la consolidation, quelle méthode s'applique à une filiale détenue à 100 % ?",o:["Mise en équivalence","Intégration proportionnelle","Intégration globale","Aucune consolidation nécessaire"],c:2,j:"L'intégration globale s'applique aux entreprises sous contrôle exclusif (généralement > 50 % des droits de vote). À 100 %, la totalité des actifs, passifs, produits et charges est reprise dans les comptes consolidés."},
{id:2,sec:"Comptabilité complexe",pts:2,q:"Quelle norme IAS/IFRS traite de la comptabilisation du chiffre d'affaires ?",o:["IAS 16","IFRS 15","IAS 38","IFRS 9"],c:1,j:"IFRS 15 (Produits des activités ordinaires tirés de contrats avec des clients) définit le modèle en 5 étapes pour la reconnaissance du chiffre d'affaires."},
{id:3,sec:"Fiscalité avancée",pts:2,q:"Quel est le plafond du taux réduit d'IS à 15 % pour les PME en 2025 ?",o:["38 120 €","42 500 €","50 000 €","76 200 €"],c:1,j:"Depuis la LF 2022 (applicable au 01/01/2022), le taux réduit de 15 % s'applique sur les 42 500 premiers € de bénéfice (contre 38 120 € auparavant), sous conditions de CA < 10 M€ et de capital détenu à 75 % par des personnes physiques."},
{id:4,sec:"Fiscalité avancée",pts:2,q:"En matière de crédit-bail immobilier, comment est traité le bien chez le preneur en comptabilité française (PCG) ?",o:["Le bien est inscrit à l'actif du preneur","Le bien n'apparaît pas au bilan du preneur, seuls les loyers sont comptabilisés en charges","Le bien est inscrit au passif","Le preneur enregistre une dette financière et un actif incorporel"],c:1,j:"En PCG, le crédit-bail n'est pas retraité : le bien n'est pas inscrit à l'actif du preneur, les loyers sont comptabilisés en charges (à la différence d'IFRS 16 qui impose la comptabilisation au bilan du preneur)."},
{id:5,sec:"Conseil",pts:2,q:"Un dirigeant vous demande d'évaluer son entreprise. Quelle méthode combine valeur patrimoniale et rentabilité ?",o:["La méthode des DCF uniquement","La méthode du Goodwill (survaleur)","La méthode des comparables boursiers","La méthode de l'actif net comptable"],c:1,j:"La méthode du Goodwill combine l'Actif Net Corrigé (valeur patrimoniale) et un surprofit (écart entre rentabilité réelle et rémunération normale des capitaux investis). L'EC doit croiser plusieurs méthodes pour fiabiliser la fourchette."},
{id:6,sec:"Audit et contrôle",pts:2,q:"Qu'est-ce que le seuil de signification en audit ?",o:["Le montant minimum pour déclencher un contrôle fiscal","Le montant au-delà duquel une anomalie pourrait influencer les décisions économiques des utilisateurs","Le plafond de rémunération de l'auditeur","Le chiffre d'affaires minimum pour être audité"],c:1,j:"Le seuil de signification (ISA 320) est le montant au-delà duquel des anomalies, individuellement ou cumulées, pourraient influencer les décisions économiques des utilisateurs des états financiers."},
{id:7,sec:"IA et transformation",pts:2,q:"Que prévoit le règlement européen AI Act (2024/1689) concernant les systèmes d'IA à haut risque ?",o:["Leur interdiction totale","Une obligation de transparence, de supervision humaine et de documentation","Aucune réglementation spécifique","Uniquement une déclaration à la CNIL"],c:1,j:"L'AI Act classe les systèmes d'IA par niveau de risque. Les systèmes à haut risque (dont certains outils de décision financière) doivent respecter des obligations de transparence, documentation technique, supervision humaine et évaluation de conformité (art. 6 à 15)."},
{id:8,sec:"Cybersécurité avancée",pts:2,q:"Qu'est-ce qu'une attaque par « rançongiciel » (ransomware) ?",o:["Un vol de mot de passe par hameçonnage","Un logiciel malveillant qui chiffre les données et exige une rançon","Une arnaque au président par usurpation d'identité","Un virus qui détruit physiquement le matériel informatique"],c:1,j:"Le rançongiciel chiffre les fichiers de la victime et exige un paiement pour fournir la clé de déchiffrement. L'ANSSI le classe parmi les menaces majeures pour les TPE-PME et les cabinets comptables (rapport Cybermalveillance.gouv.fr 2024)."},
{id:9,sec:"Management qualité",pts:2,q:"Quelle est la finalité de la NPMQ (Norme Professionnelle de Maîtrise de la Qualité) pour un cabinet ?",o:["Fixer les honoraires minimum de la profession","Organiser la maîtrise de la qualité des missions : acceptation, réalisation, supervision, documentation","Définir les horaires de travail des collaborateurs","Réglementer la publicité du cabinet"],c:1,j:"La NPMQ structure le système qualité du cabinet : procédures d'acceptation et de maintien des missions (§18-20), gestion des ressources humaines et évaluation des compétences (§22, A22-1 à A22-4), supervision des travaux (§26-30), et surveillance continue du système (§32-33)."},
{id:10,sec:"Stratégie cabinet",pts:2,q:"Quel indicateur mesure la rentabilité d'un collaborateur dans un cabinet d'expertise comptable ?",o:["Le nombre de clients suivis","Le taux de facturation (ratio heures facturées / heures travaillées)","Le nombre de déclarations déposées","Le taux d'absentéisme"],c:1,j:"Le taux de facturation (taux de chargeabilité ou billable hours ratio) mesure la proportion du temps de travail effectivement facturé aux clients. C'est l'indicateur clé de rentabilité individuelle en cabinet, généralement ciblé entre 70 % et 85 %."}
]};

/* ═══ SAVOIR-FAIRE — 5 cas par niveau, 4 pts chacun = 20 pts max ═══ */
var SF={
apprenti:[
{id:1,t:"Saisie d'une facture d'achat",d:"Un fournisseur envoie une facture de 500 € HT + TVA 20 % pour des fournitures de bureau. Quelle est l'écriture correcte ?",pts:4,
 o:[{t:"Débit 606 : 500 € / Débit 44566 : 100 € / Crédit 401 : 600 €",ok:true},{t:"Débit 401 : 600 € / Crédit 606 : 600 €",ok:false},{t:"Débit 606 : 600 € / Crédit 401 : 600 €",ok:false},{t:"Débit 607 : 500 € / Crédit 512 : 500 €",ok:false}],
 j:"On débite la charge HT (606 = 500 €), la TVA déductible (44566 = 100 €), et on crédite le fournisseur (401 = 600 € TTC)."},
{id:2,t:"Contrôle de TVA collectée",d:"Un client restaurateur facture un repas à 50 € TTC. Quel montant de TVA collectée au taux intermédiaire de 10 % ?",pts:4,
 o:[{t:"4,55 € (50 / 1,10 × 0,10)",ok:true},{t:"5,00 € (50 × 0,10)",ok:false},{t:"10,00 € (50 × 0,20)",ok:false},{t:"8,33 € (50 / 1,20 × 0,20)",ok:false}],
 j:"Au taux intermédiaire de 10 % : TVA = 50 / 1,10 × 0,10 = 4,5454 € arrondi à 4,55 €. On calcule toujours la TVA à partir du TTC en divisant par (1 + taux)."},
{id:3,t:"Rapprochement bancaire",d:"Le solde comptable du compte 512 est de 15 320 € au débit. Le relevé bancaire indique 14 850 €. L'écart est de 470 €. Que vérifiez-vous en priorité ?",pts:4,
 o:[{t:"Les chèques émis non encaissés et les virements reçus non comptabilisés",ok:true},{t:"On ajuste le solde comptable pour correspondre au relevé",ok:false},{t:"On contacte la banque pour signaler une erreur",ok:false},{t:"On passe une OD pour équilibrer",ok:false}],
 j:"Le rapprochement bancaire identifie les décalages temporels : chèques émis non encore débités, virements reçus non saisis, frais bancaires non comptabilisés. Jamais d'ajustement sans justification."},
{id:4,t:"Intégration OCR — Contrôle humain",d:"Dext a extrait une facture mais le montant HT affiché est de 1 000 € au lieu de 1 200 € sur le justificatif original. Que faites-vous ?",pts:4,
 o:[{t:"Corriger manuellement dans Dext avant validation, puis vérifier l'intégration dans le logiciel comptable",ok:true},{t:"Valider tel quel, l'écart se rattrapera en fin d'année",ok:false},{t:"Supprimer la facture de Dext et la saisir entièrement à la main",ok:false},{t:"Signaler un bug à Dext et attendre la correction",ok:false}],
 j:"Le collaborateur doit toujours vérifier les données extraites par l'OCR avant validation. L'automatisation ne dispense jamais du contrôle humain (NPMQ §26-30, supervision et revue des travaux)."},
{id:5,t:"Classement d'un avoir fournisseur",d:"Vous recevez un avoir fournisseur de 200 € HT + TVA 20 %. Comment l'enregistrer ?",pts:4,
 o:[{t:"Débit 401 : 240 € / Crédit 606 : 200 € / Crédit 44566 : 40 €",ok:true},{t:"Débit 606 : 240 € / Crédit 401 : 240 €",ok:false},{t:"Débit 401 : 200 € / Crédit 606 : 200 €",ok:false},{t:"Débit 609 : 200 € / Crédit 401 : 200 €",ok:false}],
 j:"L'avoir est la contrepassation de la facture initiale : on débite le fournisseur (401) pour le TTC, on crédite la charge (606 ou 609) et la TVA déductible (44566). L'option D est partiellement correcte (609 est acceptable) mais omet la TVA."}
],
junior:[
{id:1,t:"Révision du cycle clients",d:"Lors de la révision, vous constatez un solde client débiteur de 25 000 € TTC dont 8 000 € TTC ont plus de 90 jours. Le client est en difficulté financière avérée. Quelle provision constituez-vous ?",pts:4,
 o:[{t:"Provision sur le montant HT du solde douteux (reclassement en 416), soit 6 667 € HT si TVA 20 %",ok:true},{t:"Provision de 25 000 € (totalité du solde TTC)",ok:false},{t:"Aucune provision, on attend la confirmation du client",ok:false},{t:"Provision de 8 000 € TTC directement",ok:false}],
 j:"La provision porte sur le montant HT car la TVA sera récupérée via le mécanisme de TVA sur créances irrécouvrables (CGI, art. 272). Le solde douteux est reclassé du 411 au 416. Ici : 8 000 / 1,20 = 6 667 € HT."},
{id:2,t:"Calcul IS avec taux réduit",d:"Une PME (CA < 10 M€, capital détenu à 75 % par des personnes physiques) réalise un bénéfice fiscal de 60 000 €. Calculez l'IS dû au titre de l'exercice 2025.",pts:4,
 o:[{t:"42 500 × 15 % + 17 500 × 25 % = 6 375 + 4 375 = 10 750 €",ok:true},{t:"60 000 × 25 % = 15 000 €",ok:false},{t:"60 000 × 15 % = 9 000 €",ok:false},{t:"38 120 × 15 % + 21 880 × 25 % = 11 188 €",ok:false}],
 j:"Taux réduit de 15 % sur les 42 500 premiers € de bénéfice, puis taux normal de 25 % au-delà. Le plafond est de 42 500 € depuis la LF 2022 (et non plus 38 120 €, ancien seuil)."},
{id:3,t:"Cut-off fournisseur (FNP)",d:"Le 31/12/N, vous identifiez une facture fournisseur de 3 000 € HT reçue le 05/01/N+1 pour une prestation réalisée intégralement en décembre N. Quelle écriture de cut-off ?",pts:4,
 o:[{t:"Débit 408 (FNP) : 3 600 / Crédit 606 : 3 000 / Crédit 44586 : 600",ok:false},{t:"Débit 606 : 3 000 / Débit 44586 : 600 / Crédit 408 : 3 600",ok:true},{t:"Rien, la facture sera comptabilisée en N+1",ok:false},{t:"Débit 486 (CCA) : 3 000 / Crédit 606 : 3 000",ok:false}],
 j:"La charge concerne l'exercice N : on débite la charge (606 = 3 000 €) et la TVA sur factures non parvenues (44586 = 600 €), et on crédite le compte 408 (FNP = 3 600 € TTC) pour rattacher la charge au bon exercice (principe d'indépendance des exercices)."},
{id:4,t:"Paramétrage d'un flux automatisé",d:"Le dirigeant d'une PME demande à automatiser la collecte bancaire dans Pennylane. Quelles étapes recommandez-vous ?",pts:4,
 o:[{t:"Connecter les API bancaires, paramétrer les règles de rapprochement, tester sur un mois, valider avec le client",ok:true},{t:"Saisir manuellement les relevés puis activer l'automatisation sans test",ok:false},{t:"Déléguer entièrement au client le paramétrage",ok:false},{t:"Attendre la prochaine mise à jour de Pennylane",ok:false}],
 j:"L'automatisation suit un processus structuré : connexion technique (API), paramétrage des règles métier, phase de test sur période probatoire, et validation collaborative avec le client. La mise en production sans test préalable est proscrite."},
{id:5,t:"Analyse de ratio — BFR",d:"Le besoin en fonds de roulement (BFR) d'un client passe de 45 jours à 72 jours de CA. Quelle est votre recommandation ?",pts:4,
 o:[{t:"Analyser les délais clients, stocks et fournisseurs, identifier la cause de la dégradation et proposer un plan d'action chiffré",ok:true},{t:"Recommander un emprunt bancaire immédiat",ok:false},{t:"Ne rien signaler, c'est normal en période de croissance",ok:false},{t:"Proposer une augmentation de capital",ok:false}],
 j:"Une dégradation du BFR (+27 jours) nécessite un diagnostic détaillé : allongement des délais clients ? Augmentation des stocks ? Raccourcissement des délais fournisseurs ? Le devoir de conseil de l'expert-comptable (art. 155 du code de déontologie) impose une recommandation factuelle et chiffrée."}
],
confirme:[
{id:1,t:"Évaluation d'entreprise",d:"Un dirigeant souhaite valoriser sa PME (CA 3 M€, REX 300 k€, ANC 800 k€). Les comparables sectoriels donnent un multiple EV/EBITDA de 5×. Quelle approche recommandez-vous ?",pts:4,
 o:[{t:"Croiser la méthode patrimoniale (ANC), les multiples (EV/EBITDA) et un DCF simplifié, puis négocier dans la fourchette",ok:true},{t:"Appliquer uniquement le multiple : 300 k × 5 = 1,5 M€",ok:false},{t:"Retenir l'ANC de 800 k€ comme valeur définitive",ok:false},{t:"Proposer un prix au feeling basé sur l'expérience",ok:false}],
 j:"Une évaluation sérieuse croise au moins 2 à 3 méthodes pour dégager une fourchette de valeur. L'expert-comptable doit exercer son jugement professionnel (art. 145 du code de déontologie) et documenter sa démarche de manière traçable."},
{id:2,t:"Diagnostic d'une mission complexe",d:"Un prospect vous confie un dossier avec 18 mois de retard comptable, des factures non classées et aucune déclaration de TVA déposée. Comment structurez-vous la mission ?",pts:4,
 o:[{t:"Lettre de mission spécifique de régularisation, inventaire des obligations, planning priorisé (TVA d'abord), estimation du coût, information des risques fiscaux",ok:true},{t:"Refuser la mission, le dossier est trop risqué",ok:false},{t:"Commencer immédiatement la saisie sans lettre de mission",ok:false},{t:"Déconseiller au client de régulariser et attendre un contrôle fiscal",ok:false}],
 j:"La NPMQ (§18-20) et l'art. 150 du code de déontologie imposent une procédure d'acceptation formelle. L'art. 151 impose une lettre de mission écrite. Le risque est élevé mais gérable avec un cadrage rigoureux, un planning priorisé et une information transparente du client sur les risques et les coûts."},
{id:3,t:"Conseil fiscal — Arbitrage rémunération/dividendes",d:"Un dirigeant de SAS se rémunère exclusivement en dividendes (flat tax 30 %). Est-ce optimal ?",pts:4,
 o:[{t:"Pas nécessairement : en SAS, le dirigeant est assimilé salarié (régime général). La rémunération génère des droits sociaux (retraite, prévoyance) et réduit l'assiette de l'IS. L'optimum est un mix rémunération/dividendes à simuler selon la situation personnelle. De plus, contrairement à la SARL, les dividendes de SAS ne sont pas soumis aux cotisations sociales au-delà de 10 % du capital.",ok:true},{t:"Oui, la flat tax à 30 % est toujours plus avantageuse que le salaire",ok:false},{t:"Peu importe, le choix n'a pas d'impact significatif",ok:false},{t:"Il faut systématiquement privilégier le salaire pour les droits retraite",ok:false}],
 j:"L'optimisation rémunération/dividendes dépend de multiples facteurs : taux marginal d'IR, droits sociaux souhaités, niveau de rémunération, et forme juridique. En SAS, le président relève du régime général (assimilé salarié). Contrairement à la SARL/EURL (art. L.131-6 du CSS), les dividendes de SAS ne sont pas soumis aux cotisations sociales au-delà de 10 % du capital. L'EC doit simuler plusieurs scénarios et documenter son analyse (art. 155, devoir de conseil)."},
{id:4,t:"Gestion de crise cyber — Rançongiciel",d:"Un collaborateur signale qu'il a cliqué sur un lien suspect et que des fichiers clients semblent chiffrés. Quelle est votre réaction immédiate ?",pts:4,
 o:[{t:"Isoler le poste du réseau, alerter le responsable sécurité, vérifier les sauvegardes, ne pas payer de rançon, notifier la CNIL sous 72 h si des données personnelles sont compromises",ok:true},{t:"Éteindre tous les ordinateurs du cabinet et appeler la police",ok:false},{t:"Payer la rançon rapidement pour récupérer les fichiers",ok:false},{t:"Ignorer l'alerte, l'antivirus va gérer",ok:false}],
 j:"Le protocole ANSSI en cas de rançongiciel : isoler le poste infecté, alerter le responsable sécurité (ou le prestataire SI), vérifier l'intégrité des sauvegardes, ne jamais payer la rançon. Si des données personnelles sont affectées, notification obligatoire de la CNIL sous 72 h (RGPD, art. 33). Un dépôt de plainte est également recommandé."},
{id:5,t:"Pilotage de mission à distance",d:"Vous supervisez 3 collaborateurs juniors en télétravail. L'un d'eux accumule du retard et la qualité de ses dossiers baisse. Comment réagissez-vous ?",pts:4,
 o:[{t:"Point individuel rapide pour comprendre les causes, ajuster la charge si nécessaire, renforcer les points de contrôle intermédiaires, documenter l'échange",ok:true},{t:"Envoyer un e-mail formel de rappel à l'ordre",ok:false},{t:"Reprendre ses dossiers sans discussion",ok:false},{t:"Attendre la fin de la période fiscale pour en discuter",ok:false}],
 j:"Le management à distance exige des rituels réguliers, une écoute active et des points de contrôle intermédiaires. L'art. 148 du code de déontologie (Décret n° 2012-432, éd. janv. 2026) impose que les collaborateurs aient une compétence appropriée et que la qualité des travaux soit assurée. Le manager doit s'en assurer par une supervision adaptée."}
]};

/* ═══ SAVOIR-ÊTRE — 7 critères pondérés = 100 % ═══ */
var SE=[
{id:"se1",lbl:"Adaptabilité technologique",w:15,q:"Décrivez une situation où vous avez dû apprendre rapidement un nouvel outil numérique sans formation formelle. Comment avez-vous procédé ?",pos:["Auto-apprentissage proactif","Recherche de solutions en autonomie","Partage avec l'équipe"],neg:["Attente passive d'une formation","Blocage prolongé sans initiative","Refus d'utiliser le nouvel outil"]},
{id:"se2",lbl:"Autonomie en télétravail",w:15,q:"Comment organisez-vous votre travail lorsque vous êtes en autonomie complète, sans supervision directe ?",pos:["Planning structuré et priorisé","Communication régulière avec l'équipe","Respect des délais et alertes anticipées"],neg:["Procrastination","Difficulté de concentration durable","Isolement sans reporting"]},
{id:"se3",lbl:"Confidentialité",w:15,elim:true,q:"Vous découvrez accidentellement une information confidentielle concernant un autre client du cabinet. Que faites-vous concrètement ?",pos:["Signalement immédiat au responsable","Discrétion absolue sur l'information","Respect strict des procédures internes"],neg:["Partage de l'information avec des tiers","Indifférence à la confidentialité","Exploitation personnelle de l'information"]},
{id:"se4",lbl:"Gestion du changement",w:10,q:"Comment réagissez-vous face à un changement de procédure, d'outil ou d'organisation dans votre environnement de travail ?",pos:["Adaptation rapide et constructive","Propositions d'amélioration","Accompagnement naturel des collègues"],neg:["Résistance active ou passive","Nostalgie du système précédent","Critique sans proposition de solution"]},
{id:"se5",lbl:"Responsabilité face à l'erreur",w:15,q:"Racontez une situation où vous avez commis une erreur professionnelle. Comment l'avez-vous identifiée et gérée ?",pos:["Reconnaissance rapide de l'erreur","Information immédiate du responsable","Mise en place de mesures correctives"],neg:["Dissimulation de l'erreur","Rejet de la responsabilité sur un tiers","Répétition d'erreurs similaires"]},
{id:"se6",lbl:"Collaboration à distance",w:15,q:"Décrivez un projet en équipe où vous avez travaillé avec des personnes ayant des opinions ou méthodes différentes des vôtres.",pos:["Écoute active et reformulation","Recherche de consensus pragmatique","Respect des opinions divergentes"],neg:["Imposition de son avis sans discussion","Conflit non résolu et escalade","Retrait passif du projet"]},
{id:"se7",lbl:"Rigueur et qualité",w:15,q:"Comment vous assurez-vous de la qualité de votre travail avant remise d'un livrable (dossier de révision, bilan, déclaration) ?",pos:["Double vérification systématique","Checklist de contrôle personnelle","Anticipation des erreurs récurrentes"],neg:["Pas de relecture avant envoi","Délais non respectés","Qualité variable selon la charge"]}
];

/* ═══ APPÉTENCES NUMÉRIQUES — 4 critères à 25 % = 100 % ═══ */
var APP=[
{id:"ap1",lbl:"Aisance en environnement full cloud",w:25,q:"Avez-vous déjà travaillé dans un environnement 100 % dématérialisé (zéro papier, outils SaaS) ? Comment vivez-vous cette transition ?",pos:["Enthousiasme pour le zéro papier","Expérience concrète d'outils cloud","Exemples précis d'outils maîtrisés"],neg:["Réticence au zéro papier","Dépendance aux dossiers physiques","Aucune expérience cloud"]},
{id:"ap2",lbl:"Intérêt pour l'automatisation et l'IA",w:25,q:"Avez-vous déjà automatisé un processus ou utilisé une IA dans un contexte professionnel ? Lequel et avec quel résultat concret ?",pos:["Initiative personnelle d'automatisation","Résultat mesurable (temps gagné, erreurs réduites)","Curiosité active pour l'IA"],neg:["Aucune initiative d'automatisation","Méfiance technologique non argumentée","Pas d'intérêt pour les évolutions numériques"]},
{id:"ap3",lbl:"Sensibilité cybersécurité et RGPD",w:25,q:"Comment protégez-vous les données sensibles dans votre pratique quotidienne (mots de passe, partage de fichiers, sauvegardes) ?",pos:["Bonnes pratiques concrètes et quotidiennes","MFA activé, gestionnaire de mots de passe","Sensibilisation active des collègues ou clients"],neg:["Mots de passe faibles ou réutilisés","Partage non sécurisé de documents","Indifférence à la sécurité des données"]},
{id:"ap4",lbl:"Capacité d'accompagnement client numérique",w:25,q:"Un client exprime des réticences face à la dématérialisation de ses échanges avec le cabinet. Comment l'accompagnez-vous ?",pos:["Pédagogie patiente et progressive","Écoute des freins avant de proposer","Démonstration concrète des bénéfices"],neg:["Imposition de l'outil sans explication","Manque de patience face aux résistances","Pas de solution alternative proposée"]}
];

/* ═══ MATCH VALEURS CABINET — 5 valeurs à 20 % = 100 % ═══ */
var VAL=[
{id:"v1",lbl:"Innovation et curiosité technologique",w:20,desc:"Le cabinet investit dans les technologies émergentes (IA, automatisation, data analytics). Le candidat démontre-t-il un intérêt concret et une veille active ?"},
{id:"v2",lbl:"Autonomie et responsabilisation",w:20,desc:"Chaque collaborateur est responsable de son organisation en télétravail, dans le respect des délais et de la qualité. Le candidat démontre-t-il cette maturité professionnelle ?"},
{id:"v3",lbl:"Transparence et communication ouverte",w:20,desc:"L'information circule librement dans le cabinet (rituels, messagerie, reporting partagé). Le candidat communique-t-il naturellement et de manière structurée ?"},
{id:"v4",lbl:"Orientation client et pédagogie numérique",w:20,desc:"Le cabinet accompagne ses clients dans la transition numérique (art. 155, devoir de conseil). Le candidat a-t-il cette fibre pédagogique envers les clients ?"},
{id:"v5",lbl:"Exigence qualité et amélioration continue",w:20,desc:"La qualité est au cœur du système du cabinet (NPMQ, §32-33 : surveillance et amélioration continue). Le candidat intègre-t-il naturellement le contrôle et l'auto-évaluation ?"}
];

/* ═══ CONFORMITÉ DYNAMIQUE — Checklist réglementaire ═══ */
var CK_BASE=[
{id:"c1",t:"Méthodes d'évaluation communiquées au candidat avant les tests",r:"Art. L.1221-8 Code du travail"},
{id:"c2",t:"Questions et cas pratiques en lien direct avec le poste à pourvoir",r:"Art. L.1221-6 Code du travail"},
{id:"c3",t:"Aucun traitement automatisé exclusif n'a déterminé la décision",r:"RGPD art. 22 — Décision humaine obligatoire"},
{id:"c4",t:"Grille d'évaluation objective avec critères documentés et pondérés",r:"NPMQ §22, A22-1 à A22-4 (Réf. normatif OEC 2025)"},
{id:"c5",t:"Critères éliminatoires transparents et justifiés par les exigences du poste",r:"Art. L.1132-1 Code du travail — Non-discrimination"},
{id:"c6",t:"Commentaires d'entretien factuels et non discriminatoires",r:"CNIL, Guide recrutement et données personnelles, janv. 2023"},
{id:"c7",t:"Traçabilité de la décision (archivage grille + justification écrite)",r:"NPMQ §26-30 — Documentation et traçabilité des travaux"},
{id:"c8",t:"Conservation limitée des résultats (2 ans maximum après décision)",r:"RGPD art. 5(1)(e) — Limitation de la conservation + CNIL 2023"}
];
var CK_LEVEL={
  "Apprenti":[{id:"c9a",t:"Supervision renforcée prévue pour le candidat débutant (tuteur désigné, points de contrôle rapprochés)",r:"NPMQ §22, A22-2 — Supervision proportionnée à l'expérience"}],
  "Junior":[{id:"c9j",t:"Compétences numériques du socle obligatoire du cabinet vérifiées (cloud, OCR, rapprochement)",r:"Cabinet 100 % numérique — Socle digital obligatoire (Annexe 19)"}],
  "Confirmé":[
    {id:"c9c",t:"Capacité de supervision des juniors évaluée dans les cas pratiques",r:"Art. 148 Code de déontologie (Décret n° 2012-432, éd. janv. 2026) + NPMQ §22, A22-2"},
    {id:"c10c",t:"Compétences en pilotage numérique (tableaux de bord, KPI, data) testées",r:"Cabinet 100 % numérique — Supervision qualité digitale"}
  ]
};
function getCK(){var niv=S.lvl?CFG[S.lvl].name:"Apprenti";return CK_BASE.concat(CK_LEVEL[niv]||[])}
var CP={};

/* ═══ STATE ═══ */
var S={lvl:null,kAns:{},kScore:0,sfAns:{},sfScore:0,seScr:{},seCom:{},appScr:{},appCom:{},valScr:{},cf:0,adn:0,verdict:null,vTxt:"",vDesc:"",elimFail:[],kMax:0,sfMax:0,tmr:null,tmrSec:0};

/* ═══ NAVIGATION ═══ */
function go(n){for(var i=1;i<=5;i++){var el=document.getElementById("p"+i);if(el)el.classList.toggle("on",i===n)}
  document.querySelectorAll(".step").forEach(function(s,i){s.classList.remove("on","ok2");if(i<n-1)s.classList.add("ok2");if(i===n-1)s.classList.add("on")});
  window.scrollTo({top:0,behavior:"smooth"});updProgress()}

function selLvl(k){S.lvl=k;
  document.querySelectorAll("#p1 .pc").forEach(function(c){c.classList.remove("on")});
  var el=document.getElementById("lv-"+k);if(el)el.classList.add("on");
  var c=CFG[k];
  document.getElementById("cfgInfo").innerHTML='<table><tr><th>Paramètre</th><th>Valeur</th></tr><tr><td>Niveau</td><td><strong>'+c.name+'</strong></td></tr><tr><td>Durée QCM</td><td>'+c.dur+' minutes</td></tr><tr><td>Seuil connaissance</td><td>'+c.seuil+' / '+c.maxK+' pts</td></tr><tr><td>Culture fit minimum</td><td>'+c.cfMin+' %</td></tr><tr><td>ADN numérique minimum</td><td>'+c.adnMin+' %</td></tr></table>';
  rCk();updProgress();autoSave();toast("Niveau "+c.name+" sélectionné")}

function startTest(){
  if(!S.lvl){toast("Sélectionnez un niveau");return}
  if(!gV("cNom")){toast("Renseignez le nom du candidat");return}
  S.kAns={};S.kScore=0;S.sfAns={};S.sfScore=0;S.seScr={};S.seCom={};S.appScr={};S.appCom={};S.valScr={};
  renderQCM();renderSF();renderSE();renderAPP();renderVAL();rCk();
  go(2);startTmr(CFG[S.lvl].dur*60)}

/* ═══ QCM ═══ */
function renderQCM(){
  var qs=QCM[S.lvl];S.kMax=0;qs.forEach(function(q){S.kMax+=q.pts});
  var h="";qs.forEach(function(q,i){
    h+='<div class="qc" id="qc'+i+'"><div class="qh"><span class="ql">'+q.sec+'</span><span class="qp">'+q.pts+' pts</span></div>';
    h+='<div class="qq">Q'+(i+1)+'. '+q.q+'</div>';
    q.o.forEach(function(o,j){h+='<div class="qo" id="qo'+i+'-'+j+'" onclick="ansK('+i+','+j+')"><span class="ol">'+String.fromCharCode(65+j)+'</span><span>'+o+'</span></div>'});
    h+='<div class="qj" id="qj'+i+'">'+q.j+'</div></div>'});
  document.getElementById("qBox").innerHTML=h;updLiveK()}

function ansK(qi,oi){
  if(S.kAns[qi]!==undefined)return;
  var q=QCM[S.lvl][qi];S.kAns[qi]=oi;
  var ok=oi===q.c;if(ok)S.kScore+=q.pts;
  q.o.forEach(function(_,j){var el=document.getElementById("qo"+qi+"-"+j);el.classList.add("dis");
    if(j===q.c)el.classList.add("ok");if(j===oi&&!ok)el.classList.add("ko")});
  document.getElementById("qc"+qi).classList.add(ok?"ok":"ko");updLiveK();autoSave()}
function updLiveK(){document.getElementById("liveK").textContent=S.kScore+" / "+S.kMax}

/* ═══ TIMER ═══ */
function startTmr(sec){S.tmrSec=sec;updTmr();S.tmr=setInterval(function(){S.tmrSec--;updTmr();if(S.tmrSec<=0){clearInterval(S.tmr);toast("Temps écoulé — les réponses restent modifiables")}},1000)}
function updTmr(){var m=Math.floor(S.tmrSec/60),s=S.tmrSec%60;
  var el=document.getElementById("tmrVal");el.textContent=String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
  var t=document.getElementById("timer");t.className="tmr"+(S.tmrSec<120?" crit":S.tmrSec<300?" warn":"")}
function stopTmr(){if(S.tmr){clearInterval(S.tmr);S.tmr=null}}
function finK(){
  var qs=QCM[S.lvl],u=0;qs.forEach(function(_,i){if(S.kAns[i]===undefined)u++});
  if(u>0&&!confirm(u+" question(s) sans réponse. Valider quand même ?"))return;
  stopTmr();go(3)}

/* ═══ SAVOIR-FAIRE ═══ */
function renderSF(){
  var ts=SF[S.lvl];S.sfMax=0;ts.forEach(function(t){S.sfMax+=t.pts});
  var ctx=S.lvl==="apprenti"?"Contexte : Vous êtes apprenti(e) dans un cabinet 100 % numérique. On vous confie des tâches de saisie et de vérification via les outils cloud du cabinet (Pennylane, Dext).":S.lvl==="junior"?"Contexte : Vous êtes collaborateur junior chargé de la révision des comptes d'une PME de 15 salariés (CA : 2 M€) dans un cabinet entièrement dématérialisé.":"Contexte : Vous êtes collaborateur confirmé intervenant sur des missions de conseil et de supervision auprès de dirigeants de PME/ETI dans un cabinet 100 % numérique.";
  var h='<div class="hnt blue"><div class="ico">&#128203;</div><div><strong>'+ctx+'</strong></div></div>';
  ts.forEach(function(t,i){
    h+='<div class="qc" id="sf'+i+'"><div class="qh"><span class="ql">Cas '+(i+1)+'</span><span class="qp">'+t.pts+' pts</span></div>';
    h+='<div class="qq">'+t.t+'</div><div style="font-size:13px;color:var(--g500);margin-bottom:10px;line-height:1.55">'+t.d+'</div>';
    t.o.forEach(function(o,j){h+='<div class="qo" id="sfo'+i+'-'+j+'" onclick="ansSF('+i+','+j+')"><span class="ol">'+String.fromCharCode(65+j)+'</span><span>'+o.t+'</span></div>'});
    h+='<div class="qj" id="sfj'+i+'">'+t.j+'</div></div>'});
  document.getElementById("sfBox").innerHTML=h;updLiveSF()}

function ansSF(ti,oi){
  if(S.sfAns[ti]!==undefined)return;
  var t=SF[S.lvl][ti];S.sfAns[ti]=oi;
  var ok=t.o[oi].ok;if(ok)S.sfScore+=t.pts;
  t.o.forEach(function(o,j){var el=document.getElementById("sfo"+ti+"-"+j);el.classList.add("dis");
    if(o.ok)el.classList.add("ok");if(j===oi&&!ok)el.classList.add("ko")});
  document.getElementById("sf"+ti).classList.add(ok?"ok":"ko");updLiveSF();autoSave()}
function updLiveSF(){document.getElementById("liveSF").textContent=S.sfScore+" / "+S.sfMax}
function finSF(){go(4)}

/* ═══ SAVOIR-ÊTRE ═══ */
function renderSE(){
  var h="";SE.forEach(function(c){
    h+='<div class="sec" id="sec-'+c.id+'"><div style="display:flex;justify-content:space-between;align-items:center"><h3 style="font-size:15px">'+c.lbl+(c.elim?' <span style="color:var(--d);font-size:11px;font-weight:700">ÉLIMINATOIRE</span>':'')+'</h3><span style="font-size:12px;color:var(--g500);font-weight:600">Poids : '+c.w+' %</span></div>';
    h+='<div class="sel-q">'+c.q+'</div>';
    h+='<div class="stars" id="st-'+c.id+'">';
    for(var i=1;i<=5;i++)h+='<div class="star" onclick="rateSE(\''+c.id+'\','+i+')" id="star-'+c.id+'-'+i+'">'+i+'</div>';
    h+='</div>';
    h+='<div class="se-tips"><span class="se-pos">&#10003; '+c.pos.join(" · ")+'</span><span class="se-neg">&#10007; '+c.neg.join(" · ")+'</span></div>';
    h+='<textarea class="se-com" id="com-'+c.id+'" placeholder="Observations factuelles de l\'évaluateur..." onchange="comSE(\''+c.id+'\',this.value)"></textarea></div>'});
  document.getElementById("seBox").innerHTML=h}

function rateSE(id,sc){S.seScr[id]=sc;
  for(var i=1;i<=5;i++){document.getElementById("star-"+id+"-"+i).classList.toggle("on",i<=sc)}updLiveSE();autoSave()}
function comSE(id,v){S.seCom[id]=v;autoSave()}
function updLiveSE(){
  var total=0,wSum=0;SE.forEach(function(c){if(S.seScr[c.id]){total+=(S.seScr[c.id]/5)*c.w;wSum+=c.w}});
  S.cf=wSum>0?Math.round(total/wSum*100):0;
  document.getElementById("liveSE").textContent=S.cf+" %"}
function finSE(){
  var missing=SE.filter(function(c){return!S.seScr[c.id]});
  if(missing.length>0){toast("Notez tous les critères de savoir-être ("+missing.length+" restant(s))");return}
  go(5)}

/* ═══ APPÉTENCES NUMÉRIQUES ═══ */
function renderAPP(){
  var h="";APP.forEach(function(c){
    h+='<div class="sec" id="sec-'+c.id+'"><div style="display:flex;justify-content:space-between;align-items:center"><h3 style="font-size:15px;color:var(--s)">'+c.lbl+'</h3><span style="font-size:12px;color:var(--g500);font-weight:600">Poids : '+c.w+' %</span></div>';
    h+='<div class="sel-q">'+c.q+'</div>';
    h+='<div class="stars" id="st-'+c.id+'">';
    for(var i=1;i<=5;i++)h+='<div class="star" onclick="rateAPP(\''+c.id+'\','+i+')" id="star-'+c.id+'-'+i+'">'+i+'</div>';
    h+='</div>';
    h+='<div class="se-tips"><span class="se-pos">&#10003; '+c.pos.join(" · ")+'</span><span class="se-neg">&#10007; '+c.neg.join(" · ")+'</span></div>';
    h+='<textarea class="se-com" id="com-'+c.id+'" placeholder="Observations factuelles..." onchange="comAPP(\''+c.id+'\',this.value)"></textarea></div>'});
  document.getElementById("appBox").innerHTML=h}

function rateAPP(id,sc){S.appScr[id]=sc;
  for(var i=1;i<=5;i++){document.getElementById("star-"+id+"-"+i).classList.toggle("on",i<=sc)}updLiveAPP();autoSave()}
function comAPP(id,v){S.appCom[id]=v;autoSave()}
function updLiveAPP(){
  var total=0,wSum=0;APP.forEach(function(c){if(S.appScr[c.id]){total+=(S.appScr[c.id]/5)*c.w;wSum+=c.w}});
  var pct=wSum>0?Math.round(total/wSum*100):0;
  document.getElementById("liveApp").textContent=pct+" %"}

/* ═══ MATCH VALEURS ═══ */
function renderVAL(){
  var h="";VAL.forEach(function(v){
    h+='<div class="sec" id="sec-'+v.id+'"><div style="display:flex;justify-content:space-between;align-items:center"><h3 style="font-size:15px;color:var(--pu)">'+v.lbl+'</h3><span style="font-size:12px;color:var(--g500);font-weight:600">Poids : '+v.w+' %</span></div>';
    h+='<div class="sel-q">'+v.desc+'</div>';
    h+='<div class="stars" id="st-'+v.id+'">';
    for(var i=1;i<=5;i++)h+='<div class="star" onclick="rateVAL(\''+v.id+'\','+i+')" id="star-'+v.id+'-'+i+'">'+i+'</div>';
    h+='</div></div>'});
  document.getElementById("valBox").innerHTML=h}

function rateVAL(id,sc){S.valScr[id]=sc;
  for(var i=1;i<=5;i++){document.getElementById("star-"+id+"-"+i).classList.toggle("on",i<=sc)}updLiveVAL();autoSave()}
function updLiveVAL(){
  var total=0,wSum=0;VAL.forEach(function(v){if(S.valScr[v.id]){total+=(S.valScr[v.id]/5)*v.w;wSum+=v.w}});
  var pct=wSum>0?Math.round(total/wSum*100):0;
  document.getElementById("liveVal").textContent=pct+" %"}

/* ═══ VERDICT ═══ */
function calcVerdict(){
  if(!S.lvl){toast("Aucun test lancé");return}
  var c=CFG[S.lvl];
  // Culture fit
  var cfTot=0;SE.forEach(function(cr){cfTot+=(S.seScr[cr.id]||0)/5*cr.w});S.cf=Math.round(cfTot);
  // ADN numérique = moyenne appétences + valeurs
  var appTot=0,appW=0;APP.forEach(function(a){if(S.appScr[a.id]){appTot+=(S.appScr[a.id]/5)*a.w;appW+=a.w}});
  var appPct=appW>0?Math.round(appTot/appW*100):0;
  var valTot=0,valW=0;VAL.forEach(function(v){if(S.valScr[v.id]){valTot+=(S.valScr[v.id]/5)*v.w;valW+=v.w}});
  var valPct=valW>0?Math.round(valTot/valW*100):0;
  S.adn=Math.round((appPct+valPct)/2);
  // Éliminatoires
  S.elimFail=SE.filter(function(cr){return cr.elim&&(S.seScr[cr.id]||0)<2});
  // Verdict
  S.verdict="acc";S.vTxt="AVIS FAVORABLE";S.vDesc="Le candidat répond aux critères requis et peut intégrer le cabinet 100 % numérique. Passage à l'onboarding (Annexe 21).";
  if(S.elimFail.length>0){S.verdict="rej";S.vTxt="AVIS DÉFAVORABLE";S.vDesc="Critère éliminatoire non satisfait : confidentialité < 2/5 (art. 147, devoir de discrétion).";}
  else if(S.kScore<c.seuil){S.verdict="rej";S.vTxt="AVIS DÉFAVORABLE";S.vDesc="Score connaissance insuffisant ("+S.kScore+"/"+S.kMax+", seuil requis : "+c.seuil+").";}
  else if(S.sfScore<S.sfMax*0.4){S.verdict="rej";S.vTxt="AVIS DÉFAVORABLE";S.vDesc="Score savoir-faire insuffisant (< 40 % de réussite).";}
  else if(S.cf<c.cfMin){S.verdict="con";S.vTxt="AVIS CONDITIONNEL";S.vDesc="Culture fit limite ("+S.cf+" %, minimum requis : "+c.cfMin+" %). Accompagnement renforcé recommandé en phase d'intégration.";}
  else if(S.adn<c.adnMin){S.verdict="con";S.vTxt="AVIS CONDITIONNEL";S.vDesc="ADN numérique insuffisant ("+S.adn+" %, minimum requis : "+c.adnMin+" %). Formation aux outils digitaux du cabinet à prévoir avant prise de poste.";}
  renderResults();autoSave()}

function renderResults(){
  var c=CFG[S.lvl];
  var vc=S.verdict==="acc"?"acc":S.verdict==="con"?"con":"rej";
  var vi=S.verdict==="acc"?"\u2705":S.verdict==="con"?"\u26A0\uFE0F":"\u274C";
  document.getElementById("verdBox").innerHTML='<div class="verd '+vc+'"><h2>'+vi+" "+S.vTxt+'</h2><p>'+S.vDesc+'</p></div>';

  var kCl=S.kScore>=c.seuil?"suc":"dng";
  var sfPct=S.sfMax>0?Math.round(S.sfScore/S.sfMax*100):0,sfCl=sfPct>=60?"suc":sfPct>=40?"wrn":"dng";
  var cfCl=S.cf>=c.cfMin?"suc":S.cf>=50?"wrn":"dng";
  var adnCl=S.adn>=c.adnMin?"suc":S.adn>=40?"wrn":"dng";

  var h='<div class="rg"><div class="rc '+kCl+'"><div class="rl">Test de connaissance</div><div class="rv">'+S.kScore+'/'+S.kMax+'</div><div class="rs">Seuil : '+c.seuil+'</div></div>';
  h+='<div class="rc '+sfCl+'"><div class="rl">Savoir-faire</div><div class="rv">'+S.sfScore+'/'+S.sfMax+'</div><div class="rs">'+sfPct+' % de réussite</div></div>';
  h+='<div class="rc '+cfCl+'"><div class="rl">Culture fit</div><div class="rv">'+S.cf+' %</div><div class="rs">Min : '+c.cfMin+' %</div></div>';
  h+='<div class="rc '+adnCl+'"><div class="rl">ADN numérique</div><div class="rv">'+S.adn+' %</div><div class="rs">Min : '+c.adnMin+' %</div></div></div>';

  // Détail savoir-être
  h+='<div class="cd"><h3>Détail savoir-être</h3><table><tr><th>Critère</th><th>Poids</th><th>Note</th><th>Observations</th></tr>';
  SE.forEach(function(cr){
    var sc=S.seScr[cr.id]||0,cl=sc>=4?"var(--ok)":sc>=3?"var(--p)":sc>=2?"var(--w)":"var(--d)";
    h+='<tr><td>'+cr.lbl+(cr.elim?' <span style="color:var(--d);font-size:10px;font-weight:700">ÉLIM.</span>':'')+'</td><td>'+cr.w+' %</td><td style="color:'+cl+';font-weight:700">'+(sc>0?"\u2605".repeat(sc)+"\u2606".repeat(5-sc):"--")+'</td><td style="font-size:13px">'+(S.seCom[cr.id]||"—")+'</td></tr>'});
  h+='</table></div>';

  // Détail appétences
  h+='<div class="cd" style="border-left:4px solid var(--s)"><h3 style="color:var(--s)">Détail appétences numériques</h3><table><tr><th>Critère</th><th>Poids</th><th>Note</th><th>Observations</th></tr>';
  APP.forEach(function(a){
    var sc=S.appScr[a.id]||0,cl=sc>=4?"var(--ok)":sc>=3?"var(--p)":sc>=2?"var(--w)":"var(--d)";
    h+='<tr><td>'+a.lbl+'</td><td>'+a.w+' %</td><td style="color:'+cl+';font-weight:700">'+(sc>0?"\u2605".repeat(sc)+"\u2606".repeat(5-sc):"--")+'</td><td style="font-size:13px">'+(S.appCom[a.id]||"—")+'</td></tr>'});
  h+='</table></div>';

  // Détail valeurs
  h+='<div class="cd" style="border-left:4px solid var(--pu)"><h3 style="color:var(--pu)">Détail match valeurs cabinet</h3><table><tr><th>Valeur</th><th>Poids</th><th>Note</th></tr>';
  VAL.forEach(function(v){
    var sc=S.valScr[v.id]||0,cl=sc>=4?"var(--ok)":sc>=3?"var(--p)":sc>=2?"var(--w)":"var(--d)";
    h+='<tr><td>'+v.lbl+'</td><td>'+v.w+' %</td><td style="color:'+cl+';font-weight:700">'+(sc>0?"\u2605".repeat(sc)+"\u2606".repeat(5-sc):"--")+'</td></tr>'});
  h+='</table></div>';
  document.getElementById("resBox").innerHTML=h}

/* ═══ CONFORMITÉ ═══ */
function rCk(){var ck=getCK();var c=document.getElementById("cCk");if(!c)return;c.innerHTML="";
  ck.forEach(function(ch){var dn=CP[ch.id]?" dn":"";
    c.innerHTML+='<div class="ck'+dn+'" onclick="tC(\''+ch.id+'\')"><div class="ckb">'+(CP[ch.id]?"\u2713":"")+'</div><div><div class="ck-t">'+ch.t+'</div><div class="ck-r">'+ch.r+'</div></div></div>'});
  uCk()}
function tC(id){CP[id]=!CP[id];rCk();autoSave()}
function uCk(){var ck=getCK();var n=0;ck.forEach(function(c){if(CP[c.id])n++});var tot=ck.length;document.getElementById("ckLbl").textContent=n+"/"+tot+(n===tot?" \u2713":"")}

/* ═══ PROGRESSION ═══ */
function updProgress(){
  var total=0,done=0;
  total++;if(S.lvl)done++;
  total++;if(gV("cNom"))done++;
  total++;if(Object.keys(S.kAns).length>=5)done++;
  total++;if(Object.keys(S.sfAns).length>=3)done++;
  total++;var seD=0;SE.forEach(function(c){if(S.seScr[c.id])seD++});if(seD>=SE.length)done++;
  total++;var apD=0;APP.forEach(function(c){if(S.appScr[c.id])apD++});if(apD>=APP.length)done++;
  total++;var vlD=0;VAL.forEach(function(v){if(S.valScr[v.id])vlD++});if(vlD>=VAL.length)done++;
  total++;if(S.verdict)done++;
  var ck=getCK();ck.forEach(function(c){total++;if(CP[c.id])done++});
  var pct=total>0?Math.round(done/total*100):0;
  document.getElementById("pbarFill").style.width=pct+"%";
  document.getElementById("ppct").textContent=pct+" %"}

/* ═══ UTILS ═══ */
function gV(id){var el=document.getElementById(id);return el?el.value.trim():""}
function sV(id,v){var el=document.getElementById(id);if(el)el.value=v||""}
function fN(){var d=new Date();return String(d.getDate()).padStart(2,"0")+"."+String(d.getMonth()+1).padStart(2,"0")+"."+d.getFullYear()}
function toast(m){var el=document.getElementById("toE");el.textContent=m;el.classList.add("sh");setTimeout(function(){el.classList.remove("sh")},2500)}

/* ═══ LOCALSTORAGE ═══ */
function autoSave(){try{localStorage.setItem("a20",JSON.stringify({
  v:"4.0",lvl:S.lvl,nom:gV("cNom"),prenom:gV("cPrenom"),poste:gV("cPoste"),dateEval:gV("cDate"),evaluateur:gV("cEval"),cabinet:gV("cCab"),
  kAns:S.kAns,kScore:S.kScore,kMax:S.kMax,sfAns:S.sfAns,sfScore:S.sfScore,sfMax:S.sfMax,
  seScr:S.seScr,seCom:S.seCom,appScr:S.appScr,appCom:S.appCom,valScr:S.valScr,
  cf:S.cf,adn:S.adn,verdict:S.verdict,vTxt:S.vTxt,vDesc:S.vDesc,compliance:CP
}))}catch(e){}}
function loadFromStorage(){try{var raw=localStorage.getItem("a20");if(!raw)return;var d=JSON.parse(raw);
  if(d.lvl)selLvl(d.lvl);
  sV("cNom",d.nom);sV("cPrenom",d.prenom);sV("cPoste",d.poste);sV("cDate",d.dateEval);sV("cEval",d.evaluateur);sV("cCab",d.cabinet);
  if(d.kAns)S.kAns=d.kAns;if(d.kScore)S.kScore=d.kScore;if(d.kMax)S.kMax=d.kMax;
  if(d.sfAns)S.sfAns=d.sfAns;if(d.sfScore)S.sfScore=d.sfScore;if(d.sfMax)S.sfMax=d.sfMax;
  if(d.seScr)S.seScr=d.seScr;if(d.seCom)S.seCom=d.seCom;
  if(d.appScr)S.appScr=d.appScr;if(d.appCom)S.appCom=d.appCom;
  if(d.valScr)S.valScr=d.valScr;
  if(d.cf)S.cf=d.cf;if(d.adn)S.adn=d.adn;
  if(d.verdict){S.verdict=d.verdict;S.vTxt=d.vTxt;S.vDesc=d.vDesc}
  if(d.compliance){CP=d.compliance;rCk()}
  updProgress();toast("Données restaurées")}catch(e){}}

/* ═══ CABINET X DEMO — SIMULATION COMPLÈTE ═══ */
function loadCX(){
  /* 1. Configuration — Profil confirmé */
  selLvl("confirme");
  sV("cNom","DUPONT");sV("cPrenom","Marie");sV("cPoste","Collaboratrice confirmée — Cabinet 100 % numérique");
  sV("cDate",new Date().toISOString().split("T")[0]);sV("cEval","Expert-comptable — Cabinet X");sV("cCab","Cabinet X");

  /* 2. Init state & render */
  S.kAns={};S.kScore=0;S.sfAns={};S.sfScore=0;S.seScr={};S.seCom={};S.appScr={};S.appCom={};S.valScr={};
  renderQCM();renderSF();renderSE();renderAPP();renderVAL();rCk();

  /* 3. QCM Confirmé — 8/10 bonnes réponses = 16/20 (seuil 14)
     Q1 : erreur consolidation (répond A=Mise en équivalence au lieu de C=Intégration globale)
     Q8 : erreur rançongiciel (répond A=Vol de mot de passe au lieu de B=Logiciel malveillant) */
  var qcmR=[0,1,1,1,1,1,1,0,1,1];
  qcmR.forEach(function(a,i){ansK(i,a)});

  /* 4. Savoir-faire Confirmé — 4/5 bons = 16/20
     Cas 3 : erreur conseil fiscal (répond B=flat tax toujours avantageuse au lieu de A=mix optimal) */
  var sfR=[0,0,1,0,0];
  sfR.forEach(function(a,i){ansSF(i,a)});

  /* 5. Savoir-être — Notes 3 à 5, culture fit ~82 % (min confirmé 70 %) */
  rateSE("se1",4);S.seCom["se1"]="Candidate proactive : a appris Pennylane en autonomie en 2 semaines lors de son précédent poste. Suit la veille technologique via LinkedIn et les webinaires éditeurs.";
  sV("com-se1",S.seCom["se1"]);
  rateSE("se2",4);S.seCom["se2"]="Bonne organisation en télétravail, utilise Notion pour planifier ses tâches. Communique régulièrement via Slack et respecte les rituels d'équipe (daily, weekly).";
  sV("com-se2",S.seCom["se2"]);
  rateSE("se3",4);S.seCom["se3"]="Réaction appropriée : signalement immédiat au responsable, discrétion absolue. Connaît le secret professionnel (art. 147 du code de déontologie, Décret n° 2012-432, éd. janv. 2026).";
  sV("com-se3",S.seCom["se3"]);
  rateSE("se4",3);S.seCom["se4"]="Accepte le changement mais a besoin d'un temps d'adaptation. Pas de résistance active. Pourrait être davantage force de proposition lors des transitions.";
  sV("com-se4",S.seCom["se4"]);
  rateSE("se5",5);S.seCom["se5"]="Excellent exemple : a détecté une erreur de cut-off de 12 k€ dans un dossier de révision, a informé son responsable le jour même et proposé l'écriture corrective documentée.";
  sV("com-se5",S.seCom["se5"]);
  rateSE("se6",4);S.seCom["se6"]="Collabore efficacement à distance. Écoute active en entretien, reformule bien les questions posées. Expérience de travail en équipe distribuée sur 2 sites géographiques.";
  sV("com-se6",S.seCom["se6"]);
  rateSE("se7",4);S.seCom["se7"]="Double vérification systématique avant remise de livrable. Utilise une checklist de contrôle personnelle (Excel) pour chaque type de dossier : révision, liasses, TVA.";
  sV("com-se7",S.seCom["se7"]);

  /* 6. Appétences numériques — Notes 3 à 5, ~80 % (min confirmé 60 %) */
  rateAPP("ap1",5);S.appCom["ap1"]="Travaille en environnement full cloud depuis 3 ans (Pennylane, Dext, Slack, Google Workspace). Aucune réticence au zéro papier — l'a initié chez son ancien employeur.";
  sV("com-ap1",S.appCom["ap1"]);
  rateAPP("ap2",3);S.appCom["ap2"]="Curiosité réelle pour l'IA : a testé ChatGPT pour rédiger des courriers types et Claude pour analyser des contrats de bail. Pas encore d'automatisation via Zapier ou Make en place.";
  sV("com-ap2",S.appCom["ap2"]);
  rateAPP("ap3",4);S.appCom["ap3"]="MFA activé sur tous ses comptes professionnels, utilise Bitwarden comme gestionnaire de mots de passe. Sensibilisée au phishing — a suivi la formation ANSSI SecNumAcadémie.";
  sV("com-ap3",S.appCom["ap3"]);
  rateAPP("ap4",4);S.appCom["ap4"]="A accompagné 3 clients TPE dans la migration vers Pennylane et la dématérialisation complète. Approche pédagogique : formation individuelle + tutoriels vidéo personnalisés.";
  sV("com-ap4",S.appCom["ap4"]);

  /* 7. Match valeurs cabinet — Notes 3 à 5, ~80 % */
  rateVAL("v1",4);rateVAL("v2",4);rateVAL("v3",3);rateVAL("v4",5);rateVAL("v5",4);

  /* 8. Conformité — tout coché */
  getCK().forEach(function(ch){CP[ch.id]=true});rCk();

  /* 9. Calcul du verdict → AVIS FAVORABLE */
  calcVerdict();

  /* 10. Navigation vers la page décision */
  go(5);autoSave();
  toast("Démo : Marie DUPONT — 16/20 QCM, 16/20 SF, 82 % culture fit, 78 % ADN → AVIS FAVORABLE")}

/* ═══ RESET ═══ */
function resetAll(){if(!confirm("Réinitialiser toutes les données ? Cette action est irréversible."))return;try{localStorage.removeItem("a20")}catch(e){}location.reload()}

/* ═══ JSON EXPORT/IMPORT ═══ */
function xJSON(){
  var d={v:"4.0",annexe:"20",titre:"Test de connaissance, savoir-être et savoir-faire — Match valeurs du cabinet",date:new Date().toISOString(),
    config:{lvl:S.lvl,nom:gV("cNom"),prenom:gV("cPrenom"),poste:gV("cPoste"),dateEval:gV("cDate"),evaluateur:gV("cEval"),cabinet:gV("cCab")},
    scores:{kScore:S.kScore,kMax:S.kMax,sfScore:S.sfScore,sfMax:S.sfMax,cf:S.cf,adn:S.adn,verdict:S.verdict,vTxt:S.vTxt,vDesc:S.vDesc},
    detail:{kAns:S.kAns,sfAns:S.sfAns,seScr:S.seScr,seCom:S.seCom,appScr:S.appScr,appCom:S.appCom,valScr:S.valScr,elimFail:S.elimFail.map(function(c){return c.id})},
    compliance:CP};
  var bl=new Blob([JSON.stringify(d,null,2)],{type:"application/json"});
  var a=document.createElement("a");a.href=URL.createObjectURL(bl);a.download="annexe20_evaluation_"+gV("cNom")+"_"+new Date().toISOString().split("T")[0]+".json";a.click();toast("JSON exporté")}

function iJSON(ev){var f=ev.target.files[0];if(!f)return;
  var r=new FileReader();r.onload=function(e){try{var d=JSON.parse(e.target.result);
    if(d.config){if(d.config.lvl)selLvl(d.config.lvl);sV("cNom",d.config.nom);sV("cPrenom",d.config.prenom);sV("cPoste",d.config.poste);sV("cDate",d.config.dateEval);sV("cEval",d.config.evaluateur);sV("cCab",d.config.cabinet)}
    if(d.detail){if(d.detail.seScr)S.seScr=d.detail.seScr;if(d.detail.seCom)S.seCom=d.detail.seCom;if(d.detail.appScr)S.appScr=d.detail.appScr;if(d.detail.appCom)S.appCom=d.detail.appCom;if(d.detail.valScr)S.valScr=d.detail.valScr}
    if(d.compliance){CP=d.compliance;rCk()}
    updProgress();autoSave();toast("Importé avec succès")
  }catch(err){toast("Fichier invalide")}};r.readAsText(f)}

/* ═══ PDF EXPORT ═══ */
function xPDF(){
  document.getElementById("ov").classList.add("sh");
  setTimeout(function(){try{
    var J=window.jspdf.jsPDF,doc=new J("p","mm","a4");
    var pw=210,ph=297,mg=14,cw=pw-2*mg,y=0,pg=1,PC=[30,58,95],LH=3.3;

    function safe(t){if(!t)return"";return String(t).replace(/[\u{1F300}-\u{1FAFF}]/gu,"").replace(/[\u{2600}-\u{27BF}]/gu,"").replace(/[\u00A0\u202F]/g," ").replace(/['\u2018\u2019]/g,"'").replace(/["\u201C\u201D]/g,'"').replace(/\u2026/g,"...").replace(/[\u2013\u2014]/g,"-").replace(/\u20ac/g,"EUR").replace(/[^\x20-\x7E\u00A1-\u00FF]/g,"").trim()}
    function ft(){doc.setDrawColor(180);doc.setLineWidth(.2);doc.line(mg,ph-12,pw-mg,ph-12);doc.setFontSize(6.5);doc.setTextColor(130);doc.setFont("helvetica","normal");doc.text("Annexe 20 - Evaluation recrutement | Source : réalisé par le candidat | "+safe(gV("cCab")),mg,ph-8);doc.text("Page "+pg,pw-mg-10,ph-8)}
    function np(){ft();doc.addPage();pg++;y=14}
    function chk(n){if(y+n>ph-18)np()}
    function hdr(t){chk(13);doc.setFillColor(PC[0],PC[1],PC[2]);doc.rect(mg,y,cw,8,"F");doc.setTextColor(255);doc.setFontSize(9.5);doc.setFont("helvetica","bold");doc.text(safe(t),mg+3,y+5.8);y+=12;doc.setTextColor(0)}
    function row(l,v){doc.setFontSize(8);doc.setFont("helvetica","bold");doc.setTextColor(100);chk(5);doc.text(safe(l),mg,y);doc.setFont("helvetica","normal");doc.setTextColor(40);var ls=doc.splitTextToSize(safe(v),cw-42);doc.text(ls,mg+42,y);y+=Math.max(5,ls.length*3.5)}

    // HEADER
    doc.setFillColor(PC[0],PC[1],PC[2]);doc.rect(0,0,pw,28,"F");
    doc.setTextColor(255);doc.setFontSize(14);doc.setFont("helvetica","bold");
    doc.text("RAPPORT D'EVALUATION - CABINET 100 % NUMERIQUE",mg,13);
    doc.setFontSize(9);doc.setFont("helvetica","normal");
    doc.text(safe(gV("cPrenom")+" "+gV("cNom")+" - "+gV("cPoste")),mg,20);
    doc.setFontSize(7);doc.text(safe(gV("cCab"))+" | "+safe(fN())+" | Confidentiel",mg,25);y=34;

    hdr("1. INFORMATIONS");
    row("Candidat :",gV("cPrenom")+" "+gV("cNom"));
    row("Poste :",gV("cPoste"));
    row("Niveau :",S.lvl?CFG[S.lvl].name:"--");
    row("Evaluateur :",gV("cEval"));
    row("Cabinet :",gV("cCab"));
    row("Date :",gV("cDate")||fN());y+=3;

    hdr("2. DECISION");
    doc.setFontSize(12);doc.setFont("helvetica","bold");
    var vc=S.verdict==="acc"?[0,150,0]:S.verdict==="con"?[200,150,0]:[200,0,0];
    doc.setTextColor(vc[0],vc[1],vc[2]);chk(8);doc.text(safe(S.vTxt||"--"),mg,y);y+=5;
    doc.setFontSize(8);doc.setFont("helvetica","normal");doc.setTextColor(80);
    var dl=doc.splitTextToSize(safe(S.vDesc||""),cw);doc.text(dl,mg,y);y+=dl.length*3.5+3;

    hdr("3. SYNTHESE DES SCORES");
    if(S.lvl){var c=CFG[S.lvl];
      var sfPct=S.sfMax>0?Math.round(S.sfScore/S.sfMax*100):0;
      row("Connaissance :",S.kScore+"/"+S.kMax+" (seuil : "+c.seuil+") "+(S.kScore>=c.seuil?"-> Valide":"-> Non valide"));
      row("Savoir-faire :",S.sfScore+"/"+S.sfMax+" ("+sfPct+" %)");
      row("Culture fit :",S.cf+" % (min : "+c.cfMin+" %)");
      row("ADN numerique :",S.adn+" % (min : "+c.adnMin+" %)")}y+=3;

    np();
    hdr("4. DETAIL SAVOIR-ETRE");
    SE.forEach(function(cr){
      var sc=S.seScr[cr.id]||0;
      chk(8);doc.setFontSize(7.5);doc.setFont("helvetica","bold");doc.setTextColor(50);
      doc.text(safe(cr.lbl+(cr.elim?" [ELIM.]":""))+" ("+cr.w+" %)",mg,y);
      doc.setFont("helvetica","normal");doc.text(sc>0?"*".repeat(sc)+".".repeat(5-sc)+" "+sc+"/5":"Non note",mg+80,y);y+=3.5;
      if(S.seCom[cr.id]){doc.setFontSize(6.5);doc.setTextColor(100);var cl=doc.splitTextToSize("Obs: "+safe(S.seCom[cr.id]),cw-10);doc.text(cl,mg+4,y);y+=cl.length*2.5+1}
      y+=1});y+=3;

    hdr("5. DETAIL APPETENCES NUMERIQUES");
    APP.forEach(function(a){
      var sc=S.appScr[a.id]||0;
      chk(6);doc.setFontSize(7.5);doc.setFont("helvetica","bold");doc.setTextColor(50);
      doc.text(safe(a.lbl)+" ("+a.w+" %)",mg,y);
      doc.setFont("helvetica","normal");doc.text(sc>0?"*".repeat(sc)+".".repeat(5-sc)+" "+sc+"/5":"Non note",mg+80,y);y+=3.5;
      if(S.appCom[a.id]){doc.setFontSize(6.5);doc.setTextColor(100);var cl=doc.splitTextToSize("Obs: "+safe(S.appCom[a.id]),cw-10);doc.text(cl,mg+4,y);y+=cl.length*2.5+1}
      y+=1});y+=3;

    hdr("6. MATCH VALEURS CABINET");
    VAL.forEach(function(v){
      var sc=S.valScr[v.id]||0;
      chk(6);doc.setFontSize(7.5);doc.setFont("helvetica","bold");doc.setTextColor(50);
      doc.text(safe(v.lbl)+" ("+v.w+" %)",mg,y);
      doc.setFont("helvetica","normal");doc.text(sc>0?"*".repeat(sc)+".".repeat(5-sc)+" "+sc+"/5":"Non note",mg+80,y);y+=3.5});y+=3;

    if(S.lvl){
      hdr("7. DETAIL TEST DE CONNAISSANCE ("+CFG[S.lvl].name+")");
      QCM[S.lvl].forEach(function(q,i){
        chk(6);doc.setFontSize(7);doc.setFont("helvetica","normal");doc.setTextColor(50);
        var ans=S.kAns[i],ok=ans===q.c;
        doc.text((ok?"[OK]":"[KO]")+" Q"+(i+1)+": "+safe(q.sec)+" ("+q.pts+"pts) -> "+(ans!==undefined?String.fromCharCode(65+ans):"--"),mg,y);y+=3.5});y+=3;

      hdr("8. DETAIL SAVOIR-FAIRE ("+CFG[S.lvl].name+")");
      SF[S.lvl].forEach(function(t,i){
        chk(6);doc.setFontSize(7);doc.setFont("helvetica","normal");doc.setTextColor(50);
        var ans=S.sfAns[i],ok=ans!==undefined&&t.o[ans].ok;
        doc.text((ans!==undefined?(ok?"[OK]":"[KO]"):"[--]")+" Cas "+(i+1)+": "+safe(t.t)+" ("+t.pts+"pts)",mg,y);y+=3.5});y+=3}

    hdr("9. CONFORMITE EVALUATION");
    var ckAll=getCK();ckAll.forEach(function(c){
      chk(4);doc.setFontSize(7);doc.setFont("helvetica","normal");doc.setTextColor(50);
      doc.text((CP[c.id]?"[X]":"[ ]")+" "+safe(c.t)+" ("+safe(c.r)+")",mg,y);y+=3.5});
    var dn=0;ckAll.forEach(function(c){if(CP[c.id])dn++});var ckT=ckAll.length;
    y+=2;chk(5);doc.setFontSize(8);doc.setFont("helvetica","bold");
    doc.setTextColor(dn===ckT?0:180,dn===ckT?128:0,0);
    doc.text("Score : "+dn+"/"+ckT+(dn===ckT?" - CONFORME":" - A COMPLETER"),mg,y);y+=6;

    chk(14);y+=3;doc.setFontSize(6);doc.setTextColor(120);
    doc.text("Ce document est confidentiel. Conservation limitee a 2 ans conformement aux recommandations CNIL.",mg,y);y+=3;
    doc.text("Ref. : NPMQ p22, A22-1 a A22-4 | Art. 148 Code deontologie (Decret n. 2012-432, ed. janv. 2026) | RGPD art. 5, 13, 22 | Code du travail L.1221-6, L.1221-8, L.1132-1",mg,y);

    ft();
    doc.save("Evaluation_"+safe(gV("cNom")||"candidat")+"_"+new Date().toISOString().split("T")[0]+".pdf");
    document.getElementById("ov").classList.remove("sh");toast("PDF téléchargé")
  }catch(e){console.error(e);document.getElementById("ov").classList.remove("sh");toast("Erreur : "+e.message)}},300)}

/* ═══ INIT ═══ */
document.addEventListener("DOMContentLoaded",function(){rCk();document.getElementById("cDate").value=new Date().toISOString().split("T")[0];loadFromStorage()});
document.addEventListener("input",function(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"){autoSave();updProgress()}});
document.addEventListener("change",function(e){if(e.target.tagName==="SELECT"){autoSave();updProgress()}});
</script>
</body>
</html>
